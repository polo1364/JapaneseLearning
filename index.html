<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinguaMax - AI æ—¥èªå­¸ç¿’ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --gold: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --bg-light: #f8fafc;
            --bg-card: #ffffff;
            --text-dark: #0f172a;
            --text-light: #475569;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * { 
            font-family: 'Inter', 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-weight: 500;
            color: #1e293b;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            color: #0f172a;
        }
        
        p, span, div {
            color: #1e293b;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: var(--shadow-xl);
            color: #0f172a;
        }

        .glow-green { box-shadow: 0 0 30px rgba(16, 185, 129, 0.4), var(--shadow-lg); }
        .glow-blue { box-shadow: 0 0 30px rgba(99, 102, 241, 0.4), var(--shadow-lg); }
        .glow-gold { box-shadow: 0 0 30px rgba(245, 158, 11, 0.4), var(--shadow-lg); }

        /* Flashcard 3D ç¿»è½‰ */
        .flashcard { perspective: 1500px; }
        .flashcard-inner {
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .flashcard-back { transform: rotateY(180deg); }

        /* é€²åº¦æ¢å‹•ç•« */
        .progress-fill {
            transition: width 0.5s ease-out;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        /* æŒ‰éˆ•æ•ˆæœ */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-md);
        }

        .btn-option {
            background: white;
            border: 2px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #0f172a;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            text-align: left;
            display: flex;
            align-items: center;
            min-height: 60px;
        }
        .btn-option:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .btn-option.correct {
            border-color: var(--success) !important;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)) !important;
            color: var(--success) !important;
            animation: pulse-green 0.5s;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3) !important;
        }
        .btn-option.wrong {
            border-color: var(--danger) !important;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05)) !important;
            color: var(--danger) !important;
            animation: shake 0.5s;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3) !important;
        }

        @keyframes pulse-green {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .animate-slide { animation: slideIn 0.5s ease-out; }
        .animate-float { animation: float 3s ease-in-out infinite; }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        /* XP å‹•ç•« */
        .xp-popup {
            animation: xpFloat 1.5s ease-out forwards;
        }
        @keyframes xpFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }

        /* é€£çºŒå¤©æ•¸ç«ç„° */
        .streak-fire {
            animation: fireGlow 1.5s ease-in-out infinite alternate;
        }
        @keyframes fireGlow {
            from { filter: drop-shadow(0 0 5px #ff6b00); }
            to { filter: drop-shadow(0 0 15px #ff9500); }
        }

        /* è½åŠ›æ³¢å½¢ */
        .sound-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 30px;
        }
        .sound-wave span {
            width: 4px;
            background: var(--secondary);
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }
        .sound-wave span:nth-child(1) { animation-delay: 0s; height: 40%; }
        .sound-wave span:nth-child(2) { animation-delay: 0.1s; height: 70%; }
        .sound-wave span:nth-child(3) { animation-delay: 0.2s; height: 100%; }
        .sound-wave span:nth-child(4) { animation-delay: 0.3s; height: 70%; }
        .sound-wave span:nth-child(5) { animation-delay: 0.4s; height: 40%; }

        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }

        /* æ‰“å­—è¼¸å…¥ */
        .typing-input {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 16px;
            color: #0f172a;
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            outline: none;
            caret-color: var(--primary);
            padding: 12px 20px;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
        }
        .typing-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), var(--shadow-md);
        }

        /* Modal */
        .modal-overlay {
            backdrop-filter: blur(12px);
            background: rgba(0,0,0,0.5);
        }

        /* éš±è— scrollbar ä½†å¯æ»¾å‹• */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ä¸‹æ‹‰é¸å–®ä¿®å¾© - ç¢ºä¿æ–‡å­—å¯è¦‹ */
        select {
            color: var(--text-dark) !important;
            background-color: white !important;
            border: 2px solid #e2e8f0 !important;
            box-shadow: var(--shadow-sm) !important;
        }
        select option {
            background-color: white !important;
            color: var(--text-dark) !important;
            padding: 12px !important;
        }
        select:focus {
            outline: 2px solid var(--primary);
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
        }

        /* åˆå­¸è€…å‹å–„ - æ›´å¤§çš„å­—é«”å’Œé–“è· */
        .beginner-friendly {
            font-size: 1.1rem;
            line-height: 1.8;
        }

        /* æç¤ºæ¨™ç±¤ */
        .hint-tag {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            font-weight: 700;
            padding: 6px 16px;
            border-radius: 9999px;
            font-size: 0.75rem;
            animation: pulse 2s infinite;
            box-shadow: var(--shadow-md);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ===== èªéŸ³å„ªåŒ–æ¨£å¼ ===== */
        .volume-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 24px;
            margin-left: 8px;
        }
        
        .volume-bar {
            width: 4px;
            height: 100%;
            background: #4a5568;
            border-radius: 2px;
            transform-origin: bottom;
            transition: transform 0.1s ease, background-color 0.2s ease, opacity 0.2s ease;
        }
        
        .mic-btn-enhanced {
            position: relative;
            overflow: visible;
        }
        
        .mic-btn-enhanced.listening::after {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            border: 2px solid rgba(239, 68, 68, 0.5);
            animation: ripple 1.5s ease-out infinite;
        }
        
        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .voice-hint {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(236, 72, 153, 0.15));
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 9999px;
            color: #dc2626;
            font-size: 0.9rem;
            backdrop-filter: blur(4px);
            box-shadow: var(--shadow-sm);
            font-weight: 600;
        }
        
        .voice-hint .dot {
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
            animation: dotPulse 1s ease-in-out infinite;
        }
        
        @keyframes dotPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.6; }
        }

        /* æ–°æ‰‹å¼•å°æ°£æ³¡ */
        .guide-bubble {
            position: relative;
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
            padding: 16px 20px;
            border-radius: 16px;
            font-size: 0.9rem;
            color: white;
            box-shadow: var(--shadow-lg);
            font-weight: 600;
        }
        .guide-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #8b5cf6;
        }
    </style>
</head>
<body class="text-gray-800 overflow-hidden">

    <!-- API Key Modal -->
    <div id="key-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-8 w-full max-w-md animate-slide">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-float">
                    <i class="fa-solid fa-robot text-4xl"></i>
                </div>
                <h2 class="text-2xl font-black">æ­¡è¿ä¾†åˆ° LinguaMax</h2>
                <p class="text-gray-600 mt-2">è¼¸å…¥ Gemini API Key é–‹å§‹å­¸ç¿’</p>
            </div>
            <input type="password" id="api-key-input" 
                class="w-full bg-white border-2 border-gray-300 rounded-xl p-4 mb-4 text-gray-800 placeholder-gray-400 focus:border-indigo-500 focus:outline-none focus:ring-4 focus:ring-indigo-200 transition shadow-sm"
                placeholder="AIzaSy...">
            <button onclick="saveApiKey()" class="btn-primary w-full py-4 rounded-xl text-lg font-bold text-white">
                é–‹å§‹å­¸ç¿’ <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- ä¸»ç•«é¢ -->
    <div class="h-screen flex flex-col">
        <!-- é ‚éƒ¨å°èˆª -->
        <header class="glass-card border-b border-gray-200/50 px-4 py-4 shadow-lg">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3 md:gap-6">
                    <!-- æ‰‹æ©Ÿç‰ˆé¸å–®æŒ‰éˆ• -->
                    <button onclick="toggleMobileMenu()" class="lg:hidden w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center text-white shadow-md hover:shadow-lg transition">
                        <i class="fa-solid fa-bars text-lg"></i>
            </button>

                    <h1 class="text-lg md:text-xl font-black bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">
                        LinguaMax
                    </h1>
                    
                    <!-- é€£çºŒå¤©æ•¸ -->
                    <div class="hidden sm:flex items-center gap-2 bg-gradient-to-r from-orange-400 to-red-400 px-4 py-2 rounded-full text-white shadow-md">
                        <i class="fa-solid fa-fire streak-fire"></i>
                        <span id="streak-count" class="font-bold">0</span>
        </div>

                    <!-- XP -->
                    <div class="flex items-center gap-2 bg-gradient-to-r from-yellow-400 to-amber-400 px-4 py-2 rounded-full text-white shadow-md">
                        <i class="fa-solid fa-star"></i>
                        <span id="xp-count" class="font-bold">0 XP</span>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <!-- ç­‰ç´šé¸æ“‡ -->
                    <div class="relative">
                        <label class="text-xs text-gray-600 absolute -top-5 left-0 font-semibold">é›£åº¦ç­‰ç´š</label>
                        <select id="level-select" onchange="onLevelChange()" class="bg-white border-2 border-gray-300 rounded-xl px-4 py-2.5 text-base font-semibold cursor-pointer hover:border-indigo-500 transition min-w-[200px] shadow-sm">
                            <option value="N5" selected>ğŸŒ± å…¥é–€ (N5)</option>
                            <option value="N4">ğŸŒ¿ åˆç´š (N4)</option>
                            <option value="N3">ğŸŒ³ ä¸­ç´š (N3)</option>
                            <option value="N2">ğŸŒ² ä¸­é«˜ç´š (N2)</option>
                            <option value="N1">ğŸ”ï¸ é€²éš (N1)</option>
                            <option value="SURVIVAL">ğŸ§­ æ—…æ—¥ç”Ÿå­˜</option>
                            <option value="TRAVEL_PLUS">âœˆï¸ æ—…éŠé€²éš</option>
                            <option value="BIZ_KEIGO">ğŸ’¼ è·å ´æ•¬èª</option>
                            <option value="CASUAL">ğŸ—£ï¸ æ—¥å¸¸ä¿—èª</option>
                            <option value="IT_DEV">ğŸ‘©â€ğŸ’» IT / å·¥ç¨‹</option>
                            <option value="KANA_HIRA">ğŸˆ å¹³å‡åå…¥é–€</option>
                            <option value="KANA_KATA">ğŸˆ‚ï¸ ç‰‡å‡åå…¥é–€</option>
                            <option value="CONVO">ğŸ’¬ æœƒè©±å„ªå…ˆ</option>
                    </select>
                    </div>

                    <!-- å€‹äººè³‡æ–™ -->
                    <button onclick="openStats()" class="w-11 h-11 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold hover:scale-105 transition shadow-lg hover:shadow-xl text-white" title="å­¸ç¿’çµ±è¨ˆ">
                        <i class="fa-solid fa-chart-line text-lg"></i>
                </button>
                </div>
            </div>
        </header>

        <!-- æ‰‹æ©Ÿç‰ˆé¸å–® (è¦†è“‹å±¤) -->
        <div id="mobile-menu" class="fixed inset-0 z-40 hidden lg:hidden">
            <div class="absolute inset-0 bg-black/60" onclick="toggleMobileMenu()"></div>
            <aside class="absolute left-0 top-0 bottom-0 w-72 glass-card border-r border-gray-200/50 p-4 overflow-y-auto hide-scrollbar animate-slide shadow-2xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-gray-600 flex items-center gap-2">
                        <i class="fa-solid fa-book-open text-indigo-600"></i> é¸æ“‡å­¸ç¿’æ¨¡å¼
                    </h3>
                    <button onclick="toggleMobileMenu()" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center text-gray-600 transition">
                        <i class="fa-solid fa-times"></i>
                    </button>
            </div>

                <nav class="space-y-2" id="mobile-mode-nav">
                    <button onclick="switchMode('kana'); toggleMobileMenu();" data-mode="kana" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-indigo-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-language text-xl text-emerald-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">äº”åéŸ³</div>
                            <div class="text-xs text-gray-700 font-medium">å¹³å‡å / ç‰‡å‡å</div>
                        </div>
                    </button>
                    <button onclick="switchMode('flashcard'); toggleMobileMenu();" data-mode="flashcard" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-300 text-indigo-700 shadow-md">
                        <i class="fa-solid fa-clone text-xl text-indigo-600"></i>
                        <div class="text-left">
                            <div class="font-bold">å–®å­—é–ƒå¡</div>
                            <div class="text-xs text-indigo-500">ç¿»è½‰å­¸ç¿’æ–°å–®å­—</div>
            </div>
                    </button>
                    <button onclick="switchMode('quiz'); toggleMobileMenu();" data-mode="quiz" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-blue-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-circle-question text-xl text-blue-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">é¸æ“‡é¡Œæ¸¬é©—</div>
                            <div class="text-xs text-gray-700 font-medium">å››é¸ä¸€å¿«é€Ÿç·´ç¿’</div>
                        </div>
                    </button>
                    <button onclick="switchMode('typing'); toggleMobileMenu();" data-mode="typing" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-purple-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-keyboard text-xl text-purple-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">æ‹¼å¯«ç·´ç¿’</div>
                            <div class="text-xs text-gray-700 font-medium">æ‰“å­—è¨˜æ†¶å–®å­—</div>
                        </div>
                    </button>
                    <button onclick="switchMode('listening'); toggleMobileMenu();" data-mode="listening" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-cyan-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-headphones text-xl text-cyan-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">è½åŠ›è¨“ç·´</div>
                            <div class="text-xs text-gray-700 font-medium">è½éŸ³è¾¨ç¾©ç·´ç¿’</div>
                        </div>
                    </button>
                    <button onclick="switchMode('grammar'); toggleMobileMenu();" data-mode="grammar" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-amber-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-spell-check text-xl text-amber-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">æ–‡æ³•é—˜é—œ</div>
                            <div class="text-xs text-gray-700 font-medium">å¥å‹çµæ§‹ç·´ç¿’</div>
                        </div>
                    </button>
                    <button onclick="switchMode('chat'); toggleMobileMenu();" data-mode="chat" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-pink-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-comments text-xl text-pink-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">AI å°è©±</div>
                            <div class="text-xs text-gray-700 font-medium">æƒ…å¢ƒæ—¥èªæœƒè©±</div>
                        </div>
                    </button>
                </nav>

                <hr class="border-gray-200 my-6">

                <h3 class="text-sm font-bold text-gray-600 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-folder text-yellow-500"></i> é¸æ“‡å­¸ç¿’ä¸»é¡Œ
                </h3>
                <select id="mobile-topic-select" onchange="onMobileTopicChange()" 
                    class="w-full bg-white border-2 border-gray-300 rounded-xl px-4 py-3 text-base font-semibold cursor-pointer hover:border-yellow-400 transition shadow-sm">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </select>
            </aside>
            </div>

        <!-- ä¸»å…§å®¹å€ -->
        <div class="flex-1 flex overflow-hidden">
            <!-- å´é‚Šæ¬„ (æ¡Œé¢ç‰ˆ) -->
            <aside class="w-72 glass-card border-r border-gray-200/50 p-4 hidden lg:block overflow-y-auto hide-scrollbar shadow-lg">
                <h3 class="text-sm font-bold text-gray-600 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-book-open text-indigo-600"></i> é¸æ“‡å­¸ç¿’æ¨¡å¼
                </h3>
                
                <nav class="space-y-2" id="mode-nav">
                    <button onclick="switchMode('kana')" data-mode="kana" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-indigo-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-language text-xl text-emerald-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">äº”åéŸ³</div>
                            <div class="text-xs text-gray-700 font-medium">å¹³å‡å / ç‰‡å‡åå°ˆå€</div>
                        </div>
                    </button>

                    <button onclick="switchMode('flashcard')" data-mode="flashcard" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-300 text-indigo-700 shadow-md">
                        <i class="fa-solid fa-clone text-xl text-indigo-600"></i>
                        <div class="text-left">
                            <div class="font-bold">å–®å­—é–ƒå¡</div>
                            <div class="text-xs text-indigo-500">ç¿»è½‰å­¸ç¿’æ–°å–®å­—</div>
                        </div>
                    </button>

                    <button onclick="switchMode('quiz')" data-mode="quiz" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-blue-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-circle-question text-xl text-blue-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">é¸æ“‡é¡Œæ¸¬é©—</div>
                            <div class="text-xs text-gray-700 font-medium">å››é¸ä¸€å¿«é€Ÿç·´ç¿’</div>
                        </div>
                    </button>

                    <button onclick="switchMode('typing')" data-mode="typing" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-purple-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-keyboard text-xl text-purple-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">æ‹¼å¯«ç·´ç¿’</div>
                            <div class="text-xs text-gray-700 font-medium">æ‰“å­—è¨˜æ†¶å–®å­—</div>
                        </div>
                    </button>

                    <button onclick="switchMode('listening')" data-mode="listening" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-cyan-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-headphones text-xl text-cyan-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">è½åŠ›è¨“ç·´</div>
                            <div class="text-xs text-gray-700 font-medium">è½éŸ³è¾¨ç¾©ç·´ç¿’</div>
                        </div>
                    </button>

                    <button onclick="switchMode('grammar')" data-mode="grammar" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-amber-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-spell-check text-xl text-amber-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">æ–‡æ³•é—–é—œ</div>
                            <div class="text-xs text-gray-700 font-medium">å¥å‹çµæ§‹ç·´ç¿’</div>
                        </div>
                    </button>

                    <button onclick="switchMode('chat')" data-mode="chat" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-pink-50 border-2 border-transparent transition shadow-sm">
                        <i class="fa-solid fa-comments text-xl text-pink-500"></i>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">AI å°è©±</div>
                            <div class="text-xs text-gray-700 font-medium">æƒ…å¢ƒæ—¥èªæœƒè©±</div>
                        </div>
                    </button>
                </nav>

                <hr class="border-gray-200 my-6">

                <h3 class="text-sm font-bold text-gray-600 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-folder text-yellow-500"></i> é¸æ“‡å­¸ç¿’ä¸»é¡Œ
                </h3>
                <select id="topic-select" onchange="onTopicChange()" 
                    class="w-full bg-white border-2 border-gray-300 rounded-xl px-4 py-3 text-base font-semibold cursor-pointer hover:border-yellow-400 transition shadow-sm">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </select>
                <div id="topic-list" class="hidden">
                    <!-- ä¿ç•™çµ¦èˆŠç‰ˆç›¸å®¹ -->
                </div>

                <hr class="border-gray-200 my-6">

                <!-- ä»Šæ—¥é€²åº¦ -->
                <div class="glass-card rounded-xl p-4 mb-4 shadow-md">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-bold text-gray-700">ä»Šæ—¥ç›®æ¨™</span>
                        <span class="text-xs text-gray-600"><span id="today-learned">0</span>/20 å–®å­—</span>
                    </div>
                    <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
                        <div id="daily-progress" class="progress-fill h-full rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <!-- ç­‰ç´šé€²åº¦ -->
                <div class="glass-card rounded-xl p-4 mb-4 shadow-md">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-bold flex items-center gap-2 text-gray-700">
                            <span id="user-level-badge" class="text-lg">ğŸŒ±</span>
                            Lv.<span id="user-level">1</span>
                        </span>
                        <span class="text-xs text-gray-600"><span id="xp-to-next">0</span>/<span id="xp-needed">100</span> XP</span>
                    </div>
                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                        <div id="level-progress" class="h-full rounded-full bg-gradient-to-r from-purple-500 to-pink-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- å¿«æ·éµæç¤º -->
                <div class="text-xs text-gray-600 space-y-1 bg-gray-50 rounded-lg p-3">
                    <p class="font-bold text-gray-700 mb-2"><i class="fa-solid fa-keyboard mr-1 text-indigo-600"></i>å¿«æ·éµ</p>
                    <p><kbd class="bg-white border border-gray-300 px-2 py-1 rounded shadow-sm font-mono">ç©ºç™½</kbd> ç¿»è½‰/æ’­æ”¾</p>
                    <p><kbd class="bg-white border border-gray-300 px-2 py-1 rounded shadow-sm font-mono">1-4</kbd> é¸æ“‡ç­”æ¡ˆ</p>
                    <p><kbd class="bg-white border border-gray-300 px-2 py-1 rounded shadow-sm font-mono">S</kbd> æ…¢é€Ÿ <kbd class="bg-white border border-gray-300 px-2 py-1 rounded shadow-sm font-mono">R</kbd> é‡è¤‡</p>
                </div>
            </aside>

            <!-- ä¸»å­¸ç¿’å€ -->
            <main class="flex-1 overflow-y-auto hide-scrollbar p-6">
                <div class="max-w-3xl mx-auto">
                    
                    <!-- è¼‰å…¥ä¸­ -->
                    <div id="loading" class="hidden fixed inset-0 bg-black/50 z-40 flex items-center justify-center">
                        <div class="text-center glass-card rounded-3xl p-8">
                            <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
                            <p class="mt-4 font-bold text-lg text-gray-800">AI æ­£åœ¨ç”Ÿæˆå­¸ç¿’å…§å®¹...</p>
                        </div>
                    </div>

                    <!-- å­¸ç¿’é€²åº¦æ¢ -->
                    <div id="session-progress" class="mb-6 hidden">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-600 font-semibold">å­¸ç¿’é€²åº¦</span>
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-bold text-gray-700"><span id="current-idx">1</span> / <span id="total-items">5</span></span>
                                <button onclick="regenerateContent()" 
                                    class="text-xs bg-gradient-to-r from-indigo-500 to-purple-500 text-white hover:from-indigo-600 hover:to-purple-600 px-4 py-2 rounded-full flex items-center gap-1 transition shadow-md hover:shadow-lg"
                                    title="æ›ä¸€æ‰¹æ–°å–®å­—">
                                    <i class="fa-solid fa-shuffle"></i> æ›ä¸€æ‰¹
                                </button>
                            </div>
                        </div>
                        <div class="h-2 bg-gray-100 rounded-full overflow-hidden shadow-inner">
                            <div id="session-bar" class="progress-fill h-full rounded-full" style="width: 20%"></div>
                        </div>
                    </div>

                    <!-- äº”åéŸ³æ¨¡å¼ -->
                    <div id="view-kana" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-6 md:p-8 animate-slide">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                                <div>
                                    <div class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 border border-emerald-300 text-emerald-700 text-xs font-bold mb-2 shadow-sm">
                                        <i class="fa-solid fa-language mr-2"></i> äº”åéŸ³å°ˆå€
                                    </div>
                                    <h2 class="text-2xl md:text-3xl font-black text-gray-900">å¹³å‡å / ç‰‡å‡åç·´ç¿’</h2>
                                    <p class="text-sm text-gray-700 mt-1 font-semibold">å›ºå®šå­—å¡ï¼ŒåŒ…å«ç™¼éŸ³ã€å‡åèˆ‡ä¾‹å­—ï¼Œå…ˆç†Ÿç·´è®€éŸ³å†é€²å…¥å–®å­—ã€‚</p>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-3 mb-4">
                                <button onclick="switchKanaMode('hiragana')" class="px-4 py-2 rounded-xl bg-emerald-500/20 border border-emerald-400/40 text-emerald-100 font-bold hover:bg-emerald-500/30 transition">
                                    ğŸˆ å¹³å‡å
                                </button>
                                <button onclick="switchKanaMode('katakana')" class="px-4 py-2 rounded-xl bg-cyan-500/20 border border-cyan-400/40 text-cyan-100 font-bold hover:bg-cyan-500/30 transition">
                                    ğŸˆ‚ï¸ ç‰‡å‡å
                                </button>
                            </div>

                            <div id="kana-grid" class="grid grid-cols-5 gap-3 md:gap-4 mt-4"></div>
                            <div id="kana-extra" class="space-y-6 mt-6"></div>
                        </div>
                    </div>

                    <!-- é–ƒå¡æ¨¡å¼ -->
                    <div id="view-flashcard" class="view-section">
                        <!-- æ–°æ‰‹æç¤º -->
                        <div id="flashcard-guide" class="guide-bubble mb-6 text-center max-w-md mx-auto">
                            <i class="fa-solid fa-hand-pointer mr-2"></i>
                            <strong>æç¤ºï¼š</strong>é»æ“Šå¡ç‰‡å¯ä»¥ç¿»è½‰æŸ¥çœ‹ä¸­æ–‡æ„æ€ï¼
                            <button onclick="this.parentElement.style.display='none'" class="ml-2 opacity-70 hover:opacity-100">âœ•</button>
                        </div>

                        <div class="flashcard h-[500px] md:h-[550px] cursor-pointer mx-auto max-w-2xl" onclick="flipCard()">
                            <div class="flashcard-inner relative w-full h-full">
                                <!-- æ­£é¢ -->
                                <div class="flashcard-face flashcard-front absolute w-full h-full glass-card rounded-3xl flex flex-col p-6 md:p-8">
                                    <!-- è©æ€§æ¨™ç±¤ -->
                                    <div class="flex justify-center mb-3">
                                        <span id="card-pos" class="text-sm px-4 py-1.5 rounded-full bg-indigo-100 border border-indigo-300 text-indigo-700 font-bold shadow-sm"></span>
                                    </div>
                                    
                                    <!-- ä¸»è¦å–®å­—å€åŸŸ -->
                                    <div class="flex-1 flex flex-col items-center justify-center">
                                        <h2 id="card-word" class="text-6xl md:text-7xl font-black mb-4 text-center text-gray-900 leading-tight"></h2>
                                        
                                        <!-- å‡åå’Œç¾…é¦¬éŸ³ -->
                                        <div class="mb-6 text-center">
                                            <p id="card-kana" class="text-3xl md:text-4xl font-bold text-indigo-600 mb-2"></p>
                                            <p id="card-romaji" class="text-base text-gray-600 font-semibold"></p>
                                        </div>
                                        
                                        <!-- èªéŸ³æ’­æ”¾æŒ‰éˆ•çµ„ - æ›´å¤§æ›´æ˜é¡¯ -->
                                        <div class="flex items-center gap-4 mt-4">
                                            <button onclick="event.stopPropagation(); speakSlow()" 
                                                class="w-16 h-16 bg-amber-100 border-2 border-amber-400 rounded-full flex flex-col items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-lg hover:shadow-xl" 
                                                title="æ…¢é€Ÿæ’­æ”¾ï¼ˆ0.5å€é€Ÿï¼‰">
                                                <i class="fa-solid fa-volume-low text-amber-700 text-xl"></i>
                                                <span class="text-[10px] text-amber-700 mt-1 font-bold">æ…¢é€Ÿ</span>
                                            </button>
                                            <button onclick="event.stopPropagation(); speakNormal()" 
                                                class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-xl hover:shadow-2xl" 
                                                title="æ­£å¸¸é€Ÿåº¦æ’­æ”¾">
                                                <i class="fa-solid fa-volume-high text-white text-3xl"></i>
                                            </button>
                                            <button onclick="event.stopPropagation(); speakWord()" 
                                                class="w-16 h-16 bg-green-100 border-2 border-green-400 rounded-full flex flex-col items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-lg hover:shadow-xl" 
                                                title="é‡è¤‡æ’­æ”¾ï¼ˆæ…¢é€Ÿ+æ­£å¸¸ï¼‰">
                                                <i class="fa-solid fa-repeat text-green-700 text-xl"></i>
                                                <span class="text-[10px] text-green-700 mt-1 font-bold">é‡è¤‡</span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- åº•éƒ¨æç¤º -->
                                    <div class="text-center mt-4">
                                        <p class="text-gray-600 text-sm flex items-center justify-center gap-2 font-medium">
                                            <i class="fa-solid fa-hand-pointer animate-bounce text-indigo-500"></i>
                                            é»æ“Šå¡ç‰‡æŸ¥çœ‹ä¸­æ–‡æ„æ€å’Œä¾‹å¥
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- èƒŒé¢ -->
                                <div class="flashcard-face flashcard-back absolute w-full h-full glass-card rounded-3xl flex flex-col p-6 md:p-8 glow-green">
                                    <!-- ä¸­æ–‡æ„æ€ - æ›´çªå‡º -->
                                    <div class="text-center mb-6">
                                        <h3 id="card-mean" class="text-4xl md:text-5xl font-black text-green-600 mb-2"></h3>
                                        <p id="card-notes" class="text-sm text-amber-700 font-semibold mt-2"></p>
                                    </div>
                                    
                                    <!-- ä¾‹å¥å€åŸŸ - æ›´æ¸…æ™°çš„å¸ƒå±€ -->
                                    <div class="flex-1 flex flex-col justify-center">
                                        <div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 rounded-2xl p-5 md:p-6 w-full border-2 border-indigo-200 shadow-lg">
                                            <div class="flex items-center justify-between mb-4">
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-quote-left text-indigo-500 text-lg"></i>
                                                    <p class="text-sm text-gray-700 font-bold">ä¾‹å¥</p>
                                                </div>
                                                <button onclick="event.stopPropagation(); speakExample()" 
                                                    class="px-4 py-2 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-sm font-bold hover:from-indigo-600 hover:to-purple-600 transition shadow-md hover:shadow-lg active:scale-95" 
                                                    title="æ’­æ”¾ä¾‹å¥">
                                                    <i class="fa-solid fa-volume-high mr-2"></i>æ’­æ”¾ä¾‹å¥
                                                </button>
                                            </div>
                                            
                                            <!-- æ—¥æ–‡ä¾‹å¥ - æ›´å¤§æ›´æ¸…æ™° -->
                                            <div class="mb-4">
                                                <p id="card-example" class="text-xl md:text-2xl text-gray-900 font-bold text-center leading-relaxed mb-3"></p>
                                            </div>
                                            
                                            <!-- ä¸­æ–‡ç¿»è­¯ - åˆ†éš”ç·š -->
                                            <div class="border-t-2 border-indigo-200 pt-4">
                                                <p id="card-trans" class="text-base md:text-lg text-gray-700 text-center font-semibold leading-relaxed"></p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- åº•éƒ¨æç¤º -->
                                    <div class="text-center mt-4">
                                        <p class="text-gray-600 text-sm flex items-center justify-center gap-2 font-medium">
                                            <i class="fa-solid fa-hand-pointer animate-bounce text-green-500"></i>
                                            é»æ“Šå¡ç‰‡è¿”å›æ­£é¢
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- é–ƒå¡æ§åˆ¶æŒ‰éˆ• - æ›´å¤§æ›´æ¸…æ¥š -->
                        <div class="mt-8 text-center text-gray-600 text-sm mb-3 font-semibold">
                            <i class="fa-solid fa-lightbulb text-yellow-500 mr-1"></i>
                            ç¿»è½‰å¡ç‰‡å¾Œï¼Œé¸æ“‡ä½ å°é€™å€‹å–®å­—çš„ç†Ÿæ‚‰ç¨‹åº¦ï¼š
                        </div>
                        <div class="flex justify-center gap-3 md:gap-4">
                            <button onclick="rateCard('hard')" class="flex-1 max-w-[160px] py-4 md:py-5 rounded-2xl bg-red-50 border-2 border-red-300 text-red-600 font-bold hover:bg-red-100 hover:scale-105 transition text-base md:text-lg shadow-md hover:shadow-lg">
                                <i class="fa-solid fa-rotate-right mr-2"></i>å†å­¸ä¸€æ¬¡
                            </button>
                            <button onclick="rateCard('good')" class="flex-1 max-w-[160px] py-4 md:py-5 rounded-2xl bg-yellow-50 border-2 border-yellow-300 text-yellow-600 font-bold hover:bg-yellow-100 hover:scale-105 transition text-base md:text-lg shadow-md hover:shadow-lg">
                                <i class="fa-solid fa-check mr-2"></i>æœ‰å°è±¡
                            </button>
                            <button onclick="rateCard('easy')" class="flex-1 max-w-[160px] py-4 md:py-5 rounded-2xl bg-green-50 border-2 border-green-300 text-green-600 font-bold hover:bg-green-100 hover:scale-105 transition text-base md:text-lg shadow-md hover:shadow-lg">
                                <i class="fa-solid fa-star mr-2"></i>å¾ˆç†Ÿæ‚‰
                            </button>
                        </div>
                    </div>

                    <!-- é¸æ“‡é¡Œæ¨¡å¼ -->
                    <div id="view-quiz" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-6 md:p-10 animate-slide">
                            <div class="text-center mb-8">
                                <div class="inline-flex items-center gap-2 bg-blue-100 border-2 border-blue-300 px-5 py-2 rounded-full text-sm font-bold text-blue-700 mb-6 shadow-sm">
                                    <i class="fa-solid fa-circle-question text-lg"></i>é¸æ“‡é¡Œæ¸¬é©—
                                </div>
                                <p class="text-gray-700 mb-6 text-lg font-semibold">é€™å€‹æ—¥æ–‡è©å½™æ˜¯ä»€éº¼æ„æ€ï¼Ÿ</p>
                                
                                <!-- å–®å­—é¡¯ç¤ºå€åŸŸ - æ›´å¤§æ›´çªå‡º -->
                                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6 md:p-8 mb-6 border-2 border-indigo-200 shadow-lg">
                                    <h2 id="quiz-word" class="text-5xl md:text-6xl font-black mb-3 text-gray-900"></h2>
                                    <p id="quiz-kana" class="text-2xl md:text-3xl font-bold text-indigo-600 mb-2"></p>
                                    <p id="quiz-romaji" class="text-base text-gray-600 font-semibold"></p>
                                </div>
                                
                                <!-- èªéŸ³æŒ‰éˆ•çµ„ - æ›´å¤§æ›´æ˜é¡¯ -->
                                <div class="flex items-center justify-center gap-4 mb-6">
                                    <button onclick="speakSlow()" 
                                        class="w-16 h-16 bg-amber-100 border-2 border-amber-400 rounded-full flex flex-col items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-lg">
                                        <i class="fa-solid fa-volume-low text-amber-700 text-xl"></i>
                                        <span class="text-[10px] text-amber-700 mt-1 font-bold">æ…¢é€Ÿ</span>
                                    </button>
                                    <button onclick="speakNormal()" 
                                        class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-xl">
                                        <i class="fa-solid fa-volume-high text-white text-3xl"></i>
                                    </button>
                                    <button onclick="speakWord()" 
                                        class="w-16 h-16 bg-green-100 border-2 border-green-400 rounded-full flex flex-col items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-lg">
                                        <i class="fa-solid fa-repeat text-green-700 text-xl"></i>
                                        <span class="text-[10px] text-green-700 mt-1 font-bold">é‡è¤‡</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- æç¤ºå€åŸŸ -->
                            <div class="flex items-center justify-center gap-4 mb-6">
                                <p class="text-gray-600 text-sm font-semibold">
                                    <i class="fa-solid fa-hand-pointer mr-1 text-indigo-500"></i>é»é¸ä¸‹æ–¹æ­£ç¢ºç­”æ¡ˆ
                                </p>
                                <button onclick="showQuizHint()" id="quiz-hint-btn" 
                                    class="px-4 py-2 rounded-full bg-amber-100 border-2 border-amber-300 text-amber-700 hover:bg-amber-200 transition shadow-md font-bold text-sm">
                                    <i class="fa-solid fa-lightbulb mr-1"></i>æç¤º
                                </button>
                            </div>
                            
                            <div id="quiz-hint" class="hidden text-center text-sm text-amber-800 mb-6 p-4 bg-amber-50 border-2 border-amber-200 rounded-xl shadow-md font-semibold">
                                <!-- æç¤ºå…§å®¹ -->
                            </div>
                            
                            <!-- é¸é …å€åŸŸ - æ›´å¤§æ›´æ¸…æ™° -->
                            <div id="quiz-options" class="space-y-4 max-w-3xl mx-auto mb-6">
                                <!-- é¸é …å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                            
                            <!-- å›é¥‹å€åŸŸ -->
                            <div id="quiz-feedback" class="hidden mt-6 p-6 rounded-2xl text-center text-xl font-bold shadow-lg">
                                <!-- å›é¥‹ -->
                            </div>
                        </div>
                    </div>

                    <!-- æ‹¼å¯«æ¨¡å¼ -->
                    <div id="view-typing" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-6 md:p-10 animate-slide">
                            <div class="text-center mb-8">
                                <div class="inline-flex items-center gap-2 bg-purple-100 border-2 border-purple-300 px-5 py-2 rounded-full text-sm font-bold text-purple-700 mb-6 shadow-sm">
                                    <i class="fa-solid fa-keyboard text-lg"></i>æ‹¼å¯«ç·´ç¿’
                                </div>
                                <p class="text-gray-700 mb-6 text-lg font-semibold">è«‹è¼¸å…¥å°æ‡‰çš„å‡åæˆ–æ—¥æ–‡è©å½™</p>
                                
                                <!-- æç¤ºå€åŸŸ - æ›´å¤§æ›´æ¸…æ™° -->
                                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-6 md:p-8 mb-6 border-2 border-purple-200 shadow-lg">
                                    <h2 id="typing-hint" class="text-4xl md:text-5xl font-black text-gray-900 mb-3"></h2>
                                    <p id="typing-pos" class="text-lg text-gray-600 font-semibold"></p>
                                    <p class="text-sm text-gray-500 mt-2 font-medium">è«‹è¼¸å…¥å°æ‡‰çš„æ—¥æ–‡å–®å­—ã€å‡åæˆ–ç¾…é¦¬éŸ³</p>
                                </div>
                            </div>

                            <!-- èªéŸ³æŒ‰éˆ•çµ„ - æ›´å¤§ -->
                            <div class="flex justify-center gap-4 mb-8">
                                <button onclick="speakSlow()" 
                                    class="w-16 h-16 bg-amber-100 border-2 border-amber-400 rounded-full flex flex-col items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-lg"
                                    title="æ…¢é€Ÿæ’­æ”¾">
                                    <i class="fa-solid fa-volume-low text-amber-700 text-xl"></i>
                                    <span class="text-[10px] text-amber-700 mt-1 font-bold">æ…¢é€Ÿ</span>
                                </button>
                                <button onclick="speakNormal()" 
                                    class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-xl"
                                    title="æ­£å¸¸é€Ÿåº¦">
                                    <i class="fa-solid fa-volume-high text-white text-3xl"></i>
                                </button>
                                <button onclick="speakWord()" 
                                    class="w-16 h-16 bg-green-100 border-2 border-green-400 rounded-full flex flex-col items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-lg"
                                    title="é‡è¤‡æ’­æ”¾">
                                    <i class="fa-solid fa-repeat text-green-700 text-xl"></i>
                                    <span class="text-[10px] text-green-700 mt-1 font-bold">é‡è¤‡</span>
                                </button>
                            </div>

                            <!-- è¼¸å…¥å€åŸŸ (æ‰“å­— + èªéŸ³) - æ›´å¤§æ›´æ˜é¡¯ -->
                            <div class="relative max-w-2xl mx-auto mb-4">
                                <input type="text" id="typing-input" 
                                    class="typing-input w-full py-4 pr-16 text-2xl"
                                    placeholder="è¼¸å…¥æˆ–èªªå‡ºæ—¥æ–‡ï¼å‡å..."
                                    autocomplete="off"
                                    onkeypress="if(event.key==='Enter') checkTyping()">
                                <!-- èªéŸ³è¼¸å…¥æŒ‰éˆ• -->
                                <button onclick="startVoiceInput('typing-input')" id="typing-mic-btn"
                                    class="absolute right-2 top-1/2 -translate-y-1/2 w-14 h-14 bg-gradient-to-br from-red-500 to-pink-500 rounded-full flex items-center justify-center hover:scale-110 active:scale-95 transition shadow-xl text-white"
                                    title="é»æ“Šèªªå‡ºç­”æ¡ˆ">
                                    <i class="fa-solid fa-microphone text-2xl"></i>
                                </button>
                            </div>
                            
                            <p class="text-center text-gray-600 text-sm mt-3 font-semibold">
                                <i class="fa-solid fa-microphone mr-1 text-red-500"></i>é»æ“Šéº¥å…‹é¢¨å¯ä»¥ç”¨èªªçš„
                            </p>

                            <!-- å›é¥‹å€åŸŸ -->
                            <div id="typing-feedback" class="hidden mt-6 p-6 rounded-2xl text-center text-xl font-bold shadow-lg"></div>

                            <!-- èªéŸ³è¾¨è­˜ç‹€æ…‹ -->
                            <div id="voice-status" class="hidden mt-4 text-center">
                                <div class="inline-flex items-center gap-2 bg-red-50 border-2 border-red-300 text-red-700 px-5 py-3 rounded-full shadow-md font-bold">
                                    <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                                    <span>æ­£åœ¨è†è½...</span>
                                </div>
                            </div>

                            <button onclick="checkTyping()" class="btn-primary w-full max-w-2xl mx-auto block mt-8 py-5 rounded-xl font-bold text-xl shadow-xl hover:shadow-2xl">
                                <i class="fa-solid fa-check mr-2"></i>ç¢ºèªç­”æ¡ˆ
                            </button>
                        </div>
                    </div>

                    <!-- è½åŠ›æ¨¡å¼ -->
                    <div id="view-listening" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-6 md:p-10 animate-slide">
                            <div class="text-center mb-8">
                                <div class="inline-flex items-center gap-2 bg-cyan-100 border-2 border-cyan-300 px-5 py-2 rounded-full text-sm font-bold text-cyan-700 mb-6 shadow-sm">
                                    <i class="fa-solid fa-headphones text-lg"></i>è½åŠ›è¨“ç·´
                                </div>
                                <p class="text-gray-700 mb-6 text-lg font-semibold">ä»”ç´°è†è½ï¼Œé¸å‡ºä½ è½åˆ°çš„å–®å­—</p>
                                
                                <!-- æ’­æ”¾æŒ‰éˆ•çµ„ - æ›´å¤§æ›´çªå‡º -->
                                <div class="flex items-center justify-center gap-5 mb-6">
                                    <!-- æ…¢é€Ÿæ’­æ”¾ -->
                                    <button onclick="replayListeningSlow()" 
                                        class="w-18 h-18 bg-amber-100 border-2 border-amber-400 rounded-full flex flex-col items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-lg"
                                        title="è¶…æ…¢é€Ÿæ’­æ”¾ï¼ˆ0.4å€é€Ÿï¼‰">
                                        <i class="fa-solid fa-volume-low text-amber-700 text-2xl"></i>
                                        <span class="text-[10px] text-amber-700 mt-1 font-bold">æ…¢é€Ÿ</span>
                                    </button>
                                    
                                    <!-- ä¸»æ’­æ”¾æŒ‰éˆ• -->
                                    <button onclick="playListeningWord()" 
                                        class="w-28 h-28 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex flex-col items-center justify-center glow-blue hover:scale-110 active:scale-95 transition-all shadow-2xl text-white">
                                        <i class="fa-solid fa-play text-5xl mb-1"></i>
                                        <span class="text-sm font-bold">æ’­æ”¾</span>
                                    </button>
                                    
                                    <!-- é‡è¤‡æ’­æ”¾ -->
                                    <button onclick="playListeningWord(); setTimeout(playListeningWord, 1500);" 
                                        class="w-18 h-18 bg-green-100 border-2 border-green-400 rounded-full flex flex-col items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-lg"
                                        title="æ’­æ”¾å…©æ¬¡">
                                        <i class="fa-solid fa-repeat text-green-700 text-2xl"></i>
                                        <span class="text-[10px] text-green-700 mt-1 font-bold">é‡è¤‡</span>
                                    </button>
                                </div>

                                <!-- éŸ³æ³¢å‹•ç•« -->
                                <div class="sound-wave justify-center mt-6 mb-4 hidden" id="sound-waves">
                                    <span></span><span></span><span></span><span></span><span></span>
                                </div>
                                
                                <p class="text-gray-600 text-sm mt-4 font-semibold">
                                    <i class="fa-solid fa-lightbulb text-yellow-500 mr-1"></i>
                                    è½ä¸æ¸…æ¥šï¼Ÿé»ã€Œæ…¢é€Ÿã€æŒ‰éˆ•
                                </p>
                            </div>

                            <!-- é¸é …å€åŸŸ - æ›´å¤§æ›´æ¸…æ™° -->
                            <div id="listening-options" class="grid grid-cols-2 gap-5 max-w-3xl mx-auto mb-6">
                                <!-- é¸é … -->
                            </div>

                            <!-- å›é¥‹å€åŸŸ -->
                            <div id="listening-feedback" class="hidden mt-6 p-6 rounded-2xl text-center text-xl font-bold shadow-lg"></div>
                        </div>
                    </div>

                    <!-- æ–‡æ³•æ¨¡å¼ -->
                    <div id="view-grammar" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-6 md:p-10 animate-slide">
                            <!-- æ–‡æ³•æ¦‚å¿µå€åŸŸ -->
                            <div class="mb-8">
                                <div class="inline-flex items-center gap-2 bg-amber-100 border-2 border-amber-300 px-5 py-2 rounded-full text-sm font-bold text-amber-700 mb-6 shadow-sm">
                                    <i class="fa-solid fa-lightbulb text-lg"></i> æ–‡æ³•é‡é»
                                </div>
                                
                                <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl p-6 md:p-8 mb-6 border-2 border-amber-200 shadow-lg">
                                    <h3 id="grammar-concept" class="text-3xl md:text-4xl font-black text-gray-900 mb-4"></h3>
                                    <p id="grammar-explanation" class="text-lg text-gray-700 font-semibold leading-relaxed"></p>
                                </div>
                                
                                <!-- ä¾‹å¥å€åŸŸ -->
                                <div id="grammar-examples" class="mt-6 space-y-4 hidden">
                                    <!-- ä¾‹å¥æ¸…å–® -->
                                </div>
                            </div>

                            <!-- æ–‡æ³•é¡Œç›®å€åŸŸ -->
                            <div id="grammar-quiz" class="space-y-6">
                                <!-- æ–‡æ³•é¡Œç›® -->
                            </div>
                        </div>
                    </div>

                    <!-- AI å°è©±æ¨¡å¼ -->
            <div id="view-chat" class="view-section hidden h-full flex flex-col">
                        <div class="glass-card rounded-3xl flex-1 flex flex-col overflow-hidden">
                            <!-- å°è©±æƒ…å¢ƒ -->
                            <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-pink-100 to-purple-100">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-purple-500 rounded-full flex items-center justify-center text-white shadow-md">
                                        <i class="fa-solid fa-user-tie text-xl"></i>
                </div>
                                    <div>
                                        <h3 id="chat-scenario" class="font-bold text-gray-900">æƒ…å¢ƒå°è©±</h3>
                                        <p class="text-xs text-gray-700 font-semibold">AI æ—¥èªæ•™ç·´</p>
            </div>
                                </div>
                            </div>

                            <!-- å°è©±å€ -->
                            <div id="chat-messages" class="flex-1 overflow-y-auto hide-scrollbar p-4 space-y-4">
                                <!-- è¨Šæ¯ -->
                            </div>

                            <!-- è¼¸å…¥å€ -->
                            <div class="p-4 border-t border-gray-200 bg-gray-50">
                                <div class="flex gap-2">
                                    <!-- èªéŸ³è¼¸å…¥æŒ‰éˆ• -->
                                    <button onclick="startVoiceInput('chat-input')" id="chat-mic-btn"
                                        class="mic-btn-enhanced w-12 h-12 bg-gradient-to-br from-red-500 to-pink-500 rounded-full flex items-center justify-center hover:scale-110 transition shrink-0 text-white shadow-lg"
                                        title="é»æ“Šé–‹å§‹èªªæ—¥æ–‡ï¼ˆèªªå®Œæœƒè‡ªå‹•åœæ­¢ä¸¦ç™¼é€ï¼‰">
                                        <i class="fa-solid fa-microphone text-lg"></i>
                                    </button>
                                    <input type="text" id="chat-input" 
                                        class="flex-1 bg-white border-2 border-gray-300 rounded-full px-5 py-3 focus:border-indigo-500 focus:outline-none focus:ring-4 focus:ring-indigo-200 transition text-base text-gray-800 shadow-sm"
                                        placeholder="èªªæ—¥æ–‡æˆ–ä¸­æ–‡ï¼ŒAI æœƒæ•™ä½ ..."
                                        onkeypress="if(event.key==='Enter') sendChat()">
                                    <button onclick="sendChat()" class="w-12 h-12 bg-gradient-to-r from-pink-500 to-purple-500 rounded-full flex items-center justify-center hover:opacity-90 hover:scale-105 transition shrink-0 text-white shadow-lg" title="ç™¼é€">
                                        <i class="fa-solid fa-paper-plane"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-600 mt-2 text-center font-medium">
                                    <i class="fa-solid fa-microphone text-red-500 mr-1"></i>é»éº¥å…‹é¢¨ç”¨èªªçš„ Â· 
                                    <i class="fa-solid fa-keyboard text-indigo-500 mr-1"></i>æˆ–ç›´æ¥æ‰“å­—ï¼ˆæ—¥æ–‡/ä¸­æ–‡çš†å¯ï¼‰
                                </p>
                                <!-- èªéŸ³è¾¨è­˜ç‹€æ…‹ -->
                                <div id="chat-voice-status" class="hidden mt-3 text-center">
                                    <div class="voice-hint">
                                        <span class="dot"></span>
                                        <span>æ­£åœ¨è†è½æ—¥æ–‡...</span>
                                        <!-- å³æ™‚éŸ³é‡æŒ‡ç¤ºå™¨ -->
                                        <div id="chat-volume-indicator" class="volume-indicator">
                                            <div class="volume-bar"></div>
                                            <div class="volume-bar"></div>
                                            <div class="volume-bar"></div>
                                            <div class="volume-bar"></div>
                                            <div class="volume-bar"></div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-2 font-medium">ğŸ’¡ èªªå®Œå¾Œæœƒè‡ªå‹•çµæŸè­˜åˆ¥ä¸¦ç™¼é€</p>
                                </div>
                            </div>
                        </div>
                    </div>

        </div>
    </main>
        </div>
    </div>

    <!-- çµ±è¨ˆ Modal -->
    <div id="stats-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto hide-scrollbar animate-slide">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-900">ğŸ“Š å­¸ç¿’çµ±è¨ˆ</h2>
                <button onclick="closeStats()" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-gray-600 transition shadow-sm">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-fire text-3xl text-orange-500 mb-2"></i>
                    <div class="text-2xl font-bold text-gray-900" id="stat-streak">0</div>
                    <div class="text-xs text-gray-700 font-bold">é€£çºŒå¤©æ•¸</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-star text-3xl text-yellow-500 mb-2"></i>
                    <div class="text-2xl font-bold text-gray-900" id="stat-xp">0</div>
                    <div class="text-xs text-gray-700 font-bold">ç¸½ XP</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-book text-3xl text-green-500 mb-2"></i>
                    <div class="text-2xl font-bold text-gray-900" id="stat-words">0</div>
                    <div class="text-xs text-gray-700 font-bold">å·²å­¸å–®å­—</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-bullseye text-3xl text-blue-500 mb-2"></i>
                    <div class="text-2xl font-bold text-gray-900" id="stat-accuracy">0%</div>
                    <div class="text-xs text-gray-700 font-bold">æ­£ç¢ºç‡</div>
                </div>
            </div>

            <!-- å·²å­¸å–®å­—åˆ—è¡¨ -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-sm text-gray-600">
                        <i class="fa-solid fa-list mr-1"></i> å·²å­¸å–®å­—è¨˜éŒ„
                    </h3>
                    <button onclick="toggleLearnedWords()" class="text-xs text-indigo-600 hover:text-indigo-700 font-semibold">
                        <span id="toggle-words-text">å±•é–‹</span> <i class="fa-solid fa-chevron-down" id="toggle-words-icon"></i>
                    </button>
                </div>
                <div id="learned-words-list" class="hidden bg-gray-50 border border-gray-200 rounded-xl p-4 max-h-48 overflow-y-auto hide-scrollbar shadow-sm">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <div class="space-y-2">
                <button onclick="clearLearnedHistory()" class="w-full py-3 rounded-xl bg-amber-50 border-2 border-amber-300 text-amber-700 font-bold hover:bg-amber-100 transition shadow-md">
                    <i class="fa-solid fa-eraser mr-2"></i>æ¸…é™¤å­¸ç¿’è¨˜éŒ„ï¼ˆå¯é‡æ–°å­¸ç¿’ï¼‰
                </button>
                <button onclick="resetAllData()" class="w-full py-3 rounded-xl bg-red-50 border-2 border-red-300 text-red-700 font-bold hover:bg-red-100 transition shadow-md">
                    <i class="fa-solid fa-trash-can mr-2"></i>é‡ç½®æ‰€æœ‰æ•¸æ“š
                </button>
            </div>
        </div>
    </div>

    <!-- å®Œæˆå‹•ç•« Modal -->
    <div id="complete-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="text-center animate-slide glass-card rounded-3xl p-8 max-w-md">
            <div class="text-8xl mb-4">ğŸ‰</div>
            <h2 class="text-3xl font-black mb-2 text-gray-900">å¤ªæ£’äº†ï¼</h2>
            <p class="text-gray-700 mb-4 font-semibold">ä½ å®Œæˆäº†é€™ä¸€è¼ªå­¸ç¿’</p>
            <div class="text-5xl font-black text-green-600 mb-4">+<span id="earned-xp">50</span> XP</div>
            
            <!-- æœ¬è¼ªçµ±è¨ˆ -->
            <div class="grid grid-cols-3 gap-3 mb-6 text-center">
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 shadow-sm">
                    <div class="text-2xl font-bold text-blue-600" id="round-total">5</div>
                    <div class="text-xs text-gray-600 font-semibold">å­¸ç¿’æ•¸é‡</div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-xl p-3 shadow-sm">
                    <div class="text-2xl font-bold text-green-600" id="round-correct">0</div>
                    <div class="text-xs text-gray-600 font-semibold">ç­”å°æ•¸</div>
                </div>
                <div class="bg-amber-50 border border-amber-200 rounded-xl p-3 shadow-sm">
                    <div class="text-2xl font-bold text-amber-600" id="round-accuracy">0%</div>
                    <div class="text-xs text-gray-600 font-semibold">æ­£ç¢ºç‡</div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="reviewMistakes()" class="flex-1 py-3 rounded-xl bg-amber-50 border-2 border-amber-300 text-amber-700 font-bold hover:bg-amber-100 transition shadow-md">
                    <i class="fa-solid fa-rotate-left mr-2"></i>è¤‡ç¿’éŒ¯é¡Œ
                </button>
                <button onclick="continuelearning()" class="flex-1 btn-primary py-3 rounded-xl font-bold">
                    ç¹¼çºŒå­¸ç¿’ <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- éŸ³æ•ˆ -->
    <audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>
    <audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/2001/2001-preview.mp3" preload="auto"></audio>

    <script>
        // ===== å…¨åŸŸç‹€æ…‹ =====
        const APP_STATE = {
            currentMode: 'flashcard',
            currentTopic: 'Daily life Japanese vocabulary',  // é è¨­ä¸»é¡Œ
            currentIndex: 0,
            words: [],
            historyData: [],
            grammarHistory: [],
            isFlipped: false,
            isAnswered: false,
            totalCorrect: 0,
            totalAnswered: 0,
            roundCorrect: 0,      // æœ¬è¼ªæ­£ç¢ºæ•¸
            roundTotal: 0,        // æœ¬è¼ªç¸½é¡Œæ•¸
            mistakes: [],         // éŒ¯èª¤é¡Œç›®
            favorites: []         // æ”¶è—çš„å–®å­—
        };

        // ä¸»é¡Œè¨­å®š - label é¡¯ç¤ºä¸­æ–‡, value å‚³çµ¦ API
        // å®Œæ•´ç‰ˆ - æ¶µè“‹æ—¥æœ¬ç”Ÿæ´»æ‰€æœ‰å ´æ™¯
        const TOPICS = {
            flashcard: [
                // === åŸºç¤å…¥é–€ ===
                { label: 'ã‚›ã‚œ æ‹—éŸ³ãƒ»æ¿éŸ³å¼·åŒ–', value: 'Youon and dakuten practice for kana' },
                { label: 'ğŸ”¢ æ•¸å­—èˆ‡è¨ˆæ•¸', value: 'Numbers, counting, and counters in Japanese' },
                { label: 'ğŸ“… æ™‚é–“æ—¥æœŸ', value: 'Time, dates, days of week in Japanese' },
                { label: 'ğŸ™Œ åŸºæœ¬å•å€™', value: 'Greetings and self introduction in Japanese' },
                { label: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äººç¨±è¬‚', value: 'Family members and relationships in Japanese' },
                // === æ—¥å¸¸ç”Ÿæ´» ===
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily life Japanese vocabulary' },
                { label: 'ğŸ³ å®¶äº‹æ–™ç†', value: 'Housework and cooking vocabulary' },
                { label: 'ğŸ‘• è¡£ç‰©ç©¿æ­', value: 'Clothes and fashion vocabulary' },
                { label: 'ğŸ›‹ï¸ å®¶å…·é›»å™¨', value: 'Furniture and home appliances' },
                { label: 'ğŸŒ¤ï¸ å¤©æ°£å­£ç¯€', value: 'Weather and seasons vocabulary' },
                // === å¤–å‡ºç”¨é¤ ===
                { label: 'ğŸ£ é¤å»³é»é¤', value: 'Ordering food and drinks in Japanese' },
                { label: 'ğŸœ æ‹‰éºµå£½å¸å°ˆé–€', value: 'Ramen and sushi restaurant vocabulary' },
                { label: 'ğŸº å±…é…’å±‹ç”¨èª', value: 'Izakaya bar vocabulary and phrases' },
                { label: 'â˜• å’–å•¡å»³ç”œé»', value: 'Cafe and dessert vocabulary' },
                { label: 'ğŸª ä¾¿åˆ©å•†åº—', value: 'Convenience store vocabulary' },
                // === äº¤é€šå‡ºè¡Œ ===
                { label: 'âœˆï¸ æ—…éŠå‡ºè¡Œ', value: 'Travel Japanese for tourists' },
                { label: 'ğŸ›¤ï¸ äº¤é€šè»Šç«™', value: 'Train station and transport phrases' },
                { label: 'ğŸšŒ å•è·¯ç§»å‹•', value: 'Asking directions and transportation' },
                { label: 'ğŸš• è¨ˆç¨‹è»Šå«è»Š', value: 'Taxi and ride-hailing vocabulary' },
                { label: 'âœˆï¸ æ©Ÿå ´æµ·é—œ', value: 'Airport and customs vocabulary' },
                // === è³¼ç‰©æ¶ˆè²» ===
                { label: 'ğŸ›ï¸ è³¼ç‰©çµå¸³', value: 'Shopping and payments in Japanese' },
                { label: 'ğŸ‘— æœé£¾åº—è©¦ç©¿', value: 'Clothing store and trying on clothes' },
                { label: 'ğŸ’„ è—¥å¦åº—æ¡è³¼', value: 'Drugstore and cosmetics shopping' },
                { label: 'ğŸ® é›»å™¨3C', value: 'Electronics and tech shopping' },
                // === ä½å®¿ ===
                { label: 'ğŸ¨ è¨‚æˆ¿å…¥ä½', value: 'Hotel booking and check-in dialogues' },
                { label: 'ğŸ›ï¸ æ°‘å®¿Airbnb', value: 'Airbnb and guesthouse vocabulary' },
                { label: 'ğŸ  ç§Ÿå±‹ç°½ç´„', value: 'Apartment rental and contracts' },
                // === é†«ç™‚å¥åº· ===
                { label: 'ğŸ¥ é†«é™¢è—¥å±€', value: 'Doctor visit and pharmacy Japanese' },
                { label: 'ğŸ¦· ç‰™é†«çœ¼ç§‘', value: 'Dentist and eye doctor vocabulary' },
                { label: 'ğŸ’Š ç—‡ç‹€æè¿°', value: 'Describing symptoms and illness' },
                // === å·¥ä½œå•†å‹™ ===
                { label: 'ğŸ’¼ å•†å‹™æ•¬èªå…¥é–€', value: 'Basic business Japanese and keigo' },
                { label: 'ğŸ“ é›»è©±æ‡‰å°', value: 'Phone call etiquette and phrases' },
                { label: 'âœ‰ï¸ å•†å‹™éƒµä»¶', value: 'Business email vocabulary' },
                { label: 'ğŸ¤ æœƒè­°ç°¡å ±', value: 'Meeting and presentation vocabulary' },
                { label: 'ğŸ“ å®¢æœå®¢è¨´', value: 'Customer support and complaint handling' },
                { label: 'ğŸ‘©â€ğŸ’» IT/å·¥ç¨‹', value: 'IT and software development Japanese' },
                // === ç¤¾äº¤ç”Ÿæ´» ===
                { label: 'ğŸ‘¥ äº¤å‹èŠå¤©', value: 'Casual chats and slang with friends' },
                { label: 'ğŸ ç¦®ç¯€æ–‡åŒ–', value: 'Japanese etiquette and culture' },
                { label: 'ğŸ‰ æ´¾å°èšæœƒ', value: 'Party and social gathering vocabulary' },
                { label: 'ğŸ’• ç´„æœƒæˆ€æ„›', value: 'Dating and romance vocabulary' },
                // === å¨›æ¨‚ä¼‘é–’ ===
                { label: 'ğŸ¬ é›»å½±å‹•æ¼«', value: 'Movies and anime vocabulary' },
                { label: 'ğŸ® éŠæˆ²é›»ç«¶', value: 'Gaming and esports vocabulary' },
                { label: 'âš½ é‹å‹•å¥èº«', value: 'Sports and fitness vocabulary' },
                { label: 'ğŸµ éŸ³æ¨‚æ¼”å”±æœƒ', value: 'Music and concert vocabulary' },
                // === ç·Šæ€¥ç‹€æ³ ===
                { label: 'ğŸš¨ ç·Šæ€¥æ‡‰è®Š', value: 'Emergency and disaster phrases' },
                { label: 'ğŸ‘® è­¦å¯Ÿæ±‚åŠ©', value: 'Police and lost items vocabulary' },
                { label: 'ğŸ”¥ åœ°éœ‡é¿é›£', value: 'Earthquake and evacuation phrases' }
            ],
            quiz: [
                { label: 'ğŸ”¢ æ•¸å­—èˆ‡è¨ˆæ•¸', value: 'Numbers, counting, and counters in Japanese' },
                { label: 'ğŸ™Œ åŸºæœ¬å•å€™', value: 'Greetings and self introduction in Japanese' },
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily life Japanese vocabulary' },
                { label: 'âœˆï¸ æ—…éŠå‡ºè¡Œ', value: 'Travel Japanese for tourists' },
                { label: 'ğŸ£ é¤å»³é»é¤', value: 'Ordering food and drinks in Japanese' },
                { label: 'ğŸ›ï¸ è³¼ç‰©çµå¸³', value: 'Shopping and payments in Japanese' },
                { label: 'ğŸ’¼ å•†å‹™æ•¬èªå…¥é–€', value: 'Basic business Japanese and keigo' },
                { label: 'ğŸ“ é›»è©±æ‡‰å°', value: 'Phone call etiquette and phrases' },
                { label: 'ğŸ‘©â€ğŸ’» IT/å·¥ç¨‹', value: 'IT and software development Japanese' },
                { label: 'ğŸš¨ ç·Šæ€¥æ‡‰è®Š', value: 'Emergency and disaster phrases' },
                { label: 'ğŸ‘¥ äº¤å‹èŠå¤©', value: 'Casual chats and slang with friends' },
                { label: 'ğŸ’Š ç—‡ç‹€æè¿°', value: 'Describing symptoms and illness' }
            ],
            typing: [
                { label: 'ã‚›ã‚œ æ‹—éŸ³ãƒ»æ¿éŸ³å¼·åŒ–', value: 'Youon and dakuten practice for kana' },
                { label: 'ğŸ™Œ åŸºæœ¬å•å€™', value: 'Greetings and self introduction in Japanese' },
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily life Japanese vocabulary' },
                { label: 'ğŸ£ é¤å»³é»é¤', value: 'Ordering food and drinks in Japanese' },
                { label: 'ğŸ›¤ï¸ äº¤é€šè»Šç«™', value: 'Train station and transport phrases' },
                { label: 'ğŸ›ï¸ è³¼ç‰©çµå¸³', value: 'Shopping and payments in Japanese' },
                { label: 'ğŸ“ é›»è©±æ‡‰å°', value: 'Phone call etiquette and phrases' },
                { label: 'ğŸ‘¥ äº¤å‹èŠå¤©', value: 'Casual chats and slang with friends' },
                { label: 'ğŸ’Š ç—‡ç‹€æè¿°', value: 'Describing symptoms and illness' }
            ],
            listening: [
                { label: 'ğŸ™Œ åŸºæœ¬å•å€™', value: 'Greetings and self introduction in Japanese' },
                { label: 'ğŸ”¢ æ•¸å­—èˆ‡è¨ˆæ•¸', value: 'Numbers, counting, and counters in Japanese' },
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily life Japanese vocabulary' },
                { label: 'âœˆï¸ æ—…éŠå‡ºè¡Œ', value: 'Travel Japanese for tourists' },
                { label: 'ğŸ£ é¤å»³é»é¤', value: 'Ordering food and drinks in Japanese' },
                { label: 'ğŸ›¤ï¸ äº¤é€šè»Šç«™', value: 'Train station and transport phrases' },
                { label: 'ğŸš¨ ç·Šæ€¥æ‡‰è®Š', value: 'Emergency and disaster phrases' },
                { label: 'ğŸ“ é›»è©±æ‡‰å°', value: 'Phone call etiquette and phrases' },
                { label: 'ğŸ‘¥ äº¤å‹èŠå¤©', value: 'Casual chats and slang with friends' },
                { label: 'ğŸª ä¾¿åˆ©å•†åº—', value: 'Convenience store vocabulary' }
            ],
            grammar: [
                // === åŸºç¤æ–‡æ³• ===
                { label: 'ã¯ãƒ»ãŒ ä¸»é¡Œ vs ä¸»èª', value: 'Particles wa vs ga usage' },
                { label: 'ã‚’ï¼ã«ï¼ã§ çš„å·®åˆ¥', value: 'Particles wo ni de usage' },
                { label: 'ã¸ï¼ã‹ã‚‰ï¼ã¾ã§ æ–¹å‘', value: 'Direction particles he kara made' },
                { label: 'ã§ã™ãƒ»ã¾ã™é«”èˆ‡æ™®é€šå½¢', value: 'Polite vs plain forms' },
                // === å‹•è©è®ŠåŒ– ===
                { label: 'ã¦å½¢çš„é€£æ¥', value: 'Te-form connections' },
                { label: 'ãªã„å½¢å¦å®š', value: 'Negative nai form' },
                { label: 'ãŸå½¢èˆ‡éå»å¼', value: 'Ta form and past tense' },
                { label: 'å¯èƒ½å½¢è¡¨èƒ½åŠ›', value: 'Potential form' },
                { label: 'æ„å‘å½¢è¡¨æ„é¡˜', value: 'Volitional form expressing intention' },
                { label: 'å‘½ä»¤å½¢èˆ‡ç¦æ­¢å½¢', value: 'Imperative and prohibitive forms' },
                { label: 'å—èº«å½¢ï¼ˆè¢«å‹•ï¼‰', value: 'Passive form in Japanese' },
                { label: 'ä½¿å½¹å½¢ï¼ˆè®“...åšï¼‰', value: 'Causative form in Japanese' },
                // === è¡¨é”å¥å‹ ===
                { label: 'ã€œãŸã„ï¼ã€œãŸããªã„', value: 'Expressing desire tai form' },
                { label: 'ã€œã¦ã»ã—ã„ å¸Œæœ›åˆ¥äººåš', value: 'Wanting someone to do something' },
                { label: 'ã€œã¦ã„ã‚‹ é€²è¡Œèˆ‡ç‹€æ…‹', value: 'Te-iru progressive and state' },
                { label: 'ã€œã¦ã‚ã‚‹ çµæœç‹€æ…‹', value: 'Te-aru resultative state' },
                { label: 'ã€œã¦ãŠã äº‹å…ˆæº–å‚™', value: 'Te-oku preparation' },
                { label: 'ã€œã¦ã¿ã‚‹ å˜—è©¦åš', value: 'Te-miru trying to do' },
                { label: 'ã€œã¦ã—ã¾ã† å®Œæˆ/éºæ†¾', value: 'Te-shimau completion or regret' },
                // === åŸå› èˆ‡å‡è¨­ ===
                { label: 'åŸå›  ã‹ã‚‰ï¼ã®ã§', value: 'Giving reasons with kara/no de' },
                { label: 'ã‚‚ã—ã€œãŸã‚‰ï¼ãªã‚‰ å‡è¨­', value: 'Conditional patterns in Japanese' },
                { label: 'ã€œã°å‡å®šå½¢', value: 'Ba conditional form' },
                { label: 'ã€œã¨è‡ªç„¶æ¢ä»¶', value: 'To conditional for natural results' },
                // === è¨±å¯èˆ‡ç¾©å‹™ ===
                { label: 'ã€œã¦ã‚‚ã„ã„ï¼ã€œã¦ã¯ã„ã‘ãªã„', value: 'Permission and prohibition' },
                { label: 'ã€œãªã‘ã‚Œã°ãªã‚‰ãªã„ ç¾©å‹™', value: 'Expressing obligation must do' },
                { label: 'ã€œãªãã¦ã‚‚ã„ã„ ä¸å¿…', value: 'Not necessary to do' },
                // === æ•¬èªç³»çµ± ===
                { label: 'æ•¬èªå…¥é–€', value: 'Keigo basics for beginners' },
                { label: 'å°Šæ•¬èªï¼ˆç›¸æ‰‹ã‚’ä¸Šã’ã‚‹ï¼‰', value: 'Sonkeigo honorific language' },
                { label: 'è¬™è­²èªï¼ˆè‡ªåˆ†ã‚’ä¸‹ã’ã‚‹ï¼‰', value: 'Kenjougo humble language' },
                { label: 'ã‚¯ãƒƒã‚·ãƒ§ãƒ³è¨€è‘‰', value: 'Softening phrases for politeness' },
                { label: 'é›»è©±æ‡‰å°å¸¸ç”¨å¥', value: 'Phone call keigo patterns' },
                // === é€²éšè¡¨é” ===
                { label: 'ã€œãã†ï¼ã€œã‚ˆã† æ¨æ¸¬', value: 'Expressing conjecture sou you' },
                { label: 'ã€œã‚‰ã—ã„ å‚³è', value: 'Hearsay rashii' },
                { label: 'ã€œã‚ˆã†ã«ã™ã‚‹ åŠªåŠ›', value: 'Making effort to do' },
                { label: 'ã€œã“ã¨ã«ã™ã‚‹ æ±ºå®š', value: 'Deciding to do' }
            ],
            chat: [
                // === ğŸ½ï¸ é¤é£²ç¾é£Ÿ ===
                { label: 'â˜• å’–å•¡å»³é»é¤', value: 'Japanese Coffee Shop' },
                { label: 'ğŸœ æ‹‰éºµåº—ç”¨é¤', value: 'Ramen shop' },
                { label: 'ğŸ£ å£½å¸åº—äº’å‹•', value: 'Sushi restaurant' },
                { label: 'ğŸº å±…é…’å±‹èŠå¤©', value: 'Izakaya small talk' },
                { label: 'ğŸª ä¾¿åˆ©å•†åº—', value: 'Convenience store in Japan' },
                { label: 'ğŸ” é€Ÿé£Ÿåº—é»é¤', value: 'Fast food restaurant order' },
                { label: 'ğŸ° ç”œé»è›‹ç³•åº—', value: 'Dessert and cake shop' },
                // === ğŸšƒ äº¤é€šå‡ºè¡Œ ===
                { label: 'ğŸ›¤ï¸ è»Šç«™è³¼ç¥¨', value: 'Train station ticket' },
                { label: 'ğŸ—ºï¸ å•è·¯èˆ‡æ–¹å‘', value: 'Asking for directions in Japanese' },
                { label: 'ğŸš• æ­è¨ˆç¨‹è»Š', value: 'Taking a taxi in Japan' },
                { label: 'ğŸšŒ æ­å…¬è»Š', value: 'Taking a bus in Japan' },
                { label: 'âœˆï¸ æ©Ÿå ´å ±åˆ°', value: 'Airport check-in and boarding' },
                // === ğŸ¨ ä½å®¿ ===
                { label: 'ğŸ¨ é£¯åº—å…¥ä½', value: 'Hotel check-in in Japan' },
                { label: 'ğŸ›ï¸ æ°‘å®¿æºé€š', value: 'Guesthouse communication' },
                { label: 'ğŸ  çœ‹æˆ¿ç§Ÿå±‹', value: 'Apartment viewing and rental' },
                // === ğŸ›ï¸ è³¼ç‰© ===
                { label: 'ğŸ‘— æœé£¾åº—è³¼ç‰©', value: 'Clothing store shopping' },
                { label: 'ğŸ’„ è—¥å¦åº—æ¡è³¼', value: 'Drugstore shopping' },
                { label: 'ğŸ® é›»å™¨åº—è©¢å•', value: 'Electronics store inquiry' },
                { label: 'ğŸ ç™¾è²¨å…¬å¸é€€æ›', value: 'Department store returns' },
                // === ğŸ¥ é†«ç™‚ ===
                { label: 'ğŸ’Š è—¥å±€è²·è—¥', value: 'Pharmacy conversation' },
                { label: 'ğŸ¥ çœ‹è¨ºæè¿°ç—‡ç‹€', value: 'Describing symptoms to a doctor' },
                { label: 'ğŸ¦· ç‰™é†«é ç´„', value: 'Dental appointment' },
                // === ğŸ‘¥ ç¤¾äº¤ ===
                { label: 'ğŸ‘‹ èªè­˜æ–°æœ‹å‹', value: 'Meeting new friends in Japanese' },
                { label: 'ğŸ‰ èšæœƒæ´¾å°', value: 'Party and social gathering' },
                { label: 'ğŸ  é„°é‡Œäº¤æµ', value: 'Chatting with neighbors' },
                { label: 'ğŸ’• ç´„æœƒå°è©±', value: 'Dating conversation' },
                { label: 'ğŸ ç¦®å„€å¯’æš„', value: 'Etiquette and polite small talk' },
                // === ğŸ’¼ å·¥ä½œå•†å‹™ ===
                { label: 'ğŸ“ å•†å‹™é›»è©±', value: 'Business phone call' },
                { label: 'ğŸ’¼ å•†å‹™æœƒè­°', value: 'Business meeting in Japanese' },
                { label: 'ğŸ‘©â€ğŸ’» å°ˆæ¡ˆå”ä½œ', value: 'Project collaboration in IT' },
                { label: 'ğŸ“ å®¢æœèˆ‡æŠ±æ€¨', value: 'Customer support and complaints in Japanese' },
                { label: 'ğŸ¤ é¢è©¦æ‡‰å°', value: 'Job interview in Japanese' },
                // === ğŸš¨ ç·Šæ€¥ç‹€æ³ ===
                { label: 'ğŸš¨ æ±‚åŠ©èˆ‡ç·Šæ€¥', value: 'Emergency help in Japanese' },
                { label: 'ğŸ‘® è­¦å¯Ÿå ±æ¡ˆ', value: 'Reporting to police' },
                { label: 'ğŸ“± éºå¤±ç‰©å“', value: 'Lost and found items' },
                // === ğŸ­ ç‰¹æ®Šå ´æ™¯ ===
                { label: 'ğŸ’‡ ç¾å®¹é™¢å‰ªé«®', value: 'Hair salon conversation' },
                { label: 'ğŸ‹ï¸ å¥èº«æˆ¿å…¥æœƒ', value: 'Gym membership inquiry' },
                { label: 'ğŸ“® éƒµå±€å¯„ä»¶', value: 'Post office mailing' },
                { label: 'ğŸ¦ éŠ€è¡Œé–‹æˆ¶', value: 'Bank account opening' }
            ],
            kana: [
                { label: 'ğŸˆ å¹³å‡åäº”åéŸ³', value: 'Hiragana gojÅ«on (basic vowels and consonants)' },
                { label: 'ğŸˆ‚ï¸ ç‰‡å‡åäº”åéŸ³', value: 'Katakana gojÅ«on (basic vowels and consonants)' }
            ],
            // æ–°å¢ï¼šç”Ÿå­˜æ—¥èªé€Ÿæˆ
            survival: [
                { label: 'ğŸ†˜ è¶…åŸºæœ¬ç”Ÿå­˜å¥', value: 'Essential survival phrases' },
                { label: 'ğŸ™ è¬ç”¨ç¦®è²Œå¥', value: 'Universal polite expressions' },
                { label: 'â“ å•å¥æ¨¡æ¿', value: 'Question patterns' },
                { label: 'ğŸ”¢ æ•¸å­—é‡‘é¡', value: 'Numbers and prices' },
                { label: 'â° æ™‚é–“è¡¨é”', value: 'Time expressions' },
                { label: 'ğŸ“ ä½ç½®æ–¹å‘', value: 'Location and directions' }
            ]
        };

        // å›ºå®šäº”åéŸ³å­—å¡ï¼ˆå¹³å‡å / ç‰‡å‡åï¼‰
        const KANA_DECKS = {
            hiragana: [
                { word: 'ã‚', kana: 'ã‚', romaji: 'a', pos: 'å‡å', mean: 'ã‚ (a)', example: 'ã‚ã•', trans: 'æ—©æ™¨', notes: 'é–‹å£çŸ­ä¿ƒ a' },
                { word: 'ã„', kana: 'ã„', romaji: 'i', pos: 'å‡å', mean: 'ã„ (i)', example: 'ã„ã™', trans: 'æ¤…å­', notes: 'å˜´è§’å¾®å¼µ i' },
                { word: 'ã†', kana: 'ã†', romaji: 'u', pos: 'å‡å', mean: 'ã† (u)', example: 'ã†ã¿', trans: 'æµ·', notes: 'åœ“å”‡çŸ­ä¿ƒ u' },
                { word: 'ãˆ', kana: 'ãˆ', romaji: 'e', pos: 'å‡å', mean: 'ãˆ (e)', example: 'ãˆã', trans: 'è»Šç«™', notes: 'å¾®å¼µå˜´ e' },
                { word: 'ãŠ', kana: 'ãŠ', romaji: 'o', pos: 'å‡å', mean: 'ãŠ (o)', example: 'ãŠã‹ã­', trans: 'éŒ¢', notes: 'åœ“å”‡çŸ­ä¿ƒ o' },
                { word: 'ã‹', kana: 'ã‹', romaji: 'ka', pos: 'å‡å', mean: 'ã‹ (ka)', example: 'ã‹ã•', trans: 'å‚˜', notes: 'æ¸…éŸ³ k è¡Œ' },
                { word: 'ã', kana: 'ã', romaji: 'ki', pos: 'å‡å', mean: 'ã (ki)', example: 'ãã‚‚ã¡', trans: 'å¿ƒæƒ…', notes: 'ã /ki/' },
                { word: 'ã', kana: 'ã', romaji: 'ku', pos: 'å‡å', mean: 'ã (ku)', example: 'ãã‚‹ã¾', trans: 'è»Š', notes: 'ã /ku/' },
                { word: 'ã‘', kana: 'ã‘', romaji: 'ke', pos: 'å‡å', mean: 'ã‘ (ke)', example: 'ã‘ã„ã•ã¤', trans: 'è­¦å¯Ÿ', notes: 'ã‘ /ke/' },
                { word: 'ã“', kana: 'ã“', romaji: 'ko', pos: 'å‡å', mean: 'ã“ (ko)', example: 'ã“ã©ã‚‚', trans: 'å°å­©', notes: 'ã“ /ko/' },
                { word: 'ã•', kana: 'ã•', romaji: 'sa', pos: 'å‡å', mean: 'ã• (sa)', example: 'ã•ã‹ãª', trans: 'é­š', notes: 'æ¸…éŸ³ s è¡Œ' },
                { word: 'ã—', kana: 'ã—', romaji: 'shi', pos: 'å‡å', mean: 'ã— (shi)', example: 'ã—ã”ã¨', trans: 'å·¥ä½œ', notes: 'ç™¼ /shi/' },
                { word: 'ã™', kana: 'ã™', romaji: 'su', pos: 'å‡å', mean: 'ã™ (su)', example: 'ã™ã—', trans: 'å£½å¸', notes: 'ã™ /su/' },
                { word: 'ã›', kana: 'ã›', romaji: 'se', pos: 'å‡å', mean: 'ã› (se)', example: 'ã›ã‹ã„', trans: 'ä¸–ç•Œ', notes: 'ã› /se/' },
                { word: 'ã', kana: 'ã', romaji: 'so', pos: 'å‡å', mean: 'ã (so)', example: 'ãã‚‰', trans: 'å¤©ç©º', notes: 'ã /so/' },
                { word: 'ãŸ', kana: 'ãŸ', romaji: 'ta', pos: 'å‡å', mean: 'ãŸ (ta)', example: 'ãŸã¾ã”', trans: 'é›è›‹', notes: 'æ¸…éŸ³ t è¡Œ' },
                { word: 'ã¡', kana: 'ã¡', romaji: 'chi', pos: 'å‡å', mean: 'ã¡ (chi)', example: 'ã¡ãš', trans: 'åœ°åœ–', notes: 'ç™¼ /chi/' },
                { word: 'ã¤', kana: 'ã¤', romaji: 'tsu', pos: 'å‡å', mean: 'ã¤ (tsu)', example: 'ã¤ã', trans: 'æœˆäº®', notes: 'ç™¼ /tsu/' },
                { word: 'ã¦', kana: 'ã¦', romaji: 'te', pos: 'å‡å', mean: 'ã¦ (te)', example: 'ã¦ãŒã¿', trans: 'ä¿¡', notes: 'ã¦ /te/' },
                { word: 'ã¨', kana: 'ã¨', romaji: 'to', pos: 'å‡å', mean: 'ã¨ (to)', example: 'ã¨ã‘ã„', trans: 'é˜éŒ¶', notes: 'ã¨ /to/' },
                { word: 'ãª', kana: 'ãª', romaji: 'na', pos: 'å‡å', mean: 'ãª (na)', example: 'ãªã¾ãˆ', trans: 'åå­—', notes: 'é¼»éŸ³ n è¡Œ' },
                { word: 'ã«', kana: 'ã«', romaji: 'ni', pos: 'å‡å', mean: 'ã« (ni)', example: 'ã«ã»ã‚“', trans: 'æ—¥æœ¬', notes: 'ã« /ni/' },
                { word: 'ã¬', kana: 'ã¬', romaji: 'nu', pos: 'å‡å', mean: 'ã¬ (nu)', example: 'ã¬ã®', trans: 'å¸ƒ', notes: 'ã¬ /nu/' },
                { word: 'ã­', kana: 'ã­', romaji: 'ne', pos: 'å‡å', mean: 'ã­ (ne)', example: 'ã­ã“', trans: 'è²“', notes: 'ã­ /ne/' },
                { word: 'ã®', kana: 'ã®', romaji: 'no', pos: 'å‡å', mean: 'ã® (no)', example: 'ã®ã‚Š', trans: 'æµ·è‹”', notes: 'ã® /no/' },
                { word: 'ã¯', kana: 'ã¯', romaji: 'ha', pos: 'å‡å', mean: 'ã¯ (ha)', example: 'ã¯ãª', trans: 'èŠ±ï¼é¼»', notes: 'ä½œåŠ©è©è®€ wa' },
                { word: 'ã²', kana: 'ã²', romaji: 'hi', pos: 'å‡å', mean: 'ã² (hi)', example: 'ã²ã‚‹', trans: 'ä¸­åˆ', notes: 'ã² /hi/' },
                { word: 'ãµ', kana: 'ãµ', romaji: 'fu', pos: 'å‡å', mean: 'ãµ (fu)', example: 'ãµã­', trans: 'èˆ¹', notes: 'å”‡é½’éŸ³ /fu/' },
                { word: 'ã¸', kana: 'ã¸', romaji: 'he', pos: 'å‡å', mean: 'ã¸ (he)', example: 'ã¸ã‚„', trans: 'æˆ¿é–“', notes: 'ä½œåŠ©è©è®€ e' },
                { word: 'ã»', kana: 'ã»', romaji: 'ho', pos: 'å‡å', mean: 'ã» (ho)', example: 'ã»ã—', trans: 'æ˜Ÿæ˜Ÿ', notes: 'ã» /ho/' },
                { word: 'ã¾', kana: 'ã¾', romaji: 'ma', pos: 'å‡å', mean: 'ã¾ (ma)', example: 'ã¾ã©', trans: 'çª—æˆ¶', notes: 'é¼»éŸ³ m è¡Œ' },
                { word: 'ã¿', kana: 'ã¿', romaji: 'mi', pos: 'å‡å', mean: 'ã¿ (mi)', example: 'ã¿ãš', trans: 'æ°´', notes: 'ã¿ /mi/' },
                { word: 'ã‚€', kana: 'ã‚€', romaji: 'mu', pos: 'å‡å', mean: 'ã‚€ (mu)', example: 'ã‚€ã—', trans: 'æ˜†èŸ²', notes: 'ã‚€ /mu/' },
                { word: 'ã‚', kana: 'ã‚', romaji: 'me', pos: 'å‡å', mean: 'ã‚ (me)', example: 'ã‚ãŒã­', trans: 'çœ¼é¡', notes: 'ã‚ /me/' },
                { word: 'ã‚‚', kana: 'ã‚‚', romaji: 'mo', pos: 'å‡å', mean: 'ã‚‚ (mo)', example: 'ã‚‚ã‚‚', trans: 'æ¡ƒå­', notes: 'ã‚‚ /mo/' },
                { word: 'ã‚„', kana: 'ã‚„', romaji: 'ya', pos: 'å‡å', mean: 'ã‚„ (ya)', example: 'ã‚„ã•ã„', trans: 'è”¬èœ', notes: 'åŠæ¯éŸ³ y è¡Œ' },
                { word: 'ã‚†', kana: 'ã‚†', romaji: 'yu', pos: 'å‡å', mean: 'ã‚† (yu)', example: 'ã‚†ã', trans: 'é›ª', notes: 'ã‚† /yu/' },
                { word: 'ã‚ˆ', kana: 'ã‚ˆ', romaji: 'yo', pos: 'å‡å', mean: 'ã‚ˆ (yo)', example: 'ã‚ˆã‚‹', trans: 'å¤œæ™š', notes: 'ã‚ˆ /yo/' },
                { word: 'ã‚‰', kana: 'ã‚‰', romaji: 'ra', pos: 'å‡å', mean: 'ã‚‰ (ra)', example: 'ã‚‰ãƒ¼ã‚ã‚“', trans: 'æ‹‰éºµ', notes: 'èˆŒå°–å½ˆéŸ³ /ra/' },
                { word: 'ã‚Š', kana: 'ã‚Š', romaji: 'ri', pos: 'å‡å', mean: 'ã‚Š (ri)', example: 'ã‚Šã‚“ã”', trans: 'è˜‹æœ', notes: 'ã‚Š /ri/' },
                { word: 'ã‚‹', kana: 'ã‚‹', romaji: 'ru', pos: 'å‡å', mean: 'ã‚‹ (ru)', example: 'ã‚‹ã™', trans: 'ä¸åœ¨å®¶', notes: 'ã‚‹ /ru/' },
                { word: 'ã‚Œ', kana: 'ã‚Œ', romaji: 're', pos: 'å‡å', mean: 'ã‚Œ (re)', example: 'ã‚Œãã—', trans: 'æ­·å²', notes: 'ã‚Œ /re/' },
                { word: 'ã‚', kana: 'ã‚', romaji: 'ro', pos: 'å‡å', mean: 'ã‚ (ro)', example: 'ã‚ã†ã‹', trans: 'èµ°å»Š', notes: 'ã‚ /ro/' },
                { word: 'ã‚', kana: 'ã‚', romaji: 'wi', pos: 'å‡å', mean: 'ã‚ (wi)', example: 'ã‚ãªã‹', trans: 'é„‰ä¸‹ï¼ˆå¤ç”¨ï¼‰', notes: 'æ­·å²å‡åï¼Œç¾å¤šç”¨ ã„' },
                { word: 'ã‚‘', kana: 'ã‚‘', romaji: 'we', pos: 'å‡å', mean: 'ã‚‘ (we)', example: 'ã‚‘ã³ã™', trans: 'æƒ æ¯”å£½ï¼ˆå¤ç”¨ï¼‰', notes: 'æ­·å²å‡åï¼Œç¾å¤šç”¨ ãˆ' },
                { word: 'ã‚', kana: 'ã‚', romaji: 'wa', pos: 'å‡å', mean: 'ã‚ (wa)', example: 'ã‚ãŸã—', trans: 'æˆ‘', notes: 'åŠ©è©ã‚‚è®€ wa' },
                { word: 'ã‚’', kana: 'ã‚’', romaji: 'o/wo', pos: 'å‡å', mean: 'ã‚’ (åŠ©è©ç™¼ o)', example: 'ã‚Šã‚“ã”ã‚’ ãŸã¹ã‚‹', trans: 'åƒè˜‹æœ', notes: 'åšè³“èªåŠ©è©æ™‚è®€ o' },
                { word: 'ã‚“', kana: 'ã‚“', romaji: 'n', pos: 'å‡å', mean: 'ã‚“ (n)', example: 'ã»ã‚“', trans: 'æ›¸', notes: 'æ”¶å°¾é¼»éŸ³ n' },
                { word: 'ã£', kana: 'ã£', romaji: 'small tsu', pos: 'å‡å', mean: 'ä¿ƒéŸ³ï¼ˆã£ï¼‰', example: 'ãã£ã¦', trans: 'éƒµç¥¨', notes: 'é›™å¯«å­éŸ³ï¼Œåœé “ä¸€æ‹' }
            ],
            katakana: [
                { word: 'ã‚¢', kana: 'ã‚¢', romaji: 'a', pos: 'å‡å', mean: 'ã‚¢ (a)', example: 'ã‚¢ã‚¤ã‚¹', trans: 'å†°æ·‡æ·‹', notes: 'ç‰‡å‡å a' },
                { word: 'ã‚¤', kana: 'ã‚¤', romaji: 'i', pos: 'å‡å', mean: 'ã‚¤ (i)', example: 'ã‚¤ãƒ³ã‚¯', trans: 'å¢¨æ°´', notes: 'ç‰‡å‡å i' },
                { word: 'ã‚¦', kana: 'ã‚¦', romaji: 'u', pos: 'å‡å', mean: 'ã‚¦ (u)', example: 'ã‚¦ãƒŸ', trans: 'æµ·', notes: 'ç‰‡å‡å u' },
                { word: 'ã‚¨', kana: 'ã‚¨', romaji: 'e', pos: 'å‡å', mean: 'ã‚¨ (e)', example: 'ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼', trans: 'é›»æ¢¯', notes: 'ç‰‡å‡å e' },
                { word: 'ã‚ª', kana: 'ã‚ª', romaji: 'o', pos: 'å‡å', mean: 'ã‚ª (o)', example: 'ã‚ªãƒ¬ãƒ³ã‚¸', trans: 'æŸ³æ©™', notes: 'ç‰‡å‡å o' },
                { word: 'ã‚«', kana: 'ã‚«', romaji: 'ka', pos: 'å‡å', mean: 'ã‚« (ka)', example: 'ã‚«ãƒ¡ãƒ©', trans: 'ç›¸æ©Ÿ', notes: 'æ¸…éŸ³ k' },
                { word: 'ã‚­', kana: 'ã‚­', romaji: 'ki', pos: 'å‡å', mean: 'ã‚­ (ki)', example: 'ã‚­ãƒƒãƒãƒ³', trans: 'å»šæˆ¿', notes: 'ã‚­ /ki/' },
                { word: 'ã‚¯', kana: 'ã‚¯', romaji: 'ku', pos: 'å‡å', mean: 'ã‚¯ (ku)', example: 'ã‚¯ãƒ©ãƒ–', trans: 'ä¿±æ¨‚éƒ¨', notes: 'ã‚¯ /ku/' },
                { word: 'ã‚±', kana: 'ã‚±', romaji: 'ke', pos: 'å‡å', mean: 'ã‚± (ke)', example: 'ã‚±ãƒ¼ã‚­', trans: 'è›‹ç³•', notes: 'ã‚± /ke/' },
                { word: 'ã‚³', kana: 'ã‚³', romaji: 'ko', pos: 'å‡å', mean: 'ã‚³ (ko)', example: 'ã‚³ãƒ¼ãƒ’ãƒ¼', trans: 'å’–å•¡', notes: 'ã‚³ /ko/' },
                { word: 'ã‚µ', kana: 'ã‚µ', romaji: 'sa', pos: 'å‡å', mean: 'ã‚µ (sa)', example: 'ã‚µãƒ©ãƒ€', trans: 'æ²™æ‹‰', notes: 'ã‚µ /sa/' },
                { word: 'ã‚·', kana: 'ã‚·', romaji: 'shi', pos: 'å‡å', mean: 'ã‚· (shi)', example: 'ã‚·ãƒ£ãƒ„', trans: 'è¥¯è¡«', notes: 'ç™¼ /shi/' },
                { word: 'ã‚¹', kana: 'ã‚¹', romaji: 'su', pos: 'å‡å', mean: 'ã‚¹ (su)', example: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼', trans: 'è¶…å¸‚', notes: 'ã‚¹ /su/' },
                { word: 'ã‚»', kana: 'ã‚»', romaji: 'se', pos: 'å‡å', mean: 'ã‚» (se)', example: 'ã‚»ãƒ¼ã‚¿ãƒ¼', trans: 'æ¯›è¡£', notes: 'ã‚» /se/' },
                { word: 'ã‚½', kana: 'ã‚½', romaji: 'so', pos: 'å‡å', mean: 'ã‚½ (so)', example: 'ã‚½ãƒ¼ãƒ€', trans: 'è˜‡æ‰“', notes: 'ã‚½ /so/' },
                { word: 'ã‚¿', kana: 'ã‚¿', romaji: 'ta', pos: 'å‡å', mean: 'ã‚¿ (ta)', example: 'ã‚¿ã‚¯ã‚·ãƒ¼', trans: 'è¨ˆç¨‹è»Š', notes: 'ã‚¿ /ta/' },
                { word: 'ãƒ', kana: 'ãƒ', romaji: 'chi', pos: 'å‡å', mean: 'ãƒ (chi)', example: 'ãƒã‚±ãƒƒãƒˆ', trans: 'ç¥¨åˆ¸', notes: 'ç™¼ /chi/' },
                { word: 'ãƒ„', kana: 'ãƒ„', romaji: 'tsu', pos: 'å‡å', mean: 'ãƒ„ (tsu)', example: 'ãƒ„ã‚¢ãƒ¼', trans: 'æ—…éŠè¡Œç¨‹', notes: 'ç™¼ /tsu/' },
                { word: 'ãƒ†', kana: 'ãƒ†', romaji: 'te', pos: 'å‡å', mean: 'ãƒ† (te)', example: 'ãƒ†ãƒ¬ãƒ“', trans: 'é›»è¦–', notes: 'ãƒ† /te/' },
                { word: 'ãƒˆ', kana: 'ãƒˆ', romaji: 'to', pos: 'å‡å', mean: 'ãƒˆ (to)', example: 'ãƒˆãƒãƒˆ', trans: 'ç•ªèŒ„', notes: 'ãƒˆ /to/' },
                { word: 'ãƒŠ', kana: 'ãƒŠ', romaji: 'na', pos: 'å‡å', mean: 'ãƒŠ (na)', example: 'ãƒŠã‚¤ãƒ•', trans: 'åˆ€å­', notes: 'ãƒŠ /na/' },
                { word: 'ãƒ‹', kana: 'ãƒ‹', romaji: 'ni', pos: 'å‡å', mean: 'ãƒ‹ (ni)', example: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹', trans: 'æ–°è', notes: 'ãƒ‹ /ni/' },
                { word: 'ãƒŒ', kana: 'ãƒŒ', romaji: 'nu', pos: 'å‡å', mean: 'ãƒŒ (nu)', example: 'ãƒŒãƒ¼ãƒ‰ãƒ«', trans: 'éºµ', notes: 'ãƒŒ /nu/' },
                { word: 'ãƒ', kana: 'ãƒ', romaji: 'ne', pos: 'å‡å', mean: 'ãƒ (ne)', example: 'ãƒã‚¯ã‚¿ã‚¤', trans: 'é ˜å¸¶', notes: 'ãƒ /ne/' },
                { word: 'ãƒ', kana: 'ãƒ', romaji: 'no', pos: 'å‡å', mean: 'ãƒ (no)', example: 'ãƒãƒ¼ãƒˆ', trans: 'ç­†è¨˜æœ¬', notes: 'ãƒ /no/' },
                { word: 'ãƒ', kana: 'ãƒ', romaji: 'ha', pos: 'å‡å', mean: 'ãƒ (ha)', example: 'ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼', trans: 'æ¼¢å ¡', notes: 'ä½œåŠ©è©è®€ wa' },
                { word: 'ãƒ’', kana: 'ãƒ’', romaji: 'hi', pos: 'å‡å', mean: 'ãƒ’ (hi)', example: 'ãƒ’ãƒ¼ã‚¿ãƒ¼', trans: 'æš–æ°£', notes: 'ãƒ’ /hi/' },
                { word: 'ãƒ•', kana: 'ãƒ•', romaji: 'fu', pos: 'å‡å', mean: 'ãƒ• (fu)', example: 'ãƒ•ãƒ«ãƒ¼ãƒ„', trans: 'æ°´æœ', notes: 'å”‡é½’éŸ³ /fu/' },
                { word: 'ãƒ˜', kana: 'ãƒ˜', romaji: 'he', pos: 'å‡å', mean: 'ãƒ˜ (he)', example: 'ãƒ˜ã‚¢', trans: 'é ­é«®', notes: 'ä½œåŠ©è©è®€ e' },
                { word: 'ãƒ›', kana: 'ãƒ›', romaji: 'ho', pos: 'å‡å', mean: 'ãƒ› (ho)', example: 'ãƒ›ãƒ†ãƒ«', trans: 'é£¯åº—', notes: 'ãƒ› /ho/' },
                { word: 'ãƒ', kana: 'ãƒ', romaji: 'ma', pos: 'å‡å', mean: 'ãƒ (ma)', example: 'ãƒãƒ³ã‚¬', trans: 'æ¼«ç•«', notes: 'ãƒ /ma/' },
                { word: 'ãƒŸ', kana: 'ãƒŸ', romaji: 'mi', pos: 'å‡å', mean: 'ãƒŸ (mi)', example: 'ãƒŸãƒ«ã‚¯', trans: 'ç‰›å¥¶', notes: 'ãƒŸ /mi/' },
                { word: 'ãƒ ', kana: 'ãƒ ', romaji: 'mu', pos: 'å‡å', mean: 'ãƒ  (mu)', example: 'ãƒ ãƒ¼ãƒ“ãƒ¼', trans: 'é›»å½±', notes: 'ãƒ  /mu/' },
                { word: 'ãƒ¡', kana: 'ãƒ¡', romaji: 'me', pos: 'å‡å', mean: 'ãƒ¡ (me)', example: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼', trans: 'èœå–®', notes: 'ãƒ¡ /me/' },
                { word: 'ãƒ¢', kana: 'ãƒ¢', romaji: 'mo', pos: 'å‡å', mean: 'ãƒ¢ (mo)', example: 'ãƒ¢ãƒ‡ãƒ«', trans: 'æ¨¡ç‰¹å…’', notes: 'ãƒ¢ /mo/' },
                { word: 'ãƒ¤', kana: 'ãƒ¤', romaji: 'ya', pos: 'å‡å', mean: 'ãƒ¤ (ya)', example: 'ãƒ¤ã‚¯ãƒ«ãƒˆ', trans: 'é¤Šæ¨‚å¤š', notes: 'ãƒ¤ /ya/' },
                { word: 'ãƒ¦', kana: 'ãƒ¦', romaji: 'yu', pos: 'å‡å', mean: 'ãƒ¦ (yu)', example: 'ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ', trans: 'åˆ¶æœ', notes: 'ãƒ¦ /yu/' },
                { word: 'ãƒ¨', kana: 'ãƒ¨', romaji: 'yo', pos: 'å‡å', mean: 'ãƒ¨ (yo)', example: 'ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ', trans: 'å„ªæ ¼', notes: 'ãƒ¨ /yo/' },
                { word: 'ãƒ©', kana: 'ãƒ©', romaji: 'ra', pos: 'å‡å', mean: 'ãƒ© (ra)', example: 'ãƒ©ã‚¸ã‚ª', trans: 'æ”¶éŸ³æ©Ÿ', notes: 'å½ˆèˆŒ /ra/' },
                { word: 'ãƒª', kana: 'ãƒª', romaji: 'ri', pos: 'å‡å', mean: 'ãƒª (ri)', example: 'ãƒªã‚¹ãƒˆ', trans: 'æ¸…å–®', notes: 'ãƒª /ri/' },
                { word: 'ãƒ«', kana: 'ãƒ«', romaji: 'ru', pos: 'å‡å', mean: 'ãƒ« (ru)', example: 'ãƒ«ãƒ¼ãƒ ', trans: 'æˆ¿é–“', notes: 'ãƒ« /ru/' },
                { word: 'ãƒ¬', kana: 'ãƒ¬', romaji: 're', pos: 'å‡å', mean: 'ãƒ¬ (re)', example: 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', trans: 'é¤å»³', notes: 'ãƒ¬ /re/' },
                { word: 'ãƒ­', kana: 'ãƒ­', romaji: 'ro', pos: 'å‡å', mean: 'ãƒ­ (ro)', example: 'ãƒ­ãƒœãƒƒãƒˆ', trans: 'æ©Ÿå™¨äºº', notes: 'ãƒ­ /ro/' },
                { word: 'ãƒ°', kana: 'ãƒ°', romaji: 'wi', pos: 'å‡å', mean: 'ãƒ° (wi)', example: 'ãƒ°ã‚¹ã‚­ãƒ¼', trans: 'å¨å£«å¿Œï¼ˆèˆŠæ¨™è¨˜ï¼‰', notes: 'æ­·å²å‡åï¼Œç¾å¤šç”¨ ã‚¤' },
                { word: 'ãƒ±', kana: 'ãƒ±', romaji: 'we', pos: 'å‡å', mean: 'ãƒ± (we)', example: 'ãƒ±ãƒ“ã‚¹', trans: 'æƒ æ¯”å£½ï¼ˆèˆŠæ¨™è¨˜ï¼‰', notes: 'æ­·å²å‡åï¼Œç¾å¤šç”¨ ã‚¨' },
                { word: 'ãƒ¯', kana: 'ãƒ¯', romaji: 'wa', pos: 'å‡å', mean: 'ãƒ¯ (wa)', example: 'ãƒ¯ã‚¤ãƒ³', trans: 'ç´…é…’', notes: 'ãƒ¯ /wa/' },
                { word: 'ãƒ²', kana: 'ãƒ²', romaji: 'o/wo', pos: 'å‡å', mean: 'ãƒ² (åŠ©è©ç™¼ o)', example: 'ãƒ²ã‚¿ã‚¯', trans: 'å¾¡å®…æ—', notes: 'åŠ©è©è®€ o' },
                { word: 'ãƒ³', kana: 'ãƒ³', romaji: 'n', pos: 'å‡å', mean: 'ãƒ³ (n)', example: 'ãƒ‘ãƒ³', trans: 'éºµåŒ…', notes: 'é¼»éŸ³ n' },
                { word: 'ãƒƒ', kana: 'ãƒƒ', romaji: 'small tsu', pos: 'å‡å', mean: 'ä¿ƒéŸ³ï¼ˆãƒƒï¼‰', example: 'ã‚«ãƒƒãƒ—', trans: 'æ¯å­', notes: 'é›™å¯«å­éŸ³ï¼Œåœé “ä¸€æ‹' }
            ]
        };

        // æ¿éŸ³ / åŠæ¿éŸ³ / æ‹—éŸ³ / ä¿ƒéŸ³ / é•·éŸ³ / ç‰¹æ®Šç™¼éŸ³
        const KANA_EXTRA = {
            hiragana: {
                dakuten: [
                    { word: 'ãŒ', romaji: 'ga' }, { word: 'ã', romaji: 'gi' }, { word: 'ã', romaji: 'gu' }, { word: 'ã’', romaji: 'ge' }, { word: 'ã”', romaji: 'go' },
                    { word: 'ã–', romaji: 'za' }, { word: 'ã˜', romaji: 'ji' }, { word: 'ãš', romaji: 'zu' }, { word: 'ãœ', romaji: 'ze' }, { word: 'ã', romaji: 'zo' },
                    { word: 'ã ', romaji: 'da' }, { word: 'ã¢', romaji: 'ji/di' }, { word: 'ã¥', romaji: 'zu/du' }, { word: 'ã§', romaji: 'de' }, { word: 'ã©', romaji: 'do' },
                    { word: 'ã°', romaji: 'ba' }, { word: 'ã³', romaji: 'bi' }, { word: 'ã¶', romaji: 'bu' }, { word: 'ã¹', romaji: 'be' }, { word: 'ã¼', romaji: 'bo' }
                ],
                handaku: [
                    { word: 'ã±', romaji: 'pa' }, { word: 'ã´', romaji: 'pi' }, { word: 'ã·', romaji: 'pu' }, { word: 'ãº', romaji: 'pe' }, { word: 'ã½', romaji: 'po' }
                ],
                youon: [
                    { word: 'ãã‚ƒ', romaji: 'kya' }, { word: 'ãã‚…', romaji: 'kyu' }, { word: 'ãã‚‡', romaji: 'kyo' }, { word: 'ã—ã‚ƒ', romaji: 'sha' }, { word: 'ã—ã‚…', romaji: 'shu' },
                    { word: 'ã—ã‚‡', romaji: 'sho' }, { word: 'ã¡ã‚ƒ', romaji: 'cha' }, { word: 'ã¡ã‚…', romaji: 'chu' }, { word: 'ã¡ã‚‡', romaji: 'cho' }, { word: 'ã«ã‚ƒ', romaji: 'nya' },
                    { word: 'ã«ã‚…', romaji: 'nyu' }, { word: 'ã«ã‚‡', romaji: 'nyo' }, { word: 'ã²ã‚ƒ', romaji: 'hya' }, { word: 'ã²ã‚…', romaji: 'hyu' }, { word: 'ã²ã‚‡', romaji: 'hyo' },
                    { word: 'ã¿ã‚ƒ', romaji: 'mya' }, { word: 'ã¿ã‚…', romaji: 'myu' }, { word: 'ã¿ã‚‡', romaji: 'myo' }, { word: 'ã‚Šã‚ƒ', romaji: 'rya' }, { word: 'ã‚Šã‚…', romaji: 'ryu' },
                    { word: 'ã‚Šã‚‡', romaji: 'ryo' }, { word: 'ãã‚ƒ', romaji: 'gya' }, { word: 'ãã‚…', romaji: 'gyu' }, { word: 'ãã‚‡', romaji: 'gyo' }, { word: 'ã˜ã‚ƒ', romaji: 'ja' },
                    { word: 'ã˜ã‚…', romaji: 'ju' }, { word: 'ã˜ã‚‡', romaji: 'jo' }, { word: 'ã³ã‚ƒ', romaji: 'bya' }, { word: 'ã³ã‚…', romaji: 'byu' }, { word: 'ã³ã‚‡', romaji: 'byo' },
                    { word: 'ã´ã‚ƒ', romaji: 'pya' }, { word: 'ã´ã‚…', romaji: 'pyu' }, { word: 'ã´ã‚‡', romaji: 'pyo' }
                ],
                sokuon: [
                    { word: 'ã£', romaji: 'ä¿ƒéŸ³', notes: 'é›™å¯«å­éŸ³ï¼Œåœä¸€æ‹' }
                ],
                choon: [
                    { word: 'ãƒ¼', romaji: 'é•·éŸ³', notes: 'å‰éŸ³æ‹‰é•·ä¸€æ‹' }
                ],
                special: [
                    { word: 'ã˜/ã¢', romaji: 'ji/di', notes: 'å¯¦éš›å¤šå¿µ ji' },
                    { word: 'ãš/ã¥', romaji: 'zu/du', notes: 'å¯¦éš›å¤šå¿µ zu' }
                ]
            },
            katakana: {
                dakuten: [
                    { word: 'ã‚¬', romaji: 'ga' }, { word: 'ã‚®', romaji: 'gi' }, { word: 'ã‚°', romaji: 'gu' }, { word: 'ã‚²', romaji: 'ge' }, { word: 'ã‚´', romaji: 'go' },
                    { word: 'ã‚¶', romaji: 'za' }, { word: 'ã‚¸', romaji: 'ji' }, { word: 'ã‚º', romaji: 'zu' }, { word: 'ã‚¼', romaji: 'ze' }, { word: 'ã‚¾', romaji: 'zo' },
                    { word: 'ãƒ€', romaji: 'da' }, { word: 'ãƒ‚', romaji: 'ji/di' }, { word: 'ãƒ…', romaji: 'zu/du' }, { word: 'ãƒ‡', romaji: 'de' }, { word: 'ãƒ‰', romaji: 'do' },
                    { word: 'ãƒ', romaji: 'ba' }, { word: 'ãƒ“', romaji: 'bi' }, { word: 'ãƒ–', romaji: 'bu' }, { word: 'ãƒ™', romaji: 'be' }, { word: 'ãƒœ', romaji: 'bo' }
                ],
                handaku: [
                    { word: 'ãƒ‘', romaji: 'pa' }, { word: 'ãƒ”', romaji: 'pi' }, { word: 'ãƒ—', romaji: 'pu' }, { word: 'ãƒš', romaji: 'pe' }, { word: 'ãƒ', romaji: 'po' }
                ],
                youon: [
                    { word: 'ã‚­ãƒ£', romaji: 'kya' }, { word: 'ã‚­ãƒ¥', romaji: 'kyu' }, { word: 'ã‚­ãƒ§', romaji: 'kyo' }, { word: 'ã‚·ãƒ£', romaji: 'sha' }, { word: 'ã‚·ãƒ¥', romaji: 'shu' },
                    { word: 'ã‚·ãƒ§', romaji: 'sho' }, { word: 'ãƒãƒ£', romaji: 'cha' }, { word: 'ãƒãƒ¥', romaji: 'chu' }, { word: 'ãƒãƒ§', romaji: 'cho' }, { word: 'ãƒ‹ãƒ£', romaji: 'nya' },
                    { word: 'ãƒ‹ãƒ¥', romaji: 'nyu' }, { word: 'ãƒ‹ãƒ§', romaji: 'nyo' }, { word: 'ãƒ’ãƒ£', romaji: 'hya' }, { word: 'ãƒ’ãƒ¥', romaji: 'hyu' }, { word: 'ãƒ’ãƒ§', romaji: 'hyo' },
                    { word: 'ãƒŸãƒ£', romaji: 'mya' }, { word: 'ãƒŸãƒ¥', romaji: 'myu' }, { word: 'ãƒŸãƒ§', romaji: 'myo' }, { word: 'ãƒªãƒ£', romaji: 'rya' }, { word: 'ãƒªãƒ¥', romaji: 'ryu' },
                    { word: 'ãƒªãƒ§', romaji: 'ryo' }, { word: 'ã‚®ãƒ£', romaji: 'gya' }, { word: 'ã‚®ãƒ¥', romaji: 'gyu' }, { word: 'ã‚®ãƒ§', romaji: 'gyo' }, { word: 'ã‚¸ãƒ£', romaji: 'ja' },
                    { word: 'ã‚¸ãƒ¥', romaji: 'ju' }, { word: 'ã‚¸ãƒ§', romaji: 'jo' }, { word: 'ãƒ“ãƒ£', romaji: 'bya' }, { word: 'ãƒ“ãƒ¥', romaji: 'byu' }, { word: 'ãƒ“ãƒ§', romaji: 'byo' },
                    { word: 'ãƒ”ãƒ£', romaji: 'pya' }, { word: 'ãƒ”ãƒ¥', romaji: 'pyu' }, { word: 'ãƒ”ãƒ§', romaji: 'pyo' }
                ],
                sokuon: [
                    { word: 'ãƒƒ', romaji: 'ä¿ƒéŸ³', notes: 'é›™å¯«å­éŸ³ï¼Œåœä¸€æ‹' }
                ],
                choon: [
                    { word: 'ãƒ¼', romaji: 'é•·éŸ³', notes: 'å¤–ä¾†èªå¸¸è¦‹é•·éŸ³' }
                ],
                special: [
                    { word: 'ã‚¸/ãƒ‚', romaji: 'ji/di', notes: 'å¯¦éš›å¤šå¿µ ji' },
                    { word: 'ã‚º/ãƒ…', romaji: 'zu/du', notes: 'å¯¦éš›å¤šå¿µ zu' }
                ]
            }
        };

        let apiKey = localStorage.getItem('gemini_api_key');
        let userData = JSON.parse(localStorage.getItem('linguamax_user') || '{}');

        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', () => {
            if (!apiKey) {
                document.getElementById('key-modal').classList.remove('hidden');
            } else {
                document.getElementById('key-modal').classList.add('hidden');
                initApp();
            }
        });

        function saveApiKey() {
            const val = document.getElementById('api-key-input').value.trim();
            if (val) {
                apiKey = val;
                localStorage.setItem('gemini_api_key', apiKey);
                document.getElementById('key-modal').classList.add('hidden');
                initApp();
            }
        }

        function initApp() {
            loadUserData();
            updateTopics();
            loadContent();
            checkStreak();
        }

        // ===== ç”¨æˆ¶æ•¸æ“š =====
        function trimArray(arr, limit = 200) {
            if (!Array.isArray(arr)) return;
            if (arr.length > limit) {
                arr.splice(0, arr.length - limit); // ä¿ç•™æœ€æ–°çš„ limit ç­†
            }
        }

        function loadUserData() {
            if (!userData.xp) {
                userData = { 
                    xp: 0, 
                    streak: 0, 
                    wordsLearned: [],      // å­¸éçš„å–®å­—åˆ—è¡¨
                    learnedHistory: {},    // æŒ‰ä¸»é¡Œåˆ†é¡çš„å­¸ç¿’è¨˜éŒ„
                    learnedGrammar: {},    // æŒ‰ä¸»é¡Œåˆ†é¡çš„æ–‡æ³•æ¦‚å¿µè¨˜éŒ„
                    totalCorrect: 0, 
                    totalAnswered: 0, 
                    lastActive: null 
                };
            }
            // å…¼å®¹èˆŠç‰ˆæœ¬
            if (!userData.learnedHistory) userData.learnedHistory = {};
            if (!userData.learnedGrammar) userData.learnedGrammar = {};
            
            updateUI();
        }

        function saveUserData() {
            localStorage.setItem('linguamax_user', JSON.stringify(userData));
            updateUI();
        }

        // å–å¾—æŸä¸»é¡Œå·²å­¸éçš„å–®å­—
        function getLearnedWordsForTopic(topic) {
            return userData.learnedHistory[topic] || [];
        }

        // å–å¾—æŸä¸»é¡Œå·²å­¸éçš„æ–‡æ³•æ¦‚å¿µ
        function getLearnedGrammarForTopic(topic) {
            return userData.learnedGrammar[topic] || [];
        }

        // å„²å­˜å­¸éçš„å–®å­—åˆ°è¨˜éŒ„
        function saveLearnedWord(word, topic) {
            if (!userData.learnedHistory[topic]) {
                userData.learnedHistory[topic] = [];
            }
            if (!userData.learnedHistory[topic].includes(word)) {
                userData.learnedHistory[topic].push(word);
                trimArray(userData.learnedHistory[topic], 400);
            }
            if (!userData.wordsLearned.includes(word)) {
                userData.wordsLearned.push(word);
                trimArray(userData.wordsLearned, 1000);
            }
            saveUserData();
        }

        // å„²å­˜å­¸éçš„æ–‡æ³•æ¦‚å¿µåˆ°è¨˜éŒ„
        function saveLearnedGrammar(concept, topic) {
            if (!concept) return;
            if (!userData.learnedGrammar[topic]) {
                userData.learnedGrammar[topic] = [];
            }
            if (!userData.learnedGrammar[topic].includes(concept)) {
                userData.learnedGrammar[topic].push(concept);
                trimArray(userData.learnedGrammar[topic], 200);
            }
            saveUserData();
        }

        function updateUI() {
            document.getElementById('xp-count').textContent = userData.xp + ' XP';
            document.getElementById('streak-count').textContent = userData.streak;
            document.getElementById('today-learned').textContent = Math.min(userData.wordsLearned?.length || 0, 20);
            document.getElementById('daily-progress').style.width = Math.min((userData.wordsLearned?.length || 0) / 20 * 100, 100) + '%';
            
            // ç­‰ç´šç³»çµ±
            const levelInfo = calculateLevel(userData.xp);
            document.getElementById('user-level').textContent = levelInfo.level;
            document.getElementById('user-level-badge').textContent = levelInfo.badge;
            document.getElementById('xp-to-next').textContent = levelInfo.currentXP;
            document.getElementById('xp-needed').textContent = levelInfo.xpNeeded;
            document.getElementById('level-progress').style.width = levelInfo.progress + '%';
        }

        // ç­‰ç´šè¨ˆç®—ï¼ˆæ¯ 100 XP å‡ä¸€ç´šï¼Œé€æ¼¸å¢åŠ ï¼‰
        function calculateLevel(totalXP) {
            const levels = [
                { level: 1, badge: 'ğŸŒ±', xp: 0 },
                { level: 2, badge: 'ğŸŒ¿', xp: 100 },
                { level: 3, badge: 'ğŸŒ³', xp: 250 },
                { level: 4, badge: 'ğŸŒ²', xp: 500 },
                { level: 5, badge: 'ğŸ‹', xp: 800 },
                { level: 6, badge: 'ğŸ„', xp: 1200 },
                { level: 7, badge: 'ğŸ”ï¸', xp: 1700 },
                { level: 8, badge: 'â›°ï¸', xp: 2300 },
                { level: 9, badge: 'ğŸ—»', xp: 3000 },
                { level: 10, badge: 'ğŸŒŸ', xp: 4000 },
                { level: 11, badge: 'â­', xp: 5000 },
                { level: 12, badge: 'ğŸ’«', xp: 6500 },
                { level: 13, badge: 'âœ¨', xp: 8000 },
                { level: 14, badge: 'ğŸ”¥', xp: 10000 },
                { level: 15, badge: 'ğŸ‘‘', xp: 12500 }
            ];
            
            let currentLevel = levels[0];
            let nextLevel = levels[1];
            
            for (let i = 0; i < levels.length - 1; i++) {
                if (totalXP >= levels[i].xp) {
                    currentLevel = levels[i];
                    nextLevel = levels[i + 1];
                }
            }
            
            // æœ€é«˜ç´š
            if (totalXP >= levels[levels.length - 1].xp) {
                currentLevel = levels[levels.length - 1];
                return {
                    level: currentLevel.level,
                    badge: currentLevel.badge,
                    currentXP: totalXP - currentLevel.xp,
                    xpNeeded: 'âˆ',
                    progress: 100
                };
            }
            
            const xpInLevel = totalXP - currentLevel.xp;
            const xpForLevel = nextLevel.xp - currentLevel.xp;
            const progress = Math.round(xpInLevel / xpForLevel * 100);
            
            return {
                level: currentLevel.level,
                badge: currentLevel.badge,
                currentXP: xpInLevel,
                xpNeeded: xpForLevel,
                progress
            };
        }

        function checkStreak() {
            const today = new Date().toDateString();
            const lastActive = userData.lastActive;
            
            if (lastActive) {
                const lastDate = new Date(lastActive);
                const daysDiff = Math.floor((new Date(today) - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff > 1) {
                    userData.streak = 0; // æ–·é€£
                }
            }
        }

        function addXP(amount) {
            userData.xp += amount;
            userData.lastActive = new Date().toDateString();
            
            // æ›´æ–°é€£çºŒå¤©æ•¸
            const today = new Date().toDateString();
            if (userData.lastActive !== today) {
                userData.streak++;
            }
            
            saveUserData();
            showXPPopup(amount);
        }

        function showXPPopup(amount) {
            const popup = document.createElement('div');
            popup.className = 'xp-popup fixed top-20 left-1/2 -translate-x-1/2 text-2xl font-bold text-yellow-400 z-50';
            popup.textContent = `+${amount} XP`;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1500);
        }

        // ===== æ¨¡å¼åˆ‡æ› =====
        function switchMode(mode) {
            // åœæ­¢èªéŸ³è­˜åˆ¥çš„è‡ªå‹•é‡å•Ÿ
            autoRestartChat = false;
            if (isListening && recognition) {
                recognition.stop();
            }
            
            APP_STATE.currentMode = mode;
            APP_STATE.historyData = [];
            APP_STATE.currentIndex = 0;

            // å¦‚æœåˆ‡åˆ°äº”åéŸ³æ¨¡å¼ï¼Œé è¨­å¹³å‡å
            if (mode === 'kana') {
                const levelSelect = document.getElementById('level-select');
                const topicSelect = document.getElementById('topic-select');
                if (levelSelect) levelSelect.value = 'KANA_HIRA';
                APP_STATE.currentTopic = 'Hiragana gojÅ«on (basic vowels and consonants)';
                APP_STATE.kanaStart = 0;
                if (topicSelect) topicSelect.value = APP_STATE.currentTopic;
            } else {
                // é›¢é–‹äº”åéŸ³æ¨¡å¼æ™‚ï¼Œå¦‚æœç­‰ç´šä»ç‚ºå‡åæ¨¡å¼ï¼Œé‡ç½®åˆ° N5
                const levelSelect = document.getElementById('level-select');
                if (levelSelect && (levelSelect.value === 'KANA_HIRA' || levelSelect.value === 'KANA_KATA')) {
                    levelSelect.value = 'N5';
                }
            }

            // æ›´æ–°æ¡Œé¢ç‰ˆå°èˆª UI
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('bg-green-500/20', 'border-green-500', 'text-green-400');
                btn.classList.add('border-transparent');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('bg-green-500/20', 'border-green-500', 'text-green-400');
                    btn.classList.remove('border-transparent');
                }
            });

            // æ›´æ–°æ‰‹æ©Ÿç‰ˆå°èˆª UI
            document.querySelectorAll('.mobile-mode-btn').forEach(btn => {
                btn.classList.remove('bg-green-500/20', 'border-green-500', 'text-green-400');
                btn.classList.add('border-transparent');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('bg-green-500/20', 'border-green-500', 'text-green-400');
                    btn.classList.remove('border-transparent');
                }
            });

            // é¡¯ç¤ºå°æ‡‰è¦–åœ–
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${mode}`).classList.remove('hidden');

            // é¡¯ç¤º/éš±è—é€²åº¦æ¢
            if (['flashcard', 'quiz', 'typing', 'listening', 'kana'].includes(mode)) {
                document.getElementById('session-progress').classList.remove('hidden');
            } else {
                document.getElementById('session-progress').classList.add('hidden');
            }

            updateTopics();
            loadContent();
        }

        function updateTopics() {
            const select = document.getElementById('topic-select');
            const topics = TOPICS[APP_STATE.currentMode] || [];
            
            // æ›´æ–°ä¸‹æ‹‰é¸å–®
            select.innerHTML = topics.map((t, i) => `
                <option value="${t.value}">${t.label}</option>
            `).join('');

            // è¨­å®šç¬¬ä¸€å€‹ä¸»é¡Œç‚ºé è¨­
            if (topics.length > 0) {
                APP_STATE.currentTopic = topics[0].value;
                select.value = topics[0].value;
            }
            
            // åŒæ™‚æ›´æ–°æ‰‹æ©Ÿç‰ˆ
            updateMobileTopicSelect();
        }

        // äº”åéŸ³å°ˆå€å¿«é€Ÿé€²å…¥
        function startKanaSession(type) {
            setKanaSession(type);
        }

        // åˆ‡æ›å¹³å‡å / ç‰‡å‡åæ¨¡å¼
        function switchKanaMode(type) {
            setKanaSession(type);
        }

        function setKanaSession(type) {
            // å¼·åˆ¶åˆ‡æ›åˆ°äº”åéŸ³æ¨¡å¼
            switchMode('kana');

            const levelSelect = document.getElementById('level-select');
            const topicSelect = document.getElementById('topic-select');

            // è¨­å®šç­‰ç´šèˆ‡ä¸»é¡Œ
            if (type === 'hiragana') {
                if (levelSelect) levelSelect.value = 'KANA_HIRA';
                APP_STATE.currentTopic = 'Hiragana gojÅ«on (basic vowels and consonants)';
            } else {
                if (levelSelect) levelSelect.value = 'KANA_KATA';
                APP_STATE.currentTopic = 'Katakana gojÅ«on (basic vowels and consonants)';
            }

            // åŒæ­¥ä¸‹æ‹‰
            if (topicSelect) topicSelect.value = APP_STATE.currentTopic;
            const mobileTopic = document.getElementById('mobile-topic-select');
            if (mobileTopic) mobileTopic.value = APP_STATE.currentTopic;

            // é‡ç½® session ç‹€æ…‹ä¸¦è¼‰å…¥
            APP_STATE.historyData = [];
            APP_STATE.currentIndex = 0;
            APP_STATE.kanaStart = 0;
            loadContent();
        }

        // ä¸»é¡Œä¸‹æ‹‰é¸å–®è®Šæ›´
        function onTopicChange() {
            const select = document.getElementById('topic-select');
            APP_STATE.currentTopic = select.value;
            APP_STATE.historyData = [];
            
            // åŒæ­¥æ‰‹æ©Ÿç‰ˆé¸å–®
            const mobileSelect = document.getElementById('mobile-topic-select');
            if (mobileSelect) mobileSelect.value = select.value;
            
            loadContent();
        }

        function selectTopic(topicValue) {
            APP_STATE.currentTopic = topicValue;
            APP_STATE.historyData = [];
            
            // æ›´æ–°ä¸‹æ‹‰é¸å–®
            const select = document.getElementById('topic-select');
            if (select) select.value = topicValue;
            
            const mobileSelect = document.getElementById('mobile-topic-select');
            if (mobileSelect) mobileSelect.value = topicValue;

            loadContent();
        }

        // é‡æ–°ç”Ÿæˆå…§å®¹ï¼ˆæ›ä¸€æ‰¹ï¼‰
        function regenerateContent() {
            // æŠŠç•¶å‰çš„å–®å­—åŠ å…¥æ’é™¤åˆ—è¡¨ï¼Œç¢ºä¿ä¸‹æ¬¡ä¸æœƒé‡è¤‡
            if (APP_STATE.words && APP_STATE.words.length > 0) {
                APP_STATE.words.forEach(w => {
                    if (!APP_STATE.historyData.includes(w.word)) {
                        APP_STATE.historyData.push(w.word);
                    }
                });
            }
            APP_STATE.currentIndex = 0;
            loadContent();
        }

        // é›£åº¦ç­‰ç´šè®Šæ›´æ™‚é‡æ–°è¼‰å…¥å…§å®¹
        function onLevelChange() {
            const level = document.getElementById('level-select').value;
            console.log('é›£åº¦åˆ‡æ›è‡³:', level);
            
            // æ¸…ç©ºç•¶å‰ session çš„æ­·å²ï¼ˆä½†ä¿ç•™æŒä¹…åŒ–çš„è¨˜éŒ„ï¼‰
            APP_STATE.historyData = [];
            APP_STATE.currentIndex = 0;
            
            // é‡æ–°è¼‰å…¥å…§å®¹
            loadContent();
        }

        // ===== Gemini API ç›´æ¥å‘¼å« (ä¸éœ€è¦ server.js) =====
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        // CEFR ç­‰ç´šæè¿°
        const LEVEL_DESCRIPTIONS = {
            'N5': 'é›¶åŸºç¤å…¥é–€ï¼Œå¹³å‡å/ç‰‡å‡åèˆ‡æœ€å¸¸ç”¨è©å½™ã€ç°¡å–®ã¾ã™å½¢',
            'N4': 'åŸºç¤æ—¥å¸¸å°è©±ï¼ŒåŸºæœ¬èªæ³•ï¼ˆã¦å½¢ã€ãªã„å½¢ï¼‰èˆ‡å¸¸ç”¨è©å½™',
            'N3': 'ä¸­ç´šæ—¥å¸¸èˆ‡æ—…éŠï¼Œè¼ƒé•·å¥å­ã€å¸¸è¦‹æ•¬èªã€é–±è®€çŸ­æ–‡',
            'N2': 'ä¸­é«˜ç´šè·å ´èˆ‡æ–°èï¼Œè¤‡é›œå¥å‹èˆ‡æ•¬èªè¡¨é”',
            'N1': 'é«˜éšé–±è®€èˆ‡å°ˆæ¥­å ´åˆï¼Œé•·å¥ã€ç´°è†©èªæ„Ÿ',
            'SURVIVAL': 'æ—…æ—¥ç”Ÿå­˜å¿…å‚™ï¼šäº¤é€šã€è³¼ç‰©ã€ç·Šæ€¥æ±‚åŠ©ã€ç°¡æ˜“æ•¬èªï¼Œå¥å­çŸ­æ˜“ç”¨',
            'TRAVEL_PLUS': 'è§€å…‰é€²éšï¼šè¨‚æˆ¿ã€é¤å»³å®¢è¨´ã€å•è·¯ç´°ç¯€ã€æ™¯é»å°è©±ã€æ¨è–¦è©¢å•',
            'BIZ_KEIGO': 'è·å ´æ•¬èªï¼šé›»è©±æ‡‰å°ã€æœƒè­°è¡¨é”ã€å®¢æˆ¶æ‡‰å°ã€ç·©è¡èªèˆ‡é“æ­‰',
            'CASUAL': 'æ—¥å¸¸ä¿—èªï¼šæœ‹å‹èŠå¤©ã€ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°ã€è¼•é¬†å£èªï¼Œæ³¨æ„å ´åˆ',
            'IT_DEV': 'IT/å·¥ç¨‹ï¼šé–‹ç™¼å”ä½œã€éœ€æ±‚æºé€šã€ç°¡æ˜“æŠ€è¡“ç”¨èªï¼ˆå‰ç«¯/å¾Œç«¯/infraï¼‰',
            'KANA_HIRA': 'å°ˆæ³¨å¹³å‡åäº”åéŸ³ï¼Œæ¸…éŸ³/æ¿éŸ³/æ‹—éŸ³ï¼Œè¼¸å‡ºä»¥å‡åç‚ºä¸»',
            'KANA_KATA': 'å°ˆæ³¨ç‰‡å‡åäº”åéŸ³èˆ‡å¤–ä¾†èªç™¼éŸ³ï¼Œè¼¸å‡ºä»¥ç‰‡å‡åç‚ºä¸»',
            'CONVO': 'æœƒè©±æµæš¢åº¦å„ªå…ˆï¼Œæä¾›å¯è¤‡èª¦çš„çŸ­å¥èˆ‡æƒ…å¢ƒå°ç­”'
        };

        // éš¨æ©ŸæŒ‡ä»¤ï¼Œå¢åŠ å…§å®¹å¤šæ¨£æ€§
        const VARIETY_INSTRUCTIONS = [
            'Always include kana reading (hiragana/katakana) and short romaji.',
            'Mix easy and slightly tricky words learners often confuse.',
            'Prioritize real-life phrases usable in Japan right away.',
            'Add one onomatopoeia (æ“¬è²èª/æ“¬æ…‹èª) when appropriate.',
            'Give both polite (ã€œã¾ã™) and casual usages in examples when possible.',
            'Include at least one katakana loanword if the level allows.',
            'Highlight pitch-accent sensitive words in the notes field.',
            'Favor vocabulary that practices verb forms like ã¦å½¢/ãªã„å½¢/å¯èƒ½å½¢.',
            'Avoid textbook clichÃ©s; choose fresh, natural expressions.'
        ];

        // å–å¾—éš¨æ©ŸæŒ‡ä»¤
        function getRandomInstruction() {
            return VARIETY_INSTRUCTIONS[Math.floor(Math.random() * VARIETY_INSTRUCTIONS.length)];
        }

        // ç”¢ç”Ÿéš¨æ©Ÿç¨®å­å­—æ¯ï¼Œå¢åŠ è®ŠåŒ–
        function getRandomSeed() {
            const letters = 'abcdefghijklmnopqrstuvwxyz';
            const randomLetter = letters[Math.floor(Math.random() * letters.length)];
            const seeds = [
                `Start with words beginning with "${randomLetter.toUpperCase()}".`,
                `Avoid words starting with common letters like A, B, C, E, S, T.`,
                `Include at least one word with 3+ syllables.`,
                `Include words from different word families.`,
                `Mix formal and informal vocabulary.`,
                ''  // æœ‰æ™‚ä¸åŠ é™åˆ¶
            ];
            return seeds[Math.floor(Math.random() * seeds.length)];
        }

        // ç”Ÿæˆ Prompt
        function generatePrompt(type, topic, level, exclude, userMessage) {
            // å¦‚æœæ˜¯äº”åéŸ³å›ºå®šèª²ç¨‹ï¼Œç›´æ¥è·³é API
            if (isKanaMode(level, topic) && ['vocab', 'flashcard', 'quiz', 'typing', 'listening'].includes(type)) {
                return null;
            }

            const excludeText = (exclude && exclude.length > 0) ? exclude.join(", ") : "None";
            const levelDesc = LEVEL_DESCRIPTIONS[level] || LEVEL_DESCRIPTIONS['B1'];
            const randomInstruction = getRandomInstruction();
            const randomSeed = getRandomSeed();
            const timestamp = Date.now(); // å¢åŠ æ™‚é–“æˆ³ç¢ºä¿æ¯æ¬¡ä¸åŒ

            // å¸¸è¦‹å–®å­—é»‘åå–®ï¼ˆé¿å… AI ç¸½æ˜¯ç”Ÿæˆé€™äº›ï¼‰
            const commonWordsToAvoid = 'ã§ã™, ã¾ã™, ã¯ã„, ã„ã„ãˆ, ã“ã‚“ã«ã¡ã¯, ã•ã‚ˆã†ãªã‚‰, ã‚ã‚ŠãŒã¨ã†, ã”ã‚ã‚“ãªã•ã„, å­¦ç”Ÿ, å…ˆç”Ÿ, æ—¥æœ¬, æ±äº¬, æ°´, ã”é£¯, è¡Œã, æ¥ã‚‹, ã™ã‚‹, è¦‹ã‚‹, é£Ÿã¹ã‚‹, é£²ã‚€, è²·ã†, ã„ã‚‹, ã‚ã‚‹, ãã‚Œã„, å¤§ãã„, å°ã•ã„';

            // é‡å°ä¸åŒç­‰ç´šçš„é¡å¤–æŒ‡ç¤º
            const examInstructions = {
                'N5': 'Keep vocabulary simple, mostly kana + very common kanji with furigana. Use short ã§ã™/ã¾ã™ examples.',
                'N4': 'Use everyday verbs with ã¦å½¢/ãªã„å½¢ examples, keep sentences short.',
                'N3': 'Include casual vs polite contrast and common set phrases.',
                'N2': 'Add keigo or semi-formal wording, slightly longer sentences.',
                'N1': 'Include nuanced or idiomatic expressions; add a short note about nuance.',
                'KANA_HIRA': 'Only use hiragana (no kanji). Cover gojÅ«on, dakuten, and youon combinations.',
                'KANA_KATA': 'Use katakana loanwords and onomatopoeia. Avoid hiragana except unavoidable particles.',
                'CONVO': 'Prioritize short, repeatable conversational chunks useful in real talk.'
            };
            const extraInstruction = examInstructions[level] || '';

            switch (type) {
                case 'vocab':
                    return `You are an expert Japanese teacher for Traditional Chinese speakers. Generate UNIQUE Japanese vocabulary with kana.

**Context:**
- Topic: "${topic}"
- Level: ${level} (${levelDesc})
- Request ID: ${timestamp} (generate different words each time)
${extraInstruction ? `\n**FOCUS:** ${extraInstruction}` : ''}

**IMPORTANT EXCLUSIONS - Do NOT use these words:**
- Already learned: [${excludeText}]
- Too common/basic: [${commonWordsToAvoid}]

**Special Instructions for variety:**
- ${randomInstruction}
- ${randomSeed}

**Conversation Goal:** Pick vocabulary that helps the learner talk with Japanese people naturally. Examples must sound like real dialogue lines a native might say in daily life. Include politeness/å ´é¢ tips in notes when relevant.

**Task:** Generate exactly 5 UNIQUE Japanese vocabulary items that:
1. Fit the topic "${topic}" and level ${level}
2. Include kana reading and romaji
3. Avoid all exclusions above
4. Are memorable and practical in Japan
5. Prefer real-life, natural expressions

**Output Format (JSON only, no markdown):**
{
    "title": "Topic title in Japanese",
    "words": [
        {
            "word": "æ—¥æœ¬èªã®å˜èªï¼ˆæ¼¢å­—å¯ã€‚KANA level must use kana onlyï¼‰",
            "kana": "ã‹ãª or ã‚«ãƒŠ",
            "romaji": "romaji reading",
            "pos": "è©æ€§ (åè©/å‹•è©/å½¢å®¹è©/å¥å‹...)",
            "mean": "ç¹é«”ä¸­æ–‡è§£é‡‹ï¼ˆç°¡æ½”ï¼‰",
            "example": "è‡ªç„¶çš„æ—¥æ–‡ä¾‹å¥ï¼Œç›¡é‡å«å‡åèˆ‡å¸¸ç”¨å¥å‹",
            "trans": "ä¾‹å¥çš„ç¹é«”ä¸­æ–‡ç¿»è­¯",
            "notes": "å¯é¸ï¼šç™¼éŸ³æˆ–æ•¬èª/èªæ„Ÿæç¤º"
        }
    ]
}`;

                case 'grammar':
                    return `You are an expert Japanese grammar teacher creating interactive quiz content.

**Context:**
- Grammar Topic: "${topic}"
- Level: ${level} (${levelDesc})
- Previously used content to avoid: [${excludeText}]

**Task:** Create a grammar lesson with 3 quiz questions for Japanese learners (Traditional Chinese UI).

**Output Format (JSON only, no markdown):**
{
    "concept": "æ—¥æ–‡æ–‡æ³•æ¦‚å¿µ (Japanese)",
    "explanation": "æ¸…æ™°çš„ç¹é«”ä¸­æ–‡è§£é‡‹ï¼ŒåŒ…å«ç”¨æ³•èˆ‡å¸¸è¦‹éŒ¯èª¤",
    "example_sentences": ["Example 1 (Japanese)", "Example 2 (Japanese)"],
    "quiz": [
        {
            "question": "å¡«ç©ºæˆ–é¸æ“‡é¡Œï¼ˆæ—¥æ–‡å¥å­ï¼Œå¯å«ä¸­æ–‡æç¤ºï¼‰",
            "options": ["option1", "option2", "option3", "option4"],
            "answer": 2,
            "reason": "ç¹é«”ä¸­æ–‡èªªæ˜ç‚ºä»€éº¼æ­£ç¢º"
        }
    ]
}`;

                case 'chat':
                    // å¼·åŒ–ç‰ˆ AI å°è©±æ•™ç·´
                    return `You are a native Japanese speaker working as a professional Japanese conversation coach. You're roleplaying in a specific scenario to help learners practice REAL Japanese conversation.

**Current Scenario:** ${topic}
**Learner's Level:** ${level} (${levelDesc})
**Learner said:** "${userMessage}"

## STEP 1: Language Detection
Detect what language the learner is using:
- **Traditional Chinese (ç¹é«”ä¸­æ–‡)** â†’ set "isChinese": true
- **Japanese (æ—¥æœ¬èª)** â†’ set "isChinese": false  
- **English or mixed** â†’ set "isChinese": true (help them learn the Japanese)

## STEP 2A: If isChinese = true (Teaching Mode)
The learner wants to learn how to say something in Japanese. Your job:

1. **Translate naturally** - Don't be too formal/textbook-like. Use what real Japanese people would say in this ${topic} scenario.
2. **Provide 2-3 alternative expressions** when relevant (casual vs polite, short vs long)
3. **Highlight key vocabulary** with readings
4. **Explain the grammar pattern** simply
5. **Continue the roleplay** - respond as if you're the other person in this scenario
6. **Give a practice sentence** - suggest what they might say next in the conversation

## STEP 2B: If isChinese = false (Practice Mode)
The learner is practicing Japanese. Respond naturally as the other person in this scenario, then:

1. **Reply in-character** - Be a real Japanese person (shop staff, friend, etc.)
2. **Score fairly (0-100):**
   - Grammar (30pts): particles, verb forms, sentence structure
   - Vocabulary (30pts): appropriate words for context  
   - Naturalness (25pts): sounds like a native? right politeness level?
   - Completeness (15pts): fully expresses the meaning?
3. **Give specific feedback** - point out exact errors and how to fix them
4. **Suggest improvements** - show a better/more natural way to say it
5. **Continue the conversation** - keep the roleplay going

## Scoring Standards (IMPORTANT - vary scores based on actual quality):
- 95-100: Perfect, native-level, no errors
- 85-94: Excellent, very minor issues
- 75-84: Good, some errors but natural
- 65-74: OK, understandable but needs work
- 50-64: Weak, many errors
- Below 50: Major issues, hard to understand

## OUTPUT FORMAT (JSON only, no markdown):

If isChinese = true:
{
    "isChinese": true,
    "japanese": "æœ€è‡ªç„¶çš„æ—¥æ–‡è¡¨é”æ–¹å¼",
    "kana": "å®Œæ•´å‡åæ¨™è¨»",
    "romaji": "ç¾…é¦¬æ‹¼éŸ³",
    "alternatives": ["å…¶ä»–èªªæ³•1", "å…¶ä»–èªªæ³•2"],
    "keyVocab": [
        {"word": "å–®å­—", "reading": "ã‚ˆã¿ã‹ãŸ", "meaning": "æ„æ€"}
    ],
    "grammarPoint": "ä½¿ç”¨çš„æ–‡æ³•èªªæ˜ï¼ˆç¹é«”ä¸­æ–‡ï¼Œç°¡çŸ­æ˜“æ‡‚ï¼‰",
    "pronunciation": "ç™¼éŸ³é‡é»æç¤º",
    "reply": "ç¹¼çºŒå°è©±çš„æ—¥æ–‡å›è¦†ï¼ˆä½œç‚ºå ´æ™¯ä¸­çš„å¦ä¸€æ–¹ï¼‰",
    "replyKana": "å›è¦†çš„å‡å",
    "chinese": "å›è¦†çš„ç¹é«”ä¸­æ–‡ç¿»è­¯",
    "nextSuggestion": "å»ºè­°å­¸ç¿’è€…æ¥ä¸‹ä¾†å¯ä»¥èªªçš„å¥å­ï¼ˆæ—¥æ–‡ï¼‰",
    "nextSuggestionChinese": "å»ºè­°å¥å­çš„ä¸­æ–‡æ„æ€",
    "cultureTip": "ç›¸é—œçš„æ—¥æœ¬æ–‡åŒ–å°çŸ¥è­˜ï¼ˆé¸å¡«ï¼Œå¦‚æœæœ‰çš„è©±ï¼‰"
}

If isChinese = false:
{
    "isChinese": false,
    "reply": "ä½ çš„æ—¥æ–‡å›è¦†ï¼ˆä¿æŒè§’è‰²æ‰®æ¼”ï¼Œè‡ªç„¶å°è©±ï¼‰",
    "replyKana": "å›è¦†çš„å‡å",
    "chinese": "å›è¦†çš„ç¹é«”ä¸­æ–‡ç¿»è­¯",
    "score": å…·é«”åˆ†æ•¸(0-100),
    "scoreBreakdown": {
        "grammar": åˆ†æ•¸,
        "vocabulary": åˆ†æ•¸,
        "naturalness": åˆ†æ•¸,
        "completeness": åˆ†æ•¸
    },
    "feedback": "å…·é«”çš„è©•èªï¼ˆç¹é«”ä¸­æ–‡ï¼‰- èªªæ˜å“ªè£¡åšå¾—å¥½ï¼Œå“ªè£¡éœ€è¦æ”¹é€²",
    "correction": "å¦‚æœæœ‰éŒ¯èª¤ï¼Œé€™è£¡æ”¾æ­£ç¢ºçš„èªªæ³•",
    "betterWay": "æ›´è‡ªç„¶çš„èªªæ³•ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰",
    "nextSuggestion": "å»ºè­°æ¥ä¸‹ä¾†å¯ä»¥èªªçš„æ—¥æ–‡",
    "nextSuggestionChinese": "å»ºè­°çš„ä¸­æ–‡æ„æ€"
}

## CRITICAL REMINDERS:
- Stay in character for the ${topic} scenario throughout
- Use appropriate politeness level (åº—å“¡èªªæ•¬èªã€æœ‹å‹ç”¨æ™®é€šå½¢)
- Give varied, honest scores - NOT always 75-85
- Be encouraging but truthful about errors
- Make the conversation feel REAL and practical
}`;

                default:
                    return `Generate a simple greeting in JSON format: {"message": "Hello!"}`;
            }
        }

        // å‘¼å« Gemini API
        async function callGeminiAPI(prompt) {
            let response;
            try {
                response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 1.0,
                            topP: 0.95,
                            topK: 40,
                            maxOutputTokens: 2048
                        }
                    })
                });
            } catch (fetchError) {
                // ç¶²è·¯è«‹æ±‚æœ¬èº«å¤±æ•—
                console.error('Fetch éŒ¯èª¤:', fetchError);
                if (window.location.protocol === 'file:') {
                    throw new Error('è«‹ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨é–‹å•Ÿæ­¤é é¢ï¼ˆä¸è¦ç›´æ¥é–‹å•Ÿ HTML æª”æ¡ˆï¼‰\n\nè§£æ±ºæ–¹æ³•ï¼š\n1. å®‰è£ VS Code çš„ Live Server\n2. æˆ–åŸ·è¡Œ: python -m http.server 8080');
                }
                throw new Error(`ç¶²è·¯è«‹æ±‚å¤±æ•—: ${fetchError.message}\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå’Œ API Key`);
            }
                
            if (!response.ok) {
                let errorMsg = 'API å‘¼å«å¤±æ•—';
                try {
                    const error = await response.json();
                    errorMsg = error.error?.message || `HTTP ${response.status}`;
                    if (response.status === 400) {
                        errorMsg = 'API Key ç„¡æ•ˆæˆ–è«‹æ±‚æ ¼å¼éŒ¯èª¤';
                    } else if (response.status === 403) {
                        errorMsg = 'API Key æ²’æœ‰æ¬Šé™ï¼Œè«‹ç¢ºèªå·²å•Ÿç”¨ Gemini API';
                    } else if (response.status === 429) {
                        errorMsg = 'API è«‹æ±‚æ¬¡æ•¸è¶…éé™åˆ¶ï¼Œè«‹ç¨å¾Œå†è©¦';
                    }
                } catch (e) {}
                throw new Error(errorMsg);
            }

            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            
            // æ¸…ç† JSONï¼ˆç§»é™¤ markdown æ¨™è¨˜ï¼‰
            let cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const firstBrace = cleanText.indexOf('{');
            const lastBrace = cleanText.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace !== -1) {
                cleanText = cleanText.substring(firstBrace, lastBrace + 1);
            }
            
            return JSON.parse(cleanText);
        }

        // Fisher-Yates shuffle for better randomness
        function shuffleArray(arr) {
            const result = [...arr];
            for (let i = result.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result;
        }

        // ===== å…§å®¹è¼‰å…¥ =====
        async function loadContent() {
            if (APP_STATE.currentMode === 'chat') {
                initChat();
                return;
            }

            document.getElementById('loading').classList.remove('hidden');

            try {
                const level = document.getElementById('level-select').value;
                const topic = APP_STATE.currentTopic;
                const isKana = isKanaMode(level, topic);

                // äº”åéŸ³å›ºå®šå¡ç‰‡ï¼šç›´æ¥è¼‰å…¥æœ¬åœ°è³‡æ–™
                if (isKana) {
                    const deck = getKanaDeck(level);
                    APP_STATE.words = deck;
                    APP_STATE.kanaStart = APP_STATE.kanaStart || 0;
                    APP_STATE.historyData = [];
                    APP_STATE.currentIndex = 0;
                    renderCurrentMode();
                } else {
                    const type = ['flashcard', 'quiz', 'typing', 'listening'].includes(APP_STATE.currentMode) 
                        ? 'vocab' 
                        : APP_STATE.currentMode;
                    
                    // åˆä½µæŒä¹…åŒ–çš„å­¸ç¿’è¨˜éŒ„ + ç•¶å‰ session çš„è¨˜éŒ„
                    const persistentHistory = getLearnedWordsForTopic(APP_STATE.currentTopic);
                    const persistentGrammar = getLearnedGrammarForTopic(APP_STATE.currentTopic);
                    const allExcludedWords = [...new Set([...persistentHistory, ...APP_STATE.historyData])];
                    const allExcludedGrammar = [...new Set([...(APP_STATE.grammarHistory || []), ...persistentGrammar])];
                    
                    const prompt = generatePrompt(
                        type,
                        APP_STATE.currentTopic,
                        document.getElementById('level-select').value,
                        type === 'grammar' ? allExcludedGrammar : allExcludedWords
                    );

                    const data = await callGeminiAPI(prompt);
                    
                    if (data.words) {
                        APP_STATE.words = shuffleArray(data.words);
                        APP_STATE.words.forEach(w => {
                            APP_STATE.historyData.push(w.word);
                            trimArray(APP_STATE.historyData, 400);
                        });
                        APP_STATE.currentIndex = 0;
                        renderCurrentMode();
                    } else if (data.concept) {
                        // è¨˜éŒ„æ–‡æ³•æ¦‚å¿µï¼Œé¿å…é‡è¤‡
                        const concept = stripHtml(data.concept);
                        APP_STATE.grammarHistory.push(concept);
                        trimArray(APP_STATE.grammarHistory, 400);
                        saveLearnedGrammar(concept, APP_STATE.currentTopic);
                        renderGrammar(data);
                    }
                }

            } catch (e) {
                console.error(e);
                alert('è¼‰å…¥å¤±æ•—ï¼š' + e.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderCurrentMode() {
            updateProgress();
            
            switch (APP_STATE.currentMode) {
                case 'kana':
                    renderKana();
                    break;
                case 'flashcard':
                    renderFlashcard();
                    break;
                case 'quiz':
                    renderQuiz();
                    break;
                case 'typing':
                    renderTyping();
                    break;
                case 'listening':
                    renderListening();
                    break;
            }
        }

        // åˆ¤æ–·æ˜¯å¦ç‚ºäº”åéŸ³æ¨¡å¼
        function isKanaMode(level, topic) {
            return APP_STATE.currentMode === 'kana';
        }

        // å–å¾—å°æ‡‰çš„äº”åéŸ³å¡ç‰‡
        function getKanaDeck(level) {
            if (level === 'KANA_KATA') return KANA_DECKS.katakana;
            return KANA_DECKS.hiragana;
        }


        function updateProgress() {
            const total = Math.max(APP_STATE.words.length, 1);
            const current = Math.min(APP_STATE.currentIndex + 1, total);
            document.getElementById('current-idx').textContent = current;
            document.getElementById('total-items').textContent = total;
            document.getElementById('session-bar').style.width = (current / total * 100) + '%';
        }

        // ===== é–ƒå¡æ¨¡å¼ =====
        // æ¸…é™¤ HTML æ¨™ç±¤ï¼ˆAPI æœ‰æ™‚æœƒå›å‚³å¸¶æ¨™ç±¤çš„å…§å®¹ï¼‰
        function stripHtml(text) {
            if (!text) return '';
            return text.replace(/<[^>]*>/g, '').trim();
        }

        function renderFlashcard() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            // é‡ç½®ç¿»è½‰ç‹€æ…‹
            document.querySelector('.flashcard').classList.remove('flipped');
            APP_STATE.isFlipped = false;

            // æ­£é¢å…§å®¹
            document.getElementById('card-word').textContent = stripHtml(word.word);
            document.getElementById('card-pos').textContent = stripHtml(word.pos) || 'å–®å­—';
            
            // å‡åé¡¯ç¤º - å¦‚æœæœ‰çš„è©±
            const kanaEl = document.getElementById('card-kana');
            if (word.kana && stripHtml(word.kana)) {
                kanaEl.textContent = stripHtml(word.kana);
                kanaEl.style.display = 'block';
            } else {
                kanaEl.style.display = 'none';
            }
            
            // ç¾…é¦¬éŸ³é¡¯ç¤º - æ›´æ¸…æ™°çš„æ ¼å¼
            const romajiEl = document.getElementById('card-romaji');
            if (word.romaji && stripHtml(word.romaji)) {
                romajiEl.textContent = `[${stripHtml(word.romaji)}]`;
                romajiEl.style.display = 'block';
            } else {
                romajiEl.style.display = 'none';
            }
            
            // èƒŒé¢å…§å®¹
            document.getElementById('card-mean').textContent = stripHtml(word.mean);
            
            // ä¾‹å¥ - ç§»é™¤å¼•è™Ÿï¼Œæ›´è‡ªç„¶çš„é¡¯ç¤º
            const example = stripHtml(word.example);
            if (example) {
                document.getElementById('card-example').textContent = example;
                document.getElementById('card-example').style.display = 'block';
            } else {
                document.getElementById('card-example').textContent = 'ï¼ˆç„¡ä¾‹å¥ï¼‰';
                document.getElementById('card-example').style.opacity = '0.5';
            }
            
            // ç¿»è­¯
            const trans = stripHtml(word.trans);
            if (trans) {
                document.getElementById('card-trans').textContent = trans;
                document.getElementById('card-trans').style.display = 'block';
            } else {
                document.getElementById('card-trans').textContent = '';
                document.getElementById('card-trans').style.display = 'none';
            }
            
            // å‚™è¨»
            const notes = stripHtml(word.notes);
            if (notes) {
                document.getElementById('card-notes').textContent = `ğŸ’¡ ${notes}`;
                document.getElementById('card-notes').style.display = 'block';
            } else {
                document.getElementById('card-notes').textContent = '';
                document.getElementById('card-notes').style.display = 'none';
            }
        }

        function flipCard() {
            const card = document.querySelector('.flashcard');
            card.classList.toggle('flipped');
            APP_STATE.isFlipped = !APP_STATE.isFlipped;
        }

        function rateCard(rating) {
            let xp = 0;
            switch (rating) {
                case 'hard': xp = 5; break;
                case 'good': xp = 10; break;
                case 'easy': xp = 15; break;
            }
            
            addXP(xp);
            
            // è¨˜éŒ„å­¸éçš„å–®å­—ï¼ˆæŒä¹…åŒ–å„²å­˜ï¼‰
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                saveLearnedWord(word.word, APP_STATE.currentTopic);
            }

            nextWord();
        }

        // ===== é¸æ“‡é¡Œæ¨¡å¼ =====
        function renderQuiz() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            APP_STATE.isAnswered = false;
            
            // é¡¯ç¤ºå–®å­—
            document.getElementById('quiz-word').textContent = stripHtml(word.word);
            
            // é¡¯ç¤ºå‡å
            const kanaEl = document.getElementById('quiz-kana');
            if (word.kana && stripHtml(word.kana)) {
                kanaEl.textContent = stripHtml(word.kana);
                kanaEl.style.display = 'block';
            } else {
                kanaEl.style.display = 'none';
            }
            
            // é¡¯ç¤ºç¾…é¦¬éŸ³
            const romajiEl = document.getElementById('quiz-romaji');
            if (word.romaji && stripHtml(word.romaji)) {
                romajiEl.textContent = `[${stripHtml(word.romaji)}]`;
                romajiEl.style.display = 'block';
            } else {
                romajiEl.style.display = 'none';
            }
            
            document.getElementById('quiz-feedback').classList.add('hidden');
            document.getElementById('quiz-hint').classList.add('hidden');
            document.getElementById('quiz-hint-btn').classList.remove('hidden');

            // ç”Ÿæˆé¸é … (1å€‹æ­£ç¢º + 3å€‹éŒ¯èª¤)
            const correctAnswer = stripHtml(word.mean);
            const options = [correctAnswer];
            
            // å¾å…¶ä»–å–®å­—ä¸­éš¨æ©Ÿé¸æ“‡éŒ¯èª¤é¸é …
            const otherWords = APP_STATE.words.filter((w, i) => i !== APP_STATE.currentIndex);
            const usedMeanings = new Set([correctAnswer]);
            
            while (options.length < 4 && otherWords.length > 0) {
                const randomIdx = Math.floor(Math.random() * otherWords.length);
                const wrongAnswer = stripHtml(otherWords[randomIdx].mean);
                
                if (!usedMeanings.has(wrongAnswer) && wrongAnswer && wrongAnswer !== correctAnswer) {
                    options.push(wrongAnswer);
                    usedMeanings.add(wrongAnswer);
                }
                otherWords.splice(randomIdx, 1);
            }

            // è£œè¶³é¸é …ï¼ˆå¦‚æœé‚„ä¸å¤ 4å€‹ï¼‰
            const fillers = ['è˜‹æœ', 'æ›¸æœ¬', 'é›»è…¦', 'éŸ³æ¨‚', 'åŸå¸‚', 'å­¸æ ¡', 'æœ‹å‹', 'æ™‚é–“', 'å¤©æ°£', 'é£Ÿç‰©'];
            let fillerIndex = 0;
            while (options.length < 4 && fillerIndex < fillers.length) {
                const filler = fillers[fillerIndex];
                if (!usedMeanings.has(filler) && filler !== correctAnswer) {
                    options.push(filler);
                    usedMeanings.add(filler);
                }
                fillerIndex++;
            }

            // ä½¿ç”¨ Fisher-Yates æ´—ç‰Œç®—æ³•ç¢ºä¿çœŸæ­£éš¨æ©Ÿ
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }

            // ç¢ºä¿æ­£ç¢ºç­”æ¡ˆå·²ç¶“è¢«æ­£ç¢ºè™•ç†å’Œæ´—ç‰Œ
            const correctAnswerClean = stripHtml(word.mean);
            
            document.getElementById('quiz-options').innerHTML = options.map((opt, i) => {
                const cleanOpt = stripHtml(String(opt)).trim();
                // æ‰€æœ‰é¸é …ä½¿ç”¨å®Œå…¨ç›¸åŒçš„æ¨£å¼ï¼Œæ²’æœ‰ä»»ä½•è¦–è¦ºå€åˆ¥
                // ä½¿ç”¨ data å±¬æ€§å­˜å„²é¸é …å€¼ï¼Œé¿å…åœ¨ onclick ä¸­æš´éœ²
                return `
                <button onclick="checkQuizAnswer(this, '${cleanOpt.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${correctAnswerClean.replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" 
                    class="btn-option w-full py-4 rounded-2xl px-6 text-lg font-bold hover:scale-[1.01] transition-all shadow-md hover:shadow-lg"
                    data-option="${cleanOpt.replace(/"/g, '&quot;')}">
                    <span class="flex-shrink-0 inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 text-indigo-700 font-bold mr-4 text-base">${i + 1}</span>
                    <span class="flex-1 text-left leading-relaxed">${cleanOpt}</span>
                </button>
                `;
            }).join('');
        }

        // é¡¯ç¤ºæ¸¬é©—æç¤º
        function showQuizHint() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;
            
            let hint = '';
            if (word.kana) hint += `è®€éŸ³ï¼š${word.kana}`;
            if (word.romaji) hint += (hint ? ' / ' : '') + word.romaji;
            if (word.example) hint += `<br>ä¾‹å¥ï¼š${word.example}`;
            if (word.notes) hint += `<br>ğŸ’¡ ${word.notes}`;
            
            if (!hint) hint = 'é€™é¡Œæ²’æœ‰é¡å¤–æç¤ºï¼Œç›¸ä¿¡è‡ªå·±ï¼';
            
            document.getElementById('quiz-hint').innerHTML = hint;
            document.getElementById('quiz-hint').classList.remove('hidden');
            document.getElementById('quiz-hint-btn').classList.add('hidden');
            
            // ä½¿ç”¨æç¤ºæ‰£ XP
            addXP(-2);
        }

        function checkQuizAnswer(btn, selected, correct) {
            if (APP_STATE.isAnswered) return;
            APP_STATE.isAnswered = true;

            const isCorrect = selected === correct;
            userData.totalAnswered++;
            APP_STATE.roundTotal++;
            if (isCorrect) {
                userData.totalCorrect++;
                APP_STATE.roundCorrect++;
            } else {
                // è¨˜éŒ„éŒ¯é¡Œ
                const currentWord = APP_STATE.words[APP_STATE.currentIndex];
                if (currentWord && !APP_STATE.mistakes.find(m => m.word === currentWord.word)) {
                    APP_STATE.mistakes.push(currentWord);
                }
            }
            saveUserData();

            if (isCorrect) {
                btn.classList.add('correct');
                playSound('correct');
                addXP(10);
                showFeedback('quiz-feedback', true, 'ç­”å°äº†ï¼', '');
            } else {
                btn.classList.add('wrong');
                playSound('wrong');
                showFeedback('quiz-feedback', false, 'å†æƒ³æƒ³...', `æ­£ç¢ºç­”æ¡ˆï¼š${correct}`);
                
                // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆï¼ˆåªåœ¨ç­”éŒ¯æ™‚é¡¯ç¤ºï¼Œä½¿ç”¨æ›´ç²¾ç¢ºçš„åŒ¹é…ï¼‰
                const correctText = stripHtml(correct).trim();
                document.querySelectorAll('#quiz-options button').forEach(b => {
                    // å¾æŒ‰éˆ•æ–‡æœ¬ä¸­æå–é¸é …å…§å®¹ï¼ˆç§»é™¤ç·¨è™Ÿå’Œç©ºç™½ï¼‰
                    const btnText = b.textContent.trim().replace(/^\d+\s*/, '').trim();
                    const btnDataOption = b.dataset.option ? b.dataset.option.trim() : '';
                    // åŒ¹é…æŒ‰éˆ•æ–‡æœ¬æˆ– data å±¬æ€§
                    if (btnText === correctText || btnDataOption === correctText) {
                        b.classList.add('correct');
                    }
                });
            }

            setTimeout(nextWord, 1500);
        }

        // ===== æ‹¼å¯«æ¨¡å¼ =====
        function renderTyping() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            APP_STATE.isAnswered = false;
            // åªé¡¯ç¤ºä¸­æ–‡æ„æ€ä½œç‚ºæç¤ºï¼Œä¸é¡¯ç¤ºä»»ä½•ç­”æ¡ˆç›¸é—œä¿¡æ¯
            document.getElementById('typing-hint').textContent = stripHtml(word.mean);
            // åªé¡¯ç¤ºè©æ€§ï¼Œä¸é¡¯ç¤ºå‡åæˆ–ç¾…é¦¬éŸ³ï¼ˆé¿å…æš´éœ²ç­”æ¡ˆï¼‰
            document.getElementById('typing-pos').textContent = stripHtml(word.pos) || 'å–®å­—';
            document.getElementById('typing-input').value = '';
            document.getElementById('typing-feedback').classList.add('hidden');
            document.getElementById('typing-input').focus();
        }

        function checkTyping() {
            if (APP_STATE.isAnswered) return;
            
            const word = APP_STATE.words[APP_STATE.currentIndex];
            const input = document.getElementById('typing-input').value.trim().toLowerCase();
            const answers = [word.word, word.kana, word.romaji].filter(Boolean).map(v => v.trim().toLowerCase());

            APP_STATE.isAnswered = true;
            userData.totalAnswered++;
            APP_STATE.roundTotal++;

            if (answers.includes(input)) {
                userData.totalCorrect++;
                APP_STATE.roundCorrect++;
                saveUserData();
                playSound('correct');
                addXP(15);
                showFeedback('typing-feedback', true, 'å®Œç¾ï¼', '');
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
            } else {
                // è¨˜éŒ„éŒ¯é¡Œ
                if (!APP_STATE.mistakes.find(m => m.word === word.word)) {
                    APP_STATE.mistakes.push(word);
                }
                saveUserData();
                playSound('wrong');
                // ç­”éŒ¯æ™‚é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆï¼Œä½†æ ¼å¼æ›´æ¸…æ™°
                const answerDisplay = word.kana 
                    ? `${word.word}ï¼ˆ${word.kana}${word.romaji ? ` / ${word.romaji}` : ''}ï¼‰`
                    : word.word;
                showFeedback('typing-feedback', false, 'å·®ä¸€é»ï¼', `æ­£ç¢ºç­”æ¡ˆï¼š${answerDisplay}`);
            }

            setTimeout(nextWord, 1500);
        }

        // ===== è½åŠ›æ¨¡å¼ =====
        function renderListening() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            APP_STATE.isAnswered = false;
            document.getElementById('listening-feedback').classList.add('hidden');

            // ç”Ÿæˆé¸é …
            const correctWord = word.kana || word.word;
            const options = [correctWord];
            const otherWords = APP_STATE.words.filter((w, i) => i !== APP_STATE.currentIndex);
            while (options.length < 4 && otherWords.length > 0) {
                const idx = Math.floor(Math.random() * otherWords.length);
                const candidate = otherWords[idx].kana || otherWords[idx].word;
                if (!options.includes(candidate)) {
                    options.push(candidate);
                }
                otherWords.splice(idx, 1);
            }
            options.sort(() => Math.random() - 0.5);

            document.getElementById('listening-options').innerHTML = options.map((opt, i) => `
                <button onclick="checkListeningAnswer(this, '${stripHtml(opt).replace(/'/g, "\\'")}', '${stripHtml(correctWord).replace(/'/g, "\\'")}')" 
                    class="btn-option w-full py-6 rounded-2xl text-xl font-bold hover:scale-[1.02] transition-all shadow-md hover:shadow-lg">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-cyan-100 text-cyan-700 font-bold mr-4">${i + 1}</span>
                    ${stripHtml(opt)}
                </button>
            `).join('');

            // è‡ªå‹•æ’­æ”¾
            setTimeout(playListeningWord, 500);
        }

        function playListeningWord() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;
            
            // è½åŠ›æ¨¡å¼ç”¨è¼ƒæ…¢é€Ÿåº¦ï¼Œæ›´æ¸…æ™°
            const speakTarget = (word.kana && word.kana.trim()) ? word.kana.trim() : word.word.trim();
            if (speakTarget) {
                speakText(speakTarget, 0.65);  // ç¨æ…¢çš„é€Ÿåº¦ï¼Œæ–¹ä¾¿è½æ¸…æ¥š
                
                // é¡¯ç¤ºéŸ³æ³¢å‹•ç•«
                const soundWaves = document.getElementById('sound-waves');
                if (soundWaves) {
                    soundWaves.classList.remove('hidden');
                    setTimeout(() => {
                        if (soundWaves) soundWaves.classList.add('hidden');
                    }, 2000);
                }
            }
        }

        // è½åŠ›æ¨¡å¼é‡æ–°æ’­æ”¾ï¼ˆæ…¢é€Ÿï¼‰
        function replayListeningSlow() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                const speakTarget = (word.kana && word.kana.trim()) ? word.kana.trim() : word.word.trim();
                if (speakTarget) {
                    speakText(speakTarget, 0.4);  // è¶…æ…¢é€Ÿï¼Œæ–¹ä¾¿å­¸ç¿’
                }
            }
        }

        // æ’­æ”¾å°è©±è¨Šæ¯
        function speakChatMessage(btn, rate = 0.8) {
            const text = btn.dataset.text;
            if (text) {
                // é‚„åŸ HTML å¯¦é«”
                const decodedText = text.replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&amp;/g, '&');
                speakText(decodedText, rate);
            }
        }

        function checkListeningAnswer(btn, selected, correct) {
            if (APP_STATE.isAnswered) return;
            APP_STATE.isAnswered = true;

            userData.totalAnswered++;
            APP_STATE.roundTotal++;
            const isCorrect = selected === correct;
            if (isCorrect) {
                userData.totalCorrect++;
                APP_STATE.roundCorrect++;
            } else {
                // è¨˜éŒ„éŒ¯é¡Œ
                const currentWord = APP_STATE.words[APP_STATE.currentIndex];
                if (currentWord && !APP_STATE.mistakes.find(m => m.word === currentWord.word)) {
                    APP_STATE.mistakes.push(currentWord);
                }
            }
            saveUserData();

            if (isCorrect) {
                btn.classList.add('correct');
                playSound('correct');
                addXP(10);
                showFeedback('listening-feedback', true, 'è½åŠ›å¾ˆæ£’ï¼', '');
            } else {
                btn.classList.add('wrong');
                playSound('wrong');
                showFeedback('listening-feedback', false, 'å†è½ä¸€æ¬¡', `æ­£ç¢ºç­”æ¡ˆï¼š${correct}`);
            }

            setTimeout(nextWord, 1500);
        }

        // ===== æ–‡æ³•æ¨¡å¼ =====
        function renderGrammar(data) {
            document.getElementById('grammar-concept').textContent = stripHtml(data.concept);
            document.getElementById('grammar-explanation').textContent = stripHtml(data.explanation);

            document.getElementById('grammar-quiz').innerHTML = data.quiz.map((q, idx) => `
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 border-2 border-blue-200 shadow-lg mb-6">
                    <div class="flex items-start justify-between gap-3 mb-4">
                        <p class="text-xl font-bold text-gray-900 flex-1">Q${idx + 1}. ${stripHtml(q.question)}</p>
                        <button onclick="speakText('${stripHtml(q.question).replace(/'/g, "\\'")}', 0.9)" 
                            class="shrink-0 w-10 h-10 bg-amber-100 border border-amber-300 rounded-full flex items-center justify-center text-amber-700 hover:bg-amber-200 transition shadow-sm" 
                            title="æ’­æ”¾é¡Œç›®">
                            <i class="fa-solid fa-volume-high text-sm"></i>
                        </button>
                    </div>
                    <div class="space-y-3">
                        ${q.options.map((opt, i) => `
                            <button onclick="checkGrammarAnswer(this, ${i}, ${q.answer}, '${stripHtml(q.reason).replace(/'/g, "\\'")}')"
                                class="btn-option w-full py-4 px-6 rounded-xl text-left text-lg font-semibold hover:scale-[1.02] transition-all shadow-md hover:shadow-lg">
                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 font-bold mr-4">${String.fromCharCode(65 + i)}</span>
                                ${stripHtml(opt)}
                            </button>
                        `).join('')}
                    </div>
                    <div class="grammar-feedback hidden mt-4 p-4 rounded-xl text-base font-semibold"></div>
                </div>
            `).join('');
        }

        // Enhanced grammar render with shuffle + TTS + examples
        const renderGrammarOriginal = renderGrammar;
        renderGrammar = function (data) {
            const concept = stripHtml(data.concept);
            const explanation = stripHtml(data.explanation);
            document.getElementById('grammar-concept').textContent = concept;
            document.getElementById('grammar-explanation').textContent = explanation;

            // ä¾‹å¥å‘ˆç¾ï¼‹èªéŸ³
            const examples = Array.isArray(data.example_sentences) ? data.example_sentences : [];
            const exContainer = document.getElementById('grammar-examples');
            if (exContainer) {
                if (examples.length > 0) {
                    exContainer.innerHTML = examples.map((ex, i) => `
                        <div class="flex items-start gap-3 bg-white/5 rounded-xl px-3 py-2">
                            <span class="text-xs bg-blue-100 border border-blue-300 text-blue-700 px-2 py-1 rounded-full mt-0.5 font-bold">ä¾‹å¥ ${i + 1}</span>
                            <div class="flex-1">
                                <p class="text-sm text-gray-800 mb-1 font-semibold">${stripHtml(ex)}</p>
                                <div class="flex items-center gap-2 text-xs text-gray-700">
                                    <button onclick="speakText('${stripHtml(ex).replace(/'/g, "\\'")}', 0.9)" class="px-2 py-1 rounded-full bg-blue-100 border border-blue-300 text-blue-700 hover:bg-blue-200 transition shadow-sm font-semibold">
                                        <i class="fa-solid fa-volume-high mr-1"></i>æ’­æ”¾
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    exContainer.classList.remove('hidden');
                } else {
                    exContainer.innerHTML = '';
                    exContainer.classList.add('hidden');
                }
            }

            // é¡Œç›®èˆ‡é¸é …æ´—ç‰Œ
            const quizItems = shuffleArray(data.quiz || []);
            document.getElementById('grammar-quiz').innerHTML = quizItems.map((q, idx) => {
                const optionObjects = (q.options || []).map((opt, i) => ({ opt, i }));
                const shuffled = shuffleArray(optionObjects);
                const correctIndex = shuffled.findIndex(o => o.i === q.answer);

                const optionsHtml = shuffled.map((item, i) => `
                    <button 
                        onclick="checkGrammarAnswer(this, ${i}, ${correctIndex}, '${stripHtml(q.reason || '').replace(/'/g, "\\'")})"
                        data-correct="${i === correctIndex}"
                        class="btn-option w-full py-3 px-4 rounded-lg text-left text-sm">
                        <span class="font-bold text-blue-300 mr-2">(${i + 1})</span>${stripHtml(item.opt)}
                    </button>
                `).join('');

                return `
                <div class="bg-white/5 rounded-xl p-4">
                    <div class="flex items-start justify-between gap-3 mb-3">
                        <p class="font-bold flex-1">Q${idx + 1}. ${stripHtml(q.question)}</p>
                        <button onclick="speakText('${stripHtml(q.question).replace(/'/g, "\\'")}', 0.95)" class="shrink-0 w-9 h-9 bg-amber-100 border border-amber-300 rounded-full flex items-center justify-center text-amber-700 hover:bg-amber-200 transition shadow-sm" title="æ’­æ”¾é¡Œç›®">
                            <i class="fa-solid fa-volume-high text-sm"></i>
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${optionsHtml}
                    </div>
                    <div class="grammar-feedback hidden mt-3 p-3 rounded-lg text-sm"></div>
                </div>`;
            }).join('');
        };

        // ===== äº”åéŸ³æ¨¡å¼ =====
        function renderKana() {
            const container = document.getElementById('kana-grid');
            const extra = document.getElementById('kana-extra');
            if (!container) return;
            if (!extra) return;

            const deck = APP_STATE.words || [];
            const byKana = Object.fromEntries(deck.map(item => [(item.kana || item.word), item]));

            const H_PATTERN = [
                ['ã‚','ã„','ã†','ãˆ','ãŠ'],
                ['ã‹','ã','ã','ã‘','ã“'],
                ['ã•','ã—','ã™','ã›','ã'],
                ['ãŸ','ã¡','ã¤','ã¦','ã¨'],
                ['ãª','ã«','ã¬','ã­','ã®'],
                ['ã¯','ã²','ãµ','ã¸','ã»'],
                ['ã¾','ã¿','ã‚€','ã‚','ã‚‚'],
                ['ã‚„','','ã‚†','','ã‚ˆ'],
                ['ã‚‰','ã‚Š','ã‚‹','ã‚Œ','ã‚'],
                ['ã‚','ã‚','','ã‚‘','ã‚’'],
                ['ã‚“','','','',''],
                ['ã£','','','','']
            ];

            const K_PATTERN = [
                ['ã‚¢','ã‚¤','ã‚¦','ã‚¨','ã‚ª'],
                ['ã‚«','ã‚­','ã‚¯','ã‚±','ã‚³'],
                ['ã‚µ','ã‚·','ã‚¹','ã‚»','ã‚½'],
                ['ã‚¿','ãƒ','ãƒ„','ãƒ†','ãƒˆ'],
                ['ãƒŠ','ãƒ‹','ãƒŒ','ãƒ','ãƒ'],
                ['ãƒ','ãƒ’','ãƒ•','ãƒ˜','ãƒ›'],
                ['ãƒ','ãƒŸ','ãƒ ','ãƒ¡','ãƒ¢'],
                ['ãƒ¤','','ãƒ¦','','ãƒ¨'],
                ['ãƒ©','ãƒª','ãƒ«','ãƒ¬','ãƒ­'],
                ['ãƒ¯','ãƒ°','','ãƒ±','ãƒ²'],
                ['ãƒ³','','','',''],
                ['ãƒƒ','','','','']
            ];

            const pattern = deck.some(d => (d.kana || d.word).match(/^[ã‚¢-ãƒ³ãƒ´ãƒ¼ãƒ±ãƒ²ãƒ°ãƒƒ]/)) ? K_PATTERN : H_PATTERN;
            const script = pattern === K_PATTERN ? 'katakana' : 'hiragana';

            const rowsHtml = pattern.map(row => row.map(k => renderKanaCell(k, byKana)).join('')).join('');

            APP_STATE.currentIndex = 0; // é€²åº¦æ¢é¡¯ç¤º 1 / 50
            container.innerHTML = rowsHtml;
            extra.innerHTML = renderKanaExtra(byKana, script);
        }

        function speakKana(text, rate = 0.8) {
            if (!text) return;
            speakText(text, rate);
        }

        function renderKanaCell(k, byKana) {
            if (!k) {
                return `<div class="glass-card rounded-2xl p-4 text-center opacity-30">â€”</div>`;
            }
            const w = byKana[k];
            const text = k;
            const romaji = w?.romaji ? `ç¾…é¦¬éŸ³ï¼š${w.romaji}` : '';
            const mean = w?.mean || '';
            const notes = w?.notes || '';
            return `
            <div class="glass-card rounded-2xl p-4 text-center">
                <div class="text-sm px-3 py-1 rounded-full bg-blue-100 border border-blue-300 text-blue-700 inline-block mb-2 font-bold">å‡å</div>
                <div class="text-4xl md:text-5xl font-black mb-2 text-gray-900">${text}</div>
                <div class="text-sm text-gray-700 mb-1 font-semibold">${romaji}</div>
                <div class="text-base text-emerald-700 mb-1 font-bold">${mean}</div>
                <div class="text-xs text-amber-700 mb-2 font-semibold">${notes}</div>
                <div class="flex justify-center gap-2">
                    <button onclick="speakKana('${text}', 0.55)" class="w-9 h-9 bg-amber-100 border-2 border-amber-300 rounded-full flex items-center justify-center hover:scale-110 transition shadow-md" title="æ…¢é€Ÿ">
                        <i class="fa-solid fa-volume-low text-amber-700 text-sm"></i>
                    </button>
                    <button onclick="speakKana('${text}', 0.85)" class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center hover:scale-110 transition shadow-lg" title="æ’­æ”¾">
                        <i class="fa-solid fa-volume-high text-white"></i>
                    </button>
                </div>
            </div>`;
        }

        function renderKanaExtra(byKana, script) {
            const data = KANA_EXTRA[script];
            if (!data) return '';

            const block = (title, items) => {
                if (!items || items.length === 0) return '';
                const chunks = [];
                for (let i = 0; i < items.length; i += 5) {
                    chunks.push(items.slice(i, i + 5));
                }
                const dict = Object.fromEntries(items.map(it => [it.word, it]));
                const rows = chunks.map(row => row.map(k => k ? renderKanaCell(k.word, dict) : renderKanaCell('', {})).join('')).join('');
                return `
                <div class="mt-6">
                    <div class="text-sm font-bold text-emerald-700 mb-2">${title}</div>
                    <div class="grid grid-cols-5 gap-3 md:gap-4">
                        ${rows}
                    </div>
                </div>`;
            };

            return [
                block('æ¿éŸ³', data.dakuten),
                block('åŠæ¿éŸ³', data.handaku),
                block('æ‹—éŸ³', data.youon),
                block('ä¿ƒéŸ³', data.sokuon),
                block('é•·éŸ³', data.choon),
                block('ç‰¹æ®Šç™¼éŸ³', data.special)
            ].join('');
        }

        function checkGrammarAnswer(btn, selected, correct, reason) {
            const container = btn.closest('.space-y-2');
            const feedback = btn.closest('.bg-white\\/5').querySelector('.grammar-feedback');
            if (!container || !feedback) return;
            if (container.dataset.answered === 'true') return;
            container.dataset.answered = 'true';

            const buttons = Array.from(container.querySelectorAll('button'));
            const correctBtn = buttons.find(b => b.dataset.correct === 'true');

            if (selected === correct) {
                btn.classList.add('correct');
                playSound('correct');
                addXP(10);
                feedback.innerHTML = `<span class="text-green-400">âœ“ ${reason}</span>`;
            } else {
                btn.classList.add('wrong');
                if (correctBtn) correctBtn.classList.add('correct');
                playSound('wrong');
                feedback.innerHTML = `<span class="text-red-400">âœ— ${reason}</span>`;
            }
            feedback.classList.remove('hidden');

            // ç¦ç”¨æ‰€æœ‰é¸é …
            buttons.forEach(b => b.disabled = true);
        }

        // ===== AI å°è©±æ¨¡å¼ =====
        // å–å¾—ä¸»é¡Œçš„ä¸­æ–‡æ¨™ç±¤
        function getTopicLabel(value) {
            const topics = TOPICS[APP_STATE.currentMode] || [];
            const topic = topics.find(t => t.value === value);
            return topic ? topic.label : value;
        }

        // æƒ…å¢ƒå°è©±çš„ä¸­æ–‡æ­¡è¿èª - å®Œæ•´ç‰ˆ
        const CHAT_GREETINGS = {
            // === é¤é£²ç¾é£Ÿ ===
            'Japanese Coffee Shop': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚ã‚³ãƒ¼ãƒ’ãƒ¼ã¯ãƒ›ãƒƒãƒˆã¨ã‚¢ã‚¤ã‚¹ã€ã©ã¡ã‚‰ã«ã•ã‚Œã¾ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œå’–å•¡è¦ç†±çš„é‚„æ˜¯å†°çš„å‘¢ï¼Ÿ' },
            'Ramen shop': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ï¼é£Ÿåˆ¸ã¯ãŠè²·ã„æ±‚ã‚ã§ã™ã‹ï¼ŸãŠã™ã™ã‚ã¯é†¤æ²¹ãƒ©ãƒ¼ãƒ¡ãƒ³ã§ã™ã‚ˆã€‚', chinese: 'æ­¡è¿ï¼æœ‰å…ˆè²·é£Ÿåˆ¸å—ï¼Ÿæ¨è–¦é†¬æ²¹æ‹‰éºµå–”ã€‚' },
            'Sushi restaurant': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ï¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­ã¨ãƒ†ãƒ¼ãƒ–ãƒ«å¸­ã€ã©ã¡ã‚‰ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼è«‹å•è¦åå§æª¯é‚„æ˜¯æ¡Œå¸­ï¼Ÿ' },
            'Izakaya small talk': { greeting: 'ã“ã‚“ã°ã‚“ã¯ï¼ãŠé£²ã¿ç‰©ã¯ä½•ã«ã—ã¾ã™ã‹ï¼Ÿç”Ÿãƒ“ãƒ¼ãƒ«ã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ', chinese: 'æ™šä¸Šå¥½ï¼æƒ³å…ˆå–é»ä»€éº¼ï¼Ÿè¦ç”Ÿå•¤å—ï¼Ÿ' },
            'Convenience store in Japan': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚è¢‹ã¯ã”åˆ©ç”¨ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œéœ€è¦è³¼ç‰©è¢‹å—ï¼Ÿ' },
            'Fast food restaurant order': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚ã“ã¡ã‚‰ã§ãŠå¬ã—ä¸ŠãŒã‚Šã§ã™ã‹ã€ãŠæŒã¡å¸°ã‚Šã§ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œè«‹å•å…§ç”¨é‚„æ˜¯å¤–å¸¶ï¼Ÿ' },
            'Dessert and cake shop': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚æœ¬æ—¥ã®ãŠã™ã™ã‚ã¯ãƒ¢ãƒ³ãƒ–ãƒ©ãƒ³ã§ã™ã€‚ã”è©¦é£Ÿã„ã‹ãŒã§ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œä»Šæ—¥æ¨è–¦æ˜¯è’™å¸ƒæœ—è›‹ç³•ã€‚è¦è©¦åƒå—ï¼Ÿ' },
            // === äº¤é€šå‡ºè¡Œ ===
            'Train station ticket': { greeting: 'ã©ã¡ã‚‰ã¾ã§è¡Œã‹ã‚Œã¾ã™ã‹ï¼ŸICã‚«ãƒ¼ãƒ‰ã¯ãŠæŒã¡ã§ã™ã‹ï¼Ÿ', chinese: 'è«‹å•è¦åˆ°å“ªä¸€ç«™ï¼Ÿæœ‰ IC å¡å—ï¼Ÿ' },
            'Asking for directions in Japanese': { greeting: 'ã“ã‚“ã«ã¡ã¯ã€‚ã©ã¡ã‚‰ã¸è¡ŒããŸã„ã§ã™ã‹ï¼Ÿè¿‘ã„é“ã‚’ãŠä¼ãˆã—ã¾ã™ã­ã€‚', chinese: 'ä½ å¥½ï¼Œæƒ³å»å“ªè£¡ï¼Ÿæˆ‘å‘Šè¨´ä½ è¼ƒè¿‘çš„è·¯ç·šã€‚' },
            'Taking a taxi in Japan': { greeting: 'ã”ä¹—è»Šã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã©ã¡ã‚‰ã¾ã§è¡Œã‹ã‚Œã¾ã™ã‹ï¼Ÿä½æ‰€ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', chinese: 'æ„Ÿè¬æ­ä¹˜ï¼Œè«‹å•åˆ°å“ªè£¡ï¼Ÿæœ‰åœ°å€å—ï¼Ÿ' },
            'Taking a bus in Japan': { greeting: 'ã“ã®ãƒã‚¹ã¯æ¸‹è°·é§…è¡Œãã§ã™ã€‚ã©ã¡ã‚‰ã¾ã§è¡Œã‹ã‚Œã¾ã™ã‹ï¼Ÿ', chinese: 'é€™ç­å…¬è»Šé–‹å¾€æ¾€è°·ç«™ã€‚è«‹å•æ‚¨åˆ°å“ªè£¡ï¼Ÿ' },
            'Airport check-in and boarding': { greeting: 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã§ã™ã‹ï¼Ÿãƒ‘ã‚¹ãƒãƒ¼ãƒˆã¨äºˆç´„ç•ªå·ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚', chinese: 'æ—©å®‰ï¼Œæ˜¯è¦è¾¦ç†å ±åˆ°å—ï¼Ÿè«‹å‡ºç¤ºè­·ç…§å’Œè¨‚ä½ç·¨è™Ÿã€‚' },
            // === ä½å®¿ ===
            'Hotel check-in in Japan': { greeting: 'ã‚ˆã†ã“ããŠè¶Šã—ãã ã•ã„ã¾ã—ãŸã€‚ã”äºˆç´„ã®ãŠåå‰ã‚’é ‚ã‘ã¾ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œè«‹å‘Šè¨´æˆ‘é è¨‚çš„åå­—ã€‚' },
            'Guesthouse communication': { greeting: 'ã‚ˆã†ã“ãï¼ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã¯15æ™‚ã‹ã‚‰ã§ã™ãŒã€è·ç‰©ã¯å…ˆã«ãŠé ã‹ã‚Šã§ãã¾ã™ã‚ˆã€‚', chinese: 'æ­¡è¿ï¼å…¥ä½æ˜¯ä¸‹åˆ3é»é–‹å§‹ï¼Œä½†è¡Œæå¯ä»¥å…ˆå¯„æ”¾å–”ã€‚' },
            'Apartment viewing and rental': { greeting: 'ã“ã‚“ã«ã¡ã¯ã€ä¸å‹•ç”£ã®ã‚¿ãƒŠã‚«ã§ã™ã€‚ä»Šæ—¥ã¯1LDKã®ãŠéƒ¨å±‹ã‚’è¦‹ã‚‰ã‚Œã¾ã™ã­ã€‚', chinese: 'ä½ å¥½ï¼Œæˆ‘æ˜¯ä¸å‹•ç”¢çš„ç”°ä¸­ã€‚ä»Šå¤©è¦çœ‹çš„æ˜¯ä¸€æˆ¿ä¸€å»³çš„æˆ¿é–“ã€‚' },
            // === è³¼ç‰© ===
            'Clothing store shopping': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚ä½•ã‹ãŠæ¢ã—ã§ã™ã‹ï¼Ÿè©¦ç€å®¤ã¯ã‚ã¡ã‚‰ã§ã™ã€‚', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œåœ¨æ‰¾ä»€éº¼å—ï¼Ÿè©¦è¡£é–“åœ¨é‚£é‚Šã€‚' },
            'Drugstore shopping': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚æœ¬æ—¥ã¯ãƒã‚¤ãƒ³ãƒˆ2å€ãƒ‡ãƒ¼ã§ã™ã€‚ä½•ã‹ãŠæ¢ã—ã§ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œä»Šå¤©æ˜¯é»æ•¸å…©å€æ—¥ã€‚åœ¨æ‰¾ä»€éº¼å—ï¼Ÿ' },
            'Electronics store inquiry': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚ä½•ã‹ãŠæ¢ã—ã§ã™ã‹ï¼Ÿæœ€æ–°ã®iPhoneã¯å“åˆ‡ã‚Œã§ã™ãŒã€äºˆç´„å¯èƒ½ã§ã™ã€‚', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œåœ¨æ‰¾ä»€éº¼å—ï¼Ÿæœ€æ–°iPhoneç¼ºè²¨ä¸­ï¼Œä½†å¯ä»¥é è³¼ã€‚' },
            'Department store returns': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚è¿”å“ãƒ»äº¤æ›ã®ã”ç›¸è«‡ã§ã™ã‹ï¼Ÿãƒ¬ã‚·ãƒ¼ãƒˆã¯ãŠæŒã¡ã§ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œæ˜¯è¦é€€æ›è²¨å—ï¼Ÿæœ‰å¸¶æ”¶æ“šå—ï¼Ÿ' },
            // === é†«ç™‚ ===
            'Pharmacy conversation': { greeting: 'ã“ã‚“ã«ã¡ã¯ã€‚ã©ã®ã‚ˆã†ãªç—‡çŠ¶ã§ã™ã‹ï¼Ÿç†±ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', chinese: 'ä½ å¥½ï¼Œå“ªè£¡ä¸èˆ’æœï¼Ÿæœ‰ç™¼ç‡’å—ï¼Ÿ' },
            'Describing symptoms to a doctor': { greeting: 'ãŠå¾…ãŸã›ã—ã¾ã—ãŸã€‚ä»Šæ—¥ã¯ã©ã†ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿã„ã¤ã‹ã‚‰å…·åˆãŒæ‚ªã„ã§ã™ã‹ï¼Ÿ', chinese: 'è®“æ‚¨ä¹…ç­‰äº†ã€‚ä»Šå¤©æ€éº¼äº†ï¼Ÿå¾ä»€éº¼æ™‚å€™é–‹å§‹ä¸èˆ’æœçš„ï¼Ÿ' },
            'Dental appointment': { greeting: 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚ä»Šæ—¥ã¯å®šæœŸæ¤œè¨ºã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚ä½•ã‹æ°—ã«ãªã‚‹ã¨ã“ã‚ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ', chinese: 'æ—©å®‰ï¼Œä»Šå¤©æ˜¯å®šæœŸæª¢æŸ¥å—ï¼Ÿé‚„æ˜¯æœ‰ä»€éº¼ä¸èˆ’æœçš„åœ°æ–¹ï¼Ÿ' },
            // === ç¤¾äº¤ ===
            'Meeting new friends in Japanese': { greeting: 'ã¯ã˜ã‚ã¾ã—ã¦ï¼ã©ã“ã‹ã‚‰æ¥ã¾ã—ãŸã‹ï¼Ÿæ—¥æœ¬ã¯åˆã‚ã¦ã§ã™ã‹ï¼Ÿ', chinese: 'åˆæ¬¡è¦‹é¢ï¼ä½ å¾å“ªè£¡ä¾†ï¼Ÿç¬¬ä¸€æ¬¡ä¾†æ—¥æœ¬å—ï¼Ÿ' },
            'Party and social gathering': { greeting: 'ã‚ˆã†ã“ãï¼é£²ã¿ç‰©ã‚’ã©ã†ãã€‚ä»Šæ—¥ã®ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã¯èª°ã®ç´¹ä»‹ã§æ¥ã¾ã—ãŸã‹ï¼Ÿ', chinese: 'æ­¡è¿ï¼è«‹å–é£²æ–™ã€‚ä»Šå¤©æ˜¯èª°ä»‹ç´¹ä½ ä¾†çš„ï¼Ÿ' },
            'Chatting with neighbors': { greeting: 'ã‚ã€ã“ã‚“ã«ã¡ã¯ï¼å¼•ã£è¶Šã—ã¦ããŸã‚“ã§ã™ã‹ï¼Ÿã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚', chinese: 'å•Šï¼Œä½ å¥½ï¼æ˜¯å‰›æ¬ä¾†çš„å—ï¼Ÿè«‹å¤šæŒ‡æ•™ã€‚' },
            'Dating conversation': { greeting: 'ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã¯æ¥ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ä½•ã‹é£Ÿã¹ãŸã„ã‚‚ã®ã‚ã‚‹ï¼Ÿ', chinese: 'ä½ å¥½ï¼è¬è¬ä½ ä»Šå¤©ä¾†ã€‚æœ‰æƒ³åƒä»€éº¼å—ï¼Ÿ' },
            'Etiquette and polite small talk': { greeting: 'ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚æœ¬æ—¥ã¯ãŠå¿™ã—ã„ä¸­ãŠæ™‚é–“ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚', chinese: 'æ‰¿è’™é—œç…§ã€‚æ„Ÿè¬æ‚¨ç™¾å¿™ä¹‹ä¸­æŠ½ç©ºã€‚' },
            // === å·¥ä½œå•†å‹™ ===
            'Business phone call': { greeting: 'ãŠé›»è©±ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã€‡ã€‡æ ªå¼ä¼šç¤¾ã§ã”ã–ã„ã¾ã™ã€‚ã©ã®ã‚ˆã†ãªã”ç”¨ä»¶ã§ã—ã‚‡ã†ã‹ï¼Ÿ', chinese: 'æ„Ÿè¬ä¾†é›»ï¼Œé€™è£¡æ˜¯ã€‡ã€‡è‚¡ä»½æœ‰é™å…¬å¸ã€‚è«‹å•æœ‰ä»€éº¼äº‹å‘¢ï¼Ÿ' },
            'Business meeting in Japanese': { greeting: 'æœ¬æ—¥ã¯ãŠå¿™ã—ã„ä¸­ãŠé›†ã¾ã‚Šã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãã‚Œã§ã¯ä¼šè­°ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚', chinese: 'æ„Ÿè¬å„ä½ç™¾å¿™ä¹‹ä¸­å‰ä¾†ã€‚é‚£éº¼é–‹å§‹æœƒè­°å§ã€‚' },
            'Project collaboration in IT': { greeting: 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚ä»Šæ—¥ã®ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒƒãƒ—ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚æ˜¨æ—¥ã®é€²æ—ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿ', chinese: 'æ—©å®‰ï¼Œé–‹å§‹ä»Šå¤©çš„ç«™ç«‹æœƒè­°å§ã€‚æ˜¨å¤©çš„é€²åº¦å¦‚ä½•ï¼Ÿ' },
            'Customer support and complaints in Japanese': { greeting: 'ãŠé›»è©±ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã©ã®ã‚ˆã†ãªã”ç”¨ä»¶ã§ã—ã‚‡ã†ã‹ï¼ŸãŠå›°ã‚Šã®ã“ã¨ã‚’ãŠèã‹ã›ãã ã•ã„ã€‚', chinese: 'æ„Ÿè¬ä¾†é›»ï¼Œè«‹å•æœ‰ä»€éº¼äº‹ï¼Ÿè«‹å‘Šè¨´æˆ‘æ‚¨é‡åˆ°çš„å•é¡Œã€‚' },
            'Job interview in Japanese': { greeting: 'æœ¬æ—¥ã¯ãŠè¶Šã—ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¾ãšè‡ªå·±ç´¹ä»‹ã‚’ãŠé¡˜ã„ã§ãã¾ã™ã‹ï¼Ÿ', chinese: 'æ„Ÿè¬æ‚¨ä»Šå¤©å‰ä¾†ã€‚é¦–å…ˆå¯ä»¥è«‹æ‚¨è‡ªæˆ‘ä»‹ç´¹å—ï¼Ÿ' },
            // === ç·Šæ€¥ç‹€æ³ ===
            'Emergency help in Japanese': { greeting: '119ã§ã™ã€‚ç«äº‹ã§ã™ã‹ï¼Ÿæ•‘æ€¥ã§ã™ã‹ï¼Ÿç¾åœ¨ã®ä½æ‰€ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚', chinese: 'é€™è£¡æ˜¯119ã€‚æ˜¯ç«ç½é‚„æ˜¯æ€¥æ•‘ï¼Ÿè«‹å‘Šè¨´æˆ‘ç¾åœ¨çš„åœ°å€ã€‚' },
            'Reporting to police': { greeting: '110ã§ã™ã€‚ã©ã†ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿäº‹ä»¶ã§ã™ã‹ã€äº‹æ•…ã§ã™ã‹ï¼Ÿ', chinese: 'é€™è£¡æ˜¯110ã€‚æ€éº¼äº†ï¼Ÿæ˜¯æ¡ˆä»¶é‚„æ˜¯äº‹æ•…ï¼Ÿ' },
            'Lost and found items': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚ãŠå¿˜ã‚Œç‰©ã§ã™ã‹ï¼Ÿã„ã¤ã€ã©ã“ã§ãªãã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ', chinese: 'æ‚¨å¥½ï¼Œæ˜¯éºå¤±ç‰©å“å—ï¼Ÿä»€éº¼æ™‚å€™ã€åœ¨å“ªè£¡å¼„ä¸Ÿçš„ï¼Ÿ' },
            // === ç‰¹æ®Šå ´æ™¯ ===
            'Hair salon conversation': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚ä»Šæ—¥ã¯ã‚«ãƒƒãƒˆã§ã™ã‹ï¼Ÿã©ã®ãã‚‰ã„åˆ‡ã‚Šã¾ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œä»Šå¤©æ˜¯å‰ªé«®å—ï¼Ÿè¦å‰ªå¤šå°‘ï¼Ÿ' },
            'Gym membership inquiry': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚ã‚¸ãƒ ã®è¦‹å­¦ã§ã™ã‹ï¼Ÿæœˆé¡ãƒ—ãƒ©ãƒ³ã¨å›æ•°åˆ¸ãŒã‚ã‚Šã¾ã™ãŒã€ã©ã¡ã‚‰ãŒã„ã„ã§ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œæ˜¯ä¾†åƒè§€å¥èº«æˆ¿å—ï¼Ÿæœ‰æœˆè²»æ–¹æ¡ˆå’Œæ¬¡æ•¸åˆ¸ï¼Œæ‚¨æ¯”è¼ƒæƒ³è¦å“ªç¨®ï¼Ÿ' },
            'Post office mailing': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚éƒµä¾¿ã§ã™ã‹ï¼Ÿè·ç‰©ã§ã™ã‹ï¼Ÿã©ã¡ã‚‰ã¸ãŠé€ã‚Šã«ãªã‚Šã¾ã™ã‹ï¼Ÿ', chinese: 'æ‚¨å¥½ï¼Œæ˜¯å¯„ä¿¡é‚„æ˜¯å¯„åŒ…è£¹ï¼Ÿè¦å¯„åˆ°å“ªè£¡ï¼Ÿ' },
            'Bank account opening': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚å£åº§é–‹è¨­ã§ã™ã‹ï¼Ÿåœ¨ç•™ã‚«ãƒ¼ãƒ‰ã¨å°é‘‘ã¯ãŠæŒã¡ã§ã™ã‹ï¼Ÿ', chinese: 'æ‚¨å¥½ï¼Œæ˜¯è¦é–‹æˆ¶å—ï¼Ÿæœ‰å¸¶åœ¨ç•™å¡å’Œå°ç« å—ï¼Ÿ' }
        };

        function initChat() {
            const scenarioValue = APP_STATE.currentTopic;
            const scenarioLabel = getTopicLabel(scenarioValue);
            const chatInfo = CHAT_GREETINGS[scenarioValue] || { 
                greeting: `Hi! Welcome to our ${scenarioValue} scenario. Let's practice Japanese conversation together.`,
                chinese: `å—¨ï¼æ­¡è¿ä¾†åˆ°${scenarioLabel}æƒ…å¢ƒã€‚è®“æˆ‘å€‘ç·´ç¿’æ—¥èªå°è©±ã€‚`
            };

            document.getElementById('chat-scenario').textContent = scenarioLabel;
            document.getElementById('chat-messages').innerHTML = `
                <div class="flex gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-robot text-lg"></i>
                    </div>
                    <div class="glass-card rounded-2xl rounded-tl-sm p-4 max-w-[80%]">
                        <div class="flex items-start justify-between gap-2">
                            <p class="text-lg flex-1">${chatInfo.greeting}</p>
                            <button onclick="speakChatMessage(this)" data-text="${chatInfo.greeting.replace(/"/g, '&quot;')}" 
                                class="shrink-0 w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center text-blue-400 hover:bg-blue-500/30 transition" title="æ’­æ”¾èªéŸ³">
                                <i class="fa-solid fa-volume-high text-sm"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-700 mt-2 border-t border-gray-200 pt-2 font-semibold">${chatInfo.chinese}</p>
                        <p class="text-xs text-indigo-700 mt-2 font-semibold"><i class="fa-solid fa-lightbulb mr-1"></i>æç¤ºï¼šå¯ä»¥ç”¨æ—¥æ–‡æˆ–ä¸­æ–‡è¼¸å…¥ï¼èªªä¸­æ–‡æ™‚ï¼ŒAI æœƒæ•™ä½ å¦‚ä½•ç”¨æ—¥æ–‡è¡¨é”</p>
                    </div>
                </div>
            `;
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const messagesContainer = document.getElementById('chat-messages');

            // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
            messagesContainer.innerHTML += `
                <div class="flex gap-3 justify-end">
                    <div class="bg-blue-500/20 border border-blue-500/30 rounded-2xl rounded-tr-sm p-4 max-w-[80%]">
                        <p>${message}</p>
                        </div>
                                </div>
            `;

            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // é¡¯ç¤ºè¼‰å…¥
            const loadingId = 'typing-' + Date.now();
            messagesContainer.innerHTML += `
                <div id="${loadingId}" class="flex gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div class="glass-card rounded-2xl rounded-tl-sm p-4">
                        <div class="flex gap-1">
                            <span class="w-2 h-2 bg-white/50 rounded-full animate-bounce"></span>
                            <span class="w-2 h-2 bg-white/50 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                            <span class="w-2 h-2 bg-white/50 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        </div>
                        </div>
                    </div>
                `;

            try {
                const prompt = generatePrompt(
                    'chat',
                    APP_STATE.currentTopic,
                    document.getElementById('level-select').value,
                    [],
                    message
                );

                const data = await callGeminiAPI(prompt);
                document.getElementById(loadingId).remove();

                // è™•ç†ä¸­æ–‡è¼¸å…¥çš„æƒ…æ³ï¼ˆæ—¥æ–‡æ•™å­¸ï¼‰
                if (data.isChinese) {
                    const safeJapanese = (data.japanese || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const safeKana = (data.kana || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const safeRomaji = (data.romaji || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const safeReply = (data.reply || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const safeNextSuggestion = (data.nextSuggestion || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    // è™•ç†æ›¿ä»£èªªæ³•
                    let alternativesHtml = '';
                    if (data.alternatives && data.alternatives.length > 0) {
                        alternativesHtml = `
                            <div class="mt-2 pt-2 border-t border-purple-500/20">
                                <p class="text-xs text-purple-300 mb-1"><i class="fa-solid fa-shuffle mr-1"></i>å…¶ä»–èªªæ³•ï¼š</p>
                                <div class="flex flex-wrap gap-1">
                                    ${data.alternatives.map(alt => `<span class="text-xs bg-purple-500/20 px-2 py-1 rounded cursor-pointer hover:bg-purple-500/30" onclick="speakText('${alt.replace(/'/g, "\\'")}')">${alt}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    // è™•ç†é—œéµè©å½™
                    let vocabHtml = '';
                    if (data.keyVocab && data.keyVocab.length > 0) {
                        vocabHtml = `
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-3 mb-3 shadow-sm">
                                <p class="text-xs text-blue-700 mb-2 font-bold"><i class="fa-solid fa-book-open mr-1"></i>é‡è¦å–®å­—ï¼š</p>
                                <div class="space-y-1">
                                    ${data.keyVocab.map(v => `<div class="text-xs"><span class="text-gray-900 font-bold">${v.word}</span> <span class="text-gray-700">(${v.reading})</span> - <span class="text-blue-700 font-semibold">${v.meaning}</span></div>`).join('')}
                                </div>
                            </div>
                        `;
                    } else if (data.vocabulary) {
                        vocabHtml = `<div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-3 mb-3 shadow-sm"><p class="text-xs text-blue-700 font-bold"><i class="fa-solid fa-list mr-1"></i><strong>å–®å­—ï¼š</strong>${data.vocabulary}</p></div>`;
                    }
                    
                    messagesContainer.innerHTML += `
                        <div class="flex gap-3 animate-slide">
                            <div class="w-10 h-10 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center shrink-0">
                                <i class="fa-solid fa-robot"></i>
                            </div>
                            <div class="glass-card rounded-2xl rounded-tl-sm p-4 max-w-[85%]">
                                <!-- æ—¥æ–‡ç¿»è­¯æ•™å­¸ -->
                                <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-4 mb-3 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fa-solid fa-language text-purple-600"></i>
                                        <span class="text-sm font-bold text-purple-700">é€™æ¨£èªªæ—¥æ–‡</span>
                                    </div>
                                    <div class="flex items-start justify-between gap-2 mb-2">
                                        <div class="flex-1">
                                            <p class="text-xl font-bold mb-1 text-gray-900">${data.japanese}</p>
                                            ${data.kana ? `<p class="text-sm text-gray-700 mb-1 font-semibold">${data.kana}</p>` : ''}
                                            ${data.romaji ? `<p class="text-sm text-indigo-700 font-mono font-semibold">${data.romaji}</p>` : ''}
                                        </div>
                                        <div class="shrink-0 flex flex-col gap-1">
                                            <button onclick="speakChatMessage(this, 0.55)" data-text="${safeJapanese}" 
                                                class="w-9 h-9 bg-amber-100 border border-amber-300 rounded-full flex items-center justify-center text-amber-700 hover:bg-amber-200 transition shadow-sm" title="ğŸ¢ æ…¢é€Ÿ">
                                                <i class="fa-solid fa-volume-low text-sm"></i>
                                            </button>
                                            <button onclick="speakChatMessage(this, 0.85)" data-text="${safeJapanese}" 
                                                class="w-9 h-9 bg-indigo-100 border border-indigo-300 rounded-full flex items-center justify-center text-indigo-700 hover:bg-indigo-200 transition shadow-sm" title="â–¶ï¸ æ­£å¸¸">
                                                <i class="fa-solid fa-volume-high text-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                    ${data.pronunciation ? `<p class="text-xs text-amber-700 mt-2 font-semibold"><i class="fa-solid fa-microphone mr-1"></i>ç™¼éŸ³ï¼š${data.pronunciation}</p>` : ''}
                                    ${alternativesHtml}
                                </div>
                                
                                <!-- æ–‡æ³•èªªæ˜ -->
                                ${data.grammarPoint || data.grammar ? `
                                <div class="bg-green-50 border-2 border-green-200 rounded-xl p-3 mb-3 shadow-sm">
                                    <p class="text-xs text-green-700 font-bold"><i class="fa-solid fa-graduation-cap mr-1"></i><strong>æ–‡æ³•ï¼š</strong>${data.grammarPoint || data.grammar}</p>
                                </div>
                                ` : ''}
                                
                                <!-- é—œéµè©å½™ -->
                                ${vocabHtml}
                                
                                <!-- AI å›è¦†ï¼ˆç¹¼çºŒå°è©±ï¼‰-->
                                <div class="border-t border-gray-200 pt-3">
                                    <p class="text-xs text-gray-700 mb-1 font-bold"><i class="fa-solid fa-comment mr-1"></i>å°æ–¹å›è¦†ï¼š</p>
                                    <div class="flex items-start justify-between gap-2 mb-2">
                                        <div class="flex-1">
                                            <p class="text-base text-gray-900 font-semibold">${data.reply}</p>
                                            ${data.replyKana ? `<p class="text-xs text-gray-700 font-medium">${data.replyKana}</p>` : ''}
                                        </div>
                                        <button onclick="speakChatMessage(this, 0.85)" data-text="${safeReply}" 
                                            class="shrink-0 w-8 h-8 bg-indigo-100 border border-indigo-300 rounded-full flex items-center justify-center text-indigo-700 hover:bg-indigo-200 transition shadow-sm" title="æ’­æ”¾">
                                            <i class="fa-solid fa-volume-high text-sm"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-700 font-semibold">${data.chinese}</p>
                                </div>
                                
                                <!-- ä¸‹ä¸€æ­¥å»ºè­° -->
                                ${data.nextSuggestion ? `
                                <div class="mt-3 pt-3 border-t border-gray-200 bg-gradient-to-r from-green-50 to-teal-50 rounded-lg p-3 shadow-sm">
                                    <p class="text-xs text-green-700 mb-1 font-bold"><i class="fa-solid fa-lightbulb mr-1"></i>è©¦è©¦é€™æ¨£èªªï¼š</p>
                                    <div class="flex items-center gap-2">
                                        <p class="text-sm font-semibold flex-1 text-gray-900">${data.nextSuggestion}</p>
                                        <button onclick="speakChatMessage(this, 0.7)" data-text="${safeNextSuggestion}" 
                                            class="shrink-0 w-7 h-7 bg-green-100 border border-green-300 rounded-full flex items-center justify-center text-green-700 hover:bg-green-200 transition shadow-sm" title="æ’­æ”¾">
                                            <i class="fa-solid fa-play text-xs"></i>
                                        </button>
                                        <button onclick="document.getElementById('chat-input').value='${safeNextSuggestion}'" 
                                            class="shrink-0 w-7 h-7 bg-teal-100 border border-teal-300 rounded-full flex items-center justify-center text-teal-700 hover:bg-teal-200 transition shadow-sm" title="å¡«å…¥è¼¸å…¥æ¡†">
                                            <i class="fa-solid fa-paste text-xs"></i>
                                        </button>
                                    </div>
                                    ${data.nextSuggestionChinese ? `<p class="text-xs text-gray-700 mt-1 font-semibold">${data.nextSuggestionChinese}</p>` : ''}
                                </div>
                                ` : ''}
                                
                                <!-- æ–‡åŒ–å°çŸ¥è­˜ -->
                                ${data.cultureTip ? `<p class="text-xs text-pink-700 mt-3 pt-3 border-t border-gray-200 font-semibold"><i class="fa-solid fa-torii-gate mr-1"></i>${data.cultureTip}</p>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // æ­£å¸¸æ—¥æ–‡å°è©±ï¼ˆç·´ç¿’æ¨¡å¼ï¼‰
                    const safeReply = (data.reply || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const safeNextSuggestion = (data.nextSuggestion || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    // è¨ˆç®—åˆ†æ•¸é¡è‰²
                    const scoreColor = data.score >= 85 ? 'green' : data.score >= 70 ? 'yellow' : data.score >= 50 ? 'orange' : 'red';
                    const scoreEmoji = data.score >= 85 ? 'ğŸ‰' : data.score >= 70 ? 'ğŸ‘' : data.score >= 50 ? 'ğŸ’ª' : 'ğŸ“š';
                    
                    messagesContainer.innerHTML += `
                        <div class="flex gap-3 animate-slide">
                            <div class="w-10 h-10 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center shrink-0">
                                <i class="fa-solid fa-robot"></i>
                            </div>
                            <div class="glass-card rounded-2xl rounded-tl-sm p-4 max-w-[85%]">
                                <!-- AI å›è¦† -->
                                <div class="flex items-start justify-between gap-2 mb-2">
                                    <div class="flex-1">
                                        <p class="text-lg text-gray-900 font-semibold">${data.reply}</p>
                                        ${data.replyKana ? `<p class="text-xs text-gray-700 font-medium">${data.replyKana}</p>` : ''}
                                    </div>
                                    <div class="shrink-0 flex gap-1">
                                        <button onclick="speakChatMessage(this, 0.6)" data-text="${safeReply}" 
                                            class="w-8 h-8 bg-amber-100 border border-amber-300 rounded-full flex items-center justify-center text-amber-700 hover:bg-amber-200 transition shadow-sm" title="æ…¢é€Ÿ">
                                            <i class="fa-solid fa-volume-low text-xs"></i>
                                        </button>
                                        <button onclick="speakChatMessage(this, 0.85)" data-text="${safeReply}" 
                                            class="w-8 h-8 bg-indigo-100 border border-indigo-300 rounded-full flex items-center justify-center text-indigo-700 hover:bg-indigo-200 transition shadow-sm" title="æ­£å¸¸">
                                            <i class="fa-solid fa-volume-high text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-700 mb-3 font-semibold">${data.chinese}</p>
                                
                                <!-- è©•åˆ†å€å¡Š -->
                                ${data.score !== undefined ? `
                                <div class="bg-gradient-to-r from-${scoreColor}-500/20 to-${scoreColor}-600/10 border border-${scoreColor}-500/30 rounded-xl p-3 mb-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-bold text-${scoreColor}-300">${scoreEmoji} è¡¨é”è©•åˆ†</span>
                                        <span class="text-2xl font-black text-${scoreColor}-400">${data.score}</span>
                                    </div>
                                    <div class="h-2 bg-white/10 rounded-full overflow-hidden mb-2">
                                        <div class="h-full bg-${scoreColor}-500 transition-all duration-500" style="width: ${data.score}%"></div>
                                    </div>
                                    ${data.scoreBreakdown ? `
                                    <div class="grid grid-cols-4 gap-1 text-xs text-gray-700 font-semibold">
                                        <div>æ–‡æ³• ${data.scoreBreakdown.grammar || '-'}</div>
                                        <div>è©å½™ ${data.scoreBreakdown.vocabulary || '-'}</div>
                                        <div>è‡ªç„¶ ${data.scoreBreakdown.naturalness || '-'}</div>
                                        <div>å®Œæ•´ ${data.scoreBreakdown.completeness || '-'}</div>
                                    </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                                
                                <!-- å›é¥‹å»ºè­° -->
                                ${data.feedback ? `
                                <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-3 mb-3">
                                    <p class="text-xs text-blue-300"><i class="fa-solid fa-comment-dots mr-1"></i>${data.feedback}</p>
                                </div>
                                ` : ''}
                                
                                <!-- æ›´å¥½çš„èªªæ³• -->
                                ${data.correction || data.betterWay ? `
                                <div class="bg-purple-500/10 border border-purple-500/20 rounded-xl p-3 mb-3">
                                    ${data.correction ? `<p class="text-xs text-red-300 mb-1"><i class="fa-solid fa-pen mr-1"></i>æ­£ç¢ºèªªæ³•ï¼š<span class="text-white">${data.correction}</span></p>` : ''}
                                    ${data.betterWay ? `<p class="text-xs text-purple-300"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i>æ›´è‡ªç„¶ï¼š<span class="text-white">${data.betterWay}</span></p>` : ''}
                                </div>
                                ` : ''}
                                
                                <!-- ä¸‹ä¸€æ­¥å»ºè­° -->
                                ${data.nextSuggestion ? `
                                <div class="bg-gradient-to-r from-green-500/10 to-teal-500/10 rounded-lg p-3">
                                    <p class="text-xs text-green-300 mb-1"><i class="fa-solid fa-arrow-right mr-1"></i>æ¥ä¸‹ä¾†å¯ä»¥èªªï¼š</p>
                                    <div class="flex items-center gap-2">
                                        <p class="text-sm font-medium flex-1">${data.nextSuggestion}</p>
                                        <button onclick="speakChatMessage(this, 0.7)" data-text="${safeNextSuggestion}" 
                                            class="shrink-0 w-7 h-7 bg-green-500/20 rounded-full flex items-center justify-center text-green-400 hover:bg-green-500/30 transition" title="æ’­æ”¾">
                                            <i class="fa-solid fa-play text-xs"></i>
                                        </button>
                                        <button onclick="document.getElementById('chat-input').value='${safeNextSuggestion}'" 
                                            class="shrink-0 w-7 h-7 bg-teal-500/20 rounded-full flex items-center justify-center text-teal-400 hover:bg-teal-500/30 transition" title="å¡«å…¥">
                                            <i class="fa-solid fa-paste text-xs"></i>
                                        </button>
                                    </div>
                                    ${data.nextSuggestionChinese ? `<p class="text-xs text-gray-500 mt-1">${data.nextSuggestionChinese}</p>` : ''}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }

                addXP(5);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (e) {
                document.getElementById(loadingId).remove();
                console.error(e);
                alert('å°è©±å¤±æ•—ï¼š' + e.message);
            }
        }

        // ===== å·¥å…·å‡½æ•¸ =====
        function nextWord() {
            APP_STATE.currentIndex++;
            
            if (APP_STATE.currentIndex >= APP_STATE.words.length) {
                showCompletion();
            } else {
                renderCurrentMode();
            }
        }

        function showCompletion() {
            const earnedXP = APP_STATE.words.length * 10;
            document.getElementById('earned-xp').textContent = earnedXP;
            
            // æ›´æ–°æœ¬è¼ªçµ±è¨ˆ
            document.getElementById('round-total').textContent = APP_STATE.roundTotal || APP_STATE.words.length;
            document.getElementById('round-correct').textContent = APP_STATE.roundCorrect;
            const accuracy = APP_STATE.roundTotal > 0 ? Math.round(APP_STATE.roundCorrect / APP_STATE.roundTotal * 100) : 0;
            document.getElementById('round-accuracy').textContent = accuracy + '%';
            
            document.getElementById('complete-modal').classList.remove('hidden');
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        // è¤‡ç¿’éŒ¯é¡Œ
        function reviewMistakes() {
            document.getElementById('complete-modal').classList.add('hidden');
            if (APP_STATE.mistakes.length === 0) {
                alert('å¤ªæ£’äº†ï¼æ²’æœ‰éŒ¯é¡Œéœ€è¦è¤‡ç¿’ ğŸ‰');
                continuelearning();
                return;
            }
            APP_STATE.words = [...APP_STATE.mistakes];
            APP_STATE.mistakes = [];
            APP_STATE.currentIndex = 0;
            APP_STATE.roundCorrect = 0;
            APP_STATE.roundTotal = 0;
            renderCurrentMode();
        }

        function continuelearning() {
            document.getElementById('complete-modal').classList.add('hidden');
            APP_STATE.currentIndex = 0;
            APP_STATE.roundCorrect = 0;
            APP_STATE.roundTotal = 0;
            APP_STATE.mistakes = [];
            loadContent();
        }

        function showFeedback(elementId, isCorrect, title, subtitle) {
            const el = document.getElementById(elementId);
            el.classList.remove('hidden');
            el.className = `mt-6 p-4 rounded-xl text-center ${isCorrect ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`;
            el.innerHTML = `<div class="font-bold">${title}</div>${subtitle ? `<div class="text-sm opacity-80">${subtitle}</div>` : ''}`;
        }

        // ===== èªéŸ³æ’­æ”¾åŠŸèƒ½ï¼ˆæ”¹å–„æ¸…æ™°åº¦ï¼‰=====
        let japaneseVoice = null;
        let voicesLoaded = false;

        // åˆå§‹åŒ–ä¸¦é¸æ“‡æœ€ä½³æ—¥æ–‡èªéŸ³
        function initVoices() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return;
            
            voicesLoaded = true;
            
            // å„ªå…ˆé¸æ“‡é †åºï¼šGoogle > Microsoft > Apple > å…¶ä»–
            const preferredVoices = [
                'Google æ—¥æœ¬èª',
                'Microsoft Haruka',
                'Microsoft Ayumi',
                'Microsoft Ichiro',
                'Kyoko',            // macOS/iOS
                'Otoya',            // macOS/iOS
                'Mizuki',           // AWS Polly style names
                'Takumi'
            ];
            
            // å˜—è©¦æ‰¾åˆ°æœ€ä½³èªéŸ³
            for (const preferred of preferredVoices) {
                const found = voices.find(v => v.name.includes(preferred));
                if (found) {
                    japaneseVoice = found;
                    console.log('é¸æ“‡èªéŸ³:', found.name);
                    break;
                }
            }
            
            // å¦‚æœæ²’æ‰¾åˆ°å„ªå…ˆèªéŸ³ï¼Œé¸æ“‡ä»»ä½•æ—¥æ–‡èªéŸ³
            if (!japaneseVoice) {
                japaneseVoice = voices.find(v => v.lang && v.lang.startsWith('ja')) || voices[0];
                console.log('ä½¿ç”¨é è¨­èªéŸ³:', japaneseVoice?.name);
            }
        }

        // ç›£è½èªéŸ³åˆ—è¡¨è¼‰å…¥
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = initVoices;
            initVoices(); // ç«‹å³å˜—è©¦ä¸€æ¬¡
        }

        // é ç†±èªéŸ³å¼•æ“ï¼ˆè§£æ±ºç¬¬ä¸€å€‹å­—è¢«æˆªæ‰çš„å•é¡Œï¼‰
        let speechWarmedUp = false;
        function warmUpSpeech() {
            if (speechWarmedUp) return;
            const warmUp = new SpeechSynthesisUtterance('');
            warmUp.volume = 0;
            window.speechSynthesis.speak(warmUp);
            speechWarmedUp = true;
        }

        function speakWord() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                // å„ªå…ˆä½¿ç”¨å‡åï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨å–®å­—
                const speakTarget = (word.kana && word.kana.trim()) ? word.kana.trim() : word.word.trim();
                if (speakTarget) {
                    // å…ˆæ…¢é€Ÿæ’­æ”¾ä¸€æ¬¡ï¼Œå†æ­£å¸¸é€Ÿåº¦æ’­æ”¾ï¼Œé–“éš”æ›´é•·è®“ç”¨æˆ¶æ¶ˆåŒ–
                    speakText(speakTarget, 0.5, () => {
                        setTimeout(() => {
                            speakText(speakTarget, 0.8);
                        }, 1000);  // å¢åŠ é–“éš”æ™‚é–“
                    });
                }
            }
        }

        function speakText(text, rate = 0.75, onEnd = null) {
            if (!text || !text.trim()) return;
            
            // å…ˆå–æ¶ˆä¹‹å‰çš„æ’­æ”¾
            window.speechSynthesis.cancel();
            
            // ç­‰å¾…ä¸€å°æ®µæ™‚é–“ç¢ºä¿å–æ¶ˆå®Œæˆ
            setTimeout(() => {
                // é ç†±å¼•æ“
                warmUpSpeech();
                
                // æ¸…ç†æ–‡å­— - ç§»é™¤å¤šé¤˜ç©ºæ ¼å’Œæ¨™é»
                const cleanText = text.trim().replace(/\s+/g, ' ');
                
                // å°æ–¼å–®å­—ï¼Œä¸éœ€è¦åŠ åœé “ï¼›å°æ–¼ä¾‹å¥ï¼Œä¿æŒåŸæ¨£
                const isSentence = cleanText.length > 5 || cleanText.includes('ã€‚') || cleanText.includes('ã€');
                const textWithPause = isSentence ? cleanText : ` ${cleanText}`;
                
                const utterance = new SpeechSynthesisUtterance(textWithPause);
                
                // ä½¿ç”¨æœ€ä½³èªéŸ³
                if (japaneseVoice) {
                    utterance.voice = japaneseVoice;
                }
                
                utterance.lang = japaneseVoice?.lang || 'ja-JP';
                utterance.rate = Math.max(0.3, Math.min(1.5, rate));  // é™åˆ¶èªé€Ÿç¯„åœ
                utterance.pitch = 1.0;      // éŸ³èª¿ï¼ˆ0-2ï¼Œé è¨­1ï¼‰
                utterance.volume = 1.0;     // éŸ³é‡ï¼ˆ0-1ï¼‰
                
                // éŒ¯èª¤è™•ç†
                utterance.onerror = (e) => {
                    console.error('èªéŸ³æ’­æ”¾éŒ¯èª¤:', e);
                };
                
                if (onEnd) {
                    utterance.onend = onEnd;
                }
                
                // ä½¿ç”¨ setTimeout ç¢ºä¿å¼•æ“æº–å‚™å¥½
                setTimeout(() => {
                    try {
                        window.speechSynthesis.speak(utterance);
                    } catch (e) {
                        console.error('ç„¡æ³•æ’­æ”¾èªéŸ³:', e);
                    }
                }, 100);
            }, 50);
        }

        // æ…¢é€Ÿæ’­æ”¾ï¼ˆçµ¦ç”¨æˆ¶æ‰‹å‹•é»æ“Šç”¨ï¼‰
        function speakSlow() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                // å„ªå…ˆä½¿ç”¨å‡åï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨å–®å­—
                const speakTarget = (word.kana && word.kana.trim()) ? word.kana.trim() : word.word.trim();
                if (speakTarget) {
                    speakText(speakTarget, 0.45);  // æ›´æ…¢çš„é€Ÿåº¦ï¼Œæ–¹ä¾¿å­¸ç¿’
                }
            }
        }

        // æ­£å¸¸é€Ÿåº¦æ’­æ”¾
        function speakNormal() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                // å„ªå…ˆä½¿ç”¨å‡åï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨å–®å­—
                const speakTarget = (word.kana && word.kana.trim()) ? word.kana.trim() : word.word.trim();
                if (speakTarget) {
                    speakText(speakTarget, 0.8);  // ç¨å¾®æ…¢ä¸€é»çš„æ­£å¸¸é€Ÿåº¦
                }
            }
        }

        function speakExample() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word?.example) {
                const example = word.example.trim();
                if (example) {
                    // ä¾‹å¥ä½¿ç”¨ç¨æ…¢çš„é€Ÿåº¦ï¼Œæ–¹ä¾¿ç†è§£
                    speakText(example, 0.75);
                }
            }
        }

        function playSound(type) {
            try {
                const sound = document.getElementById(`sound-${type}`);
                sound.currentTime = 0;
                sound.volume = 0.3;
                sound.play().catch(() => {});
            } catch (e) {}
        }

        // ===== çµ±è¨ˆ =====
        function openStats() {
            document.getElementById('stat-streak').textContent = userData.streak;
            document.getElementById('stat-xp').textContent = userData.xp;
            document.getElementById('stat-words').textContent = userData.wordsLearned?.length || 0;
            const accuracy = userData.totalAnswered > 0 
                ? Math.round(userData.totalCorrect / userData.totalAnswered * 100) 
                : 0;
            document.getElementById('stat-accuracy').textContent = accuracy + '%';
            
            // æ›´æ–°å·²å­¸å–®å­—åˆ—è¡¨
            updateLearnedWordsList();
            
            document.getElementById('stats-modal').classList.remove('hidden');
        }

        function closeStats() {
            document.getElementById('stats-modal').classList.add('hidden');
        }

        // åˆ‡æ›é¡¯ç¤ºå·²å­¸å–®å­—
        function toggleLearnedWords() {
            const list = document.getElementById('learned-words-list');
            const text = document.getElementById('toggle-words-text');
            const icon = document.getElementById('toggle-words-icon');
            
            if (list.classList.contains('hidden')) {
                list.classList.remove('hidden');
                text.textContent = 'æ”¶åˆ';
                icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            } else {
                list.classList.add('hidden');
                text.textContent = 'å±•é–‹';
                icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            }
        }

        // æ›´æ–°å·²å­¸å–®å­—åˆ—è¡¨
        function updateLearnedWordsList() {
            const container = document.getElementById('learned-words-list');
            const history = userData.learnedHistory || {};
            
            if (Object.keys(history).length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center">é‚„æ²’æœ‰å­¸ç¿’è¨˜éŒ„</p>';
                return;
            }

            let html = '';
            for (const [topic, words] of Object.entries(history)) {
                if (words.length > 0) {
                    html += `
                        <div class="mb-3">
                            <div class="text-xs text-gray-400 mb-1">${topic} (${words.length})</div>
                            <div class="flex flex-wrap gap-1">
                                ${words.map(w => `<span class="text-xs bg-white/10 px-2 py-1 rounded">${w}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            container.innerHTML = html || '<p class="text-gray-500 text-sm text-center">é‚„æ²’æœ‰å­¸ç¿’è¨˜éŒ„</p>';
        }

        // æ¸…é™¤å­¸ç¿’è¨˜éŒ„ï¼ˆä½†ä¿ç•™ XP ç­‰æ•¸æ“šï¼‰
        function clearLearnedHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤å­¸ç¿’è¨˜éŒ„å—ï¼Ÿ\næ¸…é™¤å¾Œå¯ä»¥é‡æ–°å­¸ç¿’æ‰€æœ‰å–®å­—ï¼Œä½† XP å’Œé€£çºŒå¤©æ•¸æœƒä¿ç•™ã€‚')) {
                userData.learnedHistory = {};
                userData.wordsLearned = [];
                APP_STATE.historyData = [];
                saveUserData();
                updateLearnedWordsList();
                alert('å­¸ç¿’è¨˜éŒ„å·²æ¸…é™¤ï¼');
            }
        }

        // ===== æ‰‹æ©Ÿé¸å–® =====
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
            
            // åŒæ­¥æ›´æ–°æ‰‹æ©Ÿç‰ˆä¸»é¡Œåˆ—è¡¨
            if (!menu.classList.contains('hidden')) {
                updateMobileTopics();
            }
        }

        function updateMobileTopics() {
            updateMobileTopicSelect();
        }

        function updateMobileTopicSelect() {
            const select = document.getElementById('mobile-topic-select');
            if (!select) return;
            
            const topics = TOPICS[APP_STATE.currentMode] || [];
            
            select.innerHTML = topics.map(t => `
                <option value="${t.value}" ${t.value === APP_STATE.currentTopic ? 'selected' : ''}>${t.label}</option>
            `).join('');
        }

        function onMobileTopicChange() {
            const select = document.getElementById('mobile-topic-select');
            APP_STATE.currentTopic = select.value;
            APP_STATE.historyData = [];
            
            // åŒæ­¥æ¡Œé¢ç‰ˆé¸å–®
            const desktopSelect = document.getElementById('topic-select');
            if (desktopSelect) desktopSelect.value = select.value;
            
            toggleMobileMenu();
            loadContent();
        }

        // ===== èªéŸ³è¼¸å…¥åŠŸèƒ½ï¼ˆå„ªåŒ–ç‰ˆï¼‰=====
        // ä¸»è¦å„ªåŒ–ï¼š
        // 1. å³æ™‚éŸ³é‡è¦–è¦ºåé¥‹ï¼ˆè®“ç”¨æˆ¶çŸ¥é“éº¥å…‹é¢¨æ­£åœ¨æ¥æ”¶ï¼‰
        // 2. èªéŸ³æ´»å‹•æª¢æ¸¬ (VAD) - è‡ªå‹•åˆ¤æ–·åœæ­¢èªªè©±
        // 3. æ›´å¥½çš„éŒ¯èª¤è™•ç†å’Œæ¢å¾©æ©Ÿåˆ¶
        
        let recognition = null;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let isListening = false;
        let recognitionTimeout = null;
        let currentTargetInput = null;
        let accumulatedTranscript = '';
        let autoRestartChat = false;

        // èªéŸ³æ´»å‹•æª¢æ¸¬ (VAD) é…ç½®
        const VAD_CONFIG = {
            silenceThreshold: 0.02,      // éœéŸ³é–€æª» (0-1)
            silenceTimeout: 2000,         // éœéŸ³å¤šä¹…å¾ŒçµæŸ (ms)
            minSpeechDuration: 300,       // æœ€å°èªªè©±æ™‚é–“ (ms)
            maxListenDuration: 30000,     // æœ€é•·è†è½æ™‚é–“ (ms)
            smoothingFactor: 0.8          // éŸ³é‡å¹³æ»‘ä¿‚æ•¸
        };

        let silenceTimer = null;
        let speechStartTime = null;
        let lastVolumeLevel = 0;
        let volumeUpdateInterval = null;

        // ===== åˆå§‹åŒ–éŸ³è¨Šåˆ†æå™¨ï¼ˆç”¨æ–¼è¦–è¦ºåé¥‹å’Œ VADï¼‰=====
        async function initAudioAnalyser() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,      // å›éŸ³æ¶ˆé™¤
                        noiseSuppression: true,       // å™ªéŸ³æŠ‘åˆ¶
                        autoGainControl: true,        // è‡ªå‹•å¢ç›Š
                    }
                });

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;

                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                console.log('ğŸ¤ éŸ³è¨Šåˆ†æå™¨åˆå§‹åŒ–æˆåŠŸ');
                return stream;
            } catch (error) {
                console.warn('éŸ³è¨Šåˆ†æå™¨åˆå§‹åŒ–å¤±æ•—:', error);
                throw error;
            }
        }

        // ===== ç²å–ç•¶å‰éŸ³é‡ç´šåˆ¥ =====
        function getVolumeLevel() {
            if (!analyser) return 0;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length / 255;

            lastVolumeLevel = lastVolumeLevel * VAD_CONFIG.smoothingFactor + 
                              average * (1 - VAD_CONFIG.smoothingFactor);

            return lastVolumeLevel;
        }

        // ===== æ›´æ–°éŸ³é‡è¦–è¦ºåé¥‹ =====
        function updateVolumeIndicator(volume) {
            const indicators = ['chat-volume-indicator', 'voice-volume-indicator'];
            
            indicators.forEach(id => {
                const container = document.getElementById(id);
                if (!container) return;
                
                const bars = container.querySelectorAll('.volume-bar');
                const activeCount = Math.ceil(volume * bars.length * 3);

                bars.forEach((bar, index) => {
                    if (index < activeCount) {
                        bar.style.transform = `scaleY(${0.3 + volume * 2})`;
                        bar.style.opacity = '1';
                        bar.style.backgroundColor = volume > 0.3 ? '#58cc02' : '#1cb0f6';
                    } else {
                        bar.style.transform = 'scaleY(0.3)';
                        bar.style.opacity = '0.3';
                        bar.style.backgroundColor = '#4a5568';
                    }
                });
            });
        }

        // ===== èªéŸ³æ´»å‹•æª¢æ¸¬ (VAD) =====
        function startVAD() {
            if (volumeUpdateInterval) {
                clearInterval(volumeUpdateInterval);
            }

            speechStartTime = null;
            silenceTimer = null;

            volumeUpdateInterval = setInterval(() => {
                if (!isListening) {
                    clearInterval(volumeUpdateInterval);
                    return;
                }

                const volume = getVolumeLevel();
                updateVolumeIndicator(volume);

                if (volume > VAD_CONFIG.silenceThreshold) {
                    if (!speechStartTime) {
                        speechStartTime = Date.now();
                        console.log('ğŸ™ï¸ åµæ¸¬åˆ°èªéŸ³é–‹å§‹');
                    }
                    
                    if (silenceTimer) {
                        clearTimeout(silenceTimer);
                        silenceTimer = null;
                    }
                } else {
                    if (speechStartTime && !silenceTimer) {
                        const speechDuration = Date.now() - speechStartTime;
                        
                        if (speechDuration > VAD_CONFIG.minSpeechDuration) {
                            console.log('ğŸ¤« åµæ¸¬åˆ°éœéŸ³ï¼Œé–‹å§‹å€’è¨ˆæ™‚...');
                            silenceTimer = setTimeout(() => {
                                if (isListening && recognition) {
                                    console.log('â±ï¸ éœéŸ³è¶…æ™‚ï¼Œè‡ªå‹•çµæŸè†è½');
                                    recognition.stop();
                                }
                            }, VAD_CONFIG.silenceTimeout);
                        }
                    }
                }
            }, 50);
        }

        function stopVAD() {
            if (volumeUpdateInterval) {
                clearInterval(volumeUpdateInterval);
                volumeUpdateInterval = null;
            }
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
            speechStartTime = null;
            updateVolumeIndicator(0);
        }

        function initSpeechRecognition(targetInputId) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.log('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜');
                document.querySelectorAll('[id$="-mic-btn"]').forEach(btn => {
                    btn.style.display = 'none';
                });
                return false;
            }

            if (recognition && isListening) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.log('åœæ­¢èˆŠçš„ recognition:', e);
                }
                setTimeout(() => {
                    initSpeechRecognition(targetInputId);
                }, 300);
                return true;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = (targetInputId === 'chat-input');
            recognition.interimResults = true;
            recognition.maxAlternatives = 3;

            recognition.onstart = async function() {
                isListening = true;
                accumulatedTranscript = '';
                updateMicButtonState(true);
                
                // åˆå§‹åŒ–éŸ³è¨Šåˆ†æå™¨
                if (!audioContext) {
                    try {
                        await initAudioAnalyser();
                    } catch (e) {
                        console.warn('éŸ³è¨Šåˆ†æå™¨åˆå§‹åŒ–å¤±æ•—ï¼Œç¹¼çºŒä½¿ç”¨åŸºæœ¬è­˜åˆ¥');
                    }
                }

                // å•Ÿå‹• VAD
                startVAD();

                if (recognitionTimeout) clearTimeout(recognitionTimeout);
                recognitionTimeout = setTimeout(() => {
                    if (isListening && recognition) {
                        recognition.stop();
                        showVoiceError('è†è½è¶…æ™‚ï¼Œè«‹å†è©¦ä¸€æ¬¡');
                    }
                }, VAD_CONFIG.maxListenDuration);
                
                console.log('ğŸ¤ èªéŸ³è­˜åˆ¥å·²å•Ÿå‹•');
            };

            recognition.onend = function() {
                isListening = false;
                updateMicButtonState(false);
                stopVAD();
                
                if (recognitionTimeout) {
                    clearTimeout(recognitionTimeout);
                    recognitionTimeout = null;
                }
                
                if (currentTargetInput && accumulatedTranscript && !currentTargetInput.value.trim()) {
                    currentTargetInput.value = accumulatedTranscript.trim();
                    currentTargetInput.style.color = 'white';
                    playSound('correct');
                    
                    if (currentTargetInput && currentTargetInput.id === 'chat-input' && accumulatedTranscript.trim()) {
                        setTimeout(() => {
                            sendChat();
                            setTimeout(() => {
                                if (APP_STATE.currentMode === 'chat' && autoRestartChat && !isListening) {
                                    startVoiceInput('chat-input');
                                }
                            }, 800);
                        }, 300);
                        return;
                    }
                }
                
                document.getElementById('chat-voice-status')?.classList.add('hidden');
                document.getElementById('voice-status')?.classList.add('hidden');
                
                if (autoRestartChat && currentTargetInput && currentTargetInput.id === 'chat-input' && APP_STATE.currentMode === 'chat' && !isListening) {
                    setTimeout(() => {
                        if (APP_STATE.currentMode === 'chat' && autoRestartChat && !isListening) {
                            startVoiceInput('chat-input');
                        }
                    }, 800);
                }
            };

            recognition.onerror = function(event) {
                console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);
                isListening = false;
                updateMicButtonState(false);
                stopVAD();
                
                if (recognitionTimeout) {
                    clearTimeout(recognitionTimeout);
                    recognitionTimeout = null;
                }
                
                const errorMessages = {
                    'no-speech': 'æ²’æœ‰åµæ¸¬åˆ°è²éŸ³ï¼Œè«‹ç¢ºèªéº¥å…‹é¢¨æ­£å¸¸ä¸¦é è¿‘èªªè©±',
                    'not-allowed': 'è«‹å…è¨±ä½¿ç”¨éº¥å…‹é¢¨æ¬Šé™ï¼ˆé»æ“Šç¶²å€åˆ—å·¦å´çš„ ğŸ”’ åœ–ç¤ºï¼‰',
                    'network': 'ç¶²è·¯é€£ç·šå•é¡Œï¼ŒèªéŸ³è­˜åˆ¥éœ€è¦ç¶²è·¯é€£ç·š',
                    'service-not-allowed': 'èªéŸ³æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦',
                    'audio-capture': 'ç„¡æ³•å–å¾—éº¥å…‹é¢¨éŸ³è¨Šï¼Œè«‹æª¢æŸ¥éº¥å…‹é¢¨é€£æ¥',
                    'aborted': null
                };

                const message = errorMessages[event.error] || 'èªéŸ³è¾¨è­˜ç™¼ç”ŸéŒ¯èª¤';
                if (message) showVoiceError(message);
                
                document.getElementById('chat-voice-status')?.classList.add('hidden');
                document.getElementById('voice-status')?.classList.add('hidden');
            };

            recognition.onnomatch = function() {
                console.log('æ²’æœ‰åŒ¹é…çš„èªéŸ³çµæœï¼Œç¹¼çºŒè†è½...');
            };

            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript;
                    const confidence = result[0].confidence || 0.5;
                    
                    if (result.isFinal) {
                        if (confidence > 0.3) {
                            finalTranscript += transcript;
                            accumulatedTranscript += (accumulatedTranscript ? ' ' : '') + transcript;
                        }
                    } else {
                        interimTranscript = transcript;
                    }
                }

                if (interimTranscript && currentTargetInput) {
                    const displayText = accumulatedTranscript ? 
                        accumulatedTranscript + ' ' + interimTranscript : 
                        interimTranscript;
                    currentTargetInput.value = displayText;
                    currentTargetInput.style.color = '#94a3b8';
                }

                if (finalTranscript && currentTargetInput) {
                    accumulatedTranscript = accumulatedTranscript.trim();
                    currentTargetInput.value = accumulatedTranscript;
                    currentTargetInput.style.color = 'white';
                    
                    playSound('correct');
                    
                    if (targetInputId === 'chat-input' && accumulatedTranscript) {
                        autoRestartChat = true;
                        recognition.stop();
                        
                        setTimeout(() => {
                            if (currentTargetInput && currentTargetInput.value.trim()) {
                                sendChat();
                            }
                        }, 300);
                    }
                }
            };

            return true;
        }

        function startVoiceInput(targetInputId) {
            if (isListening && recognition) {
                autoRestartChat = false;
                try {
                    recognition.stop();
                } catch (e) {
                    console.log('åœæ­¢ recognition æ™‚å‡ºéŒ¯:', e);
                }
                setTimeout(() => startVoiceInput(targetInputId), 500);
                return;
            }

            currentTargetInput = document.getElementById(targetInputId);
            if (!currentTargetInput) {
                console.error('æ‰¾ä¸åˆ°ç›®æ¨™è¼¸å…¥æ¡†:', targetInputId);
                return;
            }
            
            accumulatedTranscript = '';
            autoRestartChat = (targetInputId === 'chat-input');
            
            if (!initSpeechRecognition(targetInputId)) {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨');
                return;
            }
            
            if (targetInputId === 'chat-input') {
                document.getElementById('chat-voice-status')?.classList.remove('hidden');
            } else {
                document.getElementById('voice-status')?.classList.remove('hidden');
            }

            try {
                recognition.start();
            } catch (e) {
                console.error('ç„¡æ³•å•Ÿå‹•èªéŸ³è¾¨è­˜:', e);
                if (e.message && e.message.includes('already started')) {
                    try {
                        recognition.stop();
                    } catch (e1) {
                        console.log('åœæ­¢æ™‚å‡ºéŒ¯:', e1);
                    }
                    setTimeout(() => {
                        try {
                            if (recognition && !isListening) {
                                recognition.start();
                            }
                        } catch (e2) {
                            showVoiceError('ç„¡æ³•å•Ÿå‹•èªéŸ³è¾¨è­˜ï¼Œè«‹ç¨å¾Œå†è©¦');
                        }
                    }, 500);
                } else {
                    showVoiceError('ç„¡æ³•å•Ÿå‹•èªéŸ³è¾¨è­˜ï¼Œè«‹æª¢æŸ¥éº¥å…‹é¢¨æ¬Šé™');
                }
            }
        }

        function updateMicButtonState(listening) {
            const micBtns = document.querySelectorAll('[id$="-mic-btn"]');
            micBtns.forEach(btn => {
                if (listening) {
                    btn.classList.add('animate-pulse', 'ring-4', 'ring-red-500/50', 'listening');
                    btn.innerHTML = '<i class="fa-solid fa-stop text-xl"></i>';
                } else {
                    btn.classList.remove('animate-pulse', 'ring-4', 'ring-red-500/50', 'listening');
                    btn.innerHTML = '<i class="fa-solid fa-microphone text-xl"></i>';
                    
                    document.getElementById('chat-voice-status')?.classList.add('hidden');
                    document.getElementById('voice-status')?.classList.add('hidden');
                }
            });
        }

        function showVoiceError(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full shadow-lg z-50 animate-slide';
            toast.innerHTML = `<i class="fa-solid fa-exclamation-circle mr-2"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // åˆå§‹åŒ–èªéŸ³è¾¨è­˜
        document.addEventListener('DOMContentLoaded', () => {
            initSpeechRecognition();
        });

        // ===== éµç›¤å¿«æ·éµ =====
        document.addEventListener('keydown', (e) => {
            // é¿å…åœ¨è¼¸å…¥æ¡†ä¸­è§¸ç™¼
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case ' ':  // ç©ºç™½éµï¼šç¿»è½‰é–ƒå¡ / æ’­æ”¾ç™¼éŸ³
                    e.preventDefault();
                    if (APP_STATE.currentMode === 'flashcard') {
                        flipCard();
                    } else if (APP_STATE.currentMode === 'listening') {
                        playListeningWord();
                    } else {
                        speakNormal();
                    }
                    break;
                case '1': case '2': case '3': case '4':
                    // æ•¸å­—éµï¼šé¸æ“‡é¸é …
                    if (APP_STATE.currentMode === 'quiz' || APP_STATE.currentMode === 'listening') {
                        const idx = parseInt(e.key) - 1;
                        const options = document.querySelectorAll(
                            APP_STATE.currentMode === 'quiz' ? '#quiz-options button' : '#listening-options button'
                        );
                        if (options[idx]) options[idx].click();
                    }
                    break;
                case 'ArrowRight':
                case 'Enter':
                    // å³ç®­é ­/Enterï¼šä¸‹ä¸€å€‹ï¼ˆé–ƒå¡è©•åˆ†ã€Œæœ‰å°è±¡ã€ï¼‰
                    if (APP_STATE.currentMode === 'flashcard' && APP_STATE.isFlipped) {
                        rateCard('good');
                    }
                    break;
                case 'ArrowLeft':
                    // å·¦ç®­é ­ï¼šå†å­¸ä¸€æ¬¡
                    if (APP_STATE.currentMode === 'flashcard' && APP_STATE.isFlipped) {
                        rateCard('hard');
                    }
                    break;
                case 'ArrowUp':
                    // ä¸Šç®­é ­ï¼šå¾ˆç†Ÿæ‚‰
                    if (APP_STATE.currentMode === 'flashcard' && APP_STATE.isFlipped) {
                        rateCard('easy');
                    }
                    break;
                case 's':
                    // Sï¼šæ…¢é€Ÿæ’­æ”¾
                    speakSlow();
                    break;
                case 'r':
                    // Rï¼šé‡è¤‡æ’­æ”¾
                    speakWord();
                    break;
            }
        });

        function resetAllData() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç¿’æ•¸æ“šå—ï¼Ÿ\né€™æœƒæ¸…é™¤æ‰€æœ‰ XPã€é€£çºŒå¤©æ•¸å’Œå­¸ç¿’è¨˜éŒ„ï¼')) {
                userData = { 
                    xp: 0, 
                    streak: 0, 
                    wordsLearned: [], 
                    learnedHistory: {},
                    totalCorrect: 0, 
                    totalAnswered: 0, 
                    lastActive: null 
                };
                APP_STATE.historyData = [];
                saveUserData();
                closeStats();
                alert('æ‰€æœ‰æ•¸æ“šå·²é‡ç½®ï¼');
            }
        }
    </script>
</body>
</html>
