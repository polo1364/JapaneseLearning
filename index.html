<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinguaMax - AI æ—¥èªå­¸ç¿’ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #58cc02;
            --primary-dark: #46a302;
            --secondary: #1cb0f6;
            --gold: #ffc800;
            --danger: #ff4b4b;
            --bg-dark: #131f24;
            --bg-card: #1a2c35;
            --text-light: #afafaf;
        }

        * { font-family: 'Nunito', sans-serif; }
        
        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f1a1f 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(26, 44, 53, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .glow-green { box-shadow: 0 0 20px rgba(88, 204, 2, 0.3); }
        .glow-blue { box-shadow: 0 0 20px rgba(28, 176, 246, 0.3); }
        .glow-gold { box-shadow: 0 0 20px rgba(255, 200, 0, 0.3); }

        /* Flashcard 3D ç¿»è½‰ */
        .flashcard { perspective: 1500px; }
        .flashcard-inner {
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .flashcard-back { transform: rotateY(180deg); }

        /* é€²åº¦æ¢å‹•ç•« */
        .progress-fill {
            transition: width 0.5s ease-out;
            background: linear-gradient(90deg, var(--primary), #7cd836);
        }

        /* æŒ‰éˆ•æ•ˆæœ */
        .btn-primary {
            background: var(--primary);
            box-shadow: 0 4px 0 var(--primary-dark);
            transition: all 0.1s;
        }
        .btn-primary:active {
            box-shadow: 0 2px 0 var(--primary-dark);
            transform: translateY(2px);
        }

        .btn-option {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.2);
            transition: all 0.2s;
        }
        .btn-option:hover {
            border-color: var(--secondary);
            background: rgba(28, 176, 246, 0.1);
        }
        .btn-option.correct {
            border-color: var(--primary) !important;
            background: rgba(88, 204, 2, 0.2) !important;
            animation: pulse-green 0.5s;
        }
        .btn-option.wrong {
            border-color: var(--danger) !important;
            background: rgba(255, 75, 75, 0.2) !important;
            animation: shake 0.5s;
        }

        @keyframes pulse-green {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .animate-slide { animation: slideIn 0.5s ease-out; }
        .animate-float { animation: float 3s ease-in-out infinite; }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* XP å‹•ç•« */
        .xp-popup {
            animation: xpFloat 1.5s ease-out forwards;
        }
        @keyframes xpFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }

        /* é€£çºŒå¤©æ•¸ç«ç„° */
        .streak-fire {
            animation: fireGlow 1.5s ease-in-out infinite alternate;
        }
        @keyframes fireGlow {
            from { filter: drop-shadow(0 0 5px #ff6b00); }
            to { filter: drop-shadow(0 0 15px #ff9500); }
        }

        /* è½åŠ›æ³¢å½¢ */
        .sound-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 30px;
        }
        .sound-wave span {
            width: 4px;
            background: var(--secondary);
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }
        .sound-wave span:nth-child(1) { animation-delay: 0s; height: 40%; }
        .sound-wave span:nth-child(2) { animation-delay: 0.1s; height: 70%; }
        .sound-wave span:nth-child(3) { animation-delay: 0.2s; height: 100%; }
        .sound-wave span:nth-child(4) { animation-delay: 0.3s; height: 70%; }
        .sound-wave span:nth-child(5) { animation-delay: 0.4s; height: 40%; }

        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }

        /* æ‰“å­—è¼¸å…¥ */
        .typing-input {
            background: transparent;
            border-bottom: 3px solid var(--secondary);
            color: white;
            font-size: 1.5rem;
            text-align: center;
            outline: none;
            caret-color: var(--secondary);
        }

        /* Modal */
        .modal-overlay {
            backdrop-filter: blur(8px);
            background: rgba(0,0,0,0.7);
        }

        /* éš±è— scrollbar ä½†å¯æ»¾å‹• */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ä¸‹æ‹‰é¸å–®ä¿®å¾© - ç¢ºä¿æ–‡å­—å¯è¦‹ */
        select {
            color: white !important;
            background-color: rgba(30, 41, 59, 0.95) !important;
        }
        select option {
            background-color: #1e293b !important;
            color: white !important;
            padding: 12px !important;
        }
        select:focus {
            outline: 2px solid var(--primary);
        }

        /* åˆå­¸è€…å‹å–„ - æ›´å¤§çš„å­—é«”å’Œé–“è· */
        .beginner-friendly {
            font-size: 1.1rem;
            line-height: 1.8;
        }

        /* æç¤ºæ¨™ç±¤ */
        .hint-tag {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e293b;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* æ–°æ‰‹å¼•å°æ°£æ³¡ */
        .guide-bubble {
            position: relative;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
        }
        .guide-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #8b5cf6;
        }
    </style>
</head>
<body class="text-white overflow-hidden">

    <!-- API Key Modal -->
    <div id="key-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-8 w-full max-w-md animate-slide">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-float">
                    <i class="fa-solid fa-robot text-4xl"></i>
                </div>
                <h2 class="text-2xl font-black">æ­¡è¿ä¾†åˆ° LinguaMax</h2>
                <p class="text-gray-400 mt-2">è¼¸å…¥ Gemini API Key é–‹å§‹å­¸ç¿’</p>
            </div>
            <input type="password" id="api-key-input" 
                class="w-full bg-white/10 border border-white/20 rounded-xl p-4 mb-4 text-white placeholder-gray-500 focus:border-green-500 focus:outline-none transition"
                placeholder="AIzaSy...">
            <button onclick="saveApiKey()" class="btn-primary w-full py-4 rounded-xl text-lg font-bold text-white">
                é–‹å§‹å­¸ç¿’ <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- ä¸»ç•«é¢ -->
    <div class="h-screen flex flex-col">
        <!-- é ‚éƒ¨å°èˆª -->
        <header class="glass-card border-b border-white/10 px-4 py-3">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3 md:gap-6">
                    <!-- æ‰‹æ©Ÿç‰ˆé¸å–®æŒ‰éˆ• -->
                    <button onclick="toggleMobileMenu()" class="lg:hidden w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-bars text-lg"></i>
            </button>

                    <h1 class="text-lg md:text-xl font-black bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent">
                        LinguaMax
                    </h1>
                    
                    <!-- é€£çºŒå¤©æ•¸ -->
                    <div class="hidden sm:flex items-center gap-2 bg-orange-500/20 px-3 py-1 rounded-full">
                        <i class="fa-solid fa-fire streak-fire text-orange-500"></i>
                        <span id="streak-count" class="font-bold text-orange-400">0</span>
        </div>

                    <!-- XP -->
                    <div class="flex items-center gap-2 bg-yellow-500/20 px-3 py-1 rounded-full">
                        <i class="fa-solid fa-star text-yellow-500"></i>
                        <span id="xp-count" class="font-bold text-yellow-400">0 XP</span>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <!-- ç­‰ç´šé¸æ“‡ -->
                    <div class="relative">
                        <label class="text-xs text-gray-400 absolute -top-5 left-0">é›£åº¦ç­‰ç´š</label>
                        <select id="level-select" onchange="onLevelChange()" class="bg-slate-800 border-2 border-slate-600 rounded-xl px-4 py-2.5 text-base font-semibold cursor-pointer hover:border-green-500 transition min-w-[200px]">
                            <option value="N5" selected>ğŸŒ± å…¥é–€ (N5)</option>
                            <option value="N4">ğŸŒ¿ åˆç´š (N4)</option>
                            <option value="N3">ğŸŒ³ ä¸­ç´š (N3)</option>
                            <option value="N2">ğŸŒ² ä¸­é«˜ç´š (N2)</option>
                            <option value="N1">ğŸ”ï¸ é€²éš (N1)</option>
                            <option value="SURVIVAL">ğŸ§­ æ—…æ—¥ç”Ÿå­˜</option>
                            <option value="TRAVEL_PLUS">âœˆï¸ æ—…éŠé€²éš</option>
                            <option value="BIZ_KEIGO">ğŸ’¼ è·å ´æ•¬èª</option>
                            <option value="CASUAL">ğŸ—£ï¸ æ—¥å¸¸ä¿—èª</option>
                            <option value="IT_DEV">ğŸ‘©â€ğŸ’» IT / å·¥ç¨‹</option>
                            <option value="KANA_HIRA">ğŸˆ å¹³å‡åå…¥é–€</option>
                            <option value="KANA_KATA">ğŸˆ‚ï¸ ç‰‡å‡åå…¥é–€</option>
                            <option value="CONVO">ğŸ’¬ æœƒè©±å„ªå…ˆ</option>
                    </select>
                    </div>

                    <!-- å€‹äººè³‡æ–™ -->
                    <button onclick="openStats()" class="w-11 h-11 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold hover:scale-105 transition" title="å­¸ç¿’çµ±è¨ˆ">
                        <i class="fa-solid fa-chart-line text-lg"></i>
                </button>
                </div>
            </div>
        </header>

        <!-- æ‰‹æ©Ÿç‰ˆé¸å–® (è¦†è“‹å±¤) -->
        <div id="mobile-menu" class="fixed inset-0 z-40 hidden lg:hidden">
            <div class="absolute inset-0 bg-black/60" onclick="toggleMobileMenu()"></div>
            <aside class="absolute left-0 top-0 bottom-0 w-72 glass-card border-r border-white/10 p-4 overflow-y-auto hide-scrollbar animate-slide">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-gray-400 flex items-center gap-2">
                        <i class="fa-solid fa-book-open text-green-500"></i> é¸æ“‡å­¸ç¿’æ¨¡å¼
                    </h3>
                    <button onclick="toggleMobileMenu()" class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-times"></i>
                    </button>
            </div>

                <nav class="space-y-2" id="mobile-mode-nav">
                    <button onclick="switchMode('kana'); toggleMobileMenu();" data-mode="kana" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-language text-xl text-emerald-400"></i>
                        <div class="text-left">
                            <div class="font-bold">äº”åéŸ³</div>
                            <div class="text-xs opacity-60">å¹³å‡å / ç‰‡å‡å</div>
                        </div>
                    </button>
                    <button onclick="switchMode('flashcard'); toggleMobileMenu();" data-mode="flashcard" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-green-500/20 border-2 border-green-500 text-green-400">
                        <i class="fa-solid fa-clone text-xl"></i>
                        <div class="text-left">
                            <div class="font-bold">å–®å­—é–ƒå¡</div>
                            <div class="text-xs opacity-60">ç¿»è½‰å­¸ç¿’æ–°å–®å­—</div>
            </div>
                    </button>
                    <button onclick="switchMode('quiz'); toggleMobileMenu();" data-mode="quiz" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-circle-question text-xl text-blue-400"></i>
                        <div class="text-left">
                            <div class="font-bold">é¸æ“‡é¡Œæ¸¬é©—</div>
                            <div class="text-xs opacity-60">å››é¸ä¸€å¿«é€Ÿç·´ç¿’</div>
                        </div>
                    </button>
                    <button onclick="switchMode('typing'); toggleMobileMenu();" data-mode="typing" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-keyboard text-xl text-purple-400"></i>
                        <div class="text-left">
                            <div class="font-bold">æ‹¼å¯«ç·´ç¿’</div>
                            <div class="text-xs opacity-60">æ‰“å­—è¨˜æ†¶å–®å­—</div>
                        </div>
                    </button>
                    <button onclick="switchMode('listening'); toggleMobileMenu();" data-mode="listening" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-headphones text-xl text-cyan-400"></i>
                        <div class="text-left">
                            <div class="font-bold">è½åŠ›è¨“ç·´</div>
                            <div class="text-xs opacity-60">è½éŸ³è¾¨ç¾©ç·´ç¿’</div>
                        </div>
                    </button>
                    <button onclick="switchMode('grammar'); toggleMobileMenu();" data-mode="grammar" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-spell-check text-xl text-amber-400"></i>
                        <div class="text-left">
                            <div class="font-bold">æ–‡æ³•é—˜é—œ</div>
                            <div class="text-xs opacity-60">å¥å‹çµæ§‹ç·´ç¿’</div>
                        </div>
                    </button>
                    <button onclick="switchMode('chat'); toggleMobileMenu();" data-mode="chat" 
                        class="mobile-mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-comments text-xl text-rose-400"></i>
                        <div class="text-left">
                            <div class="font-bold">AI å°è©±</div>
                            <div class="text-xs opacity-60">æƒ…å¢ƒæ—¥èªæœƒè©±</div>
                        </div>
                    </button>
                </nav>

                <hr class="border-white/10 my-6">

                <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-folder text-yellow-500"></i> é¸æ“‡å­¸ç¿’ä¸»é¡Œ
                </h3>
                <select id="mobile-topic-select" onchange="onMobileTopicChange()" 
                    class="w-full bg-slate-800 border-2 border-slate-600 rounded-xl px-4 py-3 text-base font-semibold cursor-pointer hover:border-yellow-500 transition">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </select>
            </aside>
            </div>

        <!-- ä¸»å…§å®¹å€ -->
        <div class="flex-1 flex overflow-hidden">
            <!-- å´é‚Šæ¬„ (æ¡Œé¢ç‰ˆ) -->
            <aside class="w-72 glass-card border-r border-white/10 p-4 hidden lg:block overflow-y-auto hide-scrollbar">
                <h3 class="text-sm font-bold text-gray-400 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-book-open text-green-500"></i> é¸æ“‡å­¸ç¿’æ¨¡å¼
                </h3>
                
                <nav class="space-y-2" id="mode-nav">
                    <button onclick="switchMode('kana')" data-mode="kana" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-language text-xl text-emerald-400"></i>
                        <div class="text-left">
                            <div class="font-bold">äº”åéŸ³</div>
                            <div class="text-xs opacity-60">å¹³å‡å / ç‰‡å‡åå°ˆå€</div>
                        </div>
                    </button>

                    <button onclick="switchMode('flashcard')" data-mode="flashcard" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-green-500/20 border-2 border-green-500 text-green-400">
                        <i class="fa-solid fa-clone text-xl"></i>
                        <div class="text-left">
                            <div class="font-bold">å–®å­—é–ƒå¡</div>
                            <div class="text-xs opacity-60">ç¿»è½‰å­¸ç¿’æ–°å–®å­—</div>
                        </div>
                    </button>

                    <button onclick="switchMode('quiz')" data-mode="quiz" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-circle-question text-xl text-blue-400"></i>
                        <div class="text-left">
                            <div class="font-bold">é¸æ“‡é¡Œæ¸¬é©—</div>
                            <div class="text-xs opacity-60">å››é¸ä¸€å¿«é€Ÿç·´ç¿’</div>
                        </div>
                    </button>

                    <button onclick="switchMode('typing')" data-mode="typing" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-keyboard text-xl text-purple-400"></i>
                        <div class="text-left">
                            <div class="font-bold">æ‹¼å¯«ç·´ç¿’</div>
                            <div class="text-xs opacity-60">æ‰“å­—è¨˜æ†¶å–®å­—</div>
                        </div>
                    </button>

                    <button onclick="switchMode('listening')" data-mode="listening" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-headphones text-xl text-cyan-400"></i>
                        <div class="text-left">
                            <div class="font-bold">è½åŠ›è¨“ç·´</div>
                            <div class="text-xs opacity-60">è½éŸ³è¾¨ç¾©ç·´ç¿’</div>
                        </div>
                    </button>

                    <button onclick="switchMode('grammar')" data-mode="grammar" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-spell-check text-xl text-amber-400"></i>
                        <div class="text-left">
                            <div class="font-bold">æ–‡æ³•é—–é—œ</div>
                            <div class="text-xs opacity-60">å¥å‹çµæ§‹ç·´ç¿’</div>
                        </div>
                    </button>

                    <button onclick="switchMode('chat')" data-mode="chat" 
                        class="mode-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 border-2 border-transparent">
                        <i class="fa-solid fa-comments text-xl text-rose-400"></i>
                        <div class="text-left">
                            <div class="font-bold">AI å°è©±</div>
                            <div class="text-xs opacity-60">æƒ…å¢ƒæ—¥èªæœƒè©±</div>
                        </div>
                    </button>
                </nav>

                <hr class="border-white/10 my-6">

                <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-folder text-yellow-500"></i> é¸æ“‡å­¸ç¿’ä¸»é¡Œ
                </h3>
                <select id="topic-select" onchange="onTopicChange()" 
                    class="w-full bg-slate-800 border-2 border-slate-600 rounded-xl px-4 py-3 text-base font-semibold cursor-pointer hover:border-yellow-500 transition">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </select>
                <div id="topic-list" class="hidden">
                    <!-- ä¿ç•™çµ¦èˆŠç‰ˆç›¸å®¹ -->
                </div>

                <hr class="border-white/10 my-6">

                <!-- ä»Šæ—¥é€²åº¦ -->
                <div class="glass-card rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-bold">ä»Šæ—¥ç›®æ¨™</span>
                        <span class="text-xs text-gray-400"><span id="today-learned">0</span>/20 å–®å­—</span>
                    </div>
                    <div class="h-3 bg-white/10 rounded-full overflow-hidden">
                        <div id="daily-progress" class="progress-fill h-full rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <!-- ç­‰ç´šé€²åº¦ -->
                <div class="glass-card rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-bold flex items-center gap-2">
                            <span id="user-level-badge" class="text-lg">ğŸŒ±</span>
                            Lv.<span id="user-level">1</span>
                        </span>
                        <span class="text-xs text-gray-400"><span id="xp-to-next">0</span>/<span id="xp-needed">100</span> XP</span>
                    </div>
                    <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                        <div id="level-progress" class="h-full rounded-full bg-gradient-to-r from-purple-500 to-pink-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- å¿«æ·éµæç¤º -->
                <div class="text-xs text-gray-500 space-y-1">
                    <p class="font-bold text-gray-400 mb-2"><i class="fa-solid fa-keyboard mr-1"></i>å¿«æ·éµ</p>
                    <p><kbd class="bg-white/10 px-1.5 py-0.5 rounded">ç©ºç™½</kbd> ç¿»è½‰/æ’­æ”¾</p>
                    <p><kbd class="bg-white/10 px-1.5 py-0.5 rounded">1-4</kbd> é¸æ“‡ç­”æ¡ˆ</p>
                    <p><kbd class="bg-white/10 px-1.5 py-0.5 rounded">S</kbd> æ…¢é€Ÿ <kbd class="bg-white/10 px-1.5 py-0.5 rounded">R</kbd> é‡è¤‡</p>
                </div>
            </aside>

            <!-- ä¸»å­¸ç¿’å€ -->
            <main class="flex-1 overflow-y-auto hide-scrollbar p-6">
                <div class="max-w-3xl mx-auto">
                    
                    <!-- è¼‰å…¥ä¸­ -->
                    <div id="loading" class="hidden fixed inset-0 bg-black/50 z-40 flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
                            <p class="mt-4 font-bold text-lg">AI æ­£åœ¨ç”Ÿæˆå­¸ç¿’å…§å®¹...</p>
                        </div>
                    </div>

                    <!-- å­¸ç¿’é€²åº¦æ¢ -->
                    <div id="session-progress" class="mb-6 hidden">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-400">å­¸ç¿’é€²åº¦</span>
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-bold"><span id="current-idx">1</span> / <span id="total-items">5</span></span>
                                <button onclick="regenerateContent()" 
                                    class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full flex items-center gap-1 transition"
                                    title="æ›ä¸€æ‰¹æ–°å–®å­—">
                                    <i class="fa-solid fa-shuffle"></i> æ›ä¸€æ‰¹
                                </button>
                            </div>
                        </div>
                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div id="session-bar" class="progress-fill h-full rounded-full" style="width: 20%"></div>
                        </div>
                    </div>

                    <!-- äº”åéŸ³æ¨¡å¼ -->
                    <div id="view-kana" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-6 md:p-8 animate-slide">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                                <div>
                                    <div class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-500/20 text-emerald-300 text-xs font-bold mb-2">
                                        <i class="fa-solid fa-language mr-2"></i> äº”åéŸ³å°ˆå€
                                    </div>
                                    <h2 class="text-2xl md:text-3xl font-black">å¹³å‡å / ç‰‡å‡åç·´ç¿’</h2>
                                    <p class="text-sm text-gray-300 mt-1">å›ºå®šå­—å¡ï¼ŒåŒ…å«ç™¼éŸ³ã€å‡åèˆ‡ä¾‹å­—ï¼Œå…ˆç†Ÿç·´è®€éŸ³å†é€²å…¥å–®å­—ã€‚</p>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-3 mb-4">
                                <button onclick="switchKanaMode('hiragana')" class="px-4 py-2 rounded-xl bg-emerald-500/20 border border-emerald-400/40 text-emerald-100 font-bold hover:bg-emerald-500/30 transition">
                                    ğŸˆ å¹³å‡å
                                </button>
                                <button onclick="switchKanaMode('katakana')" class="px-4 py-2 rounded-xl bg-cyan-500/20 border border-cyan-400/40 text-cyan-100 font-bold hover:bg-cyan-500/30 transition">
                                    ğŸˆ‚ï¸ ç‰‡å‡å
                                </button>
                            </div>

                            <div id="kana-grid" class="grid grid-cols-5 gap-3 md:gap-4 mt-4"></div>
                            <div id="kana-extra" class="space-y-6 mt-6"></div>
                        </div>
                    </div>

                    <!-- é–ƒå¡æ¨¡å¼ -->
                    <div id="view-flashcard" class="view-section">
                        <!-- æ–°æ‰‹æç¤º -->
                        <div id="flashcard-guide" class="guide-bubble mb-6 text-center max-w-md mx-auto">
                            <i class="fa-solid fa-hand-pointer mr-2"></i>
                            <strong>æç¤ºï¼š</strong>é»æ“Šå¡ç‰‡å¯ä»¥ç¿»è½‰æŸ¥çœ‹ä¸­æ–‡æ„æ€ï¼
                            <button onclick="this.parentElement.style.display='none'" class="ml-2 opacity-70 hover:opacity-100">âœ•</button>
                        </div>

                        <div class="flashcard h-80 md:h-[420px] cursor-pointer mx-auto max-w-lg" onclick="flipCard()">
                            <div class="flashcard-inner relative w-full h-full">
                                <!-- æ­£é¢ -->
                                <div class="flashcard-face flashcard-front absolute w-full h-full glass-card rounded-3xl flex flex-col items-center justify-center p-8">
                                    <span id="card-pos" class="text-base px-4 py-1.5 rounded-full bg-blue-500/20 text-blue-400 mb-4 font-semibold"></span>
                                    <h2 id="card-word" class="text-5xl md:text-6xl font-black mb-6 text-center"></h2>
                                    <p id="card-kana" class="text-2xl md:text-3xl font-bold text-blue-200 mb-1 text-center"></p>
                                    <p id="card-romaji" class="text-sm text-gray-400 mb-3 text-center"></p>
                                    
                                    <!-- èªéŸ³æ’­æ”¾æŒ‰éˆ•çµ„ -->
                                    <div class="flex items-center gap-3 mt-2">
                                        <button onclick="event.stopPropagation(); speakSlow()" 
                                            class="w-14 h-14 bg-amber-500/20 border-2 border-amber-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition" 
                                            title="æ…¢é€Ÿæ’­æ”¾">
                                            <i class="fa-solid fa-volume-low text-amber-400 text-lg"></i>
                                            <span class="text-[10px] text-amber-400 mt-0.5">æ…¢é€Ÿ</span>
                                        </button>
                                        <button onclick="event.stopPropagation(); speakNormal()" 
                                            class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex flex-col items-center justify-center hover:scale-110 transition shadow-lg" 
                                            title="æ­£å¸¸é€Ÿåº¦æ’­æ”¾">
                                            <i class="fa-solid fa-volume-high text-white text-2xl"></i>
                                        </button>
                                        <button onclick="event.stopPropagation(); speakWord()" 
                                            class="w-14 h-14 bg-green-500/20 border-2 border-green-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition" 
                                            title="é‡è¤‡æ’­æ”¾å…©æ¬¡">
                                            <i class="fa-solid fa-repeat text-green-400 text-lg"></i>
                                            <span class="text-[10px] text-green-400 mt-0.5">x2</span>
                                        </button>
                                    </div>
                                    
                                    <p class="text-gray-400 mt-6 text-base flex items-center gap-2">
                                        <i class="fa-solid fa-hand-pointer animate-bounce"></i>
                                        é»æ“Šå¡ç‰‡ç¿»è½‰
                                    </p>
                                </div>
                                <!-- èƒŒé¢ -->
                                <div class="flashcard-face flashcard-back absolute w-full h-full glass-card rounded-3xl flex flex-col items-center justify-center p-8 glow-green">
                                    <h3 id="card-mean" class="text-3xl md:text-4xl font-bold text-green-400 mb-6 text-center"></h3>
                                    <div class="bg-white/5 rounded-xl p-4 w-full">
                                        <div class="flex items-center justify-between mb-2">
                                            <p class="text-sm text-gray-400">ä¾‹å¥ï¼š</p>
                                            <button onclick="event.stopPropagation(); speakExample()" class="px-3 py-1 rounded-full bg-blue-500/20 text-blue-200 text-xs font-bold hover:bg-blue-500/30 transition" title="æ’­æ”¾ä¾‹å¥">
                                                <i class="fa-solid fa-volume-high mr-1"></i>æ’­æ”¾
                                            </button>
                                        </div>
                                        <p id="card-example" class="text-center text-gray-200 text-lg italic mb-2"></p>
                                        <p id="card-trans" class="text-center text-gray-400 text-base"></p>
                                    </div>
                                    <p id="card-notes" class="text-sm text-amber-300 text-center mt-3"></p>
                                </div>
                            </div>
                        </div>

                        <!-- é–ƒå¡æ§åˆ¶æŒ‰éˆ• - æ›´å¤§æ›´æ¸…æ¥š -->
                        <div class="mt-8 text-center text-gray-400 text-sm mb-3">
                            <i class="fa-solid fa-lightbulb text-yellow-500 mr-1"></i>
                            ç¿»è½‰å¡ç‰‡å¾Œï¼Œé¸æ“‡ä½ å°é€™å€‹å–®å­—çš„ç†Ÿæ‚‰ç¨‹åº¦ï¼š
                        </div>
                        <div class="flex justify-center gap-3 md:gap-4">
                            <button onclick="rateCard('hard')" class="flex-1 max-w-[160px] py-4 md:py-5 rounded-2xl bg-red-500/20 border-2 border-red-500/50 text-red-400 font-bold hover:bg-red-500/30 hover:scale-105 transition text-base md:text-lg">
                                <i class="fa-solid fa-rotate-right mr-2"></i>å†å­¸ä¸€æ¬¡
                            </button>
                            <button onclick="rateCard('good')" class="flex-1 max-w-[160px] py-4 md:py-5 rounded-2xl bg-yellow-500/20 border-2 border-yellow-500/50 text-yellow-400 font-bold hover:bg-yellow-500/30 hover:scale-105 transition text-base md:text-lg">
                                <i class="fa-solid fa-check mr-2"></i>æœ‰å°è±¡
                            </button>
                            <button onclick="rateCard('easy')" class="flex-1 max-w-[160px] py-4 md:py-5 rounded-2xl bg-green-500/20 border-2 border-green-500/50 text-green-400 font-bold hover:bg-green-500/30 hover:scale-105 transition text-base md:text-lg">
                                <i class="fa-solid fa-star mr-2"></i>å¾ˆç†Ÿæ‚‰
                            </button>
                        </div>
                    </div>

                    <!-- é¸æ“‡é¡Œæ¨¡å¼ -->
                    <div id="view-quiz" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-6 md:p-8 animate-slide">
                            <div class="text-center mb-8">
                                <div class="inline-block bg-blue-500/20 text-blue-400 px-4 py-2 rounded-full text-sm font-semibold mb-4">
                                    <i class="fa-solid fa-circle-question mr-2"></i>é¸æ“‡é¡Œ
                                </div>
                                <p class="text-gray-400 mb-4 text-base">é€™å€‹æ—¥æ–‡è©å½™æ˜¯ä»€éº¼æ„æ€ï¼Ÿ</p>
                                <h2 id="quiz-word" class="text-4xl md:text-5xl font-black mb-4"></h2>
                                
                                <!-- èªéŸ³æŒ‰éˆ•çµ„ -->
                                <div class="flex items-center justify-center gap-3">
                                    <button onclick="speakSlow()" class="bg-amber-500/20 border border-amber-500/50 px-4 py-2 rounded-full text-amber-400 font-semibold hover:scale-105 transition text-sm">
                                        <i class="fa-solid fa-volume-low mr-1"></i>æ…¢é€Ÿ
                                    </button>
                                    <button onclick="speakNormal()" class="bg-gradient-to-r from-blue-500 to-cyan-500 px-6 py-3 rounded-full text-white font-semibold hover:scale-105 transition">
                                        <i class="fa-solid fa-volume-high mr-2"></i>è½ç™¼éŸ³
                                    </button>
                                    <button onclick="speakWord()" class="bg-green-500/20 border border-green-500/50 px-4 py-2 rounded-full text-green-400 font-semibold hover:scale-105 transition text-sm">
                                        <i class="fa-solid fa-repeat mr-1"></i>x2
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-center gap-4 mb-4">
                                <p class="text-gray-400 text-sm">
                                    <i class="fa-solid fa-hand-pointer mr-1"></i>é»é¸ä¸‹æ–¹æ­£ç¢ºç­”æ¡ˆ
                                </p>
                                <button onclick="showQuizHint()" id="quiz-hint-btn" class="text-xs px-3 py-1 rounded-full bg-amber-500/20 text-amber-400 hover:bg-amber-500/30 transition">
                                    <i class="fa-solid fa-lightbulb mr-1"></i>æç¤º
                                </button>
                            </div>
                            <div id="quiz-hint" class="hidden text-center text-sm text-amber-300 mb-4 p-3 bg-amber-500/10 rounded-xl">
                                <!-- æç¤ºå…§å®¹ -->
                            </div>
                            <div id="quiz-options" class="space-y-3 max-w-lg mx-auto">
                                <!-- é¸é …å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                            <div id="quiz-feedback" class="hidden mt-6 p-5 rounded-2xl text-center text-lg">
                                <!-- å›é¥‹ -->
                            </div>
                        </div>
                    </div>

                    <!-- æ‹¼å¯«æ¨¡å¼ -->
                    <div id="view-typing" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-8 animate-slide">
                            <div class="text-center mb-8">
                                <span class="text-sm text-gray-400 mb-2 block">è«‹è¼¸å…¥å°æ‡‰çš„å‡åæˆ–æ—¥æ–‡è©å½™</span>
                                <h2 id="typing-hint" class="text-3xl font-bold text-green-400 mb-2"></h2>
                                <p id="typing-pos" class="text-gray-500"></p>
                            </div>

                            <div class="flex justify-center gap-3 mb-8">
                                <button onclick="speakSlow()" 
                                    class="w-14 h-14 bg-amber-500/20 border-2 border-amber-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition"
                                    title="æ…¢é€Ÿæ’­æ”¾">
                                    <i class="fa-solid fa-volume-low text-amber-400"></i>
                                    <span class="text-[9px] text-amber-400">æ…¢é€Ÿ</span>
                                </button>
                                <button onclick="speakNormal()" 
                                    class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center hover:scale-110 transition shadow-lg"
                                    title="æ­£å¸¸é€Ÿåº¦">
                                    <i class="fa-solid fa-volume-high text-2xl text-white"></i>
                                </button>
                                <button onclick="speakWord()" 
                                    class="w-14 h-14 bg-green-500/20 border-2 border-green-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition"
                                    title="æ’­æ”¾å…©æ¬¡">
                                    <i class="fa-solid fa-repeat text-green-400"></i>
                                    <span class="text-[9px] text-green-400">x2</span>
                                </button>
                            </div>

                            <!-- è¼¸å…¥å€åŸŸ (æ‰“å­— + èªéŸ³) -->
                            <div class="relative max-w-md mx-auto">
                                <input type="text" id="typing-input" 
                                    class="typing-input w-full py-2 pr-14"
                                    placeholder="è¼¸å…¥æˆ–èªªå‡ºæ—¥æ–‡ï¼å‡å..."
                                    autocomplete="off"
                                    onkeypress="if(event.key==='Enter') checkTyping()">
                                <!-- èªéŸ³è¼¸å…¥æŒ‰éˆ• -->
                                <button onclick="startVoiceInput('typing-input')" id="typing-mic-btn"
                                    class="absolute right-0 bottom-1 w-12 h-12 bg-gradient-to-br from-red-500 to-pink-500 rounded-full flex items-center justify-center hover:scale-110 transition shadow-lg"
                                    title="é»æ“Šèªªå‡ºç­”æ¡ˆ">
                                    <i class="fa-solid fa-microphone text-xl"></i>
                                </button>
                            </div>
                            <p class="text-center text-gray-500 text-xs mt-2">
                                <i class="fa-solid fa-microphone mr-1"></i>é»æ“Šéº¥å…‹é¢¨å¯ä»¥ç”¨èªªçš„
                            </p>

                            <div id="typing-feedback" class="hidden mt-6 p-4 rounded-xl text-center"></div>

                            <!-- èªéŸ³è¾¨è­˜ç‹€æ…‹ -->
                            <div id="voice-status" class="hidden mt-4 text-center">
                                <div class="inline-flex items-center gap-2 bg-red-500/20 text-red-400 px-4 py-2 rounded-full">
                                    <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                                    <span>æ­£åœ¨è†è½...</span>
                                </div>
                            </div>

                            <button onclick="checkTyping()" class="btn-primary w-full max-w-md mx-auto block mt-6 py-4 rounded-xl font-bold text-lg">
                                ç¢ºèªç­”æ¡ˆ
                            </button>
                        </div>
                    </div>

                    <!-- è½åŠ›æ¨¡å¼ -->
                    <div id="view-listening" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-8 animate-slide">
                            <div class="text-center mb-8">
                                <span class="text-sm text-gray-400 mb-4 block">ä»”ç´°è†è½ï¼Œé¸å‡ºä½ è½åˆ°çš„å–®å­—</span>
                                
                                <div class="flex items-center justify-center gap-4">
                                    <!-- æ…¢é€Ÿæ’­æ”¾ -->
                                    <button onclick="replayListeningSlow()" 
                                        class="w-16 h-16 bg-amber-500/20 border-2 border-amber-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition"
                                        title="è¶…æ…¢é€Ÿæ’­æ”¾">
                                        <i class="fa-solid fa-volume-low text-amber-400 text-xl"></i>
                                        <span class="text-[10px] text-amber-400">æ…¢é€Ÿ</span>
                                    </button>
                                    
                                    <!-- ä¸»æ’­æ”¾æŒ‰éˆ• -->
                                    <button onclick="playListeningWord()" class="w-24 h-24 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full flex flex-col items-center justify-center glow-blue hover:scale-105 transition">
                                        <i class="fa-solid fa-play text-4xl"></i>
                                        <span class="text-xs mt-1">æ’­æ”¾</span>
                                    </button>
                                    
                                    <!-- é‡è¤‡æ’­æ”¾ -->
                                    <button onclick="playListeningWord(); setTimeout(playListeningWord, 1500);" 
                                        class="w-16 h-16 bg-green-500/20 border-2 border-green-500/50 rounded-full flex flex-col items-center justify-center hover:scale-110 transition"
                                        title="æ’­æ”¾å…©æ¬¡">
                                        <i class="fa-solid fa-repeat text-green-400 text-xl"></i>
                                        <span class="text-[10px] text-green-400">x2</span>
                                    </button>
                                </div>

                                <div class="sound-wave justify-center mt-4 hidden" id="sound-waves">
                                    <span></span><span></span><span></span><span></span><span></span>
                                </div>
                                
                                <p class="text-gray-500 text-xs mt-3">
                                    <i class="fa-solid fa-lightbulb text-yellow-500 mr-1"></i>
                                    è½ä¸æ¸…æ¥šï¼Ÿé»ã€Œæ…¢é€Ÿã€æŒ‰éˆ•
                                </p>
                            </div>

                            <div id="listening-options" class="grid grid-cols-2 gap-4">
                                <!-- é¸é … -->
                            </div>

                            <div id="listening-feedback" class="hidden mt-6 p-4 rounded-xl text-center"></div>
                        </div>
                    </div>

                    <!-- æ–‡æ³•æ¨¡å¼ -->
                    <div id="view-grammar" class="view-section hidden">
                        <div class="glass-card rounded-3xl p-8 animate-slide">
                            <div class="mb-6">
                                <span class="px-3 py-1 bg-amber-500/20 text-amber-400 rounded-full text-sm font-bold">
                                    <i class="fa-solid fa-lightbulb mr-1"></i> æ–‡æ³•é‡é»
                                </span>
                                <h3 id="grammar-concept" class="text-2xl font-bold mt-3"></h3>
                                <p id="grammar-explanation" class="text-gray-400 mt-2"></p>
                            </div>

                            <div id="grammar-quiz" class="space-y-6">
                                <!-- æ–‡æ³•é¡Œç›® -->
                            </div>
                        </div>
                    </div>

                    <!-- AI å°è©±æ¨¡å¼ -->
            <div id="view-chat" class="view-section hidden h-full flex flex-col">
                        <div class="glass-card rounded-3xl flex-1 flex flex-col overflow-hidden">
                            <!-- å°è©±æƒ…å¢ƒ -->
                            <div class="p-4 border-b border-white/10 bg-gradient-to-r from-rose-500/20 to-purple-500/20">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center">
                                        <i class="fa-solid fa-user-tie text-xl"></i>
                </div>
                                    <div>
                                        <h3 id="chat-scenario" class="font-bold">æƒ…å¢ƒå°è©±</h3>
                                        <p class="text-xs text-gray-400">AI æ—¥èªæ•™ç·´</p>
            </div>
                                </div>
                            </div>

                            <!-- å°è©±å€ -->
                            <div id="chat-messages" class="flex-1 overflow-y-auto hide-scrollbar p-4 space-y-4">
                                <!-- è¨Šæ¯ -->
                            </div>

                            <!-- è¼¸å…¥å€ -->
                            <div class="p-4 border-t border-white/10">
                                <div class="flex gap-2">
                                    <!-- èªéŸ³è¼¸å…¥æŒ‰éˆ• -->
                                    <button onclick="startVoiceInput('chat-input')" id="chat-mic-btn"
                                        class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-500 rounded-full flex items-center justify-center hover:scale-110 transition shrink-0"
                                        title="é»æ“Šèªªæ—¥æ–‡">
                                        <i class="fa-solid fa-microphone text-lg"></i>
                                    </button>
                                    <input type="text" id="chat-input" 
                                        class="flex-1 bg-white/10 border border-white/20 rounded-full px-5 py-3 focus:border-rose-500 focus:outline-none transition text-base"
                                        placeholder="èªªæ—¥æ–‡æˆ–æ‰“å­—..."
                                        onkeypress="if(event.key==='Enter') sendChat()">
                                    <button onclick="sendChat()" class="w-12 h-12 bg-gradient-to-r from-rose-500 to-purple-500 rounded-full flex items-center justify-center hover:opacity-90 hover:scale-105 transition shrink-0" title="ç™¼é€">
                                        <i class="fa-solid fa-paper-plane"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2 text-center">
                                    <i class="fa-solid fa-microphone text-red-400 mr-1"></i>é»éº¥å…‹é¢¨ç”¨èªªçš„ Â· 
                                    <i class="fa-solid fa-keyboard text-blue-400 mr-1"></i>æˆ–ç›´æ¥æ‰“å­—
                                </p>
                                <!-- èªéŸ³è¾¨è­˜ç‹€æ…‹ -->
                                <div id="chat-voice-status" class="hidden mt-2 text-center">
                                    <div class="inline-flex items-center gap-2 bg-red-500/20 text-red-400 px-4 py-2 rounded-full text-sm">
                                        <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                                        <span>æ­£åœ¨è†è½æ‚¨èªªçš„æ—¥æ–‡...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

        </div>
    </main>
        </div>
    </div>

    <!-- çµ±è¨ˆ Modal -->
    <div id="stats-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto hide-scrollbar animate-slide">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">ğŸ“Š å­¸ç¿’çµ±è¨ˆ</h2>
                <button onclick="closeStats()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-fire text-3xl text-orange-500 mb-2"></i>
                    <div class="text-2xl font-bold" id="stat-streak">0</div>
                    <div class="text-xs text-gray-400">é€£çºŒå¤©æ•¸</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-star text-3xl text-yellow-500 mb-2"></i>
                    <div class="text-2xl font-bold" id="stat-xp">0</div>
                    <div class="text-xs text-gray-400">ç¸½ XP</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-book text-3xl text-green-500 mb-2"></i>
                    <div class="text-2xl font-bold" id="stat-words">0</div>
                    <div class="text-xs text-gray-400">å·²å­¸å–®å­—</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <i class="fa-solid fa-bullseye text-3xl text-blue-500 mb-2"></i>
                    <div class="text-2xl font-bold" id="stat-accuracy">0%</div>
                    <div class="text-xs text-gray-400">æ­£ç¢ºç‡</div>
                </div>
            </div>

            <!-- å·²å­¸å–®å­—åˆ—è¡¨ -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-sm text-gray-400">
                        <i class="fa-solid fa-list mr-1"></i> å·²å­¸å–®å­—è¨˜éŒ„
                    </h3>
                    <button onclick="toggleLearnedWords()" class="text-xs text-blue-400 hover:text-blue-300">
                        <span id="toggle-words-text">å±•é–‹</span> <i class="fa-solid fa-chevron-down" id="toggle-words-icon"></i>
                    </button>
                </div>
                <div id="learned-words-list" class="hidden bg-white/5 rounded-xl p-4 max-h-48 overflow-y-auto hide-scrollbar">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <div class="space-y-2">
                <button onclick="clearLearnedHistory()" class="w-full py-3 rounded-xl bg-amber-500/20 text-amber-400 font-bold hover:bg-amber-500/30 transition">
                    <i class="fa-solid fa-eraser mr-2"></i>æ¸…é™¤å­¸ç¿’è¨˜éŒ„ï¼ˆå¯é‡æ–°å­¸ç¿’ï¼‰
                </button>
                <button onclick="resetAllData()" class="w-full py-3 rounded-xl bg-red-500/20 text-red-400 font-bold hover:bg-red-500/30 transition">
                    <i class="fa-solid fa-trash-can mr-2"></i>é‡ç½®æ‰€æœ‰æ•¸æ“š
                </button>
            </div>
        </div>
    </div>

    <!-- å®Œæˆå‹•ç•« Modal -->
    <div id="complete-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="text-center animate-slide glass-card rounded-3xl p-8 max-w-md">
            <div class="text-8xl mb-4">ğŸ‰</div>
            <h2 class="text-3xl font-black mb-2">å¤ªæ£’äº†ï¼</h2>
            <p class="text-gray-400 mb-4">ä½ å®Œæˆäº†é€™ä¸€è¼ªå­¸ç¿’</p>
            <div class="text-5xl font-black text-green-400 mb-4">+<span id="earned-xp">50</span> XP</div>
            
            <!-- æœ¬è¼ªçµ±è¨ˆ -->
            <div class="grid grid-cols-3 gap-3 mb-6 text-center">
                <div class="bg-white/5 rounded-xl p-3">
                    <div class="text-2xl font-bold text-blue-400" id="round-total">5</div>
                    <div class="text-xs text-gray-400">å­¸ç¿’æ•¸é‡</div>
                </div>
                <div class="bg-white/5 rounded-xl p-3">
                    <div class="text-2xl font-bold text-green-400" id="round-correct">0</div>
                    <div class="text-xs text-gray-400">ç­”å°æ•¸</div>
                </div>
                <div class="bg-white/5 rounded-xl p-3">
                    <div class="text-2xl font-bold text-amber-400" id="round-accuracy">0%</div>
                    <div class="text-xs text-gray-400">æ­£ç¢ºç‡</div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="reviewMistakes()" class="flex-1 py-3 rounded-xl bg-amber-500/20 text-amber-400 font-bold hover:bg-amber-500/30 transition">
                    <i class="fa-solid fa-rotate-left mr-2"></i>è¤‡ç¿’éŒ¯é¡Œ
                </button>
                <button onclick="continuelearning()" class="flex-1 btn-primary py-3 rounded-xl font-bold">
                    ç¹¼çºŒå­¸ç¿’ <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- éŸ³æ•ˆ -->
    <audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>
    <audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/2001/2001-preview.mp3" preload="auto"></audio>

    <script>
        // ===== å…¨åŸŸç‹€æ…‹ =====
        const APP_STATE = {
            currentMode: 'flashcard',
            currentTopic: 'Daily life Japanese vocabulary',  // é è¨­ä¸»é¡Œ
            currentIndex: 0,
            words: [],
            historyData: [],
            isFlipped: false,
            isAnswered: false,
            totalCorrect: 0,
            totalAnswered: 0,
            roundCorrect: 0,      // æœ¬è¼ªæ­£ç¢ºæ•¸
            roundTotal: 0,        // æœ¬è¼ªç¸½é¡Œæ•¸
            mistakes: [],         // éŒ¯èª¤é¡Œç›®
            favorites: []         // æ”¶è—çš„å–®å­—
        };

        // ä¸»é¡Œè¨­å®š - label é¡¯ç¤ºä¸­æ–‡, value å‚³çµ¦ API
        const TOPICS = {
            flashcard: [
                { label: 'ã‚›ã‚œ æ‹—éŸ³ãƒ»æ¿éŸ³å¼·åŒ–', value: 'Youon and dakuten practice for kana' },
                { label: 'ğŸ™Œ åŸºæœ¬å•å€™', value: 'Greetings and self introduction in Japanese' },
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily life Japanese vocabulary' },
                { label: 'âœˆï¸ æ—…éŠå‡ºè¡Œ', value: 'Travel Japanese for tourists' },
                { label: 'ğŸ£ é¤å»³é»é¤', value: 'Ordering food and drinks in Japanese' },
                { label: 'ğŸ›¤ï¸ äº¤é€šè»Šç«™', value: 'Train station and transport phrases' },
                { label: 'ğŸ›ï¸ è³¼ç‰©çµå¸³', value: 'Shopping and payments in Japanese' },
                { label: 'ğŸ¥ é†«é™¢è—¥å±€', value: 'Doctor visit and pharmacy Japanese' },
                { label: 'ğŸ’¼ å•†å‹™æ•¬èªå…¥é–€', value: 'Basic business Japanese and keigo' },
                { label: 'ğŸ“ å®¢æœå®¢è¨´', value: 'Customer support and complaint handling' },
                { label: 'ğŸ‘©â€ğŸ’» IT/å·¥ç¨‹', value: 'IT and software development Japanese' },
                { label: 'ğŸ ç¦®ç¯€æ–‡åŒ–', value: 'Japanese etiquette and culture' },
                { label: 'ğŸš¨ ç·Šæ€¥æ‡‰è®Š', value: 'Emergency and disaster phrases' },
                { label: 'ğŸ‘¥ äº¤å‹èŠå¤©', value: 'Casual chats and slang with friends' },
                { label: 'ğŸ¨ è¨‚æˆ¿å…¥ä½', value: 'Hotel booking and check-in dialogues' },
                { label: 'ğŸšŒ å•è·¯ç§»å‹•', value: 'Asking directions and transportation' }
            ],
            quiz: [
                { label: 'ğŸ™Œ åŸºæœ¬å•å€™', value: 'Greetings and self introduction in Japanese' },
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily life Japanese vocabulary' },
                { label: 'âœˆï¸ æ—…éŠå‡ºè¡Œ', value: 'Travel Japanese for tourists' },
                { label: 'ğŸ£ é¤å»³é»é¤', value: 'Ordering food and drinks in Japanese' },
                { label: 'ğŸ›ï¸ è³¼ç‰©çµå¸³', value: 'Shopping and payments in Japanese' },
                { label: 'ğŸ’¼ å•†å‹™æ•¬èªå…¥é–€', value: 'Basic business Japanese and keigo' },
                { label: 'ğŸ“ å®¢æœå®¢è¨´', value: 'Customer support and complaint handling' },
                { label: 'ğŸ‘©â€ğŸ’» IT/å·¥ç¨‹', value: 'IT and software development Japanese' },
                { label: 'ğŸš¨ ç·Šæ€¥æ‡‰è®Š', value: 'Emergency and disaster phrases' },
                { label: 'ğŸ‘¥ äº¤å‹èŠå¤©', value: 'Casual chats and slang with friends' }
            ],
            typing: [
                { label: 'ã‚›ã‚œ æ‹—éŸ³ãƒ»æ¿éŸ³å¼·åŒ–', value: 'Youon and dakuten practice for kana' },
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily life Japanese vocabulary' },
                { label: 'ğŸ£ é¤å»³é»é¤', value: 'Ordering food and drinks in Japanese' },
                { label: 'ğŸ›¤ï¸ äº¤é€šè»Šç«™', value: 'Train station and transport phrases' },
                { label: 'ğŸ›ï¸ è³¼ç‰©çµå¸³', value: 'Shopping and payments in Japanese' },
                { label: 'ğŸ“ å®¢æœå®¢è¨´', value: 'Customer support and complaint handling' },
                { label: 'ğŸ‘¥ äº¤å‹èŠå¤©', value: 'Casual chats and slang with friends' }
            ],
            listening: [
                { label: 'ğŸ™Œ åŸºæœ¬å•å€™', value: 'Greetings and self introduction in Japanese' },
                { label: 'ğŸ  æ—¥å¸¸ç”Ÿæ´»', value: 'Daily life Japanese vocabulary' },
                { label: 'âœˆï¸ æ—…éŠå‡ºè¡Œ', value: 'Travel Japanese for tourists' },
                { label: 'ğŸ£ é¤å»³é»é¤', value: 'Ordering food and drinks in Japanese' },
                { label: 'ğŸ›¤ï¸ äº¤é€šè»Šç«™', value: 'Train station and transport phrases' },
                { label: 'ğŸš¨ ç·Šæ€¥æ‡‰è®Š', value: 'Emergency and disaster phrases' },
                { label: 'ğŸ‘¥ äº¤å‹èŠå¤©', value: 'Casual chats and slang with friends' }
            ],
            grammar: [
                { label: 'ã¯ãƒ»ãŒ ä¸»é¡Œ vs ä¸»èª', value: 'Particles wa vs ga usage' },
                { label: 'ã‚’ï¼ã«ï¼ã§ çš„å·®åˆ¥', value: 'Particles wo ni de usage' },
                { label: 'ã§ã™ãƒ»ã¾ã™é«”èˆ‡æ™®é€šå½¢', value: 'Polite vs plain forms' },
                { label: 'ã¦å½¢çš„é€£æ¥', value: 'Te-form connections' },
                { label: 'ãªã„å½¢å¦å®š', value: 'Negative nai form' },
                { label: 'ãŸå½¢èˆ‡éå»å¼', value: 'Ta form and past tense' },
                { label: 'å¯èƒ½å½¢è¡¨èƒ½åŠ›', value: 'Potential form' },
                { label: 'ã€œãŸã„ï¼ã€œãŸããªã„', value: 'Expressing desire tai form' },
                { label: 'åŸå›  ã‹ã‚‰ï¼ã®ã§', value: 'Giving reasons with kara/no de' },
                { label: 'ã‚‚ã—ã€œãŸã‚‰ï¼ãªã‚‰ å‡è¨­', value: 'Conditional patterns in Japanese' },
                { label: 'ã€œã¦ã‚‚ã„ã„ï¼ã€œã¦ã¯ã„ã‘ãªã„', value: 'Permission and prohibition' },
                { label: 'æ•¬èªå…¥é–€', value: 'Keigo basics for beginners' },
                { label: 'ã‚¯ãƒƒã‚·ãƒ§ãƒ³è¨€è‘‰', value: 'Softening phrases for politeness' },
                { label: 'é›»è©±æ‡‰å°å¸¸ç”¨å¥', value: 'Phone call keigo patterns' }
            ],
            chat: [
                { label: 'â˜• å’–å•¡å»³é»é¤', value: 'Japanese Coffee Shop' },
                { label: 'ğŸœ æ‹‰éºµåº—ç”¨é¤', value: 'Ramen shop' },
                { label: 'ğŸ›¤ï¸ è»Šç«™è³¼ç¥¨', value: 'Train station ticket' },
                { label: 'ğŸ¨ é£¯åº—å…¥ä½', value: 'Hotel check-in in Japan' },
                { label: 'ğŸª ä¾¿åˆ©å•†åº—', value: 'Convenience store in Japan' },
                { label: 'ğŸº å±…é…’å±‹èŠå¤©', value: 'Izakaya small talk' },
                { label: 'ğŸ—ºï¸ å•è·¯èˆ‡æ–¹å‘', value: 'Asking for directions in Japanese' },
                { label: 'ğŸ’Š è—¥å±€è²·è—¥', value: 'Pharmacy conversation' },
                { label: 'ğŸ‘‹ èªè­˜æ–°æœ‹å‹', value: 'Meeting new friends in Japanese' },
                { label: 'ğŸ“ å®¢æœèˆ‡æŠ±æ€¨', value: 'Customer support and complaints in Japanese' },
                { label: 'ğŸ’¼ å•†å‹™æœƒè­°', value: 'Business meeting in Japanese' },
                { label: 'ğŸ‘©â€ğŸ’» å°ˆæ¡ˆå”ä½œ', value: 'Project collaboration in IT' },
                { label: 'ğŸ¥ çœ‹è¨ºæè¿°ç—‡ç‹€', value: 'Describing symptoms to a doctor' },
                { label: 'ğŸš¨ æ±‚åŠ©èˆ‡ç·Šæ€¥', value: 'Emergency help in Japanese' },
                { label: 'ğŸ ç¦®å„€å¯’æš„', value: 'Etiquette and polite small talk' },
                { label: 'ğŸ  é„°é‡Œäº¤æµ', value: 'Chatting with neighbors' }
            ],
            kana: [
                { label: 'ğŸˆ å¹³å‡åäº”åéŸ³', value: 'Hiragana gojÅ«on (basic vowels and consonants)' },
                { label: 'ğŸˆ‚ï¸ ç‰‡å‡åäº”åéŸ³', value: 'Katakana gojÅ«on (basic vowels and consonants)' }
            ]
        };

        // å›ºå®šäº”åéŸ³å­—å¡ï¼ˆå¹³å‡å / ç‰‡å‡åï¼‰
        const KANA_DECKS = {
            hiragana: [
                { word: 'ã‚', kana: 'ã‚', romaji: 'a', pos: 'å‡å', mean: 'ã‚ (a)', example: 'ã‚ã•', trans: 'æ—©æ™¨', notes: 'é–‹å£çŸ­ä¿ƒ a' },
                { word: 'ã„', kana: 'ã„', romaji: 'i', pos: 'å‡å', mean: 'ã„ (i)', example: 'ã„ã™', trans: 'æ¤…å­', notes: 'å˜´è§’å¾®å¼µ i' },
                { word: 'ã†', kana: 'ã†', romaji: 'u', pos: 'å‡å', mean: 'ã† (u)', example: 'ã†ã¿', trans: 'æµ·', notes: 'åœ“å”‡çŸ­ä¿ƒ u' },
                { word: 'ãˆ', kana: 'ãˆ', romaji: 'e', pos: 'å‡å', mean: 'ãˆ (e)', example: 'ãˆã', trans: 'è»Šç«™', notes: 'å¾®å¼µå˜´ e' },
                { word: 'ãŠ', kana: 'ãŠ', romaji: 'o', pos: 'å‡å', mean: 'ãŠ (o)', example: 'ãŠã‹ã­', trans: 'éŒ¢', notes: 'åœ“å”‡çŸ­ä¿ƒ o' },
                { word: 'ã‹', kana: 'ã‹', romaji: 'ka', pos: 'å‡å', mean: 'ã‹ (ka)', example: 'ã‹ã•', trans: 'å‚˜', notes: 'æ¸…éŸ³ k è¡Œ' },
                { word: 'ã', kana: 'ã', romaji: 'ki', pos: 'å‡å', mean: 'ã (ki)', example: 'ãã‚‚ã¡', trans: 'å¿ƒæƒ…', notes: 'ã /ki/' },
                { word: 'ã', kana: 'ã', romaji: 'ku', pos: 'å‡å', mean: 'ã (ku)', example: 'ãã‚‹ã¾', trans: 'è»Š', notes: 'ã /ku/' },
                { word: 'ã‘', kana: 'ã‘', romaji: 'ke', pos: 'å‡å', mean: 'ã‘ (ke)', example: 'ã‘ã„ã•ã¤', trans: 'è­¦å¯Ÿ', notes: 'ã‘ /ke/' },
                { word: 'ã“', kana: 'ã“', romaji: 'ko', pos: 'å‡å', mean: 'ã“ (ko)', example: 'ã“ã©ã‚‚', trans: 'å°å­©', notes: 'ã“ /ko/' },
                { word: 'ã•', kana: 'ã•', romaji: 'sa', pos: 'å‡å', mean: 'ã• (sa)', example: 'ã•ã‹ãª', trans: 'é­š', notes: 'æ¸…éŸ³ s è¡Œ' },
                { word: 'ã—', kana: 'ã—', romaji: 'shi', pos: 'å‡å', mean: 'ã— (shi)', example: 'ã—ã”ã¨', trans: 'å·¥ä½œ', notes: 'ç™¼ /shi/' },
                { word: 'ã™', kana: 'ã™', romaji: 'su', pos: 'å‡å', mean: 'ã™ (su)', example: 'ã™ã—', trans: 'å£½å¸', notes: 'ã™ /su/' },
                { word: 'ã›', kana: 'ã›', romaji: 'se', pos: 'å‡å', mean: 'ã› (se)', example: 'ã›ã‹ã„', trans: 'ä¸–ç•Œ', notes: 'ã› /se/' },
                { word: 'ã', kana: 'ã', romaji: 'so', pos: 'å‡å', mean: 'ã (so)', example: 'ãã‚‰', trans: 'å¤©ç©º', notes: 'ã /so/' },
                { word: 'ãŸ', kana: 'ãŸ', romaji: 'ta', pos: 'å‡å', mean: 'ãŸ (ta)', example: 'ãŸã¾ã”', trans: 'é›è›‹', notes: 'æ¸…éŸ³ t è¡Œ' },
                { word: 'ã¡', kana: 'ã¡', romaji: 'chi', pos: 'å‡å', mean: 'ã¡ (chi)', example: 'ã¡ãš', trans: 'åœ°åœ–', notes: 'ç™¼ /chi/' },
                { word: 'ã¤', kana: 'ã¤', romaji: 'tsu', pos: 'å‡å', mean: 'ã¤ (tsu)', example: 'ã¤ã', trans: 'æœˆäº®', notes: 'ç™¼ /tsu/' },
                { word: 'ã¦', kana: 'ã¦', romaji: 'te', pos: 'å‡å', mean: 'ã¦ (te)', example: 'ã¦ãŒã¿', trans: 'ä¿¡', notes: 'ã¦ /te/' },
                { word: 'ã¨', kana: 'ã¨', romaji: 'to', pos: 'å‡å', mean: 'ã¨ (to)', example: 'ã¨ã‘ã„', trans: 'é˜éŒ¶', notes: 'ã¨ /to/' },
                { word: 'ãª', kana: 'ãª', romaji: 'na', pos: 'å‡å', mean: 'ãª (na)', example: 'ãªã¾ãˆ', trans: 'åå­—', notes: 'é¼»éŸ³ n è¡Œ' },
                { word: 'ã«', kana: 'ã«', romaji: 'ni', pos: 'å‡å', mean: 'ã« (ni)', example: 'ã«ã»ã‚“', trans: 'æ—¥æœ¬', notes: 'ã« /ni/' },
                { word: 'ã¬', kana: 'ã¬', romaji: 'nu', pos: 'å‡å', mean: 'ã¬ (nu)', example: 'ã¬ã®', trans: 'å¸ƒ', notes: 'ã¬ /nu/' },
                { word: 'ã­', kana: 'ã­', romaji: 'ne', pos: 'å‡å', mean: 'ã­ (ne)', example: 'ã­ã“', trans: 'è²“', notes: 'ã­ /ne/' },
                { word: 'ã®', kana: 'ã®', romaji: 'no', pos: 'å‡å', mean: 'ã® (no)', example: 'ã®ã‚Š', trans: 'æµ·è‹”', notes: 'ã® /no/' },
                { word: 'ã¯', kana: 'ã¯', romaji: 'ha', pos: 'å‡å', mean: 'ã¯ (ha)', example: 'ã¯ãª', trans: 'èŠ±ï¼é¼»', notes: 'ä½œåŠ©è©è®€ wa' },
                { word: 'ã²', kana: 'ã²', romaji: 'hi', pos: 'å‡å', mean: 'ã² (hi)', example: 'ã²ã‚‹', trans: 'ä¸­åˆ', notes: 'ã² /hi/' },
                { word: 'ãµ', kana: 'ãµ', romaji: 'fu', pos: 'å‡å', mean: 'ãµ (fu)', example: 'ãµã­', trans: 'èˆ¹', notes: 'å”‡é½’éŸ³ /fu/' },
                { word: 'ã¸', kana: 'ã¸', romaji: 'he', pos: 'å‡å', mean: 'ã¸ (he)', example: 'ã¸ã‚„', trans: 'æˆ¿é–“', notes: 'ä½œåŠ©è©è®€ e' },
                { word: 'ã»', kana: 'ã»', romaji: 'ho', pos: 'å‡å', mean: 'ã» (ho)', example: 'ã»ã—', trans: 'æ˜Ÿæ˜Ÿ', notes: 'ã» /ho/' },
                { word: 'ã¾', kana: 'ã¾', romaji: 'ma', pos: 'å‡å', mean: 'ã¾ (ma)', example: 'ã¾ã©', trans: 'çª—æˆ¶', notes: 'é¼»éŸ³ m è¡Œ' },
                { word: 'ã¿', kana: 'ã¿', romaji: 'mi', pos: 'å‡å', mean: 'ã¿ (mi)', example: 'ã¿ãš', trans: 'æ°´', notes: 'ã¿ /mi/' },
                { word: 'ã‚€', kana: 'ã‚€', romaji: 'mu', pos: 'å‡å', mean: 'ã‚€ (mu)', example: 'ã‚€ã—', trans: 'æ˜†èŸ²', notes: 'ã‚€ /mu/' },
                { word: 'ã‚', kana: 'ã‚', romaji: 'me', pos: 'å‡å', mean: 'ã‚ (me)', example: 'ã‚ãŒã­', trans: 'çœ¼é¡', notes: 'ã‚ /me/' },
                { word: 'ã‚‚', kana: 'ã‚‚', romaji: 'mo', pos: 'å‡å', mean: 'ã‚‚ (mo)', example: 'ã‚‚ã‚‚', trans: 'æ¡ƒå­', notes: 'ã‚‚ /mo/' },
                { word: 'ã‚„', kana: 'ã‚„', romaji: 'ya', pos: 'å‡å', mean: 'ã‚„ (ya)', example: 'ã‚„ã•ã„', trans: 'è”¬èœ', notes: 'åŠæ¯éŸ³ y è¡Œ' },
                { word: 'ã‚†', kana: 'ã‚†', romaji: 'yu', pos: 'å‡å', mean: 'ã‚† (yu)', example: 'ã‚†ã', trans: 'é›ª', notes: 'ã‚† /yu/' },
                { word: 'ã‚ˆ', kana: 'ã‚ˆ', romaji: 'yo', pos: 'å‡å', mean: 'ã‚ˆ (yo)', example: 'ã‚ˆã‚‹', trans: 'å¤œæ™š', notes: 'ã‚ˆ /yo/' },
                { word: 'ã‚‰', kana: 'ã‚‰', romaji: 'ra', pos: 'å‡å', mean: 'ã‚‰ (ra)', example: 'ã‚‰ãƒ¼ã‚ã‚“', trans: 'æ‹‰éºµ', notes: 'èˆŒå°–å½ˆéŸ³ /ra/' },
                { word: 'ã‚Š', kana: 'ã‚Š', romaji: 'ri', pos: 'å‡å', mean: 'ã‚Š (ri)', example: 'ã‚Šã‚“ã”', trans: 'è˜‹æœ', notes: 'ã‚Š /ri/' },
                { word: 'ã‚‹', kana: 'ã‚‹', romaji: 'ru', pos: 'å‡å', mean: 'ã‚‹ (ru)', example: 'ã‚‹ã™', trans: 'ä¸åœ¨å®¶', notes: 'ã‚‹ /ru/' },
                { word: 'ã‚Œ', kana: 'ã‚Œ', romaji: 're', pos: 'å‡å', mean: 'ã‚Œ (re)', example: 'ã‚Œãã—', trans: 'æ­·å²', notes: 'ã‚Œ /re/' },
                { word: 'ã‚', kana: 'ã‚', romaji: 'ro', pos: 'å‡å', mean: 'ã‚ (ro)', example: 'ã‚ã†ã‹', trans: 'èµ°å»Š', notes: 'ã‚ /ro/' },
                { word: 'ã‚', kana: 'ã‚', romaji: 'wi', pos: 'å‡å', mean: 'ã‚ (wi)', example: 'ã‚ãªã‹', trans: 'é„‰ä¸‹ï¼ˆå¤ç”¨ï¼‰', notes: 'æ­·å²å‡åï¼Œç¾å¤šç”¨ ã„' },
                { word: 'ã‚‘', kana: 'ã‚‘', romaji: 'we', pos: 'å‡å', mean: 'ã‚‘ (we)', example: 'ã‚‘ã³ã™', trans: 'æƒ æ¯”å£½ï¼ˆå¤ç”¨ï¼‰', notes: 'æ­·å²å‡åï¼Œç¾å¤šç”¨ ãˆ' },
                { word: 'ã‚', kana: 'ã‚', romaji: 'wa', pos: 'å‡å', mean: 'ã‚ (wa)', example: 'ã‚ãŸã—', trans: 'æˆ‘', notes: 'åŠ©è©ã‚‚è®€ wa' },
                { word: 'ã‚’', kana: 'ã‚’', romaji: 'o/wo', pos: 'å‡å', mean: 'ã‚’ (åŠ©è©ç™¼ o)', example: 'ã‚Šã‚“ã”ã‚’ ãŸã¹ã‚‹', trans: 'åƒè˜‹æœ', notes: 'åšè³“èªåŠ©è©æ™‚è®€ o' },
                { word: 'ã‚“', kana: 'ã‚“', romaji: 'n', pos: 'å‡å', mean: 'ã‚“ (n)', example: 'ã»ã‚“', trans: 'æ›¸', notes: 'æ”¶å°¾é¼»éŸ³ n' },
                { word: 'ã£', kana: 'ã£', romaji: 'small tsu', pos: 'å‡å', mean: 'ä¿ƒéŸ³ï¼ˆã£ï¼‰', example: 'ãã£ã¦', trans: 'éƒµç¥¨', notes: 'é›™å¯«å­éŸ³ï¼Œåœé “ä¸€æ‹' }
            ],
            katakana: [
                { word: 'ã‚¢', kana: 'ã‚¢', romaji: 'a', pos: 'å‡å', mean: 'ã‚¢ (a)', example: 'ã‚¢ã‚¤ã‚¹', trans: 'å†°æ·‡æ·‹', notes: 'ç‰‡å‡å a' },
                { word: 'ã‚¤', kana: 'ã‚¤', romaji: 'i', pos: 'å‡å', mean: 'ã‚¤ (i)', example: 'ã‚¤ãƒ³ã‚¯', trans: 'å¢¨æ°´', notes: 'ç‰‡å‡å i' },
                { word: 'ã‚¦', kana: 'ã‚¦', romaji: 'u', pos: 'å‡å', mean: 'ã‚¦ (u)', example: 'ã‚¦ãƒŸ', trans: 'æµ·', notes: 'ç‰‡å‡å u' },
                { word: 'ã‚¨', kana: 'ã‚¨', romaji: 'e', pos: 'å‡å', mean: 'ã‚¨ (e)', example: 'ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼', trans: 'é›»æ¢¯', notes: 'ç‰‡å‡å e' },
                { word: 'ã‚ª', kana: 'ã‚ª', romaji: 'o', pos: 'å‡å', mean: 'ã‚ª (o)', example: 'ã‚ªãƒ¬ãƒ³ã‚¸', trans: 'æŸ³æ©™', notes: 'ç‰‡å‡å o' },
                { word: 'ã‚«', kana: 'ã‚«', romaji: 'ka', pos: 'å‡å', mean: 'ã‚« (ka)', example: 'ã‚«ãƒ¡ãƒ©', trans: 'ç›¸æ©Ÿ', notes: 'æ¸…éŸ³ k' },
                { word: 'ã‚­', kana: 'ã‚­', romaji: 'ki', pos: 'å‡å', mean: 'ã‚­ (ki)', example: 'ã‚­ãƒƒãƒãƒ³', trans: 'å»šæˆ¿', notes: 'ã‚­ /ki/' },
                { word: 'ã‚¯', kana: 'ã‚¯', romaji: 'ku', pos: 'å‡å', mean: 'ã‚¯ (ku)', example: 'ã‚¯ãƒ©ãƒ–', trans: 'ä¿±æ¨‚éƒ¨', notes: 'ã‚¯ /ku/' },
                { word: 'ã‚±', kana: 'ã‚±', romaji: 'ke', pos: 'å‡å', mean: 'ã‚± (ke)', example: 'ã‚±ãƒ¼ã‚­', trans: 'è›‹ç³•', notes: 'ã‚± /ke/' },
                { word: 'ã‚³', kana: 'ã‚³', romaji: 'ko', pos: 'å‡å', mean: 'ã‚³ (ko)', example: 'ã‚³ãƒ¼ãƒ’ãƒ¼', trans: 'å’–å•¡', notes: 'ã‚³ /ko/' },
                { word: 'ã‚µ', kana: 'ã‚µ', romaji: 'sa', pos: 'å‡å', mean: 'ã‚µ (sa)', example: 'ã‚µãƒ©ãƒ€', trans: 'æ²™æ‹‰', notes: 'ã‚µ /sa/' },
                { word: 'ã‚·', kana: 'ã‚·', romaji: 'shi', pos: 'å‡å', mean: 'ã‚· (shi)', example: 'ã‚·ãƒ£ãƒ„', trans: 'è¥¯è¡«', notes: 'ç™¼ /shi/' },
                { word: 'ã‚¹', kana: 'ã‚¹', romaji: 'su', pos: 'å‡å', mean: 'ã‚¹ (su)', example: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼', trans: 'è¶…å¸‚', notes: 'ã‚¹ /su/' },
                { word: 'ã‚»', kana: 'ã‚»', romaji: 'se', pos: 'å‡å', mean: 'ã‚» (se)', example: 'ã‚»ãƒ¼ã‚¿ãƒ¼', trans: 'æ¯›è¡£', notes: 'ã‚» /se/' },
                { word: 'ã‚½', kana: 'ã‚½', romaji: 'so', pos: 'å‡å', mean: 'ã‚½ (so)', example: 'ã‚½ãƒ¼ãƒ€', trans: 'è˜‡æ‰“', notes: 'ã‚½ /so/' },
                { word: 'ã‚¿', kana: 'ã‚¿', romaji: 'ta', pos: 'å‡å', mean: 'ã‚¿ (ta)', example: 'ã‚¿ã‚¯ã‚·ãƒ¼', trans: 'è¨ˆç¨‹è»Š', notes: 'ã‚¿ /ta/' },
                { word: 'ãƒ', kana: 'ãƒ', romaji: 'chi', pos: 'å‡å', mean: 'ãƒ (chi)', example: 'ãƒã‚±ãƒƒãƒˆ', trans: 'ç¥¨åˆ¸', notes: 'ç™¼ /chi/' },
                { word: 'ãƒ„', kana: 'ãƒ„', romaji: 'tsu', pos: 'å‡å', mean: 'ãƒ„ (tsu)', example: 'ãƒ„ã‚¢ãƒ¼', trans: 'æ—…éŠè¡Œç¨‹', notes: 'ç™¼ /tsu/' },
                { word: 'ãƒ†', kana: 'ãƒ†', romaji: 'te', pos: 'å‡å', mean: 'ãƒ† (te)', example: 'ãƒ†ãƒ¬ãƒ“', trans: 'é›»è¦–', notes: 'ãƒ† /te/' },
                { word: 'ãƒˆ', kana: 'ãƒˆ', romaji: 'to', pos: 'å‡å', mean: 'ãƒˆ (to)', example: 'ãƒˆãƒãƒˆ', trans: 'ç•ªèŒ„', notes: 'ãƒˆ /to/' },
                { word: 'ãƒŠ', kana: 'ãƒŠ', romaji: 'na', pos: 'å‡å', mean: 'ãƒŠ (na)', example: 'ãƒŠã‚¤ãƒ•', trans: 'åˆ€å­', notes: 'ãƒŠ /na/' },
                { word: 'ãƒ‹', kana: 'ãƒ‹', romaji: 'ni', pos: 'å‡å', mean: 'ãƒ‹ (ni)', example: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹', trans: 'æ–°è', notes: 'ãƒ‹ /ni/' },
                { word: 'ãƒŒ', kana: 'ãƒŒ', romaji: 'nu', pos: 'å‡å', mean: 'ãƒŒ (nu)', example: 'ãƒŒãƒ¼ãƒ‰ãƒ«', trans: 'éºµ', notes: 'ãƒŒ /nu/' },
                { word: 'ãƒ', kana: 'ãƒ', romaji: 'ne', pos: 'å‡å', mean: 'ãƒ (ne)', example: 'ãƒã‚¯ã‚¿ã‚¤', trans: 'é ˜å¸¶', notes: 'ãƒ /ne/' },
                { word: 'ãƒ', kana: 'ãƒ', romaji: 'no', pos: 'å‡å', mean: 'ãƒ (no)', example: 'ãƒãƒ¼ãƒˆ', trans: 'ç­†è¨˜æœ¬', notes: 'ãƒ /no/' },
                { word: 'ãƒ', kana: 'ãƒ', romaji: 'ha', pos: 'å‡å', mean: 'ãƒ (ha)', example: 'ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼', trans: 'æ¼¢å ¡', notes: 'ä½œåŠ©è©è®€ wa' },
                { word: 'ãƒ’', kana: 'ãƒ’', romaji: 'hi', pos: 'å‡å', mean: 'ãƒ’ (hi)', example: 'ãƒ’ãƒ¼ã‚¿ãƒ¼', trans: 'æš–æ°£', notes: 'ãƒ’ /hi/' },
                { word: 'ãƒ•', kana: 'ãƒ•', romaji: 'fu', pos: 'å‡å', mean: 'ãƒ• (fu)', example: 'ãƒ•ãƒ«ãƒ¼ãƒ„', trans: 'æ°´æœ', notes: 'å”‡é½’éŸ³ /fu/' },
                { word: 'ãƒ˜', kana: 'ãƒ˜', romaji: 'he', pos: 'å‡å', mean: 'ãƒ˜ (he)', example: 'ãƒ˜ã‚¢', trans: 'é ­é«®', notes: 'ä½œåŠ©è©è®€ e' },
                { word: 'ãƒ›', kana: 'ãƒ›', romaji: 'ho', pos: 'å‡å', mean: 'ãƒ› (ho)', example: 'ãƒ›ãƒ†ãƒ«', trans: 'é£¯åº—', notes: 'ãƒ› /ho/' },
                { word: 'ãƒ', kana: 'ãƒ', romaji: 'ma', pos: 'å‡å', mean: 'ãƒ (ma)', example: 'ãƒãƒ³ã‚¬', trans: 'æ¼«ç•«', notes: 'ãƒ /ma/' },
                { word: 'ãƒŸ', kana: 'ãƒŸ', romaji: 'mi', pos: 'å‡å', mean: 'ãƒŸ (mi)', example: 'ãƒŸãƒ«ã‚¯', trans: 'ç‰›å¥¶', notes: 'ãƒŸ /mi/' },
                { word: 'ãƒ ', kana: 'ãƒ ', romaji: 'mu', pos: 'å‡å', mean: 'ãƒ  (mu)', example: 'ãƒ ãƒ¼ãƒ“ãƒ¼', trans: 'é›»å½±', notes: 'ãƒ  /mu/' },
                { word: 'ãƒ¡', kana: 'ãƒ¡', romaji: 'me', pos: 'å‡å', mean: 'ãƒ¡ (me)', example: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼', trans: 'èœå–®', notes: 'ãƒ¡ /me/' },
                { word: 'ãƒ¢', kana: 'ãƒ¢', romaji: 'mo', pos: 'å‡å', mean: 'ãƒ¢ (mo)', example: 'ãƒ¢ãƒ‡ãƒ«', trans: 'æ¨¡ç‰¹å…’', notes: 'ãƒ¢ /mo/' },
                { word: 'ãƒ¤', kana: 'ãƒ¤', romaji: 'ya', pos: 'å‡å', mean: 'ãƒ¤ (ya)', example: 'ãƒ¤ã‚¯ãƒ«ãƒˆ', trans: 'é¤Šæ¨‚å¤š', notes: 'ãƒ¤ /ya/' },
                { word: 'ãƒ¦', kana: 'ãƒ¦', romaji: 'yu', pos: 'å‡å', mean: 'ãƒ¦ (yu)', example: 'ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ', trans: 'åˆ¶æœ', notes: 'ãƒ¦ /yu/' },
                { word: 'ãƒ¨', kana: 'ãƒ¨', romaji: 'yo', pos: 'å‡å', mean: 'ãƒ¨ (yo)', example: 'ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ', trans: 'å„ªæ ¼', notes: 'ãƒ¨ /yo/' },
                { word: 'ãƒ©', kana: 'ãƒ©', romaji: 'ra', pos: 'å‡å', mean: 'ãƒ© (ra)', example: 'ãƒ©ã‚¸ã‚ª', trans: 'æ”¶éŸ³æ©Ÿ', notes: 'å½ˆèˆŒ /ra/' },
                { word: 'ãƒª', kana: 'ãƒª', romaji: 'ri', pos: 'å‡å', mean: 'ãƒª (ri)', example: 'ãƒªã‚¹ãƒˆ', trans: 'æ¸…å–®', notes: 'ãƒª /ri/' },
                { word: 'ãƒ«', kana: 'ãƒ«', romaji: 'ru', pos: 'å‡å', mean: 'ãƒ« (ru)', example: 'ãƒ«ãƒ¼ãƒ ', trans: 'æˆ¿é–“', notes: 'ãƒ« /ru/' },
                { word: 'ãƒ¬', kana: 'ãƒ¬', romaji: 're', pos: 'å‡å', mean: 'ãƒ¬ (re)', example: 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', trans: 'é¤å»³', notes: 'ãƒ¬ /re/' },
                { word: 'ãƒ­', kana: 'ãƒ­', romaji: 'ro', pos: 'å‡å', mean: 'ãƒ­ (ro)', example: 'ãƒ­ãƒœãƒƒãƒˆ', trans: 'æ©Ÿå™¨äºº', notes: 'ãƒ­ /ro/' },
                { word: 'ãƒ°', kana: 'ãƒ°', romaji: 'wi', pos: 'å‡å', mean: 'ãƒ° (wi)', example: 'ãƒ°ã‚¹ã‚­ãƒ¼', trans: 'å¨å£«å¿Œï¼ˆèˆŠæ¨™è¨˜ï¼‰', notes: 'æ­·å²å‡åï¼Œç¾å¤šç”¨ ã‚¤' },
                { word: 'ãƒ±', kana: 'ãƒ±', romaji: 'we', pos: 'å‡å', mean: 'ãƒ± (we)', example: 'ãƒ±ãƒ“ã‚¹', trans: 'æƒ æ¯”å£½ï¼ˆèˆŠæ¨™è¨˜ï¼‰', notes: 'æ­·å²å‡åï¼Œç¾å¤šç”¨ ã‚¨' },
                { word: 'ãƒ¯', kana: 'ãƒ¯', romaji: 'wa', pos: 'å‡å', mean: 'ãƒ¯ (wa)', example: 'ãƒ¯ã‚¤ãƒ³', trans: 'ç´…é…’', notes: 'ãƒ¯ /wa/' },
                { word: 'ãƒ²', kana: 'ãƒ²', romaji: 'o/wo', pos: 'å‡å', mean: 'ãƒ² (åŠ©è©ç™¼ o)', example: 'ãƒ²ã‚¿ã‚¯', trans: 'å¾¡å®…æ—', notes: 'åŠ©è©è®€ o' },
                { word: 'ãƒ³', kana: 'ãƒ³', romaji: 'n', pos: 'å‡å', mean: 'ãƒ³ (n)', example: 'ãƒ‘ãƒ³', trans: 'éºµåŒ…', notes: 'é¼»éŸ³ n' },
                { word: 'ãƒƒ', kana: 'ãƒƒ', romaji: 'small tsu', pos: 'å‡å', mean: 'ä¿ƒéŸ³ï¼ˆãƒƒï¼‰', example: 'ã‚«ãƒƒãƒ—', trans: 'æ¯å­', notes: 'é›™å¯«å­éŸ³ï¼Œåœé “ä¸€æ‹' }
            ]
        };

        // æ¿éŸ³ / åŠæ¿éŸ³ / æ‹—éŸ³ / ä¿ƒéŸ³ / é•·éŸ³ / ç‰¹æ®Šç™¼éŸ³
        const KANA_EXTRA = {
            hiragana: {
                dakuten: [
                    { word: 'ãŒ', romaji: 'ga' }, { word: 'ã', romaji: 'gi' }, { word: 'ã', romaji: 'gu' }, { word: 'ã’', romaji: 'ge' }, { word: 'ã”', romaji: 'go' },
                    { word: 'ã–', romaji: 'za' }, { word: 'ã˜', romaji: 'ji' }, { word: 'ãš', romaji: 'zu' }, { word: 'ãœ', romaji: 'ze' }, { word: 'ã', romaji: 'zo' },
                    { word: 'ã ', romaji: 'da' }, { word: 'ã¢', romaji: 'ji/di' }, { word: 'ã¥', romaji: 'zu/du' }, { word: 'ã§', romaji: 'de' }, { word: 'ã©', romaji: 'do' },
                    { word: 'ã°', romaji: 'ba' }, { word: 'ã³', romaji: 'bi' }, { word: 'ã¶', romaji: 'bu' }, { word: 'ã¹', romaji: 'be' }, { word: 'ã¼', romaji: 'bo' }
                ],
                handaku: [
                    { word: 'ã±', romaji: 'pa' }, { word: 'ã´', romaji: 'pi' }, { word: 'ã·', romaji: 'pu' }, { word: 'ãº', romaji: 'pe' }, { word: 'ã½', romaji: 'po' }
                ],
                youon: [
                    { word: 'ãã‚ƒ', romaji: 'kya' }, { word: 'ãã‚…', romaji: 'kyu' }, { word: 'ãã‚‡', romaji: 'kyo' }, { word: 'ã—ã‚ƒ', romaji: 'sha' }, { word: 'ã—ã‚…', romaji: 'shu' },
                    { word: 'ã—ã‚‡', romaji: 'sho' }, { word: 'ã¡ã‚ƒ', romaji: 'cha' }, { word: 'ã¡ã‚…', romaji: 'chu' }, { word: 'ã¡ã‚‡', romaji: 'cho' }, { word: 'ã«ã‚ƒ', romaji: 'nya' },
                    { word: 'ã«ã‚…', romaji: 'nyu' }, { word: 'ã«ã‚‡', romaji: 'nyo' }, { word: 'ã²ã‚ƒ', romaji: 'hya' }, { word: 'ã²ã‚…', romaji: 'hyu' }, { word: 'ã²ã‚‡', romaji: 'hyo' },
                    { word: 'ã¿ã‚ƒ', romaji: 'mya' }, { word: 'ã¿ã‚…', romaji: 'myu' }, { word: 'ã¿ã‚‡', romaji: 'myo' }, { word: 'ã‚Šã‚ƒ', romaji: 'rya' }, { word: 'ã‚Šã‚…', romaji: 'ryu' },
                    { word: 'ã‚Šã‚‡', romaji: 'ryo' }, { word: 'ãã‚ƒ', romaji: 'gya' }, { word: 'ãã‚…', romaji: 'gyu' }, { word: 'ãã‚‡', romaji: 'gyo' }, { word: 'ã˜ã‚ƒ', romaji: 'ja' },
                    { word: 'ã˜ã‚…', romaji: 'ju' }, { word: 'ã˜ã‚‡', romaji: 'jo' }, { word: 'ã³ã‚ƒ', romaji: 'bya' }, { word: 'ã³ã‚…', romaji: 'byu' }, { word: 'ã³ã‚‡', romaji: 'byo' },
                    { word: 'ã´ã‚ƒ', romaji: 'pya' }, { word: 'ã´ã‚…', romaji: 'pyu' }, { word: 'ã´ã‚‡', romaji: 'pyo' }
                ],
                sokuon: [
                    { word: 'ã£', romaji: 'ä¿ƒéŸ³', notes: 'é›™å¯«å­éŸ³ï¼Œåœä¸€æ‹' }
                ],
                choon: [
                    { word: 'ãƒ¼', romaji: 'é•·éŸ³', notes: 'å‰éŸ³æ‹‰é•·ä¸€æ‹' }
                ],
                special: [
                    { word: 'ã˜/ã¢', romaji: 'ji/di', notes: 'å¯¦éš›å¤šå¿µ ji' },
                    { word: 'ãš/ã¥', romaji: 'zu/du', notes: 'å¯¦éš›å¤šå¿µ zu' }
                ]
            },
            katakana: {
                dakuten: [
                    { word: 'ã‚¬', romaji: 'ga' }, { word: 'ã‚®', romaji: 'gi' }, { word: 'ã‚°', romaji: 'gu' }, { word: 'ã‚²', romaji: 'ge' }, { word: 'ã‚´', romaji: 'go' },
                    { word: 'ã‚¶', romaji: 'za' }, { word: 'ã‚¸', romaji: 'ji' }, { word: 'ã‚º', romaji: 'zu' }, { word: 'ã‚¼', romaji: 'ze' }, { word: 'ã‚¾', romaji: 'zo' },
                    { word: 'ãƒ€', romaji: 'da' }, { word: 'ãƒ‚', romaji: 'ji/di' }, { word: 'ãƒ…', romaji: 'zu/du' }, { word: 'ãƒ‡', romaji: 'de' }, { word: 'ãƒ‰', romaji: 'do' },
                    { word: 'ãƒ', romaji: 'ba' }, { word: 'ãƒ“', romaji: 'bi' }, { word: 'ãƒ–', romaji: 'bu' }, { word: 'ãƒ™', romaji: 'be' }, { word: 'ãƒœ', romaji: 'bo' }
                ],
                handaku: [
                    { word: 'ãƒ‘', romaji: 'pa' }, { word: 'ãƒ”', romaji: 'pi' }, { word: 'ãƒ—', romaji: 'pu' }, { word: 'ãƒš', romaji: 'pe' }, { word: 'ãƒ', romaji: 'po' }
                ],
                youon: [
                    { word: 'ã‚­ãƒ£', romaji: 'kya' }, { word: 'ã‚­ãƒ¥', romaji: 'kyu' }, { word: 'ã‚­ãƒ§', romaji: 'kyo' }, { word: 'ã‚·ãƒ£', romaji: 'sha' }, { word: 'ã‚·ãƒ¥', romaji: 'shu' },
                    { word: 'ã‚·ãƒ§', romaji: 'sho' }, { word: 'ãƒãƒ£', romaji: 'cha' }, { word: 'ãƒãƒ¥', romaji: 'chu' }, { word: 'ãƒãƒ§', romaji: 'cho' }, { word: 'ãƒ‹ãƒ£', romaji: 'nya' },
                    { word: 'ãƒ‹ãƒ¥', romaji: 'nyu' }, { word: 'ãƒ‹ãƒ§', romaji: 'nyo' }, { word: 'ãƒ’ãƒ£', romaji: 'hya' }, { word: 'ãƒ’ãƒ¥', romaji: 'hyu' }, { word: 'ãƒ’ãƒ§', romaji: 'hyo' },
                    { word: 'ãƒŸãƒ£', romaji: 'mya' }, { word: 'ãƒŸãƒ¥', romaji: 'myu' }, { word: 'ãƒŸãƒ§', romaji: 'myo' }, { word: 'ãƒªãƒ£', romaji: 'rya' }, { word: 'ãƒªãƒ¥', romaji: 'ryu' },
                    { word: 'ãƒªãƒ§', romaji: 'ryo' }, { word: 'ã‚®ãƒ£', romaji: 'gya' }, { word: 'ã‚®ãƒ¥', romaji: 'gyu' }, { word: 'ã‚®ãƒ§', romaji: 'gyo' }, { word: 'ã‚¸ãƒ£', romaji: 'ja' },
                    { word: 'ã‚¸ãƒ¥', romaji: 'ju' }, { word: 'ã‚¸ãƒ§', romaji: 'jo' }, { word: 'ãƒ“ãƒ£', romaji: 'bya' }, { word: 'ãƒ“ãƒ¥', romaji: 'byu' }, { word: 'ãƒ“ãƒ§', romaji: 'byo' },
                    { word: 'ãƒ”ãƒ£', romaji: 'pya' }, { word: 'ãƒ”ãƒ¥', romaji: 'pyu' }, { word: 'ãƒ”ãƒ§', romaji: 'pyo' }
                ],
                sokuon: [
                    { word: 'ãƒƒ', romaji: 'ä¿ƒéŸ³', notes: 'é›™å¯«å­éŸ³ï¼Œåœä¸€æ‹' }
                ],
                choon: [
                    { word: 'ãƒ¼', romaji: 'é•·éŸ³', notes: 'å¤–ä¾†èªå¸¸è¦‹é•·éŸ³' }
                ],
                special: [
                    { word: 'ã‚¸/ãƒ‚', romaji: 'ji/di', notes: 'å¯¦éš›å¤šå¿µ ji' },
                    { word: 'ã‚º/ãƒ…', romaji: 'zu/du', notes: 'å¯¦éš›å¤šå¿µ zu' }
                ]
            }
        };

        let apiKey = localStorage.getItem('gemini_api_key');
        let userData = JSON.parse(localStorage.getItem('linguamax_user') || '{}');

        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', () => {
            if (!apiKey) {
                document.getElementById('key-modal').classList.remove('hidden');
            } else {
                document.getElementById('key-modal').classList.add('hidden');
                initApp();
            }
        });

        function saveApiKey() {
            const val = document.getElementById('api-key-input').value.trim();
            if (val) {
                apiKey = val;
                localStorage.setItem('gemini_api_key', apiKey);
                document.getElementById('key-modal').classList.add('hidden');
                initApp();
            }
        }

        function initApp() {
            loadUserData();
            updateTopics();
            loadContent();
            checkStreak();
        }

        // ===== ç”¨æˆ¶æ•¸æ“š =====
        function loadUserData() {
            if (!userData.xp) {
                userData = { 
                    xp: 0, 
                    streak: 0, 
                    wordsLearned: [],      // å­¸éçš„å–®å­—åˆ—è¡¨
                    learnedHistory: {},    // æŒ‰ä¸»é¡Œåˆ†é¡çš„å­¸ç¿’è¨˜éŒ„
                    totalCorrect: 0, 
                    totalAnswered: 0, 
                    lastActive: null 
                };
            }
            // å…¼å®¹èˆŠç‰ˆæœ¬
            if (!userData.learnedHistory) userData.learnedHistory = {};
            
            updateUI();
        }

        function saveUserData() {
            localStorage.setItem('linguamax_user', JSON.stringify(userData));
            updateUI();
        }

        // å–å¾—æŸä¸»é¡Œå·²å­¸éçš„å–®å­—
        function getLearnedWordsForTopic(topic) {
            return userData.learnedHistory[topic] || [];
        }

        // å„²å­˜å­¸éçš„å–®å­—åˆ°è¨˜éŒ„
        function saveLearnedWord(word, topic) {
            if (!userData.learnedHistory[topic]) {
                userData.learnedHistory[topic] = [];
            }
            if (!userData.learnedHistory[topic].includes(word)) {
                userData.learnedHistory[topic].push(word);
            }
            if (!userData.wordsLearned.includes(word)) {
                userData.wordsLearned.push(word);
            }
            saveUserData();
        }

        function updateUI() {
            document.getElementById('xp-count').textContent = userData.xp + ' XP';
            document.getElementById('streak-count').textContent = userData.streak;
            document.getElementById('today-learned').textContent = Math.min(userData.wordsLearned?.length || 0, 20);
            document.getElementById('daily-progress').style.width = Math.min((userData.wordsLearned?.length || 0) / 20 * 100, 100) + '%';
            
            // ç­‰ç´šç³»çµ±
            const levelInfo = calculateLevel(userData.xp);
            document.getElementById('user-level').textContent = levelInfo.level;
            document.getElementById('user-level-badge').textContent = levelInfo.badge;
            document.getElementById('xp-to-next').textContent = levelInfo.currentXP;
            document.getElementById('xp-needed').textContent = levelInfo.xpNeeded;
            document.getElementById('level-progress').style.width = levelInfo.progress + '%';
        }

        // ç­‰ç´šè¨ˆç®—ï¼ˆæ¯ 100 XP å‡ä¸€ç´šï¼Œé€æ¼¸å¢åŠ ï¼‰
        function calculateLevel(totalXP) {
            const levels = [
                { level: 1, badge: 'ğŸŒ±', xp: 0 },
                { level: 2, badge: 'ğŸŒ¿', xp: 100 },
                { level: 3, badge: 'ğŸŒ³', xp: 250 },
                { level: 4, badge: 'ğŸŒ²', xp: 500 },
                { level: 5, badge: 'ğŸ‹', xp: 800 },
                { level: 6, badge: 'ğŸ„', xp: 1200 },
                { level: 7, badge: 'ğŸ”ï¸', xp: 1700 },
                { level: 8, badge: 'â›°ï¸', xp: 2300 },
                { level: 9, badge: 'ğŸ—»', xp: 3000 },
                { level: 10, badge: 'ğŸŒŸ', xp: 4000 },
                { level: 11, badge: 'â­', xp: 5000 },
                { level: 12, badge: 'ğŸ’«', xp: 6500 },
                { level: 13, badge: 'âœ¨', xp: 8000 },
                { level: 14, badge: 'ğŸ”¥', xp: 10000 },
                { level: 15, badge: 'ğŸ‘‘', xp: 12500 }
            ];
            
            let currentLevel = levels[0];
            let nextLevel = levels[1];
            
            for (let i = 0; i < levels.length - 1; i++) {
                if (totalXP >= levels[i].xp) {
                    currentLevel = levels[i];
                    nextLevel = levels[i + 1];
                }
            }
            
            // æœ€é«˜ç´š
            if (totalXP >= levels[levels.length - 1].xp) {
                currentLevel = levels[levels.length - 1];
                return {
                    level: currentLevel.level,
                    badge: currentLevel.badge,
                    currentXP: totalXP - currentLevel.xp,
                    xpNeeded: 'âˆ',
                    progress: 100
                };
            }
            
            const xpInLevel = totalXP - currentLevel.xp;
            const xpForLevel = nextLevel.xp - currentLevel.xp;
            const progress = Math.round(xpInLevel / xpForLevel * 100);
            
            return {
                level: currentLevel.level,
                badge: currentLevel.badge,
                currentXP: xpInLevel,
                xpNeeded: xpForLevel,
                progress
            };
        }

        function checkStreak() {
            const today = new Date().toDateString();
            const lastActive = userData.lastActive;
            
            if (lastActive) {
                const lastDate = new Date(lastActive);
                const daysDiff = Math.floor((new Date(today) - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff > 1) {
                    userData.streak = 0; // æ–·é€£
                }
            }
        }

        function addXP(amount) {
            userData.xp += amount;
            userData.lastActive = new Date().toDateString();
            
            // æ›´æ–°é€£çºŒå¤©æ•¸
            const today = new Date().toDateString();
            if (userData.lastActive !== today) {
                userData.streak++;
            }
            
            saveUserData();
            showXPPopup(amount);
        }

        function showXPPopup(amount) {
            const popup = document.createElement('div');
            popup.className = 'xp-popup fixed top-20 left-1/2 -translate-x-1/2 text-2xl font-bold text-yellow-400 z-50';
            popup.textContent = `+${amount} XP`;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1500);
        }

        // ===== æ¨¡å¼åˆ‡æ› =====
        function switchMode(mode) {
            APP_STATE.currentMode = mode;
            APP_STATE.historyData = [];
            APP_STATE.currentIndex = 0;

            // å¦‚æœåˆ‡åˆ°äº”åéŸ³æ¨¡å¼ï¼Œé è¨­å¹³å‡å
            if (mode === 'kana') {
                const levelSelect = document.getElementById('level-select');
                const topicSelect = document.getElementById('topic-select');
                if (levelSelect) levelSelect.value = 'KANA_HIRA';
                APP_STATE.currentTopic = 'Hiragana gojÅ«on (basic vowels and consonants)';
                APP_STATE.kanaStart = 0;
                if (topicSelect) topicSelect.value = APP_STATE.currentTopic;
            } else {
                // é›¢é–‹äº”åéŸ³æ¨¡å¼æ™‚ï¼Œå¦‚æœç­‰ç´šä»ç‚ºå‡åæ¨¡å¼ï¼Œé‡ç½®åˆ° N5
                const levelSelect = document.getElementById('level-select');
                if (levelSelect && (levelSelect.value === 'KANA_HIRA' || levelSelect.value === 'KANA_KATA')) {
                    levelSelect.value = 'N5';
                }
            }

            // æ›´æ–°æ¡Œé¢ç‰ˆå°èˆª UI
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('bg-green-500/20', 'border-green-500', 'text-green-400');
                btn.classList.add('border-transparent');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('bg-green-500/20', 'border-green-500', 'text-green-400');
                    btn.classList.remove('border-transparent');
                }
            });

            // æ›´æ–°æ‰‹æ©Ÿç‰ˆå°èˆª UI
            document.querySelectorAll('.mobile-mode-btn').forEach(btn => {
                btn.classList.remove('bg-green-500/20', 'border-green-500', 'text-green-400');
                btn.classList.add('border-transparent');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('bg-green-500/20', 'border-green-500', 'text-green-400');
                    btn.classList.remove('border-transparent');
                }
            });

            // é¡¯ç¤ºå°æ‡‰è¦–åœ–
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${mode}`).classList.remove('hidden');

            // é¡¯ç¤º/éš±è—é€²åº¦æ¢
            if (['flashcard', 'quiz', 'typing', 'listening', 'kana'].includes(mode)) {
                document.getElementById('session-progress').classList.remove('hidden');
            } else {
                document.getElementById('session-progress').classList.add('hidden');
            }

            updateTopics();
            loadContent();
        }

        function updateTopics() {
            const select = document.getElementById('topic-select');
            const topics = TOPICS[APP_STATE.currentMode] || [];
            
            // æ›´æ–°ä¸‹æ‹‰é¸å–®
            select.innerHTML = topics.map((t, i) => `
                <option value="${t.value}">${t.label}</option>
            `).join('');

            // è¨­å®šç¬¬ä¸€å€‹ä¸»é¡Œç‚ºé è¨­
            if (topics.length > 0) {
                APP_STATE.currentTopic = topics[0].value;
                select.value = topics[0].value;
            }
            
            // åŒæ™‚æ›´æ–°æ‰‹æ©Ÿç‰ˆ
            updateMobileTopicSelect();
        }

        // äº”åéŸ³å°ˆå€å¿«é€Ÿé€²å…¥
        function startKanaSession(type) {
            setKanaSession(type);
        }

        // åˆ‡æ›å¹³å‡å / ç‰‡å‡åæ¨¡å¼
        function switchKanaMode(type) {
            setKanaSession(type);
        }

        function setKanaSession(type) {
            // å¼·åˆ¶åˆ‡æ›åˆ°äº”åéŸ³æ¨¡å¼
            switchMode('kana');

            const levelSelect = document.getElementById('level-select');
            const topicSelect = document.getElementById('topic-select');

            // è¨­å®šç­‰ç´šèˆ‡ä¸»é¡Œ
            if (type === 'hiragana') {
                if (levelSelect) levelSelect.value = 'KANA_HIRA';
                APP_STATE.currentTopic = 'Hiragana gojÅ«on (basic vowels and consonants)';
            } else {
                if (levelSelect) levelSelect.value = 'KANA_KATA';
                APP_STATE.currentTopic = 'Katakana gojÅ«on (basic vowels and consonants)';
            }

            // åŒæ­¥ä¸‹æ‹‰
            if (topicSelect) topicSelect.value = APP_STATE.currentTopic;
            const mobileTopic = document.getElementById('mobile-topic-select');
            if (mobileTopic) mobileTopic.value = APP_STATE.currentTopic;

            // é‡ç½® session ç‹€æ…‹ä¸¦è¼‰å…¥
            APP_STATE.historyData = [];
            APP_STATE.currentIndex = 0;
            APP_STATE.kanaStart = 0;
            loadContent();
        }

        // ä¸»é¡Œä¸‹æ‹‰é¸å–®è®Šæ›´
        function onTopicChange() {
            const select = document.getElementById('topic-select');
            APP_STATE.currentTopic = select.value;
            APP_STATE.historyData = [];
            
            // åŒæ­¥æ‰‹æ©Ÿç‰ˆé¸å–®
            const mobileSelect = document.getElementById('mobile-topic-select');
            if (mobileSelect) mobileSelect.value = select.value;
            
            loadContent();
        }

        function selectTopic(topicValue) {
            APP_STATE.currentTopic = topicValue;
            APP_STATE.historyData = [];
            
            // æ›´æ–°ä¸‹æ‹‰é¸å–®
            const select = document.getElementById('topic-select');
            if (select) select.value = topicValue;
            
            const mobileSelect = document.getElementById('mobile-topic-select');
            if (mobileSelect) mobileSelect.value = topicValue;

            loadContent();
        }

        // é‡æ–°ç”Ÿæˆå…§å®¹ï¼ˆæ›ä¸€æ‰¹ï¼‰
        function regenerateContent() {
            // æŠŠç•¶å‰çš„å–®å­—åŠ å…¥æ’é™¤åˆ—è¡¨ï¼Œç¢ºä¿ä¸‹æ¬¡ä¸æœƒé‡è¤‡
            if (APP_STATE.words && APP_STATE.words.length > 0) {
                APP_STATE.words.forEach(w => {
                    if (!APP_STATE.historyData.includes(w.word)) {
                        APP_STATE.historyData.push(w.word);
                    }
                });
            }
            APP_STATE.currentIndex = 0;
            loadContent();
        }

        // é›£åº¦ç­‰ç´šè®Šæ›´æ™‚é‡æ–°è¼‰å…¥å…§å®¹
        function onLevelChange() {
            const level = document.getElementById('level-select').value;
            console.log('é›£åº¦åˆ‡æ›è‡³:', level);
            
            // æ¸…ç©ºç•¶å‰ session çš„æ­·å²ï¼ˆä½†ä¿ç•™æŒä¹…åŒ–çš„è¨˜éŒ„ï¼‰
            APP_STATE.historyData = [];
            APP_STATE.currentIndex = 0;
            
            // é‡æ–°è¼‰å…¥å…§å®¹
            loadContent();
        }

        // ===== Gemini API ç›´æ¥å‘¼å« (ä¸éœ€è¦ server.js) =====
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        // CEFR ç­‰ç´šæè¿°
        const LEVEL_DESCRIPTIONS = {
            'N5': 'é›¶åŸºç¤å…¥é–€ï¼Œå¹³å‡å/ç‰‡å‡åèˆ‡æœ€å¸¸ç”¨è©å½™ã€ç°¡å–®ã¾ã™å½¢',
            'N4': 'åŸºç¤æ—¥å¸¸å°è©±ï¼ŒåŸºæœ¬èªæ³•ï¼ˆã¦å½¢ã€ãªã„å½¢ï¼‰èˆ‡å¸¸ç”¨è©å½™',
            'N3': 'ä¸­ç´šæ—¥å¸¸èˆ‡æ—…éŠï¼Œè¼ƒé•·å¥å­ã€å¸¸è¦‹æ•¬èªã€é–±è®€çŸ­æ–‡',
            'N2': 'ä¸­é«˜ç´šè·å ´èˆ‡æ–°èï¼Œè¤‡é›œå¥å‹èˆ‡æ•¬èªè¡¨é”',
            'N1': 'é«˜éšé–±è®€èˆ‡å°ˆæ¥­å ´åˆï¼Œé•·å¥ã€ç´°è†©èªæ„Ÿ',
            'SURVIVAL': 'æ—…æ—¥ç”Ÿå­˜å¿…å‚™ï¼šäº¤é€šã€è³¼ç‰©ã€ç·Šæ€¥æ±‚åŠ©ã€ç°¡æ˜“æ•¬èªï¼Œå¥å­çŸ­æ˜“ç”¨',
            'TRAVEL_PLUS': 'è§€å…‰é€²éšï¼šè¨‚æˆ¿ã€é¤å»³å®¢è¨´ã€å•è·¯ç´°ç¯€ã€æ™¯é»å°è©±ã€æ¨è–¦è©¢å•',
            'BIZ_KEIGO': 'è·å ´æ•¬èªï¼šé›»è©±æ‡‰å°ã€æœƒè­°è¡¨é”ã€å®¢æˆ¶æ‡‰å°ã€ç·©è¡èªèˆ‡é“æ­‰',
            'CASUAL': 'æ—¥å¸¸ä¿—èªï¼šæœ‹å‹èŠå¤©ã€ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°ã€è¼•é¬†å£èªï¼Œæ³¨æ„å ´åˆ',
            'IT_DEV': 'IT/å·¥ç¨‹ï¼šé–‹ç™¼å”ä½œã€éœ€æ±‚æºé€šã€ç°¡æ˜“æŠ€è¡“ç”¨èªï¼ˆå‰ç«¯/å¾Œç«¯/infraï¼‰',
            'KANA_HIRA': 'å°ˆæ³¨å¹³å‡åäº”åéŸ³ï¼Œæ¸…éŸ³/æ¿éŸ³/æ‹—éŸ³ï¼Œè¼¸å‡ºä»¥å‡åç‚ºä¸»',
            'KANA_KATA': 'å°ˆæ³¨ç‰‡å‡åäº”åéŸ³èˆ‡å¤–ä¾†èªç™¼éŸ³ï¼Œè¼¸å‡ºä»¥ç‰‡å‡åç‚ºä¸»',
            'CONVO': 'æœƒè©±æµæš¢åº¦å„ªå…ˆï¼Œæä¾›å¯è¤‡èª¦çš„çŸ­å¥èˆ‡æƒ…å¢ƒå°ç­”'
        };

        // éš¨æ©ŸæŒ‡ä»¤ï¼Œå¢åŠ å…§å®¹å¤šæ¨£æ€§
        const VARIETY_INSTRUCTIONS = [
            'Always include kana reading (hiragana/katakana) and short romaji.',
            'Mix easy and slightly tricky words learners often confuse.',
            'Prioritize real-life phrases usable in Japan right away.',
            'Add one onomatopoeia (æ“¬è²èª/æ“¬æ…‹èª) when appropriate.',
            'Give both polite (ã€œã¾ã™) and casual usages in examples when possible.',
            'Include at least one katakana loanword if the level allows.',
            'Highlight pitch-accent sensitive words in the notes field.',
            'Favor vocabulary that practices verb forms like ã¦å½¢/ãªã„å½¢/å¯èƒ½å½¢.',
            'Avoid textbook clichÃ©s; choose fresh, natural expressions.'
        ];

        // å–å¾—éš¨æ©ŸæŒ‡ä»¤
        function getRandomInstruction() {
            return VARIETY_INSTRUCTIONS[Math.floor(Math.random() * VARIETY_INSTRUCTIONS.length)];
        }

        // ç”¢ç”Ÿéš¨æ©Ÿç¨®å­å­—æ¯ï¼Œå¢åŠ è®ŠåŒ–
        function getRandomSeed() {
            const letters = 'abcdefghijklmnopqrstuvwxyz';
            const randomLetter = letters[Math.floor(Math.random() * letters.length)];
            const seeds = [
                `Start with words beginning with "${randomLetter.toUpperCase()}".`,
                `Avoid words starting with common letters like A, B, C, E, S, T.`,
                `Include at least one word with 3+ syllables.`,
                `Include words from different word families.`,
                `Mix formal and informal vocabulary.`,
                ''  // æœ‰æ™‚ä¸åŠ é™åˆ¶
            ];
            return seeds[Math.floor(Math.random() * seeds.length)];
        }

        // ç”Ÿæˆ Prompt
        function generatePrompt(type, topic, level, exclude, userMessage) {
            // å¦‚æœæ˜¯äº”åéŸ³å›ºå®šèª²ç¨‹ï¼Œç›´æ¥è·³é API
            if (isKanaMode(level, topic) && ['vocab', 'flashcard', 'quiz', 'typing', 'listening'].includes(type)) {
                return null;
            }

            const excludeText = (exclude && exclude.length > 0) ? exclude.join(", ") : "None";
            const levelDesc = LEVEL_DESCRIPTIONS[level] || LEVEL_DESCRIPTIONS['B1'];
            const randomInstruction = getRandomInstruction();
            const randomSeed = getRandomSeed();
            const timestamp = Date.now(); // å¢åŠ æ™‚é–“æˆ³ç¢ºä¿æ¯æ¬¡ä¸åŒ

            // å¸¸è¦‹å–®å­—é»‘åå–®ï¼ˆé¿å… AI ç¸½æ˜¯ç”Ÿæˆé€™äº›ï¼‰
            const commonWordsToAvoid = 'ã§ã™, ã¾ã™, ã¯ã„, ã„ã„ãˆ, ã“ã‚“ã«ã¡ã¯, ã•ã‚ˆã†ãªã‚‰, ã‚ã‚ŠãŒã¨ã†, ã”ã‚ã‚“ãªã•ã„, å­¦ç”Ÿ, å…ˆç”Ÿ, æ—¥æœ¬, æ±äº¬, æ°´, ã”é£¯, è¡Œã, æ¥ã‚‹, ã™ã‚‹, è¦‹ã‚‹, é£Ÿã¹ã‚‹, é£²ã‚€, è²·ã†, ã„ã‚‹, ã‚ã‚‹, ãã‚Œã„, å¤§ãã„, å°ã•ã„';

            // é‡å°ä¸åŒç­‰ç´šçš„é¡å¤–æŒ‡ç¤º
            const examInstructions = {
                'N5': 'Keep vocabulary simple, mostly kana + very common kanji with furigana. Use short ã§ã™/ã¾ã™ examples.',
                'N4': 'Use everyday verbs with ã¦å½¢/ãªã„å½¢ examples, keep sentences short.',
                'N3': 'Include casual vs polite contrast and common set phrases.',
                'N2': 'Add keigo or semi-formal wording, slightly longer sentences.',
                'N1': 'Include nuanced or idiomatic expressions; add a short note about nuance.',
                'KANA_HIRA': 'Only use hiragana (no kanji). Cover gojÅ«on, dakuten, and youon combinations.',
                'KANA_KATA': 'Use katakana loanwords and onomatopoeia. Avoid hiragana except unavoidable particles.',
                'CONVO': 'Prioritize short, repeatable conversational chunks useful in real talk.'
            };
            const extraInstruction = examInstructions[level] || '';

            switch (type) {
                case 'vocab':
                    return `You are an expert Japanese teacher for Traditional Chinese speakers. Generate UNIQUE Japanese vocabulary with kana.

**Context:**
- Topic: "${topic}"
- Level: ${level} (${levelDesc})
- Request ID: ${timestamp} (generate different words each time)
${extraInstruction ? `\n**FOCUS:** ${extraInstruction}` : ''}

**IMPORTANT EXCLUSIONS - Do NOT use these words:**
- Already learned: [${excludeText}]
- Too common/basic: [${commonWordsToAvoid}]

**Special Instructions for variety:**
- ${randomInstruction}
- ${randomSeed}

**Conversation Goal:** Pick vocabulary that helps the learner talk with Japanese people naturally. Examples must sound like real dialogue lines a native might say in daily life. Include politeness/å ´é¢ tips in notes when relevant.

**Task:** Generate exactly 5 UNIQUE Japanese vocabulary items that:
1. Fit the topic "${topic}" and level ${level}
2. Include kana reading and romaji
3. Avoid all exclusions above
4. Are memorable and practical in Japan
5. Prefer real-life, natural expressions

**Output Format (JSON only, no markdown):**
{
    "title": "Topic title in Japanese",
    "words": [
        {
            "word": "æ—¥æœ¬èªã®å˜èªï¼ˆæ¼¢å­—å¯ã€‚KANA level must use kana onlyï¼‰",
            "kana": "ã‹ãª or ã‚«ãƒŠ",
            "romaji": "romaji reading",
            "pos": "è©æ€§ (åè©/å‹•è©/å½¢å®¹è©/å¥å‹...)",
            "mean": "ç¹é«”ä¸­æ–‡è§£é‡‹ï¼ˆç°¡æ½”ï¼‰",
            "example": "è‡ªç„¶çš„æ—¥æ–‡ä¾‹å¥ï¼Œç›¡é‡å«å‡åèˆ‡å¸¸ç”¨å¥å‹",
            "trans": "ä¾‹å¥çš„ç¹é«”ä¸­æ–‡ç¿»è­¯",
            "notes": "å¯é¸ï¼šç™¼éŸ³æˆ–æ•¬èª/èªæ„Ÿæç¤º"
        }
    ]
}`;

                case 'grammar':
                    return `You are an expert Japanese grammar teacher creating interactive quiz content.

**Context:**
- Grammar Topic: "${topic}"
- Level: ${level} (${levelDesc})
- Previously used content to avoid: [${excludeText}]

**Task:** Create a grammar lesson with 3 quiz questions for Japanese learners (Traditional Chinese UI).

**Output Format (JSON only, no markdown):**
{
    "concept": "æ—¥æ–‡æ–‡æ³•æ¦‚å¿µ (Japanese)",
    "explanation": "æ¸…æ™°çš„ç¹é«”ä¸­æ–‡è§£é‡‹ï¼ŒåŒ…å«ç”¨æ³•èˆ‡å¸¸è¦‹éŒ¯èª¤",
    "example_sentences": ["Example 1 (Japanese)", "Example 2 (Japanese)"],
    "quiz": [
        {
            "question": "å¡«ç©ºæˆ–é¸æ“‡é¡Œï¼ˆæ—¥æ–‡å¥å­ï¼Œå¯å«ä¸­æ–‡æç¤ºï¼‰",
            "options": ["option1", "option2", "option3", "option4"],
            "answer": 2,
            "reason": "ç¹é«”ä¸­æ–‡èªªæ˜ç‚ºä»€éº¼æ­£ç¢º"
        }
    ]
}`;

                case 'chat':
                    return `You are an AI Japanese conversation partner in a language learning app.

**Scenario:** ${topic}
**User's Level:** ${level} (${levelDesc})
**User said:** "${userMessage}"

**Your Task:**
1. Reply naturally in Japanese as the other person in this scenario.
2. Keep the language appropriate for ${level} level.
3. Provide helpful feedback on the user's Japanese.
4. Give a score (0-100) based on grammar, vocabulary, and naturalness.

**Output Format (JSON only, no markdown):**
{
    "reply": "ä½ çš„æ—¥æ–‡å›è¦† (2-3 sentences, keep natural)",
    "chinese": "å›è¦†çš„ç¹é«”ä¸­æ–‡ç¿»è­¯",
    "score": 85,
    "feedback": "å°ç”¨æˆ¶æ—¥æ–‡çš„å…·é«”å»ºè­°ï¼ˆç”¨ç¹é«”ä¸­æ–‡ï¼‰"
}`;

                default:
                    return `Generate a simple greeting in JSON format: {"message": "Hello!"}`;
            }
        }

        // å‘¼å« Gemini API
        async function callGeminiAPI(prompt) {
            const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                    method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 1.0,  // æé«˜éš¨æ©Ÿæ€§
                        topP: 0.95,        // å¢åŠ å¤šæ¨£æ€§
                        topK: 40,
                        maxOutputTokens: 2048
                    }
                    })
                });
                
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API å‘¼å«å¤±æ•—');
            }

            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            
            // æ¸…ç† JSONï¼ˆç§»é™¤ markdown æ¨™è¨˜ï¼‰
            let cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const firstBrace = cleanText.indexOf('{');
            const lastBrace = cleanText.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace !== -1) {
                cleanText = cleanText.substring(firstBrace, lastBrace + 1);
            }
            
            return JSON.parse(cleanText);
        }

        // Fisher-Yates shuffle for better randomness
        function shuffleArray(arr) {
            const result = [...arr];
            for (let i = result.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result;
        }

        // ===== å…§å®¹è¼‰å…¥ =====
        async function loadContent() {
            if (APP_STATE.currentMode === 'chat') {
                initChat();
                return;
            }

            document.getElementById('loading').classList.remove('hidden');

            try {
                const level = document.getElementById('level-select').value;
                const topic = APP_STATE.currentTopic;
                const isKana = isKanaMode(level, topic);

                // äº”åéŸ³å›ºå®šå¡ç‰‡ï¼šç›´æ¥è¼‰å…¥æœ¬åœ°è³‡æ–™
                if (isKana) {
                    const deck = getKanaDeck(level);
                    APP_STATE.words = deck;
                    APP_STATE.kanaStart = APP_STATE.kanaStart || 0;
                    APP_STATE.historyData = [];
                    APP_STATE.currentIndex = 0;
                    renderCurrentMode();
                } else {
                    const type = ['flashcard', 'quiz', 'typing', 'listening'].includes(APP_STATE.currentMode) 
                        ? 'vocab' 
                        : APP_STATE.currentMode;
                    
                    // åˆä½µæŒä¹…åŒ–çš„å­¸ç¿’è¨˜éŒ„ + ç•¶å‰ session çš„è¨˜éŒ„
                    const persistentHistory = getLearnedWordsForTopic(APP_STATE.currentTopic);
                    const allExcluded = [...new Set([...persistentHistory, ...APP_STATE.historyData])];
                    
                    const prompt = generatePrompt(
                        type,
                        APP_STATE.currentTopic,
                        document.getElementById('level-select').value,
                        allExcluded
                    );

                    const data = await callGeminiAPI(prompt);
                    
                    if (data.words) {
                        APP_STATE.words = shuffleArray(data.words);
                        APP_STATE.words.forEach(w => APP_STATE.historyData.push(w.word));
                        APP_STATE.currentIndex = 0;
                        renderCurrentMode();
                    } else if (data.concept) {
                        renderGrammar(data);
                    }
                }

            } catch (e) {
                console.error(e);
                alert('è¼‰å…¥å¤±æ•—ï¼š' + e.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderCurrentMode() {
            updateProgress();
            
            switch (APP_STATE.currentMode) {
                case 'kana':
                    renderKana();
                    break;
                case 'flashcard':
                    renderFlashcard();
                    break;
                case 'quiz':
                    renderQuiz();
                    break;
                case 'typing':
                    renderTyping();
                    break;
                case 'listening':
                    renderListening();
                    break;
            }
        }

        // åˆ¤æ–·æ˜¯å¦ç‚ºäº”åéŸ³æ¨¡å¼
        function isKanaMode(level, topic) {
            return APP_STATE.currentMode === 'kana';
        }

        // å–å¾—å°æ‡‰çš„äº”åéŸ³å¡ç‰‡
        function getKanaDeck(level) {
            if (level === 'KANA_KATA') return KANA_DECKS.katakana;
            return KANA_DECKS.hiragana;
        }


        function updateProgress() {
            const total = Math.max(APP_STATE.words.length, 1);
            const current = Math.min(APP_STATE.currentIndex + 1, total);
            document.getElementById('current-idx').textContent = current;
            document.getElementById('total-items').textContent = total;
            document.getElementById('session-bar').style.width = (current / total * 100) + '%';
        }

        // ===== é–ƒå¡æ¨¡å¼ =====
        // æ¸…é™¤ HTML æ¨™ç±¤ï¼ˆAPI æœ‰æ™‚æœƒå›å‚³å¸¶æ¨™ç±¤çš„å…§å®¹ï¼‰
        function stripHtml(text) {
            if (!text) return '';
            return text.replace(/<[^>]*>/g, '').trim();
        }

        function renderFlashcard() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            // é‡ç½®ç¿»è½‰ç‹€æ…‹
            document.querySelector('.flashcard').classList.remove('flipped');
            APP_STATE.isFlipped = false;

            document.getElementById('card-word').textContent = stripHtml(word.word);
            document.getElementById('card-pos').textContent = stripHtml(word.pos);
            document.getElementById('card-kana').textContent = stripHtml(word.kana) || '';
            document.getElementById('card-romaji').textContent = word.romaji ? `ç¾…é¦¬éŸ³ï¼š${stripHtml(word.romaji)}` : '';
            document.getElementById('card-mean').textContent = stripHtml(word.mean);
            document.getElementById('card-example').textContent = `"${stripHtml(word.example)}"`;
            document.getElementById('card-trans').textContent = stripHtml(word.trans) || '';
            document.getElementById('card-notes').textContent = stripHtml(word.notes) || '';
        }

        function flipCard() {
            const card = document.querySelector('.flashcard');
            card.classList.toggle('flipped');
            APP_STATE.isFlipped = !APP_STATE.isFlipped;
        }

        function rateCard(rating) {
            let xp = 0;
            switch (rating) {
                case 'hard': xp = 5; break;
                case 'good': xp = 10; break;
                case 'easy': xp = 15; break;
            }
            
            addXP(xp);
            
            // è¨˜éŒ„å­¸éçš„å–®å­—ï¼ˆæŒä¹…åŒ–å„²å­˜ï¼‰
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                saveLearnedWord(word.word, APP_STATE.currentTopic);
            }

            nextWord();
        }

        // ===== é¸æ“‡é¡Œæ¨¡å¼ =====
        function renderQuiz() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            APP_STATE.isAnswered = false;
            document.getElementById('quiz-word').textContent = stripHtml(word.word);
            document.getElementById('quiz-feedback').classList.add('hidden');
            document.getElementById('quiz-hint').classList.add('hidden');
            document.getElementById('quiz-hint-btn').classList.remove('hidden');

            // ç”Ÿæˆé¸é … (1å€‹æ­£ç¢º + 3å€‹éŒ¯èª¤)
            const options = [word.mean];
            const otherWords = APP_STATE.words.filter((w, i) => i !== APP_STATE.currentIndex);
            while (options.length < 4 && otherWords.length > 0) {
                const idx = Math.floor(Math.random() * otherWords.length);
                if (!options.includes(otherWords[idx].mean)) {
                    options.push(otherWords[idx].mean);
                }
                otherWords.splice(idx, 1);
            }

            // è£œè¶³é¸é …
            const fillers = ['è˜‹æœ', 'æ›¸æœ¬', 'é›»è…¦', 'éŸ³æ¨‚', 'åŸå¸‚'];
            while (options.length < 4) {
                options.push(fillers[options.length]);
            }

            // æ‰“äº‚é †åº
            options.sort(() => Math.random() - 0.5);

            document.getElementById('quiz-options').innerHTML = options.map((opt, i) => `
                <button onclick="checkQuizAnswer(this, '${stripHtml(opt).replace(/'/g, "\\'")}', '${stripHtml(word.mean).replace(/'/g, "\\'")}')" 
                    class="btn-option w-full py-4 rounded-xl text-left px-6 text-lg font-semibold">
                    ${stripHtml(opt)}
                </button>
                `).join('');
        }

        // é¡¯ç¤ºæ¸¬é©—æç¤º
        function showQuizHint() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;
            
            let hint = '';
            if (word.kana) hint += `è®€éŸ³ï¼š${word.kana}`;
            if (word.romaji) hint += (hint ? ' / ' : '') + word.romaji;
            if (word.example) hint += `<br>ä¾‹å¥ï¼š${word.example}`;
            if (word.notes) hint += `<br>ğŸ’¡ ${word.notes}`;
            
            if (!hint) hint = 'é€™é¡Œæ²’æœ‰é¡å¤–æç¤ºï¼Œç›¸ä¿¡è‡ªå·±ï¼';
            
            document.getElementById('quiz-hint').innerHTML = hint;
            document.getElementById('quiz-hint').classList.remove('hidden');
            document.getElementById('quiz-hint-btn').classList.add('hidden');
            
            // ä½¿ç”¨æç¤ºæ‰£ XP
            addXP(-2);
        }

        function checkQuizAnswer(btn, selected, correct) {
            if (APP_STATE.isAnswered) return;
            APP_STATE.isAnswered = true;

            const isCorrect = selected === correct;
            userData.totalAnswered++;
            APP_STATE.roundTotal++;
            if (isCorrect) {
                userData.totalCorrect++;
                APP_STATE.roundCorrect++;
            } else {
                // è¨˜éŒ„éŒ¯é¡Œ
                const currentWord = APP_STATE.words[APP_STATE.currentIndex];
                if (currentWord && !APP_STATE.mistakes.find(m => m.word === currentWord.word)) {
                    APP_STATE.mistakes.push(currentWord);
                }
            }
            saveUserData();

            if (isCorrect) {
                btn.classList.add('correct');
                playSound('correct');
                addXP(10);
                showFeedback('quiz-feedback', true, 'ç­”å°äº†ï¼', '');
            } else {
                btn.classList.add('wrong');
                playSound('wrong');
                showFeedback('quiz-feedback', false, 'å†æƒ³æƒ³...', `æ­£ç¢ºç­”æ¡ˆï¼š${correct}`);
                
                // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
                document.querySelectorAll('#quiz-options button').forEach(b => {
                    if (b.textContent.trim() === correct) {
                        b.classList.add('correct');
                    }
                });
            }

            setTimeout(nextWord, 1500);
        }

        // ===== æ‹¼å¯«æ¨¡å¼ =====
        function renderTyping() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            APP_STATE.isAnswered = false;
            document.getElementById('typing-hint').textContent = stripHtml(word.mean);
            document.getElementById('typing-pos').textContent = word.kana 
                ? `å‡åï¼š${stripHtml(word.kana)}${word.romaji ? ` / ${stripHtml(word.romaji)}` : ''}` 
                : stripHtml(word.pos) || '';
            document.getElementById('typing-input').value = '';
            document.getElementById('typing-feedback').classList.add('hidden');
            document.getElementById('typing-input').focus();
        }

        function checkTyping() {
            if (APP_STATE.isAnswered) return;
            
            const word = APP_STATE.words[APP_STATE.currentIndex];
            const input = document.getElementById('typing-input').value.trim().toLowerCase();
            const answers = [word.word, word.kana, word.romaji].filter(Boolean).map(v => v.trim().toLowerCase());

            APP_STATE.isAnswered = true;
            userData.totalAnswered++;
            APP_STATE.roundTotal++;

            if (answers.includes(input)) {
                userData.totalCorrect++;
                APP_STATE.roundCorrect++;
                saveUserData();
                playSound('correct');
                addXP(15);
                showFeedback('typing-feedback', true, 'å®Œç¾ï¼', '');
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
            } else {
                // è¨˜éŒ„éŒ¯é¡Œ
                if (!APP_STATE.mistakes.find(m => m.word === word.word)) {
                    APP_STATE.mistakes.push(word);
                }
                saveUserData();
                playSound('wrong');
                showFeedback('typing-feedback', false, 'å·®ä¸€é»ï¼', `æ­£ç¢ºç­”æ¡ˆï¼š${word.word}ï¼ˆ${word.kana || ''}ï¼‰`);
            }

            setTimeout(nextWord, 1500);
        }

        // ===== è½åŠ›æ¨¡å¼ =====
        function renderListening() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;

            APP_STATE.isAnswered = false;
            document.getElementById('listening-feedback').classList.add('hidden');

            // ç”Ÿæˆé¸é …
            const correctWord = word.kana || word.word;
            const options = [correctWord];
            const otherWords = APP_STATE.words.filter((w, i) => i !== APP_STATE.currentIndex);
            while (options.length < 4 && otherWords.length > 0) {
                const idx = Math.floor(Math.random() * otherWords.length);
                const candidate = otherWords[idx].kana || otherWords[idx].word;
                if (!options.includes(candidate)) {
                    options.push(candidate);
                }
                otherWords.splice(idx, 1);
            }
            options.sort(() => Math.random() - 0.5);

            document.getElementById('listening-options').innerHTML = options.map(opt => `
                <button onclick="checkListeningAnswer(this, '${stripHtml(opt)}', '${stripHtml(correctWord)}')" 
                    class="btn-option py-6 rounded-xl text-lg font-bold">
                    ${stripHtml(opt)}
                </button>
            `).join('');

            // è‡ªå‹•æ’­æ”¾
            setTimeout(playListeningWord, 500);
        }

        function playListeningWord() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (!word) return;
            
            // è½åŠ›æ¨¡å¼ç”¨è¼ƒæ…¢é€Ÿåº¦ï¼Œæ›´æ¸…æ™°
            const speakTarget = word.kana || word.word;
            speakText(speakTarget, 0.65);
            
            document.getElementById('sound-waves').classList.remove('hidden');
            setTimeout(() => document.getElementById('sound-waves').classList.add('hidden'), 2000);
        }

        // è½åŠ›æ¨¡å¼é‡æ–°æ’­æ”¾ï¼ˆæ…¢é€Ÿï¼‰
        function replayListeningSlow() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                const speakTarget = word.kana || word.word;
                speakText(speakTarget, 0.45);
            }
        }

        // æ’­æ”¾å°è©±è¨Šæ¯
        function speakChatMessage(btn, rate = 0.8) {
            const text = btn.dataset.text;
            if (text) {
                // é‚„åŸ HTML å¯¦é«”
                const decodedText = text.replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&amp;/g, '&');
                speakText(decodedText, rate);
            }
        }

        function checkListeningAnswer(btn, selected, correct) {
            if (APP_STATE.isAnswered) return;
            APP_STATE.isAnswered = true;

            userData.totalAnswered++;
            APP_STATE.roundTotal++;
            const isCorrect = selected === correct;
            if (isCorrect) {
                userData.totalCorrect++;
                APP_STATE.roundCorrect++;
            } else {
                // è¨˜éŒ„éŒ¯é¡Œ
                const currentWord = APP_STATE.words[APP_STATE.currentIndex];
                if (currentWord && !APP_STATE.mistakes.find(m => m.word === currentWord.word)) {
                    APP_STATE.mistakes.push(currentWord);
                }
            }
            saveUserData();

            if (isCorrect) {
                btn.classList.add('correct');
                playSound('correct');
                addXP(10);
                showFeedback('listening-feedback', true, 'è½åŠ›å¾ˆæ£’ï¼', '');
            } else {
                btn.classList.add('wrong');
                playSound('wrong');
                showFeedback('listening-feedback', false, 'å†è½ä¸€æ¬¡', `æ­£ç¢ºç­”æ¡ˆï¼š${correct}`);
            }

            setTimeout(nextWord, 1500);
        }

        // ===== æ–‡æ³•æ¨¡å¼ =====
        function renderGrammar(data) {
            document.getElementById('grammar-concept').textContent = stripHtml(data.concept);
            document.getElementById('grammar-explanation').textContent = stripHtml(data.explanation);

            document.getElementById('grammar-quiz').innerHTML = data.quiz.map((q, idx) => `
                <div class="bg-white/5 rounded-xl p-4">
                    <p class="font-bold mb-3">${stripHtml(q.question)}</p>
                    <div class="space-y-2">
                                        ${q.options.map((opt, i) => `
                            <button onclick="checkGrammarAnswer(this, ${i}, ${q.answer}, '${stripHtml(q.reason).replace(/'/g, "\\'")}')"
                                class="btn-option w-full py-3 px-4 rounded-lg text-left text-sm">
                                                ${stripHtml(opt)}
                                            </button>
                                        `).join('')}
                                    </div>
                    <div class="grammar-feedback hidden mt-3 p-3 rounded-lg text-sm"></div>
                                </div>
            `).join('');
        }

        // ===== äº”åéŸ³æ¨¡å¼ =====
        function renderKana() {
            const container = document.getElementById('kana-grid');
            const extra = document.getElementById('kana-extra');
            if (!container) return;
            if (!extra) return;

            const deck = APP_STATE.words || [];
            const byKana = Object.fromEntries(deck.map(item => [(item.kana || item.word), item]));

            const H_PATTERN = [
                ['ã‚','ã„','ã†','ãˆ','ãŠ'],
                ['ã‹','ã','ã','ã‘','ã“'],
                ['ã•','ã—','ã™','ã›','ã'],
                ['ãŸ','ã¡','ã¤','ã¦','ã¨'],
                ['ãª','ã«','ã¬','ã­','ã®'],
                ['ã¯','ã²','ãµ','ã¸','ã»'],
                ['ã¾','ã¿','ã‚€','ã‚','ã‚‚'],
                ['ã‚„','','ã‚†','','ã‚ˆ'],
                ['ã‚‰','ã‚Š','ã‚‹','ã‚Œ','ã‚'],
                ['ã‚','ã‚','','ã‚‘','ã‚’'],
                ['ã‚“','','','',''],
                ['ã£','','','','']
            ];

            const K_PATTERN = [
                ['ã‚¢','ã‚¤','ã‚¦','ã‚¨','ã‚ª'],
                ['ã‚«','ã‚­','ã‚¯','ã‚±','ã‚³'],
                ['ã‚µ','ã‚·','ã‚¹','ã‚»','ã‚½'],
                ['ã‚¿','ãƒ','ãƒ„','ãƒ†','ãƒˆ'],
                ['ãƒŠ','ãƒ‹','ãƒŒ','ãƒ','ãƒ'],
                ['ãƒ','ãƒ’','ãƒ•','ãƒ˜','ãƒ›'],
                ['ãƒ','ãƒŸ','ãƒ ','ãƒ¡','ãƒ¢'],
                ['ãƒ¤','','ãƒ¦','','ãƒ¨'],
                ['ãƒ©','ãƒª','ãƒ«','ãƒ¬','ãƒ­'],
                ['ãƒ¯','ãƒ°','','ãƒ±','ãƒ²'],
                ['ãƒ³','','','',''],
                ['ãƒƒ','','','','']
            ];

            const pattern = deck.some(d => (d.kana || d.word).match(/^[ã‚¢-ãƒ³ãƒ´ãƒ¼ãƒ±ãƒ²ãƒ°ãƒƒ]/)) ? K_PATTERN : H_PATTERN;
            const script = pattern === K_PATTERN ? 'katakana' : 'hiragana';

            const rowsHtml = pattern.map(row => row.map(k => renderKanaCell(k, byKana)).join('')).join('');

            APP_STATE.currentIndex = 0; // é€²åº¦æ¢é¡¯ç¤º 1 / 50
            container.innerHTML = rowsHtml;
            extra.innerHTML = renderKanaExtra(byKana, script);
        }

        function speakKana(text, rate = 0.8) {
            if (!text) return;
            speakText(text, rate);
        }

        function renderKanaCell(k, byKana) {
            if (!k) {
                return `<div class="glass-card rounded-2xl p-4 text-center opacity-30">â€”</div>`;
            }
            const w = byKana[k];
            const text = k;
            const romaji = w?.romaji ? `ç¾…é¦¬éŸ³ï¼š${w.romaji}` : '';
            const mean = w?.mean || '';
            const notes = w?.notes || '';
            return `
            <div class="glass-card rounded-2xl p-4 text-center">
                <div class="text-sm px-3 py-1 rounded-full bg-blue-500/20 text-blue-200 inline-block mb-2">å‡å</div>
                <div class="text-4xl md:text-5xl font-black mb-2">${text}</div>
                <div class="text-sm text-gray-300 mb-1">${romaji}</div>
                <div class="text-base text-emerald-300 mb-1">${mean}</div>
                <div class="text-xs text-amber-200 mb-2">${notes}</div>
                <div class="flex justify-center gap-2">
                    <button onclick="speakKana('${text}', 0.55)" class="w-9 h-9 bg-amber-500/20 border border-amber-400/40 rounded-full flex items-center justify-center hover:scale-110 transition" title="æ…¢é€Ÿ">
                        <i class="fa-solid fa-volume-low text-amber-200 text-sm"></i>
                    </button>
                    <button onclick="speakKana('${text}', 0.85)" class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center hover:scale-110 transition shadow-lg" title="æ’­æ”¾">
                        <i class="fa-solid fa-volume-high text-white"></i>
                    </button>
                </div>
            </div>`;
        }

        function renderKanaExtra(byKana, script) {
            const data = KANA_EXTRA[script];
            if (!data) return '';

            const block = (title, items) => {
                if (!items || items.length === 0) return '';
                const chunks = [];
                for (let i = 0; i < items.length; i += 5) {
                    chunks.push(items.slice(i, i + 5));
                }
                const dict = Object.fromEntries(items.map(it => [it.word, it]));
                const rows = chunks.map(row => row.map(k => k ? renderKanaCell(k.word, dict) : renderKanaCell('', {})).join('')).join('');
                return `
                <div class="mt-6">
                    <div class="text-sm font-bold text-emerald-300 mb-2">${title}</div>
                    <div class="grid grid-cols-5 gap-3 md:gap-4">
                        ${rows}
                    </div>
                </div>`;
            };

            return [
                block('æ¿éŸ³', data.dakuten),
                block('åŠæ¿éŸ³', data.handaku),
                block('æ‹—éŸ³', data.youon),
                block('ä¿ƒéŸ³', data.sokuon),
                block('é•·éŸ³', data.choon),
                block('ç‰¹æ®Šç™¼éŸ³', data.special)
            ].join('');
        }

        function checkGrammarAnswer(btn, selected, correct, reason) {
            const container = btn.closest('.space-y-2');
            const feedback = btn.closest('.bg-white\\/5').querySelector('.grammar-feedback');
            
            if (selected === correct) {
                btn.classList.add('correct');
                playSound('correct');
                addXP(10);
                feedback.innerHTML = `<span class="text-green-400">âœ“ ${reason}</span>`;
            } else {
                btn.classList.add('wrong');
                playSound('wrong');
                feedback.innerHTML = `<span class="text-red-400">âœ— ${reason}</span>`;
            }
            feedback.classList.remove('hidden');

            // ç¦ç”¨æ‰€æœ‰é¸é …
            container.querySelectorAll('button').forEach(b => b.disabled = true);
        }

        // ===== AI å°è©±æ¨¡å¼ =====
        // å–å¾—ä¸»é¡Œçš„ä¸­æ–‡æ¨™ç±¤
        function getTopicLabel(value) {
            const topics = TOPICS[APP_STATE.currentMode] || [];
            const topic = topics.find(t => t.value === value);
            return topic ? topic.label : value;
        }

        // æƒ…å¢ƒå°è©±çš„ä¸­æ–‡æ­¡è¿èª
        const CHAT_GREETINGS = {
            'Japanese Coffee Shop': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚ã‚³ãƒ¼ãƒ’ãƒ¼ã¯ãƒ›ãƒƒãƒˆã¨ã‚¢ã‚¤ã‚¹ã€ã©ã¡ã‚‰ã«ã•ã‚Œã¾ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œå’–å•¡è¦ç†±çš„é‚„æ˜¯å†°çš„å‘¢ï¼Ÿ' },
            'Ramen shop': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ï¼é£Ÿåˆ¸ã¯ãŠè²·ã„æ±‚ã‚ã§ã™ã‹ï¼ŸãŠã™ã™ã‚ã¯é†¤æ²¹ãƒ©ãƒ¼ãƒ¡ãƒ³ã§ã™ã‚ˆã€‚', chinese: 'æ­¡è¿ï¼æœ‰å…ˆè²·é£Ÿåˆ¸å—ï¼Ÿæ¨è–¦é†¬æ²¹æ‹‰éºµå–”ã€‚' },
            'Train station ticket': { greeting: 'ã©ã¡ã‚‰ã¾ã§è¡Œã‹ã‚Œã¾ã™ã‹ï¼ŸICã‚«ãƒ¼ãƒ‰ã¯ãŠæŒã¡ã§ã™ã‹ï¼Ÿ', chinese: 'è«‹å•è¦åˆ°å“ªä¸€ç«™ï¼Ÿæœ‰ IC å¡å—ï¼Ÿ' },
            'Hotel check-in in Japan': { greeting: 'ã‚ˆã†ã“ããŠè¶Šã—ãã ã•ã„ã¾ã—ãŸã€‚ã”äºˆç´„ã®ãŠåå‰ã‚’é ‚ã‘ã¾ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œè«‹å‘Šè¨´æˆ‘é è¨‚çš„åå­—ã€‚' },
            'Convenience store in Japan': { greeting: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚è¢‹ã¯ã”åˆ©ç”¨ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ', chinese: 'æ­¡è¿å…‰è‡¨ï¼Œéœ€è¦è³¼ç‰©è¢‹å—ï¼Ÿ' },
            'Izakaya small talk': { greeting: 'ã“ã‚“ã°ã‚“ã¯ï¼ãŠé£²ã¿ç‰©ã¯ä½•ã«ã—ã¾ã™ã‹ï¼Ÿç”Ÿãƒ“ãƒ¼ãƒ«ã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ', chinese: 'æ™šä¸Šå¥½ï¼æƒ³å…ˆå–é»ä»€éº¼ï¼Ÿè¦ç”Ÿå•¤å—ï¼Ÿ' },
            'Asking for directions in Japanese': { greeting: 'ã“ã‚“ã«ã¡ã¯ã€‚ã©ã¡ã‚‰ã¸è¡ŒããŸã„ã§ã™ã‹ï¼Ÿè¿‘ã„é“ã‚’ãŠä¼ãˆã—ã¾ã™ã­ã€‚', chinese: 'ä½ å¥½ï¼Œæƒ³å»å“ªè£¡ï¼Ÿæˆ‘å‘Šè¨´ä½ è¼ƒè¿‘çš„è·¯ç·šã€‚' },
            'Pharmacy conversation': { greeting: 'ã“ã‚“ã«ã¡ã¯ã€‚ã©ã®ã‚ˆã†ãªç—‡çŠ¶ã§ã™ã‹ï¼Ÿç†±ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', chinese: 'ä½ å¥½ï¼Œå“ªè£¡ä¸èˆ’æœï¼Ÿæœ‰ç™¼ç‡’å—ï¼Ÿ' },
            'Meeting new friends in Japanese': { greeting: 'ã¯ã˜ã‚ã¾ã—ã¦ï¼ã©ã“ã‹ã‚‰æ¥ã¾ã—ãŸã‹ï¼Ÿæ—¥æœ¬ã¯åˆã‚ã¦ã§ã™ã‹ï¼Ÿ', chinese: 'åˆæ¬¡è¦‹é¢ï¼ä½ å¾å“ªè£¡ä¾†ï¼Ÿç¬¬ä¸€æ¬¡ä¾†æ—¥æœ¬å—ï¼Ÿ' }
        };

        function initChat() {
            const scenarioValue = APP_STATE.currentTopic;
            const scenarioLabel = getTopicLabel(scenarioValue);
            const chatInfo = CHAT_GREETINGS[scenarioValue] || { 
                greeting: `Hi! Welcome to our ${scenarioValue} scenario. Let's practice Japanese conversation together.`,
                chinese: `å—¨ï¼æ­¡è¿ä¾†åˆ°${scenarioLabel}æƒ…å¢ƒã€‚è®“æˆ‘å€‘ç·´ç¿’æ—¥èªå°è©±ã€‚`
            };

            document.getElementById('chat-scenario').textContent = scenarioLabel;
            document.getElementById('chat-messages').innerHTML = `
                <div class="flex gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-robot text-lg"></i>
                    </div>
                    <div class="glass-card rounded-2xl rounded-tl-sm p-4 max-w-[80%]">
                        <div class="flex items-start justify-between gap-2">
                            <p class="text-lg flex-1">${chatInfo.greeting}</p>
                            <button onclick="speakChatMessage(this)" data-text="${chatInfo.greeting.replace(/"/g, '&quot;')}" 
                                class="shrink-0 w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center text-blue-400 hover:bg-blue-500/30 transition" title="æ’­æ”¾èªéŸ³">
                                <i class="fa-solid fa-volume-high text-sm"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-400 mt-2 border-t border-white/10 pt-2">${chatInfo.chinese}</p>
                        <p class="text-xs text-blue-400 mt-2"><i class="fa-solid fa-lightbulb mr-1"></i>æç¤ºï¼šç”¨æ—¥æ–‡å›è¦†ï¼Œç·´ç¿’å°è©±ï¼</p>
                    </div>
                </div>
            `;
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const messagesContainer = document.getElementById('chat-messages');

            // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
            messagesContainer.innerHTML += `
                <div class="flex gap-3 justify-end">
                    <div class="bg-blue-500/20 border border-blue-500/30 rounded-2xl rounded-tr-sm p-4 max-w-[80%]">
                        <p>${message}</p>
                        </div>
                                </div>
            `;

            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // é¡¯ç¤ºè¼‰å…¥
            const loadingId = 'typing-' + Date.now();
            messagesContainer.innerHTML += `
                <div id="${loadingId}" class="flex gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div class="glass-card rounded-2xl rounded-tl-sm p-4">
                        <div class="flex gap-1">
                            <span class="w-2 h-2 bg-white/50 rounded-full animate-bounce"></span>
                            <span class="w-2 h-2 bg-white/50 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                            <span class="w-2 h-2 bg-white/50 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        </div>
                        </div>
                    </div>
                `;

            try {
                const prompt = generatePrompt(
                    'chat',
                    APP_STATE.currentTopic,
                    document.getElementById('level-select').value,
                    [],
                    message
                );

                const data = await callGeminiAPI(prompt);
                document.getElementById(loadingId).remove();

                // AI å›è¦† - è½‰ç¾©å¼•è™Ÿé¿å… HTML å•é¡Œ
                const safeReply = data.reply.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                
                messagesContainer.innerHTML += `
                    <div class="flex gap-3 animate-slide">
                        <div class="w-10 h-10 bg-gradient-to-br from-rose-500 to-purple-500 rounded-full flex items-center justify-center shrink-0">
                            <i class="fa-solid fa-robot"></i>
                        </div>
                        <div class="glass-card rounded-2xl rounded-tl-sm p-4 max-w-[80%]">
                            <div class="flex items-start justify-between gap-2">
                                <p class="flex-1">${data.reply}</p>
                                <div class="shrink-0 flex gap-1">
                                    <button onclick="speakChatMessage(this, 0.6)" data-text="${safeReply}" 
                                        class="w-8 h-8 bg-amber-500/20 rounded-full flex items-center justify-center text-amber-400 hover:bg-amber-500/30 transition" title="æ…¢é€Ÿæ’­æ”¾">
                                        <i class="fa-solid fa-volume-low text-xs"></i>
                                    </button>
                                    <button onclick="speakChatMessage(this, 0.85)" data-text="${safeReply}" 
                                        class="w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center text-blue-400 hover:bg-blue-500/30 transition" title="æ­£å¸¸æ’­æ”¾">
                                        <i class="fa-solid fa-volume-high text-sm"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">${data.chinese}</p>
                            ${data.feedback ? `<p class="text-xs text-yellow-400 mt-2 border-t border-white/10 pt-2">ğŸ’¡ ${data.feedback}</p>` : ''}
                            ${data.score ? `<div class="mt-2 flex items-center gap-2">
                                <span class="text-xs text-gray-400">è¡¨é”è©•åˆ†</span>
                                <div class="flex-1 h-2 bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full ${data.score >= 80 ? 'bg-green-500' : data.score >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${data.score}%"></div>
                                </div>
                                <span class="text-xs font-bold">${data.score}</span>
                            </div>` : ''}
                        </div>
                    </div>
                `;

                addXP(5);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (e) {
                document.getElementById(loadingId).remove();
                console.error(e);
                alert('å°è©±å¤±æ•—ï¼š' + e.message);
            }
        }

        // ===== å·¥å…·å‡½æ•¸ =====
        function nextWord() {
            APP_STATE.currentIndex++;
            
            if (APP_STATE.currentIndex >= APP_STATE.words.length) {
                showCompletion();
            } else {
                renderCurrentMode();
            }
        }

        function showCompletion() {
            const earnedXP = APP_STATE.words.length * 10;
            document.getElementById('earned-xp').textContent = earnedXP;
            
            // æ›´æ–°æœ¬è¼ªçµ±è¨ˆ
            document.getElementById('round-total').textContent = APP_STATE.roundTotal || APP_STATE.words.length;
            document.getElementById('round-correct').textContent = APP_STATE.roundCorrect;
            const accuracy = APP_STATE.roundTotal > 0 ? Math.round(APP_STATE.roundCorrect / APP_STATE.roundTotal * 100) : 0;
            document.getElementById('round-accuracy').textContent = accuracy + '%';
            
            document.getElementById('complete-modal').classList.remove('hidden');
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        // è¤‡ç¿’éŒ¯é¡Œ
        function reviewMistakes() {
            document.getElementById('complete-modal').classList.add('hidden');
            if (APP_STATE.mistakes.length === 0) {
                alert('å¤ªæ£’äº†ï¼æ²’æœ‰éŒ¯é¡Œéœ€è¦è¤‡ç¿’ ğŸ‰');
                continuelearning();
                return;
            }
            APP_STATE.words = [...APP_STATE.mistakes];
            APP_STATE.mistakes = [];
            APP_STATE.currentIndex = 0;
            APP_STATE.roundCorrect = 0;
            APP_STATE.roundTotal = 0;
            renderCurrentMode();
        }

        function continuelearning() {
            document.getElementById('complete-modal').classList.add('hidden');
            APP_STATE.currentIndex = 0;
            APP_STATE.roundCorrect = 0;
            APP_STATE.roundTotal = 0;
            APP_STATE.mistakes = [];
            loadContent();
        }

        function showFeedback(elementId, isCorrect, title, subtitle) {
            const el = document.getElementById(elementId);
            el.classList.remove('hidden');
            el.className = `mt-6 p-4 rounded-xl text-center ${isCorrect ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`;
            el.innerHTML = `<div class="font-bold">${title}</div>${subtitle ? `<div class="text-sm opacity-80">${subtitle}</div>` : ''}`;
        }

        // ===== èªéŸ³æ’­æ”¾åŠŸèƒ½ï¼ˆæ”¹å–„æ¸…æ™°åº¦ï¼‰=====
        let japaneseVoice = null;
        let voicesLoaded = false;

        // åˆå§‹åŒ–ä¸¦é¸æ“‡æœ€ä½³æ—¥æ–‡èªéŸ³
        function initVoices() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return;
            
            voicesLoaded = true;
            
            // å„ªå…ˆé¸æ“‡é †åºï¼šGoogle > Microsoft > Apple > å…¶ä»–
            const preferredVoices = [
                'Google æ—¥æœ¬èª',
                'Microsoft Haruka',
                'Microsoft Ayumi',
                'Microsoft Ichiro',
                'Kyoko',            // macOS/iOS
                'Otoya',            // macOS/iOS
                'Mizuki',           // AWS Polly style names
                'Takumi'
            ];
            
            // å˜—è©¦æ‰¾åˆ°æœ€ä½³èªéŸ³
            for (const preferred of preferredVoices) {
                const found = voices.find(v => v.name.includes(preferred));
                if (found) {
                    japaneseVoice = found;
                    console.log('é¸æ“‡èªéŸ³:', found.name);
                    break;
                }
            }
            
            // å¦‚æœæ²’æ‰¾åˆ°å„ªå…ˆèªéŸ³ï¼Œé¸æ“‡ä»»ä½•æ—¥æ–‡èªéŸ³
            if (!japaneseVoice) {
                japaneseVoice = voices.find(v => v.lang && v.lang.startsWith('ja')) || voices[0];
                console.log('ä½¿ç”¨é è¨­èªéŸ³:', japaneseVoice?.name);
            }
        }

        // ç›£è½èªéŸ³åˆ—è¡¨è¼‰å…¥
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = initVoices;
            initVoices(); // ç«‹å³å˜—è©¦ä¸€æ¬¡
        }

        // é ç†±èªéŸ³å¼•æ“ï¼ˆè§£æ±ºç¬¬ä¸€å€‹å­—è¢«æˆªæ‰çš„å•é¡Œï¼‰
        let speechWarmedUp = false;
        function warmUpSpeech() {
            if (speechWarmedUp) return;
            const warmUp = new SpeechSynthesisUtterance('');
            warmUp.volume = 0;
            window.speechSynthesis.speak(warmUp);
            speechWarmedUp = true;
        }

        function speakWord() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                // å…ˆæ…¢é€Ÿæ’­æ”¾ä¸€æ¬¡ï¼Œå†æ­£å¸¸é€Ÿåº¦æ’­æ”¾
                const speakTarget = word.kana || word.word;
                speakText(speakTarget, 0.6, () => {
                    setTimeout(() => speakText(speakTarget, 0.85), 800);
                });
            }
        }

        function speakText(text, rate = 0.75, onEnd = null) {
            // å…ˆå–æ¶ˆä¹‹å‰çš„æ’­æ”¾
            window.speechSynthesis.cancel();
            
            // é ç†±å¼•æ“
            warmUpSpeech();
            
            // åœ¨å–®å­—å‰åŠ ä¸Šå¾®å°åœé “ï¼Œé¿å…ç¬¬ä¸€å€‹éŸ³ç¯€è¢«æˆªæ‰
            // ä½¿ç”¨é€—è™Ÿæœƒç”¢ç”Ÿè‡ªç„¶çš„çŸ­æš«åœé “
            const textWithPause = `, ${text}`;
            
            const utterance = new SpeechSynthesisUtterance(textWithPause);
            
            // ä½¿ç”¨æœ€ä½³èªéŸ³
            if (japaneseVoice) {
                utterance.voice = japaneseVoice;
            }
            
            utterance.lang = japaneseVoice?.lang || 'ja-JP';
            utterance.rate = rate;      // èªé€Ÿï¼ˆ0.1-10ï¼Œé è¨­1ï¼‰
            utterance.pitch = 1.0;      // éŸ³èª¿ï¼ˆ0-2ï¼Œé è¨­1ï¼‰
            utterance.volume = 1.0;     // éŸ³é‡ï¼ˆ0-1ï¼‰
            
            if (onEnd) {
                utterance.onend = onEnd;
            }
            
            // ä½¿ç”¨ setTimeout ç¢ºä¿å¼•æ“æº–å‚™å¥½
            setTimeout(() => {
                window.speechSynthesis.speak(utterance);
            }, 50);
        }

        // æ…¢é€Ÿæ’­æ”¾ï¼ˆçµ¦ç”¨æˆ¶æ‰‹å‹•é»æ“Šç”¨ï¼‰
        function speakSlow() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                const speakTarget = word.kana || word.word;
                speakText(speakTarget, 0.5);
            }
        }

        // æ­£å¸¸é€Ÿåº¦æ’­æ”¾
        function speakNormal() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word) {
                const speakTarget = word.kana || word.word;
                speakText(speakTarget, 0.85);
            }
        }

        function speakExample() {
            const word = APP_STATE.words[APP_STATE.currentIndex];
            if (word?.example) {
                speakText(word.example, 0.9);
            }
        }

        function playSound(type) {
            try {
                const sound = document.getElementById(`sound-${type}`);
                sound.currentTime = 0;
                sound.volume = 0.3;
                sound.play().catch(() => {});
            } catch (e) {}
        }

        // ===== çµ±è¨ˆ =====
        function openStats() {
            document.getElementById('stat-streak').textContent = userData.streak;
            document.getElementById('stat-xp').textContent = userData.xp;
            document.getElementById('stat-words').textContent = userData.wordsLearned?.length || 0;
            const accuracy = userData.totalAnswered > 0 
                ? Math.round(userData.totalCorrect / userData.totalAnswered * 100) 
                : 0;
            document.getElementById('stat-accuracy').textContent = accuracy + '%';
            
            // æ›´æ–°å·²å­¸å–®å­—åˆ—è¡¨
            updateLearnedWordsList();
            
            document.getElementById('stats-modal').classList.remove('hidden');
        }

        function closeStats() {
            document.getElementById('stats-modal').classList.add('hidden');
        }

        // åˆ‡æ›é¡¯ç¤ºå·²å­¸å–®å­—
        function toggleLearnedWords() {
            const list = document.getElementById('learned-words-list');
            const text = document.getElementById('toggle-words-text');
            const icon = document.getElementById('toggle-words-icon');
            
            if (list.classList.contains('hidden')) {
                list.classList.remove('hidden');
                text.textContent = 'æ”¶åˆ';
                icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            } else {
                list.classList.add('hidden');
                text.textContent = 'å±•é–‹';
                icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            }
        }

        // æ›´æ–°å·²å­¸å–®å­—åˆ—è¡¨
        function updateLearnedWordsList() {
            const container = document.getElementById('learned-words-list');
            const history = userData.learnedHistory || {};
            
            if (Object.keys(history).length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center">é‚„æ²’æœ‰å­¸ç¿’è¨˜éŒ„</p>';
                return;
            }

            let html = '';
            for (const [topic, words] of Object.entries(history)) {
                if (words.length > 0) {
                    html += `
                        <div class="mb-3">
                            <div class="text-xs text-gray-400 mb-1">${topic} (${words.length})</div>
                            <div class="flex flex-wrap gap-1">
                                ${words.map(w => `<span class="text-xs bg-white/10 px-2 py-1 rounded">${w}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            container.innerHTML = html || '<p class="text-gray-500 text-sm text-center">é‚„æ²’æœ‰å­¸ç¿’è¨˜éŒ„</p>';
        }

        // æ¸…é™¤å­¸ç¿’è¨˜éŒ„ï¼ˆä½†ä¿ç•™ XP ç­‰æ•¸æ“šï¼‰
        function clearLearnedHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤å­¸ç¿’è¨˜éŒ„å—ï¼Ÿ\næ¸…é™¤å¾Œå¯ä»¥é‡æ–°å­¸ç¿’æ‰€æœ‰å–®å­—ï¼Œä½† XP å’Œé€£çºŒå¤©æ•¸æœƒä¿ç•™ã€‚')) {
                userData.learnedHistory = {};
                userData.wordsLearned = [];
                APP_STATE.historyData = [];
                saveUserData();
                updateLearnedWordsList();
                alert('å­¸ç¿’è¨˜éŒ„å·²æ¸…é™¤ï¼');
            }
        }

        // ===== æ‰‹æ©Ÿé¸å–® =====
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
            
            // åŒæ­¥æ›´æ–°æ‰‹æ©Ÿç‰ˆä¸»é¡Œåˆ—è¡¨
            if (!menu.classList.contains('hidden')) {
                updateMobileTopics();
            }
        }

        function updateMobileTopics() {
            updateMobileTopicSelect();
        }

        function updateMobileTopicSelect() {
            const select = document.getElementById('mobile-topic-select');
            if (!select) return;
            
            const topics = TOPICS[APP_STATE.currentMode] || [];
            
            select.innerHTML = topics.map(t => `
                <option value="${t.value}" ${t.value === APP_STATE.currentTopic ? 'selected' : ''}>${t.label}</option>
            `).join('');
        }

        function onMobileTopicChange() {
            const select = document.getElementById('mobile-topic-select');
            APP_STATE.currentTopic = select.value;
            APP_STATE.historyData = [];
            
            // åŒæ­¥æ¡Œé¢ç‰ˆé¸å–®
            const desktopSelect = document.getElementById('topic-select');
            if (desktopSelect) desktopSelect.value = select.value;
            
            toggleMobileMenu();
            loadContent();
        }

        // ===== èªéŸ³è¼¸å…¥åŠŸèƒ½ =====
        let recognition = null;
        let isListening = false;

        function initSpeechRecognition() {
            // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´èªéŸ³è¾¨è­˜
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.log('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜');
                // éš±è—éº¥å…‹é¢¨æŒ‰éˆ•
                document.querySelectorAll('[id$="-mic-btn"]').forEach(btn => {
                    btn.style.display = 'none';
                });
                return false;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';  // è¾¨è­˜æ—¥æ–‡
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                isListening = true;
                updateMicButtonState(true);
            };

            recognition.onend = function() {
                isListening = false;
                updateMicButtonState(false);
            };

            recognition.onerror = function(event) {
                console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);
                isListening = false;
                updateMicButtonState(false);
                
                if (event.error === 'no-speech') {
                    showVoiceError('æ²’æœ‰åµæ¸¬åˆ°è²éŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡');
                } else if (event.error === 'not-allowed') {
                    showVoiceError('è«‹å…è¨±ä½¿ç”¨éº¥å…‹é¢¨æ¬Šé™');
                }
            };

            return true;
        }

        function startVoiceInput(targetInputId) {
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨');
                    return;
                }
            }

            if (isListening) {
                recognition.stop();
                return;
            }

            const targetInput = document.getElementById(targetInputId);
            
            // é¡¯ç¤ºè†è½ç‹€æ…‹
            if (targetInputId === 'chat-input') {
                document.getElementById('chat-voice-status').classList.remove('hidden');
            } else {
                document.getElementById('voice-status').classList.remove('hidden');
            }

            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // å³æ™‚é¡¯ç¤ºè¾¨è­˜çµæœ
                if (interimTranscript) {
                    targetInput.value = interimTranscript;
                    targetInput.style.color = '#94a3b8'; // æš«æ™‚çµæœç”¨ç°è‰²
                }

                if (finalTranscript) {
                    targetInput.value = finalTranscript;
                    targetInput.style.color = 'white';
                    
                    // éš±è—è†è½ç‹€æ…‹
                    document.getElementById('chat-voice-status')?.classList.add('hidden');
                    document.getElementById('voice-status')?.classList.add('hidden');

                    // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                    playSound('correct');
                }
            };

            try {
                recognition.start();
            } catch (e) {
                console.error('ç„¡æ³•å•Ÿå‹•èªéŸ³è¾¨è­˜:', e);
            }
        }

        function updateMicButtonState(listening) {
            const micBtns = document.querySelectorAll('[id$="-mic-btn"]');
            micBtns.forEach(btn => {
                if (listening) {
                    btn.classList.add('animate-pulse', 'ring-4', 'ring-red-500/50');
                    btn.innerHTML = '<i class="fa-solid fa-stop text-xl"></i>';
                } else {
                    btn.classList.remove('animate-pulse', 'ring-4', 'ring-red-500/50');
                    btn.innerHTML = '<i class="fa-solid fa-microphone text-xl"></i>';
                    
                    // éš±è—æ‰€æœ‰è†è½ç‹€æ…‹
                    document.getElementById('chat-voice-status')?.classList.add('hidden');
                    document.getElementById('voice-status')?.classList.add('hidden');
                }
            });
        }

        function showVoiceError(message) {
            // ç°¡å–®çš„éŒ¯èª¤æç¤º
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full shadow-lg z-50 animate-slide';
            toast.innerHTML = `<i class="fa-solid fa-exclamation-circle mr-2"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // åˆå§‹åŒ–èªéŸ³è¾¨è­˜
        document.addEventListener('DOMContentLoaded', () => {
            initSpeechRecognition();
        });

        // ===== éµç›¤å¿«æ·éµ =====
        document.addEventListener('keydown', (e) => {
            // é¿å…åœ¨è¼¸å…¥æ¡†ä¸­è§¸ç™¼
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case ' ':  // ç©ºç™½éµï¼šç¿»è½‰é–ƒå¡ / æ’­æ”¾ç™¼éŸ³
                    e.preventDefault();
                    if (APP_STATE.currentMode === 'flashcard') {
                        flipCard();
                    } else if (APP_STATE.currentMode === 'listening') {
                        playListeningWord();
                    } else {
                        speakNormal();
                    }
                    break;
                case '1': case '2': case '3': case '4':
                    // æ•¸å­—éµï¼šé¸æ“‡é¸é …
                    if (APP_STATE.currentMode === 'quiz' || APP_STATE.currentMode === 'listening') {
                        const idx = parseInt(e.key) - 1;
                        const options = document.querySelectorAll(
                            APP_STATE.currentMode === 'quiz' ? '#quiz-options button' : '#listening-options button'
                        );
                        if (options[idx]) options[idx].click();
                    }
                    break;
                case 'ArrowRight':
                case 'Enter':
                    // å³ç®­é ­/Enterï¼šä¸‹ä¸€å€‹ï¼ˆé–ƒå¡è©•åˆ†ã€Œæœ‰å°è±¡ã€ï¼‰
                    if (APP_STATE.currentMode === 'flashcard' && APP_STATE.isFlipped) {
                        rateCard('good');
                    }
                    break;
                case 'ArrowLeft':
                    // å·¦ç®­é ­ï¼šå†å­¸ä¸€æ¬¡
                    if (APP_STATE.currentMode === 'flashcard' && APP_STATE.isFlipped) {
                        rateCard('hard');
                    }
                    break;
                case 'ArrowUp':
                    // ä¸Šç®­é ­ï¼šå¾ˆç†Ÿæ‚‰
                    if (APP_STATE.currentMode === 'flashcard' && APP_STATE.isFlipped) {
                        rateCard('easy');
                    }
                    break;
                case 's':
                    // Sï¼šæ…¢é€Ÿæ’­æ”¾
                    speakSlow();
                    break;
                case 'r':
                    // Rï¼šé‡è¤‡æ’­æ”¾
                    speakWord();
                    break;
            }
        });

        function resetAllData() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç¿’æ•¸æ“šå—ï¼Ÿ\né€™æœƒæ¸…é™¤æ‰€æœ‰ XPã€é€£çºŒå¤©æ•¸å’Œå­¸ç¿’è¨˜éŒ„ï¼')) {
                userData = { 
                    xp: 0, 
                    streak: 0, 
                    wordsLearned: [], 
                    learnedHistory: {},
                    totalCorrect: 0, 
                    totalAnswered: 0, 
                    lastActive: null 
                };
                APP_STATE.historyData = [];
                saveUserData();
                closeStats();
                alert('æ‰€æœ‰æ•¸æ“šå·²é‡ç½®ï¼');
            }
        }
    </script>
</body>
</html>
